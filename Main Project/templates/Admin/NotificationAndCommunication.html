<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
                    <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
      
        <div class="main-panel">
        <div class="content-wrapper">
          <div class="row">
           <!-- Announcements Section -->
           <div class="col-md-12 grid-margin stretch-card">
            <div class="card">
  <div class="card-body">
    <h4 class="card-title">Announcements</h4>

    <form id="announcementForm" class="forms-sample">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Title -->
      <div class="form-group">
        <label for="announcementTitle">Title:</label>
        <input type="text" class="form-control" id="announcementTitle" placeholder="Title" required>
      </div>

      <!-- Message -->
      <div class="form-group">
        <label for="announcementMessage">Message:</label>
        <textarea class="form-control" id="announcementMessage" placeholder="Write your message here" required></textarea>
      </div>

      <!-- Target Group -->
      <div class="form-group">
        <label for="announcementTarget">Send to:</label>
        <select class="form-control" id="announcementTarget" onchange="updateAnnouncementDropdown()" required>
          <option value="">-- Select an option --</option>
          <option value="all">All</option>
          <option value="employees">Specific Employee</option>
          <option value="teams">Specific Team</option>
        </select>
      </div>

      <!-- Conditional Dropdown -->
      <div class="form-group" id="targetSelectionContainer" style="display: none;">
        <label for="announcementSelection">Select:</label>
        <select class="form-control" id="announcementSelection"></select>
      </div>

      <!-- Buttons -->
      <button type="submit" class="btn btn-primary mr-2">Submit</button>
      <button type="button" class="btn btn-light">Cancel</button>
    </form>
  </div>
            </div>
        </div>

<!-- Meeting Schedule Section -->
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Schedule a Meeting</h4>
      <p class="card-description">Fill in the details below</p>
      <form id="meetingForm" class="forms-sample">
        
        <!-- Meeting Title -->
        <div class="form-group">
          <label for="meetingTitle">Meeting Title:</label>
          <input type="text" class="form-control" id="meetingTitle" required>
        </div>

        <!-- Meeting Date & Time -->
        <div class="form-group">
          <label for="meetingDate">Date:</label>
          <input type="date" class="form-control" id="meetingDate" required>
        </div>
        <div class="form-group">
          <label for="meetingTime">Time:</label>
          <input type="time" class="form-control" id="meetingTime" required>
        </div>

        <!-- Meeting Duration -->
        <div class="form-group">
          <label for="meetingDuration">Duration (minutes):</label>
          <input type="number" class="form-control" id="meetingDuration" required>
        </div>

        <!-- Meeting Location -->
        <div class="form-group">
          <label for="meetingLocation">Location:</label>
          <input type="text" class="form-control" id="meetingLocation" required>
        </div>

        <!-- Meeting Description -->
        <div class="form-group">
          <label for="meetingDescription">Description:</label>
          <textarea class="form-control" id="meetingDescription" required></textarea>
        </div>

        <!-- First Dropdown: Select Target -->
        <div class="form-group">
          <label for="targetGroup">Invite:</label>
          <select class="form-control" id="meetingTarget" onchange="updateMeetingDropdown()">
            <option value="">-- Select an option --</option>
            <option value="employees">Employees</option>
            <option value="teams">Teams</option>
            <option value="all">All</option>
          </select>
        </div>

        <!-- Second Dropdown: Select Employees or Teams -->
        <div class="form-group" id="meetingTargetSelectionContainer">
          <label for="targetSelection">Select:</label>
          <select class="form-control" id="meetingTargetSelection"></select>
        </div>

        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Submit and Cancel Buttons -->
        <button type="submit" class="btn btn-primary mr-2">Schedule</button>
        <button type="button" class="btn btn-light">Cancel</button>
      </form>
    </div>
  </div>
</div>


<!-- Alert Creation Form -->
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
      <div class="card-body">
          <h4 class="card-title">Create Alert</h4>
          <p class="card-description">Fill in the details below</p>
          <form id="alertForm" class="forms-sample">
              <!-- CSRF Token -->
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

              <!-- Title -->
              <div class="form-group">
                  <label for="alertTitle">Title:</label>
                  <input type="text" class="form-control" id="alertTitle" placeholder="Enter alert title" required>
              </div>

              <!-- Message -->
              <div class="form-group">
                  <label for="alertMessage">Message:</label>
                  <textarea class="form-control" id="alertMessage" placeholder="Enter alert message" required></textarea>
              </div>

              <!-- Alert Type -->
              <div class="form-group">
                  <label for="alertType">Alert Type:</label>
                  <input type="text" class="form-control" id="alertType" placeholder="Enter alert type" required>
              </div>

              <!-- Severity Level -->
              <div class="form-group">
                  <label for="severityLevel">Severity Level:</label>
                  <select class="form-control" id="severityLevel" required>
                      <option value="">-- Select severity --</option>
                      <option value="info">Info</option>
                      <option value="warning">Warning</option>
                      <option value="critical">Critical</option>
                  </select>
              </div>

              <!-- Target Group Dropdown -->
              <div class="form-group">
                  <label for="alertTarget">Send to:</label>
                  <select class="form-control" id="alertTarget" onchange="updateAlertDropdown()">
                      <option value="">-- Select an option --</option>
                      <option value="all">All</option>
                      <option value="employees">Specific Employee</option>
                      <option value="teams">Specific Team</option>
                  </select>
              </div>

              <!-- Target Selection Dropdown -->
              <div class="form-group" id="alertTargetSelectionContainer" style="display: none;">
                  <label for="alertTargetSelection">Select:</label>
                  <select class="form-control" id="alertTargetSelection"></select>
              </div>

              <!-- Submit and Cancel Buttons -->
              <button type="submit" class="btn btn-primary mr-2">Submit</button>
              <button type="button" class="btn btn-light">Cancel</button>
          </form>
      </div>
  </div>
</div>

  
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Send Feedback Request</h4>
      <form id="feedbackForm">
        <div class="form-group">
          <label for="feedbackTitle">Title:</label>
          <input type="text" class="form-control" id="feedbackTitle" required>
        </div>
        <div class="form-group">
          <label for="feedbackMessage">Message:</label>
          <textarea class="form-control" id="feedbackMessage" required></textarea>
        </div>
        <div class="form-group">
          <label for="feedbackDeadline">Deadline:</label>
          <input type="date" class="form-control" id="feedbackDeadline" required>
        </div>
        <div class="form-group">
          <label for="feedbackTarget">Send To:</label>
          <select class="form-control" id="feedbackTarget" onchange="updateFeedbackDropdown()">
            <option value="">-- Select an option --</option>
            <option value="all">All Employees & Teams</option>
            <option value="employees">Specific Employee</option>
            <option value="teams">Specific Team</option>
          </select>
        </div>
        <div class="form-group" id="feedbackTargetSelectionContainer" style="display: none;">
          <label for="feedbackTargetSelection">Select:</label>
          <select class="form-control" id="feedbackTargetSelection"></select>
        </div>
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
    </div>
  </div>
</div>

<!-- Announcement table-->
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Employee Announcements</h4>
      <p class="card-description">View announcements sent to employees</p>
      
      <input type="search" id="announcementSearch" class="form-control mb-2" placeholder="Search announcements...">

      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Team name</th>
              <th>Announcement Title</th>
              <th>Message</th>
              <th>Created At</th>
              <th>Read at</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="announcementTable">
          </tbody>
        </table>
      </div>
      <div id="announcement-pagination-controls"></div>
    </div>
  </div>
</div>

<!-- Alerts Table -->
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Employee Alerts</h4>
      <p class="card-description">View alerts sent to employees</p>
      
      <input type="search" id="alertSearch" class="form-control mb-2" placeholder="Search alerts...">

      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Team name</th>
              <th>Alert Title</th>
              <th>Message</th>
              <th>Created At</th>
              <th>Read at</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="alertTable">
          </tbody>
        </table>
      </div>
      <div id="alert-pagination-controls"></div>
    </div>
  </div>
</div>

<!-- Meetings Table -->
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Employee Meetings</h4>
      <p class="card-description">View scheduled meetings</p>
      
      <input type="search" id="meetingSearch" class="form-control mb-2" placeholder="Search meetings...">

      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Team name</th>
              <th>Meeting Title</th>
              <th>Description</th>
              <th>Duration</th>
              <th>Location</th>
              <th>Meeting Date</th>
              <th>Created At</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="meetingTable">
          </tbody>
        </table>
      </div>
      <div id="meeting-pagination-controls"></div>
    </div>
  </div>
</div>

<!-- Feedback Requests Table -->
<div class="col-md-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Feedback Requests</h4>
      <p class="card-description">View feedback requests</p>
      
      <input type="search" id="feedbackSearch" class="form-control mb-2" placeholder="Search feedback requests...">

      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Team name</th>
              <th>Feedback Title</th>
              <th>Message</th>
              <th>Deadline</th>
              <th>Created At</th>
              <th>Submitted At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="feedbackTable">
          </tbody>
        </table>
      </div>
      <div id="feedback-pagination-controls"></div>
    </div>
  </div>
</div>


<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Success</h5>
      </div>
      <div class="modal-body" id="successModalMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal" id="successModalOkBtn">OK</button>
      </div>
    </div>
  </div>
</div>


<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
      </div>
      <div class="modal-body" id="errorModalMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Dismiss</button>
      </div>
    </div>
  </div>
</div>


<!-- Edit Modal -->
<div class="modal fade" id="editMeetingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <form id="editForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit Record</h5>
        </div>
        <div class="modal-body">
          <input class="form-control mb-2" id="editTitle" placeholder="New Title">
          <div id="messageField" class="form-group">
            <textarea class="form-control mb-2" id="editMessage" placeholder="New Message"></textarea>
          </div>
          <div id="meetingFields" class="optional-edit-field" style="display:none;">
            <textarea class="form-control mb-2" id="editDescription" placeholder="Description"></textarea>
            <input type="number" class="form-control mb-2" id="editDuration" placeholder="Duration">
            <input class="form-control mb-2" id="editLocation" placeholder="Location">
            <input type="date" class="form-control mb-2" id="editMeetingDate" placeholder="Meeting Date (YYYY-MM-DD HH:MM:SS)">
          </div>
          <div id="feedbackFields" class="optional-edit-field" style="display:none;">
            <input type="date" class="form-control mb-2" id="editDeadline" placeholder="Deadline (YYYY-MM-DD HH:MM:SS)">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
      </div>
      <div class="modal-body">Are you sure you want to delete this record?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for editing -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Edit Record</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <form id="editForm">
                  <input type="hidden" id="edit_id" name="id">
                  <input type="hidden" id="edit_type" name="type">
                  <div class="form-group">
                      <label for="edit_title">Title</label>
                      <input type="text" class="form-control" id="edit_title" name="title">
                  </div>
                  <div class="form-group">
                      <label for="edit_message">Message</label>
                      <textarea class="form-control" id="edit_message" name="message"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
              </form>
          </div>
      </div>
  </div>
</div>

<!-- Session Conflict Modal -->
<div
  class="modal fade"
  id="sessionConflictModal"
  tabindex="-1"
  aria-labelledby="sessionConflictLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="sessionConflictLabel">Session Conflict</h5>
      </div>
      <div class="modal-body">
        <p>
          <strong
            >Someone has logged into your account from another tab or
            device.</strong
          >
        </p>
        <p>You will be logged out for security reasons.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Logout</h5>
        <button type="button" class="close" id="closeLogoutModal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelLogout">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmLogout">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Access Denied Modal -->
<div
  class="modal fade"
  id="accessDeniedModal"
  tabindex="-1"
  aria-labelledby="accessDeniedLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
      </div>
      <div class="modal-body">
        <p>Only Super Admins are allowed to access this page.</p>
      </div>
      <div class="modal-footer">
        <button id="redirectBtn" type="button" class="btn btn-danger">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for viewing feedback responses -->
<div class="modal fade" id="feedbackResponsesModal" tabindex="-1" aria-labelledby="feedbackResponsesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackResponsesModalLabel">Feedback Responses</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="feedbackResponsesContainer">
        <!-- Responses will be loaded here -->
      </div>
    </div>
  </div>
</div>

    <!-- Loading Spinner Modal -->
    <div
      class="modal fade"
      id="loadingSpinnerModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 bg-transparent shadow-none">
          <div class="modal-body text-center">
            <div
              class="spinner-border text-white"
              style="width: 4rem; height: 4rem"
              role="status"
            >
              <span class="sr-only"></span>
            </div>
            <div class="mt-3 text-white font-weight-bold">Please wait...</div>
          </div>
        </div>
      </div>
    </div>
  
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <footer class="footer">
          <div class="card">
            <div class="card-body">
              <div class="d-sm-flex justify-content-center justify-content-sm-between">
                <span class="text-muted d-block text-center text-sm-left d-sm-inline-block">Copyright © bootstrapdash.com 2020</span>
                <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"> Free <a href="https://www.bootstrapdash.com/" target="_blank">Bootstrap dashboard templates</a> from Bootstrapdash.com</span>
              </div>
            </div>
          </div>
        </footer>
        <!-- partial -->
      </div>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- container-scroller -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- Custom js for this page-->
    <script src="../../static/Admin/js/file-upload.js"></script>
    <!-- End custom js for this page-->
     <!-- plugin js for this page -->
    <script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>
    <!-- End plugin js for this page -->

<!-- Spinner logic for Bootstrap 5 (add once, for all modals and actions) -->
<script>
function showSpinner() {
  if (!window._spinnerOpen) {
    const modalElement = document.getElementById('loadingSpinnerModal');
    if (!modalElement) return;
    window._spinnerInstance = new bootstrap.Modal(modalElement, {
      backdrop: 'static',
      keyboard: false
    });
    window._spinnerInstance.show();
    window._spinnerOpen = true;
  }
}
function hideSpinner() {
  if (window._spinnerInstance) {
    window._spinnerInstance.hide();
    window._spinnerOpen = false;
  }
}
</script>

<!-- Script for fetching teams and employees (Start) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const token = sessionStorage.getItem("adminToken");

  showSpinner();
  // Fetch employees
  fetch("/get_employees", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    window.employees = data.map(emp => ({
      id: emp.employee_id,
      email: emp.email
    }));
    // Continue only after employees loaded
    return fetch("/get_teams", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
  })
  .then(res => res.json())
  .then(data => {
    window.teams = data.map(team => ({
      id: team.team_id,
      name: team.team_name
    }));
    hideSpinner();
  })
  .catch(err => {
    hideSpinner();
    console.error("Failed to load employees/teams:", err);
  });
});
</script>
<!-- Script for fetching teams and employees (End) -->

<!-- Script for displaying api for announcement, meeting, feedback request, and alert tables (Start) -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
  const token = sessionStorage.getItem('adminToken');

  // --- PAGINATION CONSTANTS & STATE ---
  const ANNOUNCEMENT_PAGE_SIZE = 40;
  let announcementCurrentPage = 1;
  let globalAnnouncements = [];

  const ALERT_PAGE_SIZE = 40;
  let alertCurrentPage = 1;
  let globalAlerts = [];

  const MEETING_PAGE_SIZE = 40;
  let meetingCurrentPage = 1;
  let globalMeetings = [];

  const FEEDBACK_PAGE_SIZE = 40;
  let feedbackCurrentPage = 1;
  let globalFeedbacks = [];

  showSpinner();
  fetch('/notificationsandcommunication_data', {
      headers: {
          'Authorization': 'Bearer ' + token
      }
  })
  .then(res => res.json())
  .then(data => {
      hideSpinner();
      renderAnnouncements(data.announcements || []);
      renderAlerts(data.alerts || []);
      renderMeetings(data.meetings || []);
      renderFeedback(data.feedback_requests || []);
  })
  .catch(err => {
      hideSpinner();
      console.error('Error loading notifications and communications:', err);
  });

  function formatDateToAMPM(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true
      });
  }

  // --- SMART PAGINATION HELPER ---
  function renderSmartPaginationControls(options) {
    const { containerId, currentPage, totalPages, onPageChange } = options;
    let container = document.getElementById(containerId);
    if (!container) {
      container = document.createElement('div');
      container.id = containerId;
      container.className = 'd-flex justify-content-center my-2';
      const tableDiv = document.querySelector('.table-responsive');
      if (tableDiv) {
        tableDiv.parentNode.insertBefore(container, tableDiv.nextSibling);
      } else {
        document.body.appendChild(container);
      }
    }
    container.innerHTML = '';
    if (totalPages <= 1) {
      container.style.display = 'none';
      return;
    } else {
      container.style.display = 'flex';
    }
    const windowSize = 2;
    function createBtn(label, page, disabled = false, active = false) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm mx-1 ' + (active ? 'btn-primary' : 'btn-outline-primary');
      btn.textContent = label;
      btn.disabled = disabled;
      if (!disabled && !active) {
        btn.onclick = function () {
          onPageChange(page);
        };
      }
      return btn;
    }
    // Prev
    container.appendChild(createBtn('Previous', currentPage - 1, currentPage === 1));
    // Always show first page
    container.appendChild(createBtn('1', 1, false, currentPage === 1));
    // Left ellipsis
    if (currentPage - windowSize > 2) {
      const span = document.createElement('span');
      span.className = 'mx-1';
      span.textContent = '...';
      container.appendChild(span);
    }
    // Page window
    for (
      let i = Math.max(2, currentPage - windowSize);
      i <= Math.min(totalPages - 1, currentPage + windowSize);
      i++
    ) {
      container.appendChild(createBtn(i, i, false, currentPage === i));
    }
    // Right ellipsis
    if (currentPage + windowSize < totalPages - 1) {
      const span = document.createElement('span');
      span.className = 'mx-1';
      span.textContent = '...';
      container.appendChild(span);
    }
    // Always show last page
    if (totalPages > 1)
      container.appendChild(createBtn(totalPages, totalPages, false, currentPage === totalPages));
    // Next
    container.appendChild(createBtn('Next', currentPage + 1, currentPage === totalPages));
  }

  // --- PAGINATION CONTROL RENDERERS (use smart pagination) ---
  function renderAnnouncementPaginationControls(totalPages) {
    renderSmartPaginationControls({
      containerId: 'announcement-pagination-controls',
      currentPage: announcementCurrentPage,
      totalPages,
      onPageChange: function (page) {
        announcementCurrentPage = page;
        renderAnnouncements(globalAnnouncements);
      }
    });
  }
  function renderAlertPaginationControls(totalPages) {
    renderSmartPaginationControls({
      containerId: 'alert-pagination-controls',
      currentPage: alertCurrentPage,
      totalPages,
      onPageChange: function (page) {
        alertCurrentPage = page;
        renderAlerts(globalAlerts);
      }
    });
  }
  function renderMeetingPaginationControls(totalPages) {
    renderSmartPaginationControls({
      containerId: 'meeting-pagination-controls',
      currentPage: meetingCurrentPage,
      totalPages,
      onPageChange: function (page) {
        meetingCurrentPage = page;
        renderMeetings(globalMeetings);
      }
    });
  }
  function renderFeedbackPaginationControls(totalPages) {
    renderSmartPaginationControls({
      containerId: 'feedback-pagination-controls',
      currentPage: feedbackCurrentPage,
      totalPages,
      onPageChange: function (page) {
        feedbackCurrentPage = page;
        renderFeedback(globalFeedbacks);
      }
    });
  }

  // --- TABLE RENDERERS WITH PAGINATION ---
  function renderAnnouncements(announcements) {
    const tbody = document.getElementById('announcementTable');
    globalAnnouncements = announcements;
    tbody.innerHTML = '';
    if (!announcements || !Array.isArray(announcements) || announcements.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">No announcements found.</td></tr>';
      renderAnnouncementPaginationControls(0);
      return;
    }
    const totalPages = Math.ceil(announcements.length / ANNOUNCEMENT_PAGE_SIZE);
    if (announcementCurrentPage > totalPages) announcementCurrentPage = totalPages;
    if (announcementCurrentPage < 1) announcementCurrentPage = 1;
    const startIdx = (announcementCurrentPage - 1) * ANNOUNCEMENT_PAGE_SIZE;
    const endIdx = startIdx + ANNOUNCEMENT_PAGE_SIZE;
    const pagedList = announcements.slice(startIdx, endIdx);
    tbody.innerHTML = pagedList.map(a => `
      <tr>
          <td>${a.email || '(Assigned to a team)'}</td>
          <td>${a.team_name || '(Assigned to an employee)'}</td>
          <td>${a.title}</td>
          <td>${a.message}</td>
          <td>${formatDateToAMPM(a.created_at)}</td>
          <td>${a.status}</td>
          <td>
              <input type="hidden" name="csrf_token" value="">
              <button class="btn btn-info" onclick="editRecord('${a.announcement_id}', 'announcement')">Edit</button>
              <button class="btn btn-danger" onclick="deleteRecord('${a.announcement_id}', 'announcement')">Delete</button>
          </td>
      </tr>
    `).join('');
    renderAnnouncementPaginationControls(totalPages);
  }

  function renderAlerts(alerts) {
    const tbody = document.getElementById('alertTable');
    globalAlerts = alerts;
    tbody.innerHTML = '';
    if (!alerts || !Array.isArray(alerts) || alerts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">No alerts found.</td></tr>';
      renderAlertPaginationControls(0);
      return;
    }
    const totalPages = Math.ceil(alerts.length / ALERT_PAGE_SIZE);
    if (alertCurrentPage > totalPages) alertCurrentPage = totalPages;
    if (alertCurrentPage < 1) alertCurrentPage = 1;
    const startIdx = (alertCurrentPage - 1) * ALERT_PAGE_SIZE;
    const endIdx = startIdx + ALERT_PAGE_SIZE;
    const pagedList = alerts.slice(startIdx, endIdx);
    tbody.innerHTML = pagedList.map(a => `
      <tr>
          <td>${a.email || '(Assigned to a team)'}</td>
          <td>${a.team_name || '(Assigned to an employee)'}</td>
          <td>${a.title}</td>
          <td>${a.message}</td>
          <td>${formatDateToAMPM(a.created_at)}</td>
          <td>${a.status}</td>
          <td>
              <input type="hidden" name="csrf_token" value="">
              <button class="btn btn-info" onclick="editRecord('${a.alert_id}', 'alert')">Edit</button>
              <button class="btn btn-danger" onclick="deleteRecord('${a.alert_id}', 'alert')">Delete</button>
          </td>
      </tr>
    `).join('');
    renderAlertPaginationControls(totalPages);
  }

  function renderMeetings(meetings) {
    const tbody = document.getElementById('meetingTable');
    globalMeetings = meetings;
    tbody.innerHTML = '';
    if (!meetings || !Array.isArray(meetings) || meetings.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="text-center">No meetings found.</td></tr>';
      renderMeetingPaginationControls(0);
      return;
    }
    const totalPages = Math.ceil(meetings.length / MEETING_PAGE_SIZE);
    if (meetingCurrentPage > totalPages) meetingCurrentPage = totalPages;
    if (meetingCurrentPage < 1) meetingCurrentPage = 1;
    const startIdx = (meetingCurrentPage - 1) * MEETING_PAGE_SIZE;
    const endIdx = startIdx + MEETING_PAGE_SIZE;
    const pagedList = meetings.slice(startIdx, endIdx);
    tbody.innerHTML = pagedList.map(m => `
      <tr>
          <td>${m.email || '(Assigned to a team)'}</td>
          <td>${m.team_name || '(Assigned to an employee)'}</td>
          <td>${m.title}</td>
          <td>${m.description}</td>
          <td>${m.duration}</td>
          <td>${m.location}</td>
          <td>${formatDateToAMPM(m.meeting_date)}</td>
          <td>${formatDateToAMPM(m.created_at)}</td>
          <td>${m.status}</td>
          <td>
              <input type="hidden" name="csrf_token" value="">
              <button class="btn btn-info" onclick="editRecord('${m.meeting_id}', 'meeting')">Edit</button>
              <button class="btn btn-danger" onclick="deleteRecord('${m.meeting_id}', 'meeting')">Delete</button>
          </td>
      </tr>
    `).join('');
    renderMeetingPaginationControls(totalPages);
  }

  function renderFeedback(feedbacks) {
    const tbody = document.getElementById('feedbackTable');
    globalFeedbacks = feedbacks;
    tbody.innerHTML = '';
    if (!feedbacks || !Array.isArray(feedbacks) || feedbacks.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">No feedback requests found.</td></tr>';
      renderFeedbackPaginationControls(0);
      return;
    }
    const totalPages = Math.ceil(feedbacks.length / FEEDBACK_PAGE_SIZE);
    if (feedbackCurrentPage > totalPages) feedbackCurrentPage = totalPages;
    if (feedbackCurrentPage < 1) feedbackCurrentPage = 1;
    const startIdx = (feedbackCurrentPage - 1) * FEEDBACK_PAGE_SIZE;
    const endIdx = startIdx + FEEDBACK_PAGE_SIZE;
    const pagedList = feedbacks.slice(startIdx, endIdx);
    tbody.innerHTML = pagedList.map(f => `
      <tr>
          <td>${f.email || '(Assigned to a team)'}</td>
          <td>${f.team_name || '(Assigned to an employee)'}</td>
          <td>${f.title}</td>
          <td>${f.message}</td>
          <td>${formatDateToAMPM(f.deadline)}</td>
          <td>${formatDateToAMPM(f.created_at)}</td>
          <td>
              <button class="btn btn-sm btn-primary view-feedback-btn" data-request-id="${f.request_id}">
                  View Responses
              </button>
          </td>
          <td>
              <input type="hidden" name="csrf_token" value="">
              <button class="btn btn-info" onclick="editRecord('${f.request_id}', 'feedback')">Edit</button>
              <button class="btn btn-danger" onclick="deleteRecord('${f.request_id}', 'feedback')">Delete</button>
          </td>
      </tr>
    `).join('');
    renderFeedbackPaginationControls(totalPages);
  }

  document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('view-feedback-btn')) {
          const requestId = e.target.getAttribute('data-request-id');
          const token = sessionStorage.getItem('adminToken');
          const container = document.getElementById('feedbackResponsesContainer');
          container.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

          showSpinner();
          fetch(`/feedback_request_responses/${requestId}`, {
              headers: {
                  'Authorization': 'Bearer ' + token
              }
          })
          .then(res => res.json())
          .then(responses => {
              hideSpinner();
              if (!responses.length) {
                  container.innerHTML = '<div class="text-center text-muted">No responses yet.</div>';
                  return;
              }
              container.innerHTML = `
                  <table class="table table-bordered">
                      <thead>
                          <tr>
                              <th>Employee</th>
                              <th>Response</th>
                              <th>Submitted At</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${responses.map(r => `
                              <tr>
                                  <td>${r.email || r.employee_id}</td>
                                  <td>${r.response}</td>
                                  <td>${r.submitted_at ? formatDateToAMPM(r.submitted_at) : ''}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              `;
          })
          .catch(err => {
              hideSpinner();
              container.innerHTML = '<div class="text-danger">Error loading responses.</div>';
          });

          // Show the modal
          new bootstrap.Modal(document.getElementById('feedbackResponsesModal')).show();
      }
  });

  // Generic filter function for tables
  function setupSearch(inputId, tableBodyId) {
      const input = document.getElementById(inputId);
      input.addEventListener('input', function () {
          const filter = input.value.toLowerCase();
          const rows = document.getElementById(tableBodyId).getElementsByTagName('tr');
          Array.from(rows).forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(filter) ? '' : 'none';
          });
      });
  }

  // Setup search inputs for all tables
  setupSearch('announcementSearch', 'announcementTable');
  setupSearch('alertSearch', 'alertTable');
  setupSearch('meetingSearch', 'meetingTable');
  setupSearch('feedbackSearch', 'feedbackTable');
});
</script>
<!-- Script for displaying api for announcement, meeting, feedback request, and alert tables (End) -->
 
<!-- Script for editing and deleting records of announcement, meeting, feedback request, and alert tables (Start) -->
<script>
let currentEditId = null;
let currentEditType = null;

function getToken() {
  return sessionStorage.getItem("adminToken");
}

function toInputDateFormat(dateString) {
  if (!dateString) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
  if (/^\d{4}-\d{2}-\d{2}\s/.test(dateString)) return dateString.split(' ')[0];
  if (/^\d{4}-\d{2}-\d{2}T/.test(dateString)) return dateString.split('T')[0];
  const d = new Date(dateString);
  if (!isNaN(d.getTime())) {
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const day = d.getDate().toString().padStart(2, '0');
    return `${d.getFullYear()}-${month}-${day}`;
  }
  return '';
}

function editRecord(recordId, recordType) {
  currentEditId = recordId;
  currentEditType = recordType;
  document.getElementById('editTitle').value = '';
  document.getElementById('editDescription').value = '';
  document.getElementById('editDuration').value = '';
  document.getElementById('editLocation').value = '';
  document.getElementById('editMeetingDate').value = '';
  document.getElementById('editDeadline').value = '';
  const messageFieldDiv = document.getElementById('messageField');
  if (recordType === 'meeting') {
    messageFieldDiv.style.display = 'none';
  } else {
    messageFieldDiv.style.display = 'block';
    document.getElementById('editMessage').value = '';
  }
  document.querySelectorAll('.optional-edit-field').forEach(el => el.style.display = 'none');
  if (recordType === "meeting") {
    document.getElementById("meetingFields").style.display = "block";
  } else if (recordType === "feedback") {
    document.getElementById("feedbackFields").style.display = "block";
  }
  showSpinner();
  fetch(`/edit/${recordType}/${recordId}`, {
    method: 'GET',
    headers: {
      "Authorization": `Bearer ${getToken()}`
    }
  })
    .then(res => res.json())
    .then(data => {
      hideSpinner();
      if (data.error) {
        showErrorModal(data.error);
        return;
      }
      if (typeof data.title !== "undefined") document.getElementById('editTitle').value = data.title || '';
      if (typeof data.description !== "undefined") document.getElementById('editDescription').value = data.description || '';
      if (typeof data.duration !== "undefined") document.getElementById('editDuration').value = data.duration || '';
      if (typeof data.location !== "undefined") document.getElementById('editLocation').value = data.location || '';
      if (typeof data.meeting_date !== "undefined" && data.meeting_date) {
        document.getElementById('editMeetingDate').value = toInputDateFormat(data.meeting_date);
      }
      if (typeof data.deadline !== "undefined" && data.deadline) {
        document.getElementById('editDeadline').value = toInputDateFormat(data.deadline);
      }
      if (recordType !== 'meeting' && typeof data.message !== "undefined") {
        document.getElementById('editMessage').value = data.message || '';
      }
      $('#editMeetingModal').modal('show');
    })
    .catch(err => {
      hideSpinner();
      console.error("Edit fetch error:", err);
      showErrorModal("Failed to fetch record details. Please try again.");
    });
}

document.getElementById("editForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const title = document.getElementById('editTitle').value.trim();
  const message = document.getElementById('editMessage').value.trim();
  const description = document.getElementById('editDescription').value.trim();
  const duration = document.getElementById('editDuration').value.trim();
  const location = document.getElementById('editLocation').value.trim();
  const meetingDate = document.getElementById('editMeetingDate').value.trim();
  const deadline = document.getElementById('editDeadline').value.trim();
  const payload = {
    id: currentEditId,
    type: currentEditType,
    title: title || null,
    ...(currentEditType !== 'meeting' && { message: message || null }),
    description: description || null,
    duration: duration || null,
    location: location || null,
    meeting_date: meetingDate || null,
    deadline: deadline || null
  };
  showSpinner();
  fetch("/update_communication_records", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${getToken()}`
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    hideSpinner();
    $('#editMeetingModal').modal('hide');
    if (data.error) {
      showErrorModal(data.error);
    } else {
      showSuccessModal("Record updated successfully!", () => window.location.reload());
    }
  })
  .catch(err => {
    hideSpinner();
    console.error("Edit Error:", err);
    showErrorModal("A network error occurred. Please try again.");
  });
});

let deleteRecordId = null;
let deleteRecordType = null;

function deleteRecord(id, type) {
  deleteRecordId = id;
  deleteRecordType = type;
  $('#confirmDeleteModal').modal('show');
}

document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
  showSpinner();
  fetch(`/delete/${deleteRecordType}/${deleteRecordId}`, {
    method: 'DELETE',
    headers: { "Authorization": `Bearer ${getToken()}` }
  })
  .then(res => res.json())
  .then(data => {
    hideSpinner();
    $('#confirmDeleteModal').modal('hide');
    if (data.error) {
      showErrorModal(data.error);
    } else {
      showSuccessModal(data.message, () => window.location.reload());
    }
  })
  .catch(err => {
    hideSpinner();
    console.error("Delete Error:", err);
    showErrorModal("A network error occurred.");
  });
});

function showSuccessModal(message, callback) {
  document.getElementById("successModalMessage").textContent = message;
  $('#successModal').modal('show');
  $('#successModal').off('hidden.bs.modal').on('hidden.bs.modal', function () {
    if (callback) callback();
  });
}
function showErrorModal(message) {
  document.getElementById("errorModalMessage").textContent = message;
  $('#errorModal').modal('show');
}
</script>
<!-- Script for editing and deleting records of announcement, meeting, feedback request, and alert tables (End) -->
 
<!-- Script for submitting alerts (Start)-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const token = sessionStorage.getItem("adminToken");
});

function updateAlertDropdown() {
  const targetGroup = document.getElementById("alertTarget").value;
  const container = document.getElementById("alertTargetSelectionContainer");
  const dropdown = document.getElementById("alertTargetSelection");
  dropdown.innerHTML = "";

  if (targetGroup === "all") {
    container.style.display = "none";
  } else {
    container.style.display = "block";
    const options = (targetGroup === "employees" ? window.employees : window.teams)
      .map(item => `<option value="${item.id}">${item.email || item.name}</option>`)
      .join("");
    dropdown.innerHTML = options;
  }
}

document.getElementById("alertForm").addEventListener("submit", function (event) {
  event.preventDefault();
  const token = sessionStorage.getItem("adminToken");

  const title = document.getElementById("alertTitle").value;
  const message = document.getElementById("alertMessage").value;
  const alertType = document.getElementById("alertType").value;
  const severityLevel = document.getElementById("severityLevel").value;
  const targetGroup = document.getElementById("alertTarget").value;
  const targetSelection = document.getElementById("alertTargetSelection").value || null;

  const payload = {
    title,
    message,
    alert_type: alertType,
    severity_level: severityLevel,
    target_group: targetGroup
  };

  if (targetGroup === "employees" && targetSelection) {
    payload.employee_id = targetSelection;
  } else if (targetGroup === "teams" && targetSelection) {
    payload.team_id = targetSelection;
  }

  showSpinner();
  fetch("/create_alerts", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(payload),
  })
  .then(res => res.json().then(data => ({ status: res.status, body: data })))
  .then(({ status, body }) => {
    hideSpinner();
    if (status >= 200 && status < 300) {
      document.getElementById("successModalMessage").textContent = body.message || "Alert sent successfully.";
      $('#successModal').modal('show');
      document.getElementById("successModalOkBtn").onclick = () => {
        location.reload();
      };
    } else {
      document.getElementById("errorModalMessage").textContent = body.error || "Failed to send alert.";
      $('#errorModal').modal('show');
    }
  })
  .catch(err => {
    hideSpinner();
    console.error("Alert Error:", err);
    document.getElementById("errorModalMessage").textContent = "An unexpected error occurred.";
    $('#errorModal').modal('show');
  });
});
</script>
<!-- Script for submitting alerts (End)-->

<!-- Script for submitting new feedback request (Start) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const token = sessionStorage.getItem("adminToken");
  fetch("/get_employees", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    window.employees = data.map(emp => ({
      id: emp.employee_id,
      email: emp.email
    }));
  })
  .catch(err => {
    console.error("Failed to load employees:", err);
    window.employees = [];
  });

  fetch("/get_teams", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    window.teams = data.map(team => ({
      id: team.team_id,
      name: team.team_name
    }));
  })
  .catch(err => {
    console.error("Failed to load teams:", err);
    window.teams = [];
  });

  // Restore scroll position if present
  if (localStorage.getItem('scrollPosition')) {
    setTimeout(function() {
      window.scrollTo(0, parseInt(localStorage.getItem('scrollPosition')));
      localStorage.removeItem('scrollPosition');
    }, 100);
  }
});

function updateFeedbackDropdown() {
  const targetGroup = document.getElementById("feedbackTarget").value;
  const container = document.getElementById("feedbackTargetSelectionContainer");
  const dropdown = document.getElementById("feedbackTargetSelection");
  dropdown.innerHTML = "";

  if (targetGroup === "all") {
    container.style.display = "none";
    return;
  }

  container.style.display = "block";
  const dataList = targetGroup === "employees" ? window.employees : window.teams;

  if (!Array.isArray(dataList) || dataList.length === 0) {
    dropdown.innerHTML = `<option disabled>Loading or no data available...</option>`;
    return;
  }

  const options = dataList.map(item => {
    let display;
    if (targetGroup === "employees") {
      display = item.email ? item.email : `Employee ID: ${item.id}`;
    } else {
      display = item.name;
    }
    return `<option value="${item.id}">${display}</option>`;
  }).join("");

  dropdown.innerHTML = options;
}

/**
 * Modal callback-based helper (compatible with onOk pattern)
 */
function showSuccessModal(message, onOk) {
  document.getElementById("successModalMessage").textContent = message;
  $('#successModal').modal('show');
  const okBtn = document.getElementById("successModalOkBtn");

  // Clean up previous listeners
  const newBtn = okBtn.cloneNode(true);
  okBtn.parentNode.replaceChild(newBtn, okBtn);

  newBtn.addEventListener("click", function () {
    $('#successModal').modal('hide');
    if (typeof onOk === "function") onOk();
  });
}

function showErrorModal(message) {
  document.getElementById("errorModalMessage").textContent = message;
  $('#errorModal').modal('show');
}

document.getElementById("feedbackForm").addEventListener("submit", function (event) {
  event.preventDefault();
  const token = sessionStorage.getItem("adminToken");

  const title = document.getElementById("feedbackTitle").value;
  const content = document.getElementById("feedbackMessage").value;
  const deadline = document.getElementById("feedbackDeadline").value;
  const targetGroup = document.getElementById("feedbackTarget").value;

  let targetId = null;
  if (targetGroup !== "all") {
    targetId = document.getElementById("feedbackTargetSelection").value;
  }

  const payload = {
    title: title,
    content: content,
    deadline: deadline,
    target_group: targetGroup,
    target_id: targetId
  };

  showSpinner();
  fetch("/create_feedback", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(payload),
  })
  .then(async res => {
    const data = await res.json();
    hideSpinner();
    if (res.ok) {
      // Pass a callback to showSuccessModal that will reload with scroll preservation
      showSuccessModal(data.message || "Feedback submitted successfully.", function() {
        document.getElementById("feedbackForm").reset();
        document.getElementById("feedbackTargetSelectionContainer").style.display = "none";
        // On modal close, store scroll and reload
        localStorage.setItem('scrollPosition', window.scrollY || document.documentElement.scrollTop);
        window.location.reload();
      });
    } else {
      showErrorModal(data.error || "Failed to submit feedback.");
    }
  })
  .catch(err => {
    hideSpinner();
    console.error("Feedback Error:", err);
    showErrorModal("A network error occurred. Please try again.");
  });
});
</script>
<!-- Script for submitting new feedback request (End) -->

<!-- Script for submitting a new announcement (Start) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const token = sessionStorage.getItem("adminToken");
  fetch("/get_employees", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    window.employees = data.map(emp => ({
      id: emp.employee_id,
      email: emp.email,
    }));
  })
  .catch(err => {
    console.error("Failed to load employees:", err);
    window.employees = [];
  });

  fetch("/get_teams", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    window.teams = data.map(team => ({
      id: team.team_id,
      name: team.team_name
    }));
  })
  .catch(err => {
    console.error("Failed to load teams:", err);
    window.teams = [];
  });
});

function updateAnnouncementDropdown() {
  const targetGroup = document.getElementById("announcementTarget").value;
  const container = document.getElementById("targetSelectionContainer");
  const dropdown = document.getElementById("announcementSelection");
  dropdown.innerHTML = "";

  if (targetGroup === "all") {
    container.style.display = "none";
    return;
  }

  container.style.display = "block";
  const dataList = targetGroup === "employees" ? window.employees : window.teams;

  if (!Array.isArray(dataList) || dataList.length === 0) {
    dropdown.innerHTML = `<option disabled>Loading or no data available...</option>`;
    return;
  }

  const options = dataList.map(item => {
    let display;
    if (targetGroup === "employees") {
      display = item.email ? item.email : `Employee ID: ${item.id}`;
    } else {
      display = item.name;
    }
    return `<option value="${item.id}">${display}</option>`;
  }).join("");

  dropdown.innerHTML = options;
}

function showSuccessModal(message) {
  document.getElementById("successModalMessage").textContent = message;
  $('#successModal').modal('show');
}

function showErrorModal(message) {
  document.getElementById("errorModalMessage").textContent = message;
  $('#errorModal').modal('show');
}

document.getElementById("announcementForm").addEventListener("submit", function (event) {
  event.preventDefault();
  const token = sessionStorage.getItem("adminToken");

  const title = document.getElementById("announcementTitle").value;
  const message = document.getElementById("announcementMessage").value;
  const targetGroup = document.getElementById("announcementTarget").value;

  let targetId = null;
  if (targetGroup !== "all") {
    targetId = document.getElementById("announcementSelection").value;
  }

  const payload = {
    title: title,
    message: message,
    target_group: targetGroup,
    target_id: targetId
  };

  showSpinner();
  fetch("/create_announcement", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(payload),
  })
  .then(async res => {
    const data = await res.json();
    hideSpinner();
    if (res.ok) {
      showSuccessModal(data.message || "Announcement created successfully.");
      document.getElementById("announcementForm").reset();
      document.getElementById("targetSelectionContainer").style.display = "none";
    } else {
      showErrorModal(data.error || "Failed to create announcement.");
    }
  })
  .catch(err => {
    hideSpinner();
    console.error("Announcement Error:", err);
    showErrorModal("A network error occurred. Please try again.");
  });
});
</script>
<!-- Script for submitting a new announcement (End) -->

<!-- Script for submitting a new meeting (Start) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const token = sessionStorage.getItem("adminToken");
  showSpinner();
  // Fetch employees
  fetch("/get_employees", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    window.employees = data.map(emp => ({
      id: emp.employee_id,
      email: emp.email
    }));
    // Fetch teams only after employees are loaded
    return fetch("/get_teams", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
  })
  .then(res => res.json())
  .then(data => {
    window.teams = data.map(team => ({
      id: team.team_id,
      name: team.team_name
    }));
    hideSpinner();
  })
  .catch(err => {
    hideSpinner();
    console.error("Failed to load employees/teams:", err);
    window.employees = [];
    window.teams = [];
  });

  // Restore scroll position if present
  if (localStorage.getItem('scrollPosition')) {
    setTimeout(function() {
      window.scrollTo(0, parseInt(localStorage.getItem('scrollPosition')));
      localStorage.removeItem('scrollPosition');
    }, 100);
  }
});

// Populate dropdown based on selection
function updateMeetingDropdown() {
  const targetGroup = document.getElementById("meetingTarget").value;
  const container = document.getElementById("meetingTargetSelectionContainer");
  const dropdown = document.getElementById("meetingTargetSelection");
  dropdown.innerHTML = "";

  if (targetGroup === "all") {
    container.style.display = "none";
    return;
  }

  container.style.display = "block";
  const dataList = targetGroup === "employees" ? window.employees : window.teams;

  if (!Array.isArray(dataList) || dataList.length === 0) {
    dropdown.innerHTML = `<option disabled>Loading or no data available...</option>`;
    return;
  }

  const options = dataList.map(item => {
    let display;
    if (targetGroup === "employees") {
      display = item.email ? item.email : `Employee ID: ${item.id}`;
    } else {
      display = item.name;
    }
    return `<option value="${item.id}">${display}</option>`;
  }).join("");

  dropdown.innerHTML = options;
}

// Submit Meeting Form
document.getElementById("meetingForm").addEventListener("submit", function (event) {
  event.preventDefault();
  const token = sessionStorage.getItem("adminToken");

  // Form values
  const meetingDate = document.getElementById("meetingDate").value;
  const meetingTime = document.getElementById("meetingTime").value;
  const title = document.getElementById("meetingTitle").value;
  const duration = document.getElementById("meetingDuration").value;
  const location = document.getElementById("meetingLocation").value;
  const description = document.getElementById("meetingDescription").value;
  const targetGroup = document.getElementById("meetingTarget").value;
  let targetId = null;

  if (!meetingDate || !meetingTime) {
    showErrorModal("Please specify both meeting date and time.");
    return;
  }

  if (targetGroup !== "all") {
    targetId = document.getElementById("meetingTargetSelection").value;
    if (!targetId) {
      showErrorModal(`Please select a specific ${targetGroup === "employees" ? "employee" : "team"}.`);
      return;
    }
  }

  const payload = {
    title,
    description,
    meeting_date: `${meetingDate} ${meetingTime}`,
    duration,
    location,
    target_group: targetGroup,
    target_id: targetId
  };

  showSpinner();
  fetch("/create_meetings", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(payload)
  })
  .then(async res => {
    const data = await res.json();
    hideSpinner();
    if (res.ok) {
      // Register scroll-preserving reload on modal close
      showSuccessModal(data.message || "Meeting scheduled successfully.", function () {
        document.getElementById("meetingForm").reset();
        document.getElementById("meetingTargetSelectionContainer").style.display = 'none';
        // Register reload after modal closes
        $('#successModal').off('hidden.bs.modal').on('hidden.bs.modal', function() {
          localStorage.setItem('scrollPosition', window.scrollY || document.documentElement.scrollTop);
          window.location.reload();
        });
      });
    } else {
      showErrorModal(data.error || "Failed to schedule meeting.");
    }
  })
  .catch(err => {
    hideSpinner();
    console.error("Meeting Error:", err);
    showErrorModal("A network error occurred. Please try again.");
  });
});

// Bootstrap 4 Modal Helpers
function showSuccessModal(message, onOk) {
  document.getElementById("successModalMessage").textContent = message;
  $('#successModal').modal('show');
  const okBtn = document.getElementById("successModalOkBtn");

  // Clean up previous listeners
  const newBtn = okBtn.cloneNode(true);
  okBtn.parentNode.replaceChild(newBtn, okBtn);

  newBtn.addEventListener("click", function () {
    $('#successModal').modal('hide');
    if (onOk) onOk();
  });
}

function showErrorModal(message) {
  document.getElementById("errorModalMessage").textContent = message;
  $('#errorModal').modal('show');
}
</script>
<!-- Script for submitting a new meeting (End) -->

<!-- Script for logging out (Start) -->
<script>
document.querySelector(".logout-btn").addEventListener("click", function () {
  $("#logoutModal").modal("show");
});

document.getElementById("confirmLogout").addEventListener("click", function () {
  showSpinner();
  setTimeout(function() {
    sessionStorage.removeItem("adminToken");
    window.location.href = "/admin_login";
  }, 600);
});

document.getElementById("cancelLogout").addEventListener("click", function () {
  $("#logoutModal").modal("hide");
});

document.getElementById("closeLogoutModal").addEventListener("click", function () {
  $("#logoutModal").modal("hide");
});
</script>
<!-- Script for logging out (End) -->

<!-- Script that redirects admin back to login page if the token doesn't exist (Start) -->
<script>
const token = sessionStorage.getItem("adminToken");
if (!token) {
  showSpinner && showSpinner();
  setTimeout(function() {
    alert("Not authenticated. Redirecting to login.");
    window.location.href = "/admin_login";
  }, 600);
}
</script>
<!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

<!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start) -->
<script>
function getToken() {
  return sessionStorage.getItem("adminToken");
}

function checkSessionConflict() {
  const token = getToken();
  if (!token) return;

  fetch("/check_jti", {
    method: "GET",
    headers: {
      Authorization: "Bearer " + token,
    },
  })
    .then((response) => {
      if (response.status === 403) {
        throw new Error("session_conflict");
      }
      return response.json();
    })
    .then((data) => {
      if (data.error === "session_conflict") {
        throw new Error("session_conflict");
      }
    })
    .catch((err) => {
      if (err.message === "session_conflict") {
        const modal = new bootstrap.Modal(
          document.getElementById("sessionConflictModal"),
          {
            backdrop: "static",
            keyboard: false,
          }
        );
        modal.show();
        const logoutBtn = document.getElementById("confirmLogoutBetweenTabs");
        if (!logoutBtn.dataset.bound) {
          logoutBtn.addEventListener("click", () => {
            showSpinner();
            setTimeout(function() {
              sessionStorage.removeItem("adminToken");
              window.location.href = "/admin_login";
            }, 600);
          });
          logoutBtn.dataset.bound = "true";
        }
      }
    });
}

checkSessionConflict();
setInterval(checkSessionConflict, 30000);
</script>
<!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

<!-- Script for checking admin if they have access to this page (Start) -->
<script>
const accessDenied = {{ 'true' if access_denied else 'false' }};
if (accessDenied) {
  const accessModal = new bootstrap.Modal(document.getElementById("accessDeniedModal"));
  accessModal.show();
  document.getElementById("forceLogoutBtn").addEventListener("click", function () {
    showSpinner();
    setTimeout(function() {
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    }, 600);
  });
}
</script>
<!-- Script for checking admin if they have access to this page (End) -->

  </body>
</html>
