<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}">

  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
                    <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
      
        <div class="main-panel">
          
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <form class="forms-sample">
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#holidayModal">Add Holiday</button>
                                <h4 class="card-title" style="margin-top: 10px;">Holidays details</h4>
                                <input type="text" id="holidaySearch" class="form-control mb-3" placeholder="Search holidays..." style="border: 1px solid #aaa; color: #222;">
                                <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                              <table class="table table-striped">
                                  <thead>
                                      <tr>
                                          <th>Name</th>
                                          <th>Status</th>
                                          <th>Actions</th>
                                      </tr>
                                  </thead>
                                  <tbody id="holidayTableBody">
                                      <!-- Data will be inserted here dynamically -->
                                  </tbody>
                              </table>
                          </div>
                          <div id="holidayPagination" class="my-2"></div>
                        </div>
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#leaveRequestModal">Create Leave Balance</button>
                        <h4 class="card-title" style="margin-top: 10px;">Employee's leave balance</h4>
                        
        <input
            type="text"
            class="form-control mb-3"
            id="leaveBalancesSearch"
            placeholder="Search by employee name, email, or leave type..."
            style="border: 1px solid #aaa; color: #222;"
        />
                        <div class="card-body">

    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Email</th>
                    <th>Sick Leave</th>
                    <th>Vacation Leave</th>
                    <th>Personal Leave</th>
                    <th>Unpaid Leave</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="leaveBalancesTableBody">
                <!-- Data will be inserted here dynamically -->
            </tbody>
        </table>
    </div>
    <div id="leaveBalancesPagination" class="my-2"></div>
</div>
                        <h4 class="card-title" style="margin-top: 10px;">Leave request details</h4>
                            <input
      type="text"
      class="form-control mb-3"
      id="leaveRequestSearch"
      placeholder="Search leave requests..."
      style=" border: 1px solid #aaa; color: #222;"
    />
                          <div class="card-body">
  <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Leave type</th>
          <th>Requested by</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="leaveRequestTableBody">
        <!-- Data will be inserted here dynamically -->
      </tbody>
    </table>
  </div>
  <div id="leaveRequestsPagination" class="my-2"></div>
</div>
                        </form>
                            <div class="form-group">
                           
                              <button onclick="createBackup()" type="button" class="btn btn-primary">Create backup</button>
                          </div>
                          <div class="mb-3">
  <input type="date" class="form-control" id="backupDateFilter" placeholder="Filter by date" style=" border: 1px solid #aaa; color: #222;"/>
</div>
                          <h3>Available Backups</h3>
                          <ul id="backup-list"></ul>
                          <div id="backupPagination" class="my-2"></div>
                    </div>
                </div>
            </div>
            

            </div>

    
          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <footer class="footer">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                    >Copyright © bootstrapdash.com 2020</span
                  >
                  <span
                    class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                  >
                    Free
                    <a href="https://www.bootstrapdash.com/" target="_blank"
                      >Bootstrap dashboard templates</a
                    >
                    from Bootstrapdash.com</span
                  >
                </div>
              </div>
            </div>
          </footer>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

<!-- Employee Details Modal (Bootstrap 4) -->
<div class="modal fade" id="employeeDetailsModal" tabindex="-1" role="dialog" aria-labelledby="employeeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeDetailsModalLabel">Employee Leave Balance Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="employeeDetailsContent">
                    <!-- Employee details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Remove Balance Modal (Bootstrap 4) -->
<div class="modal fade" id="removeBalanceModal" tabindex="-1" role="dialog" aria-labelledby="removeBalanceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeBalanceModalLabel">Remove Leave Balance</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="removeBalanceForm">
                    <input type="hidden" id="removeEmployeeId" name="employee_id">
                    <div class="mb-3">
                        <label class="form-label">Employee: <span id="removeEmployeeName" class="font-weight-bold"></span></label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="removeSickLeave" class="form-label">Sick Leave</label>
                                <input type="number" class="form-control" id="removeSickLeave" name="sick_leave" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="removeVacationLeave" class="form-label">Vacation Leave</label>
                                <input type="number" class="form-control" id="removeVacationLeave" name="vacation_leave" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="removePersonalLeave" class="form-label">Personal Leave</label>
                                <input type="number" class="form-control" id="removePersonalLeave" name="personal_leave" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="removeUnpaidLeave" class="form-label">Unpaid Leave</label>
                                <input type="number" class="form-control" id="removeUnpaidLeave" name="unpaid_leave" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitRemoveBalance()">Remove Balance</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Balance Modal (Bootstrap 4) -->
<div class="modal fade" id="editBalanceModal" tabindex="-1" role="dialog" aria-labelledby="editBalanceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBalanceModalLabel">Edit Leave Balance</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editBalanceForm">
                    <input type="hidden" id="editEmployeeId" name="employee_id">
                    <div class="mb-3">
                        <label class="form-label">Employee: <span id="editEmployeeName" class="font-weight-bold"></span></label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSickLeave" class="form-label">Sick Leave</label>
                                <input type="number" class="form-control" id="editSickLeave" name="sick_leave" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editVacationLeave" class="form-label">Vacation Leave</label>
                                <input type="number" class="form-control" id="editVacationLeave" name="vacation_leave" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPersonalLeave" class="form-label">Personal Leave</label>
                                <input type="number" class="form-control" id="editPersonalLeave" name="personal_leave" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editUnpaidLeave" class="form-label">Unpaid Leave</label>
                                <input type="number" class="form-control" id="editUnpaidLeave" name="unpaid_leave" min="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitEditBalance()">Update Balance</button>
            </div>
        </div>
    </div>
</div>


<!-- Logout Confirmation Modal (Bootstrap 4) -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelLogout">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmLogout">Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="successModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="successModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Success</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="successModalMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-success"
          data-dismiss="modal"
          id="successModalOkBtn"
        >
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="errorModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="errorModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="errorModalMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">
          Dismiss
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Leave Request Modal (Bootstrap 4) -->
<div class="modal fade" id="leaveRequestModal" tabindex="-1" role="dialog" aria-labelledby="leaveRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="leaveRequestModalLabel">Submit Leave Balance</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <form id="leaveRequestForm">
                  <label>Employee:</label>
                  <select id="members" name="employee_id" class="form-control" required>
                      <option value="">Loading employees...</option>
                  </select>

                  <!-- Other form fields -->
                  <label>Leave Type:</label>
                  <select id="leaveType" class="form-control">
                      <option value="sick_leave">Sick Leave</option>
                      <option value="vacation_leave">Vacation Leave</option>
                      <option value="personal_leave">Personal Leave</option>
                      <option value="unpaid_leave">Unpaid Leave</option>
                  </select>
                  
                  <label>Amount of days :</label>
                  <input type="number" id="leaveAmount" class="form-control">
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="submitLeaveRequest()">Submit</button>
          </div>
      </div>
  </div>
</div>

<!-- Add Holiday Modal (Bootstrap 4) -->
<div class="modal fade" id="holidayModal" tabindex="-1" role="dialog" aria-labelledby="holidayModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="holidayModalLabel">Add Holiday</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <form id="holidayForm">
                  <label>Holiday Name:</label>
                  <input type="text" id="holidayName" class="form-control">

                  <label>Holiday Date:</label>
                  <input type="date" id="holidayDate" class="form-control">

                  <label>Apply to:</label>
                  <select id="applyTo" class="form-control" onchange="toggleSelectionList()">
                      <option value="" disabled>-- Select an option -- </option>
                      <option value="teams">Teams</option>
                      <option value="employees">Employees</option>
                      <option value="both">Both</option>
                  </select>

                  <label>Select:</label>
                  <select id="selectionList" class="form-control" multiple>
                      {% for team in teams %}
                          <option value="{{ team[0] }}">{{ team[1] }}</option>
                      {% endfor %}
                  </select>
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="submitHoliday()">Submit</button>
          </div>
      </div>
  </div>
</div>

<!-- View Leave Request Modal (Bootstrap 4) -->
<div class="modal fade" id="viewLeaveRequestModal" tabindex="-1" role="dialog" aria-labelledby="viewLeaveRequestLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewLeaveRequestLabel">Leave Request Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="leaveRequestDetails">
        <!-- Data will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- Edit Leave Request Modal (Bootstrap 4) -->
<div class="modal fade" id="editLeaveRequestModal" tabindex="-1" role="dialog" aria-labelledby="editLeaveRequestLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editLeaveRequestLabel">Edit Leave Request</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editLeaveRequestForm">
          <input type="hidden" id="editRequestId">
          <div class="form-group">
            <label for="editLeaveType">Leave Type</label>
            <select class="form-control" id="editLeaveType">
              <option value="sick_leave">Sick leave</option>
              <option value="vacation_leave">Vacation leave</option>
              <option value="personal_leave">Personal leave</option>
              <option value="unpaid_leave">Unpaid leave</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editStartDate">Start Date</label>
            <input type="date" class="form-control" id="editStartDate" required>
          </div>
          <div class="form-group">
            <label for="editEndDate">End Date</label>
            <input type="date" class="form-control" id="editEndDate" required>
          </div>
          <div class="form-group">
            <label for="editStatus">Status</label>
            <select class="form-control" id="editStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editRemarks">Remarks</label>
            <textarea class="form-control" id="editRemarks"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Leave Request Modal (Bootstrap 4) -->
<div class="modal fade" id="deleteLeaveRequestModal" tabindex="-1" role="dialog" aria-labelledby="deleteLeaveRequestLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteLeaveRequestLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this leave request?</p>
        <input type="hidden" id="deleteRequestId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteLeaveRequest">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- View Holiday Modal (Bootstrap 4) -->
<div class="modal fade" id="viewHolidayModal" tabindex="-1" role="dialog" aria-labelledby="viewHolidayLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewHolidayLabel">Holiday Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="holidayDetails"></div>
    </div>
  </div>
</div>

<!-- Edit Holiday Modal (Bootstrap 4) -->
<div class="modal fade" id="editHolidayModal" tabindex="-1" role="dialog" aria-labelledby="editHolidayLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editHolidayLabel">Edit Holiday</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editHolidayForm">
          <input type="hidden" id="editHolidayId">

          <div class="form-group">
            <label for="editHolidayName">Holiday Name</label>
            <input type="text" class="form-control" id="editHolidayName" required>
          </div>

          <div class="form-group">
            <label for="editHolidayDate">Date</label>
            <input type="date" class="form-control" id="editHolidayDate" required>
          </div>

          <div class="form-group">
            <label for="editSelectionType">Assign To</label>
            <select class="form-control" id="editSelectionType" onchange="toggleAssignmentType()">
              <option value="">-- Select --</option>
              <option value="team">Team</option>
              <option value="employee">Employee</option>
              <option value="both">Both</option>
            </select>
          </div>

          <div class="form-group" id="teamSelection" style="display: none;">
            <label for="editTeams">Select Teams</label>
            <select multiple class="form-control" id="editTeams"></select>
          </div>

          <div class="form-group" id="employeeSelection" style="display: none;">
            <label for="editEmployees">Select Employees</label>
            <select multiple class="form-control" id="editEmployees"></select>
          </div>

          <div class="form-group">
            <label for="editIsPaid">Payment Status</label>
            <select class="form-control" id="editIsPaid">
              <option value="true">Paid</option>
              <option value="false">Not Yet Paid</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Holiday Modal (Bootstrap 4) -->
<div class="modal fade" id="deleteHolidayModal" tabindex="-1" role="dialog" aria-labelledby="deleteHolidayLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteHolidayLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this holiday?</p>
        <input type="hidden" id="deleteHolidayId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteHoliday">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Backup Delete Modal (Bootstrap 4) -->
<div class="modal fade" id="confirmBackupDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmBackupDeleteLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmBackupDeleteLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirmBackupDeleteText">Are you sure you want to delete this backup?</p>
        <input type="hidden" id="backupToDelete">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBackupBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for restoring database confirmation (Bootstrap 4) -->
<div class="modal fade" id="confirmRestoreModal" tabindex="-1" role="dialog" aria-labelledby="confirmRestoreModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmRestoreModalLabel">Confirm Restore</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Warning:</strong> This action will overwrite your current database!
        </div>
        <p id="confirmRestoreText">Are you sure you want to restore from this backup?</p>
        <input type="hidden" id="backupToRestore">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmRestoreBtn">Restore</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for displaying successful backup (Bootstrap 4) -->
<div class="modal fade" id="backupResultModal" tabindex="-1" role="dialog" aria-labelledby="backupResultModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="backupResultModalLabel">Backup Operation Result</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="backupResultMessage" class="alert">Operation completed.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Session Conflict Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="sessionConflictModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="sessionConflictLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="sessionConflictLabel">Session Conflict</h5>
      </div>
      <div class="modal-body">
        <p>
          <strong>
            Someone has logged into your account from another tab or device.
          </strong>
        </p>
        <p>You will be logged out for security reasons.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal (Bootstrap 4) -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeLogoutModal">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelLogout">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmLogout">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Access Denied Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="accessDeniedModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="accessDeniedLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
      </div>
      <div class="modal-body">
        <p>Only Super Admins are allowed to access this page.</p>
      </div>
      <div class="modal-footer">
        <button id="redirectBtn" type="button" class="btn btn-danger">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="loadingSpinnerModal"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0 bg-transparent shadow-none">
      <div class="modal-body text-center">
        <div
          class="spinner-border text-white"
          style="width: 4rem; height: 4rem"
          role="status"
        >
          <span class="sr-only"></span>
        </div>
        <div class="mt-3 text-white font-weight-bold">Please wait...</div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery first! -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 4 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
<!-- All your other plugin imports -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
<script src="../../static/Admin/js/off-canvas.js"></script>
<script src="../../static/Admin/js/hoverable-collapse.js"></script>
<script src="../../static/Admin/js/template.js"></script>
<script src="../../static/Admin/js/file-upload.js"></script>
<script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>

    <!-- Script for spinner logic and displaying success and error (Start) -->
    <script>
      window.ModalUtils = (function () {
        let spinnerVisible = false;

        function showSpinner() {
          if (spinnerVisible) return;
          spinnerVisible = true;
          $("#loadingSpinnerModal").modal({
            backdrop: "static",
            keyboard: false,
            show: true,
          });
        }

        function hideSpinner() {
          spinnerVisible = false;
          $("#loadingSpinnerModal").modal("hide");
        }

        function showSuccess(message, onClose) {
          $("#successModalMessage").html(message);
          $("#successModal").modal("show");
          $("#successModal").off("hidden.bs.modal");
          if (typeof onClose === "function") {
            const handler = function () {
              $("#successModal").off("hidden.bs.modal", handler);
              onClose();
            };
            $("#successModal").on("hidden.bs.modal", handler);
          }
        }

        function showerror(message, onClose) {
          $("#errorModalMessage").html(message);
          $("#errorModal").modal("show");
          $("#errorModal").off("hidden.bs.modal");
          if (typeof onClose === "function") {
            const handler = function () {
              $("#errorModal").off("hidden.bs.modal", handler);
              onClose();
            };
            $("#errorModal").on("hidden.bs.modal", handler);
          }
        }

        function hideSuccess() {
          $("#successModal").modal("hide");
        }
        function hideError() {
          $("#errorModal").modal("hide");
        }

        return {
          showSpinner,
          hideSpinner,
          showSuccess,
          showerror,
          hideSuccess,
          hideError,
        };
      })();
    </script>
    <!-- Script for spinner logic and displaying success and error (End) -->

<!-- Script for handling balance table (Start) -->
<script>
  // Global variables
let leaveBalancesData = [];
let filteredLeaveBalancesData = [];
let currentPage = 1;
const pageSize = 40; // Number of rows per page
const authToken = sessionStorage.getItem('adminToken');

// Use ModalUtils from global script for spinner, success, and error modals
$(document).ready(function () {
    console.log('Document ready. Loading leave balances...');
    loadLeaveBalances();
    $('#leaveBalancesSearch').on('input', filterLeaveBalancesTable);
});

// Utility: Show error modal only after all requested modals are closed
function showErrorAfterModalsClose(modalIds, message) {
    if (!Array.isArray(modalIds)) modalIds = [modalIds];
    let toClose = modalIds.filter(id => {
        const el = $('#' + id);
        return el.length && el.hasClass('show');
    });

    if (toClose.length === 0) {
        ModalUtils.showError(message);
        return;
    }

    // Close all, and when last is hidden, show the error modal
    let closed = 0;
    toClose.forEach((id, idx) => {
        const el = $('#' + id);
        function handler() {
            el.off('hidden.bs.modal', handler);
            closed++;
            if (closed === toClose.length) {
                ModalUtils.showError(message);
            }
        }
        el.on('hidden.bs.modal', handler);
        el.modal('hide');
    });
}

// Load leave balances data
async function loadLeaveBalances() {
    ModalUtils.showSpinner();
    console.log('Fetching /api/leave-balances...');
    try {
        const response = await fetch('/api/leave-balances', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('Fetch response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        leaveBalancesData = await response.json();
        console.log('Raw leaveBalancesData:', leaveBalancesData);

        filteredLeaveBalancesData = leaveBalancesData;
        currentPage = 1;

        console.log('Calling gotoPage with page:', currentPage);
        gotoLeaveBalancesPage(currentPage);

    } catch (error) {
        console.error('Error loading leave balances:', error);
        showErrorAfterModalsClose(['employeeDetailsModal', 'editBalanceModal', 'removeBalanceModal', 'holidayModal'], 'Failed to load leave balances');
    } finally {
        ModalUtils.hideSpinner()
    }
}

// Display leave balances in table (paginated)
function displayLeaveBalances(data) {
    console.log('Rendering leave balances table with data:', data);

    const tbody = document.getElementById('leaveBalancesTableBody');
    if (!tbody) {
        console.error('Could not find table body with id leaveBalancesTableBody!');
        return;
    }
    console.log('Found tbody:', tbody);

    tbody.innerHTML = '';

    if (!Array.isArray(data)) {
        console.error('Data passed to displayLeaveBalances is not an array:', data);
        return;
    }

    if (data.length === 0) {
        console.warn('No leave balances to display.');
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" class="text-center">No leave balances found.</td>';
        tbody.appendChild(row);
        return;
    }

    data.forEach((balance, idx) => {
        console.log(`Rendering balance #${idx}:`, balance);
        // Log all expected fields for this row
        console.log(
            'employee_name:', balance.employee_name,
            '| employee_email:', balance.employee_email,
            '| sick_leave:', balance.sick_leave,
            '| vacation_leave:', balance.vacation_leave,
            '| personal_leave:', balance.personal_leave,
            '| unpaid_leave:', balance.unpaid_leave
        );

        // Show "N/A" if any field is missing or undefined
        const sickLeave = (balance.sick_leave !== undefined && balance.sick_leave !== null) ? balance.sick_leave : 'N/A';
        const vacationLeave = (balance.vacation_leave !== undefined && balance.vacation_leave !== null) ? balance.vacation_leave : 'N/A';
        const personalLeave = (balance.personal_leave !== undefined && balance.personal_leave !== null) ? balance.personal_leave : 'N/A';
        const unpaidLeave = (balance.unpaid_leave !== undefined && balance.unpaid_leave !== null) ? balance.unpaid_leave : 'N/A';
        const employeeName = balance.employee_name || 'N/A';
        const employeeEmail = balance.employee_email || 'N/A';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employeeName}</td>
            <td>${employeeEmail}</td>
            <td><span class="badge badge-info">${sickLeave}</span></td>
            <td><span class="badge badge-success">${vacationLeave}</span></td>
            <td><span class="badge badge-warning">${personalLeave}</span></td>
            <td><span class="badge badge-secondary">${unpaidLeave}</span></td>
            <td>
                <button type="button" class="btn btn-info btn-sm" onclick="viewEmployeeDetails(${balance.employee_id})" title="View Details">
                    View
                </button>
                <button type="button" class="btn btn-warning btn-sm" onclick="openEditBalanceModal(${balance.employee_id}, '${employeeName}', ${JSON.stringify(balance).replace(/"/g, '&quot;')})" title="Edit Balance">
                    Edit
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    console.log('Finished rendering leave balances table.');
}

// Smart pagination rendering
function renderBalancePagination(totalItems, currentPage, pageSize) {
    const paginationWrapper = document.getElementById("leaveBalancesPagination");
    if (!paginationWrapper) return;
    paginationWrapper.innerHTML = '';

    const totalPages = Math.ceil(totalItems / pageSize);
    console.log('Rendering pagination. totalItems:', totalItems, 'currentPage:', currentPage, 'pageSize:', pageSize, 'totalPages:', totalPages);

    if (totalPages <= 1) return;

    // Helper to create page button
    const createPageBtn = (page, label = null, isActive = false, isDisabled = false) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
      btn.textContent = label || page;
      btn.disabled = isDisabled;
      // FIX HERE:
      btn.addEventListener('click', () => gotoLeaveBalancesPage(page));
      return btn;
    };

    // Prev
    paginationWrapper.appendChild(createPageBtn(currentPage - 1, 'Prev', false, currentPage === 1));

    // Pages
    if (totalPages <= 7) {
      for (let page = 1; page <= totalPages; page++) {
        paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
      }
    } else {
      paginationWrapper.appendChild(createPageBtn(1, null, 1 === currentPage));
      if (currentPage > 4) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.className = 'mx-1';
        paginationWrapper.appendChild(dots);
      }
      let start = Math.max(2, currentPage - 1);
      let end = Math.min(totalPages - 1, currentPage + 1);
      for (let page = start; page <= end; page++) {
        paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
      }
      if (currentPage < totalPages - 3) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.className = 'mx-1';
        paginationWrapper.appendChild(dots);
      }
      paginationWrapper.appendChild(createPageBtn(totalPages, null, totalPages === currentPage));
    }
    // Next
    paginationWrapper.appendChild(createPageBtn(currentPage + 1, 'Next', false, currentPage === totalPages));
}

// Goto page and update table
function gotoLeaveBalancesPage(page) {
    const totalPages = Math.ceil(filteredLeaveBalancesData.length / pageSize);
    console.log('gotoLeaveBalancesPage called. filteredLeaveBalancesData.length:', filteredLeaveBalancesData.length, 'totalPages:', totalPages, 'requestedPage:', page);

    // Always render the table and pagination, even if no results
    if (page < 1) page = 1;
    if (totalPages && page > totalPages) page = totalPages;
    currentPage = page;
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageData = filteredLeaveBalancesData.slice(startIdx, endIdx);
    console.log('Page data:', pageData);
    displayLeaveBalances(pageData);
    renderBalancePagination(filteredLeaveBalancesData.length, currentPage, pageSize);
}

// Filter leave balances table based on search input
function filterLeaveBalancesTable() {
    const keyword = $('#leaveBalancesSearch').val().toLowerCase();
    console.log('Filtering leave balances table with keyword:', keyword);

    filteredLeaveBalancesData = leaveBalancesData.filter(balance => {
        return (
            (balance.employee_name && balance.employee_name.toLowerCase().includes(keyword)) ||
            (balance.employee_email && balance.employee_email.toLowerCase().includes(keyword)) ||
            (balance.sick_leave !== undefined && balance.sick_leave.toString().toLowerCase().includes(keyword)) ||
            (balance.vacation_leave !== undefined && balance.vacation_leave.toString().toLowerCase().includes(keyword)) ||
            (balance.personal_leave !== undefined && balance.personal_leave.toString().toLowerCase().includes(keyword)) ||
            (balance.unpaid_leave !== undefined && balance.unpaid_leave.toString().toLowerCase().includes(keyword))
        );
    });

    console.log('filteredLeaveBalancesData after filter:', filteredLeaveBalancesData);

    currentPage = 1;
    gotoLeaveBalancesPage(currentPage);
}

// View employee details
async function viewEmployeeDetails(employeeId) {
    ModalUtils.showSpinner();
    console.log('Viewing employee details for ID:', employeeId);
    try {
        const response = await fetch(`/api/leave-balances/${employeeId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('Details fetch response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const details = await response.json();
        console.log('Employee details:', details);
        displayEmployeeDetails(details);

        $('#employeeDetailsModal').modal('show');
    } catch (error) {
        console.error('Error loading employee details:', error);
        showErrorAfterModalsClose(['employeeDetailsModal'], 'Failed to load employee details');
    } finally {
        ModalUtils.hideSpinner()
    }
}

// Display employee details in modal
function displayEmployeeDetails(details) {
    console.log('Displaying employee details in modal:', details);
    const content = document.getElementById('employeeDetailsContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Employee Information</h6>
                <p><strong>Name:</strong> ${details.employee_name}</p>
                <p><strong>Email:</strong> ${details.employee_email}</p>
                <p><strong>Employee ID:</strong> ${details.employee_id}</p>
            </div>
            <div class="col-md-6">
                <h6>Leave Balances</h6>
                <div class="mb-2">
                    <span class="badge badge-info mr-2">Sick Leave</span>
                    <span class="font-weight-bold">${details.leave_types.sick_leave} days</span>
                </div>
                <div class="mb-2">
                    <span class="badge badge-success mr-2">Vacation Leave</span>
                    <span class="font-weight-bold">${details.leave_types.vacation_leave} days</span>
                </div>
                <div class="mb-2">
                    <span class="badge badge-warning mr-2">Personal Leave</span>
                    <span class="font-weight-bold">${details.leave_types.personal_leave} days</span>
                </div>
                <div class="mb-2">
                    <span class="badge badge-secondary mr-2">Unpaid Leave</span>
                    <span class="font-weight-bold">${details.leave_types.unpaid_leave} days</span>
                </div>
            </div>
        </div>
    `;
}

// Open remove balance modal
function openRemoveBalanceModal(employeeId, employeeName) {
    console.log('Opening remove balance modal for:', employeeId, employeeName);
    $('#removeEmployeeId').val(employeeId);
    $('#removeEmployeeName').text(employeeName);

    $('#removeBalanceForm')[0].reset();
    $('#removeBalanceModal').modal('show');
}

// Open edit balance modal
function openEditBalanceModal(employeeId, employeeName, balanceData) {
    console.log('Opening edit balance modal for:', employeeId, employeeName, balanceData);
    $('#editEmployeeId').val(employeeId);
    $('#editEmployeeName').text(employeeName);

    $('#editSickLeave').val(balanceData.sick_leave);
    $('#editVacationLeave').val(balanceData.vacation_leave);
    $('#editPersonalLeave').val(balanceData.personal_leave);
    $('#editUnpaidLeave').val(balanceData.unpaid_leave);

    $('#editBalanceModal').modal('show');
}

// Submit edit balance
async function submitEditBalance() {
    const employeeId = $('#editEmployeeId').val();
    const formData = new FormData(document.getElementById('editBalanceForm'));

    const data = {};
    for (let [key, value] of formData.entries()) {
        if (key !== 'employee_id' && value !== '') {
            data[key] = parseInt(value);
        }
    }

    console.log('Submitting edit balance for employee:', employeeId, 'data:', data);

    if (Object.keys(data).length === 0) {
        showErrorAfterModalsClose(['editBalanceModal'], 'Please enter at least one value to update');
        return;
    }

    ModalUtils.showSpinner();
    try {
        const response = await fetch(`/api/leave-balances/${employeeId}/edit`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        console.log('Edit response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Edit result:', result);
        ModalUtils.showSuccess(result.message);

        $('#editBalanceModal').modal('hide');
        loadLeaveBalances();
    } catch (error) {
        console.error('Error editing balance:', error);
        showErrorAfterModalsClose(['editBalanceModal'], 'Failed to edit balance');
    } finally {
        ModalUtils.hideSpinner()
    }
}

// Refresh leave balances
function refreshLeaveBalances() {
    console.log('Refreshing leave balances...');
    loadLeaveBalances();
}

// Show success modal
function showSuccessModal(message) {
    console.log('Showing success modal:', message);
    ModalUtils.showSuccess(message);
}

// Show error modal
function showErrorModal(message) {
    console.log('Showing error modal:', message);
    ModalUtils.showError(message);
}
</script>
<!-- Script for handling balances table (End) -->

<!-- Script for adding, viewing, deleting and editing holidays (Start) -->
<script>
// Assumes ModalUtils is loaded globally (see previous script)

// Bootstrap 4 version, refactored to use ModalUtils

function cleanupBackdrop() {
  $('.modal-backdrop').remove();
  $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
}

// Show success/error modal, with optional reload after close using ModalUtils
function showModalMessage(type, message, reload = false) {
  if (type === 'success') {
    ModalUtils.showSuccess(message, reload ? () => window.location.reload() : undefined);
  } else {
    ModalUtils.showError(message, reload ? () => window.location.reload() : undefined);
  }
}

// Helper to always close a modal before showing another modal
function showModalMessageAfterModalClose(closeModalId, type, message, reload = false) {
  const $closeModalEl = $('#' + closeModalId);

  if ($closeModalEl.hasClass('show')) {
    $closeModalEl.one('hidden.bs.modal', function handler() {
      showModalMessage(type, message, reload);
    });
    $closeModalEl.modal('hide');
  } else {
    showModalMessage(type, message, reload);
  }
}

function forceCloseAllModals() {
  $('.modal.show').each(function () {
    $(this).modal('hide');
  });
  setTimeout(() => {
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
  }, 500);
}

function submitHoliday() {
  const appliesTo = document.getElementById("applyTo").value;
  let selectedIds = Array.from(document.getElementById("selectionList").selectedOptions).map(opt => opt.value);

  const data = {
    holiday_name: document.getElementById("holidayName").value,
    holiday_date: document.getElementById("holidayDate").value,
    applies_to: appliesTo,
    selected_ids: selectedIds
  };

  // Debugging: Show what will be sent
  console.debug("submitHoliday payload:", data);

  ModalUtils.showSpinner()
  fetch("/add_holiday", {
    method: "POST",
    headers: getAuthHeaders(),
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    ModalUtils.hideSpinner()
    const type = data.error ? "error" : "success";
    const message = data.message || data.error;
    showModalMessageAfterModalClose("holidayModal", type, message, !data.error);
  })
  .catch(error => {
    ModalUtils.hideSpinner()
    console.error("Error:", error);
    showModalMessageAfterModalClose("holidayModal", "error", "Something went wrong while adding the holiday.");
  });
}

function viewHoliday(holidayId) {
  ModalUtils.showSpinner()
  fetch(`/holidays/view?holiday_id=${holidayId}`, {
    headers: getAuthHeaders()
  })
  .then(response => response.json())
  .then(data => {
    ModalUtils.hideSpinner()
    // --- DEBUGGING OUTPUT ---
    console.debug("[Holiday Details] Raw data for holidayId", holidayId, data);

    if (data.error) {
      showModalMessage("error", data.error);
      return;
    }

    // Extra debugging for assigned employees and teams
    console.debug("[Holiday Details] assigned_employees:", data.assigned_employees);
    console.debug("[Holiday Details] assigned_teams:", data.assigned_teams);

    let assignedToHtml = '';

    if (Array.isArray(data.assigned_employees) && data.assigned_employees.length > 0) {
      assignedToHtml += `<strong>Employees:</strong><ul>`;
      data.assigned_employees.forEach(employee => {
        assignedToHtml += `<li>${employee}</li>`;
      });
      assignedToHtml += `</ul>`;
    }

    if (Array.isArray(data.assigned_teams) && data.assigned_teams.length > 0) {
      assignedToHtml += `<strong>Teams:</strong><ul>`;
      data.assigned_teams.forEach(team => {
        assignedToHtml += `<li>${team}</li>`;
      });
      assignedToHtml += `</ul>`;
    }

    if (
      !Array.isArray(data.assigned_employees) ||
      !Array.isArray(data.assigned_teams) ||
      (data.assigned_employees.length === 0 && data.assigned_teams.length === 0)
    ) {
      assignedToHtml = '<p><strong>Assigned To:</strong> N/A</p>';
    }

    const detailsHtml = `
      <p><strong>Holiday Name:</strong> ${data.holiday_name}</p>
      <p><strong>Holiday Date:</strong> ${data.date}</p>
      <p><strong>Assigned To:</strong><br> ${assignedToHtml}</p>
    `;

    document.getElementById("holidayDetails").innerHTML = detailsHtml;

    $('#viewHolidayModal').modal('show');
  })
  .catch(error => {
    ModalUtils.hideSpinner()
    console.error("Error fetching holiday details:", error);
    showModalMessage("error", "Failed to fetch holiday details.");
  });
}

const confirmDeleteHolidayBtn = document.getElementById("confirmDeleteHoliday");
if (confirmDeleteHolidayBtn) {
  confirmDeleteHolidayBtn.addEventListener("click", function (event) {
    event.preventDefault();
    const holidayId = document.getElementById("deleteHolidayId").value;
    ModalUtils.showSpinner()
    fetch("/holidays/delete", {
      method: "POST",
      headers: getAuthHeaders(),
      body: JSON.stringify({ holiday_id: holidayId })
    })
    .then(response => response.json())
    .then(data => {
      ModalUtils.hideSpinner()
      const type = data.error ? "error" : "success";
      const message = data.message || data.error;
      showModalMessageAfterModalClose("deleteHolidayModal", type, message, !data.error);
    })
    .catch(error => {
      ModalUtils.hideSpinner()
      console.error("Delete request failed:", error);
      showModalMessageAfterModalClose("deleteHolidayModal", "error", "Failed to delete holiday.");
    });
  });
}

const editHolidayForm = document.getElementById("editHolidayForm");
if (editHolidayForm) {
  editHolidayForm.addEventListener("submit", function (event) {
    event.preventDefault();
    const holidayId = document.getElementById("editHolidayId").value;
    const holidayName = document.getElementById("editHolidayName").value;
    const holidayDate = document.getElementById("editHolidayDate").value;
    const selectionType = document.getElementById("editSelectionType").value;
    const isPaid = document.getElementById("editIsPaid").value === "true";

    let selectedIds = [];
    if (selectionType === "team") {
      selectedIds = [...document.getElementById("editTeams").selectedOptions].map(option => option.value);
    } else if (selectionType === "employee") {
      selectedIds = [...document.getElementById("editEmployees").selectedOptions].map(option => option.value);
    } else if (selectionType === "both") {
      selectedIds = [
        ...[...document.getElementById("editTeams").selectedOptions].map(option => option.value),
        ...[...document.getElementById("editEmployees").selectedOptions].map(option => option.value)
      ];
    }

    const requestData = {
      holiday_id: holidayId,
      holiday_name: holidayName,
      date: holidayDate,
      selection_type: selectionType,
      selected_ids: selectedIds,
      is_paid: isPaid
    };

    ModalUtils.showSpinner()
    fetch("/holidays/edit", {
      method: "POST",
      headers: getAuthHeaders(),
      body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
      ModalUtils.hideSpinner()
      const type = data.error ? "error" : "success";
      const message = data.message || data.error;
      showModalMessageAfterModalClose("editHolidayModal", type, message, !data.error);
    })
    .catch(error => {
      ModalUtils.hideSpinner()
      console.error("Error editing holiday:", error);
      showModalMessageAfterModalClose("editHolidayModal", "error", "Failed to edit holiday.");
    });
  });
}
</script>
<!-- Script for adding, viewing, deleting and editing holidays (End) -->

<!-- Script for loading employees in dropdown (Start) -->
<script>
function loadEmployees() {
    const token = sessionStorage.getItem("adminToken");

    ModalUtils.showSpinner()
    fetch("/get_employees", {
        method: "GET",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        ModalUtils.hideSpinner()
        const membersSelect = document.getElementById("members");
        membersSelect.innerHTML = "";

        if (data.length === 0) {
            const option = document.createElement("option");
            option.textContent = "No employees found";
            option.disabled = true;
            membersSelect.appendChild(option);
            return;
        }

        data.forEach(emp => {
            const option = document.createElement("option");
            option.value = emp.employee_id;
            option.textContent = emp.email || `Employee ID: ${emp.employee_id}`;
            membersSelect.appendChild(option);
        });
    })
    .catch(error => {
        ModalUtils.hideSpinner()
        console.error("Failed to load employees:", error);
        const membersSelect = document.getElementById("members");
        membersSelect.innerHTML = '<option>Error loading employees</option>';
        ModalUtils.showError("Failed to load employees.");
    });
}

// Bootstrap 4: use jQuery event for modal show
$('#leaveRequestModal').on('show.bs.modal', loadEmployees);
</script>
<!-- Script for loading employees in dropdown (End) -->

<!-- Script for displaying holidays (Start) -->
<script>
function getAuthHeaders() {
  const token = sessionStorage.getItem("adminToken");
  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${token}`
  };
}

function formatDateToISO(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return date.toISOString().split("T")[0];
}

function toggleAssignmentType() {
  const selectionType = document.getElementById("editSelectionType").value;
  const teamSelection = document.getElementById("teamSelection");
  const employeeSelection = document.getElementById("employeeSelection");

  if (selectionType === "team") {
    teamSelection.style.display = "block";
    employeeSelection.style.display = "none";
  } else if (selectionType === "employee") {
    teamSelection.style.display = "none";
    employeeSelection.style.display = "block";
  } else if (selectionType === "both") {
    teamSelection.style.display = "block";
    employeeSelection.style.display = "block";
  } else {
    teamSelection.style.display = "none";
    employeeSelection.style.display = "none";
  }
}

const token = sessionStorage.getItem("adminToken");
function fetchTeamsAndEmployees() {
  ModalUtils.showSpinner();
  let teamsLoaded = false;
  let employeesLoaded = false;
  function maybeHide() {
    if (teamsLoaded && employeesLoaded) ModalUtils.hideSpinner();
  }

  fetch("/get_teams", {
    headers: { "Authorization": `Bearer ${token}` }
  })
    .then(response => response.json())
    .then(data => {
      const teamSelect = document.getElementById("editTeams");
      teamSelect.innerHTML = "";
      data.forEach(team => {
        let option = document.createElement("option");
        option.value = team.team_id;
        option.textContent = team.team_name;
        teamSelect.appendChild(option);
      });
      teamsLoaded = true;
      maybeHide();
    })
    .catch(error => {
      teamsLoaded = true;
      maybeHide();
      ModalUtils.showError("Error loading teams.");
    });

  fetch("/get_employees", {
    headers: { "Authorization": `Bearer ${token}` }
  })
    .then(response => response.json())
    .then(data => {
      const employeeSelect = document.getElementById("editEmployees");
      employeeSelect.innerHTML = "";
      data.forEach(employee => {
        let option = document.createElement("option");
        option.value = employee.employee_id;
        option.textContent = employee.email;
        employeeSelect.appendChild(option);
      });
      employeesLoaded = true;
      maybeHide();
    })
    .catch(error => {
      employeesLoaded = true;
      maybeHide();
      ModalUtils.showError("Error loading employees.");
    });
}

function populateHolidayEditForm(event, id, name, date, isPaid) {
  event.preventDefault();
  document.getElementById("editHolidayId").value = id;
  document.getElementById("editHolidayName").value = name;
  document.getElementById("editHolidayDate").value = formatDateToISO(date);
  document.getElementById("editIsPaid").value = isPaid ? "true" : "false";
  $("#editHolidayModal").modal("show");
}

function confirmDeleteHoliday(event, holidayId) {
  event.preventDefault();
  document.getElementById("deleteHolidayId").value = holidayId;
  $("#deleteHolidayModal").modal("show");
}

document.addEventListener("DOMContentLoaded", function () {
  const tableBody = document.getElementById("holidayTableBody");
  const searchInput = document.getElementById("holidaySearch");
  const paginationWrapper = document.getElementById("holidayPagination");

  let holidays = [];
  let filteredHolidays = [];
  let currentPage = 1;
  const pageSize = 40; // Number of rows per page

function renderTable(dataToRender) {
  tableBody.innerHTML = "";
  if (dataToRender.length === 0) {
    // Show a message when there are no results
    let row = document.createElement("tr");
    row.innerHTML = `
      <td colspan="3" class="text-center">No holidays found.</td>
    `;
    tableBody.appendChild(row);
    return;
  }
  dataToRender.forEach(item => {
    let assignedToHtml = '';
    if (item.assigned_employees && item.assigned_employees.length > 0) {
      assignedToHtml += `<strong>Employees:</strong><ul>`;
      item.assigned_employees.forEach(employee => {
        assignedToHtml += `<li>${employee}</li>`;
      });
      assignedToHtml += `</ul>`;
    }
    if (item.assigned_teams && item.assigned_teams.length > 0) {
      assignedToHtml += `<strong>Teams:</strong><ul>`;
      item.assigned_teams.forEach(team => {
        assignedToHtml += `<li>${team}</li>`;
      });
      assignedToHtml += `</ul>`;
    }
    if (!assignedToHtml) {
      assignedToHtml = 'N/A';
    }

    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.name || 'N/A'}</td>
      <td>${item.is_paid === null ? "Pending" : item.is_paid ? "Paid" : "Unpaid"}</td>
      <td>
        <button type="button" class="btn btn-info btn-sm" onclick="viewHoliday('${item.id}')">View</button>
        <button type="button" class="btn btn-warning btn-sm" onclick="populateHolidayEditForm(event, '${item.id}', '${item.name}', '${item.date}', '${item.is_paid}')">Edit</button>
        <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteHoliday(event, '${item.id}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

  function renderPagination(totalItems, currentPage, pageSize) {
    if (!paginationWrapper) return;
    paginationWrapper.innerHTML = '';
    const totalPages = Math.ceil(totalItems / pageSize);
    if (totalPages <= 1) return;
    const createPageBtn = (page, label = null, isActive = false, isDisabled = false) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
      btn.textContent = label || page;
      btn.disabled = isDisabled;
      btn.addEventListener('click', () => gotoPage(page));
      return btn;
    };
    paginationWrapper.appendChild(createPageBtn(currentPage - 1, 'Prev', false, currentPage === 1));
    if (totalPages <= 7) {
      for (let page = 1; page <= totalPages; page++) {
        paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
      }
    } else {
      paginationWrapper.appendChild(createPageBtn(1, null, 1 === currentPage));
      if (currentPage > 4) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.className = 'mx-1';
        paginationWrapper.appendChild(dots);
      }
      let start = Math.max(2, currentPage - 1);
      let end = Math.min(totalPages - 1, currentPage + 1);
      for (let page = start; page <= end; page++) {
        paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
      }
      if (currentPage < totalPages - 3) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.className = 'mx-1';
        paginationWrapper.appendChild(dots);
      }
      paginationWrapper.appendChild(createPageBtn(totalPages, null, totalPages === currentPage));
    }
    paginationWrapper.appendChild(createPageBtn(currentPage + 1, 'Next', false, currentPage === totalPages));
  }

function gotoPage(page) {
  const totalPages = Math.ceil(filteredHolidays.length / pageSize);
  // Prevent page from being less than 1
  if (page < 1) page = 1;
  // Prevent page from being more than totalPages, but allow page 1 if there are zero results
  if (totalPages && page > totalPages) page = totalPages;

  currentPage = page;

  const startIdx = (currentPage - 1) * pageSize;
  const endIdx = startIdx + pageSize;
  // Always render, even if filteredHolidays is []
  renderTable(filteredHolidays.slice(startIdx, endIdx));
  renderPagination(filteredHolidays.length, currentPage, pageSize);
}

  // --- CLIENT SIDE SEARCH LOGIC ---
function filterTableHolidays() {
  const keyword = searchInput.value.toLowerCase().trim();
  filteredHolidays = holidays.filter(item => {
    return (
      (item.name && item.name.toLowerCase().includes(keyword)) ||
      (item.is_paid !== null && (item.is_paid ? "paid" : "unpaid").includes(keyword)) ||
      ((item.assigned_employees && Array.isArray(item.assigned_employees) ? item.assigned_employees.join(" ").toLowerCase() : "").includes(keyword)) ||
      ((item.assigned_teams && Array.isArray(item.assigned_teams) ? item.assigned_teams.join(" ").toLowerCase() : "").includes(keyword)) ||
      (item.module_name && item.module_name.toLowerCase().includes(keyword)) ||
      (item.date && item.date.toLowerCase().includes(keyword)) ||
      (item.created_at && item.created_at.toLowerCase().includes(keyword))
    );
  });
  currentPage = 1;
  gotoPage(currentPage);
  console.log("Filtered holidays:", filteredHolidays);
}

  searchInput.addEventListener("input", filterTableHolidays);

  // Initial data fetch (only once)
  ModalUtils.showSpinner();
  fetch('/api/holidays', {
    headers: getAuthHeaders()
  })
  .then(response => response.json())
  .then(data => {
    holidays = Array.isArray(data) ? data : [];
    filteredHolidays = holidays;
    currentPage = 1;
    gotoPage(currentPage);
    ModalUtils.hideSpinner();
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    holidays = [];
    filteredHolidays = [];
    currentPage = 1;
    gotoPage(currentPage);
    ModalUtils.showError("Failed to fetch holidays.");
  });
});

fetchTeamsAndEmployees();
</script>
<!-- Script for displaying holidays (End) -->

<!-- Script for displaying, deleting, editing and viewing details of leave_requests (Start) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const token = sessionStorage.getItem("adminToken");
    let leaveRequests = [];
    let filteredLeaveRequests = [];
    let currentPage = 1;
    const pageSize = 40; // Rows per page

    function showSuccess(message) {
        ModalUtils.showSuccess(message);
    }

    function showError(message) {
        ModalUtils.showError(message);
    }

    function formatDateToISO(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        return date.toISOString().split("T")[0];
    }

    // --- View ---
    function viewLeaveRequest(requestId) {
        ModalUtils.showSpinner();
        fetch(`/leave_requests/view?request_id=${requestId}`, {
            headers: { Authorization: `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            ModalUtils.hideSpinner();
            if (data.error) return showError(data.error);
            const html = `
                <p><strong>Employee:</strong> ${data.email}</p>
                <p><strong>Leave Type:</strong> ${data.leave_type}</p>
                <p><strong>Start Date:</strong> ${formatDateToISO(data.start_date)}</p>
                <p><strong>End Date:</strong> ${formatDateToISO(data.end_date)}</p>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Remarks:</strong> ${data.remarks}</p>
            `;
            document.getElementById("leaveRequestDetails").innerHTML = html;
            $("#viewLeaveRequestModal").modal("show");
        })
        .catch(err => {
            ModalUtils.hideSpinner();
            console.error("View request error:", err);
            showError("Failed to fetch leave request.");
        });
    }

    // --- Edit ---
    const editForm = document.getElementById("editLeaveRequestForm");
    if (editForm) {
        editForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const payload = {
                request_id: document.getElementById("editRequestId").value,
                leave_type: document.getElementById("editLeaveType").value,
                start_date: document.getElementById("editStartDate").value,
                end_date: document.getElementById("editEndDate").value,
                status: document.getElementById("editStatus").value,
                remarks: document.getElementById("editRemarks").value
            };
            ModalUtils.showSpinner();
            fetch("/leave_requests/edit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                ModalUtils.hideSpinner();
                $("#editLeaveRequestModal").modal("hide");
                data.error ? showError(data.error) : showSuccess(data.message || "Updated");
                setTimeout(() => window.location.reload(), 1500);
            })
            .catch(err => {
                ModalUtils.hideSpinner();
                console.error("Edit error:", err);
                showError("Failed to edit.");
            });
        });
    }

    // --- Delete ---
    const deleteBtn = document.getElementById("confirmDeleteLeaveRequest");
    if (deleteBtn) {
        deleteBtn.addEventListener("click", function (e) {
            e.preventDefault();
            const id = document.getElementById("deleteRequestId").value;
            if (!id) return showError("Invalid ID");
            ModalUtils.showSpinner();
            fetch("/leave_requests/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ request_id: id })
            })
            .then(res => res.json())
            .then(data => {
                ModalUtils.hideSpinner();
                $("#deleteLeaveRequestModal").modal("hide");
                data.error ? showError(data.error) : showSuccess(data.message || "Deleted");
                setTimeout(() => window.location.reload(), 1500);
            })
            .catch(err => {
                ModalUtils.hideSpinner();
                console.error("Delete error:", err);
                showError("Failed to delete.");
            });
        });
    }

    // --- Smart Pagination ---
    function renderLeaveRequestsPagination(totalItems, currentPage, pageSize) {
        const paginationWrapper = document.getElementById("leaveRequestsPagination");
        if (!paginationWrapper) return;
        paginationWrapper.innerHTML = '';

        const totalPages = Math.ceil(totalItems / pageSize);
        if (totalPages <= 1) return;

        const createPageBtn = (page, label = null, isActive = false, isDisabled = false) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
            btn.textContent = label || page;
            btn.disabled = isDisabled;
            btn.addEventListener('click', () => LeaveRequestsgotoPage(page));
            return btn;
        };

        // Prev button
        paginationWrapper.appendChild(createPageBtn(currentPage - 1, 'Prev', false, currentPage === 1));

        // Page numbers (smart)
        if (totalPages <= 7) {
            for (let page = 1; page <= totalPages; page++) {
                paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
            }
        } else {
            paginationWrapper.appendChild(createPageBtn(1, null, 1 === currentPage));
            if (currentPage > 4) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.className = 'mx-1';
                paginationWrapper.appendChild(dots);
            }
            let start = Math.max(2, currentPage - 1);
            let end = Math.min(totalPages - 1, currentPage + 1);
            for (let page = start; page <= end; page++) {
                paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
            }
            if (currentPage < totalPages - 3) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.className = 'mx-1';
                paginationWrapper.appendChild(dots);
            }
            paginationWrapper.appendChild(createPageBtn(totalPages, null, totalPages === currentPage));
        }

        // Next button
        paginationWrapper.appendChild(createPageBtn(currentPage + 1, 'Next', false, currentPage === totalPages));
    }

    function LeaveRequestsgotoPage(page) {
    const totalPages = Math.ceil(filteredLeaveRequests.length / pageSize);
    const startIdx = (page - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    LeaveRequestsrenderTable(filteredLeaveRequests.slice(startIdx, endIdx));
    renderLeaveRequestsPagination(filteredLeaveRequests.length, page, pageSize);
    if (page >= 1 && page <= Math.max(totalPages, 1)) {
        currentPage = page;
    }
}

    // --- Populate Table (and search) ---
    function LeaveRequestsrenderTable(data) {
    const tbody = document.getElementById("leaveRequestTableBody");
    if (!tbody) {
        console.error("Table body not found!");
        return;
    }
    tbody.innerHTML = "";
    if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center">No leave requests found.</td></tr>`;
        return;
    }
    data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${item.leave_type || 'N/A'}</td>
            <td>${item.assigned_to || 'N/A'}</td>
            <td>${item.status || 'N/A'}</td>
            <td>
                <button type="button" class="btn btn-info btn-sm" onclick="viewLeaveRequest('${item.id}')">View</button>
                <button type="button" class="btn btn-warning btn-sm" onclick="populateLeaveEditForm(event, '${item.id}', '${item.leave_type}', '${item.start_date}', '${item.end_date}', '${item.status}', '${item.remarks}')">Edit</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteLeaveRequest(event, '${item.id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

    // --- Filter Table on Search ---
    function filterTable() {
        const searchInput = document.getElementById("leaveRequestSearch");
        if (!searchInput) {
            console.error("Search input not found!");
            return;
        }
        const keyword = searchInput.value.toLowerCase();
        console.log("Filtering with keyword:", keyword);

        filteredLeaveRequests = leaveRequests.filter(item => {
            // Match keyword in any string field of the item
            return Object.values(item)
                .filter(val => typeof val === "string")
                .some(val => val.toLowerCase().includes(keyword));
        });

        console.log("Filtered results:", filteredLeaveRequests);
        currentPage = 1;
        LeaveRequestsgotoPage(currentPage);
    }

    // Attach search event
    const searchInput = document.getElementById("leaveRequestSearch");
    if (searchInput) {
        searchInput.addEventListener("input", filterTable);
    } else {
        console.error("Search input not found in DOM!");
    }

    // Fetch data and initialize table
    ModalUtils.showSpinner();
    fetch('/api/leave-requests', {
        headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
        ModalUtils.hideSpinner();
        if (!Array.isArray(data)) return console.error("Invalid data:", data);
        leaveRequests = data;
        filteredLeaveRequests = leaveRequests;
        currentPage = 1;
        LeaveRequestsgotoPage(currentPage);
    })
    .catch(err => {
        ModalUtils.hideSpinner();
        console.error("Fetch error:", err);
    });

    // --- Edit Form Pre-fill ---
    window.populateLeaveEditForm = function (e, id, leaveType, startDate, endDate, status, remarks) {
        e.preventDefault();
        document.getElementById("editRequestId").value = id;
        document.getElementById("editLeaveType").value = leaveType || '';
        document.getElementById("editStartDate").value = formatDateToISO(startDate);
        document.getElementById("editEndDate").value = formatDateToISO(endDate);
        document.getElementById("editStatus").value = status || '';
        document.getElementById("editRemarks").value = remarks || '';
        $("#editLeaveRequestModal").modal("show");
    };

    // --- Delete Modal Trigger ---
    window.confirmDeleteLeaveRequest = function (e, id) {
        e.preventDefault();
        document.getElementById("deleteRequestId").value = id;
        $("#deleteLeaveRequestModal").modal("show");
    };

    // --- Expose view globally ---
    window.viewLeaveRequest = viewLeaveRequest;
});
</script>
<!-- Script for displaying, deleting, editing and viewing details of leave_requests (End) -->

<!-- Script for backing up database (Start) -->
<script>
let backupsData = [];
let filteredBackupsData = [];
let currentPageBackUp = 1;
const backuppageSize = 40;

function filterBackupsByDate(dateStr) {
  if (!dateStr) {
    filteredBackupsData = backupsData.slice();
    currentPageBackUp = 1;
    gotoPage(currentPageBackUp);
    return;
  }
  // dateStr format: YYYY-MM-DD
  filteredBackupsData = backupsData.filter(file => {
    const match = file.match(/backup_(\d+)\.sql/);
    if (!match) return false;
    const timestamp = parseInt(match[1]) * 1000;
    const fileDate = new Date(timestamp);
    // Compare date portions
    const fileDateStr = fileDate.toISOString().split('T')[0];
    return fileDateStr === dateStr;
  });
  currentPageBackUp = 1;
  gotoPage(currentPageBackUp);
}

async function createBackup() {
  try {
    ModalUtils.showSpinner()
    const response = await fetch('/backup', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      }
    });

    ModalUtils.hideSpinner()
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    showBackupResult(result.message || result.error, response.ok ? 'success' : 'error');
    if (response.ok) {
      // Refresh the page after successful backup creation
      setTimeout(() => { window.location.reload(); }, 1000);
    } else {
      loadBackups();
    }
  } catch (error) {
    ModalUtils.hideSpinner()
    showBackupResult('Error creating backup.', 'error');
    console.error('Create backup error:', error);
  }
}

async function loadBackups() {
  try {
    ModalUtils.showSpinner()
    const response = await fetch('/backups', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      }
    });

    ModalUtils.hideSpinner()
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    const backupList = document.getElementById('backup-list');
    backupList.innerHTML = '';

    if (data.backups && data.backups.length > 0) {
      backupsData = data.backups;
      filteredBackupsData = backupsData.slice();
      currentPageBackUp = 1;
      gotoPage(currentPageBackUp);
    } else {
      backupsData = [];
      filteredBackupsData = [];
      const backupList = document.getElementById('backup-list');
      backupList.innerHTML = '';
      const li = document.createElement('li');
      li.className = 'list-group-item text-center text-muted';
      li.textContent = 'No backups available';
      backupList.appendChild(li);
      renderPagination(0, 1, backuppageSize);
    }
  } catch (error) {
    ModalUtils.hideSpinner()
    console.error('Error loading backups:', error);
    showBackupResult('Failed to load backups.', 'error');
  }
}

function renderBackupList(pageItems) {
  const backupList = document.getElementById('backup-list');
  backupList.innerHTML = '';
  if (pageItems.length === 0) {
    const li = document.createElement('li');
    li.className = 'list-group-item text-center text-muted';
    li.textContent = 'No backups available for this date';
    backupList.appendChild(li);
    return;
  }
  pageItems.forEach(file => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';

    // File info
    const fileInfo = document.createElement('div');
    fileInfo.innerHTML = `<strong>${file}</strong><br>
      <small class="text-muted">Created: ${formatBackupDate(file)}</small>`;
    // Button group
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'btn-group';

    const restoreButton = document.createElement('button');
    restoreButton.textContent = 'Restore';
    restoreButton.className = 'btn btn-success btn-sm mr-2';
    restoreButton.type = 'button';
    restoreButton.onclick = (e) => {
      e.preventDefault();
      showRestoreConfirmModal(file);
    };

    const downloadButton = document.createElement('button');
    downloadButton.textContent = 'Download';
    downloadButton.className = 'btn btn-primary btn-sm mr-2';
    downloadButton.type = 'button';
    downloadButton.onclick = async (e) => {
      e.preventDefault();
      await downloadBackupWithToken(file);
    };

    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'Delete';
    deleteButton.className = 'btn btn-danger btn-sm';
    deleteButton.type = 'button';
    deleteButton.onclick = (e) => {
      e.preventDefault();
      showDeleteBackupModal(file);
    };

    buttonGroup.appendChild(restoreButton);
    buttonGroup.appendChild(downloadButton);
    buttonGroup.appendChild(deleteButton);

    li.appendChild(fileInfo);
    li.appendChild(buttonGroup);
    backupList.appendChild(li);
  });
}

function renderPagination(totalItems, currentPageBackUp, backuppageSize) {
  const paginationWrapper = document.getElementById("backupPagination");
  if (!paginationWrapper) return;
  paginationWrapper.innerHTML = '';

  const totalPages = Math.ceil(totalItems / backuppageSize);
  if (totalPages <= 1) return;

  const createPageBtn = (page, label = null, isActive = false, isDisabled = false) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
    btn.textContent = label || page;
    btn.disabled = isDisabled;
    btn.addEventListener('click', () => gotoPage(page));
    return btn;
  };

  paginationWrapper.appendChild(createPageBtn(currentPageBackUp - 1, 'Prev', false, currentPageBackUp === 1));
  if (totalPages <= 7) {
    for (let page = 1; page <= totalPages; page++) {
      paginationWrapper.appendChild(createPageBtn(page, null, page === currentPageBackUp));
    }
  } else {
    paginationWrapper.appendChild(createPageBtn(1, null, 1 === currentPageBackUp));
    if (currentPageBackUp > 4) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'mx-1';
      paginationWrapper.appendChild(dots);
    }
    let start = Math.max(2, currentPageBackUp - 1);
    let end = Math.min(totalPages - 1, currentPageBackUp + 1);
    for (let page = start; page <= end; page++) {
      paginationWrapper.appendChild(createPageBtn(page, null, page === currentPageBackUp));
    }
    if (currentPageBackUp < totalPages - 3) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'mx-1';
      paginationWrapper.appendChild(dots);
    }
    paginationWrapper.appendChild(createPageBtn(totalPages, null, totalPages === currentPageBackUp));
  }
  paginationWrapper.appendChild(createPageBtn(currentPageBackUp + 1, 'Next', false, currentPageBackUp === totalPages));
}

function gotoPage(page) {
  const totalPages = Math.ceil(filteredBackupsData.length / backuppageSize);
  if (page < 1 || page > Math.max(totalPages, 1)) return;
  currentPageBackUp = page;
  const startIdx = (currentPageBackUp - 1) * backuppageSize;
  const endIdx = startIdx + backuppageSize;
  renderBackupList(filteredBackupsData.slice(startIdx, endIdx));
  renderPagination(filteredBackupsData.length, currentPageBackUp, backuppageSize);
}


async function downloadBackupWithToken(file) {
  try {
    ModalUtils.showSpinner()
    const response = await fetch(`/backup/${encodeURIComponent(file)}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });
    ModalUtils.hideSpinner()
    if (!response.ok) {
      showBackupResult('Download failed: ' + response.statusText, 'error');
      return;
    }
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = file;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  } catch (error) {
    ModalUtils.hideSpinner()
    showBackupResult('Download failed.', 'error');
    console.error('Download backup error:', error);
  }
}

function formatBackupDate(filename) {
  // Extract timestamp from filename (backup_timestamp.sql)
  const match = filename.match(/backup_(\d+)\.sql/);
  if (match) {
    const timestamp = parseInt(match[1]) * 1000; // Convert to milliseconds
    return new Date(timestamp).toLocaleString();
  }
  return 'Unknown date';
}

function showDeleteBackupModal(file) {
  document.getElementById('backupToDelete').value = file;
  document.getElementById('confirmBackupDeleteText').textContent = `Are you sure you want to delete backup: ${file}?`;
  $('#confirmBackupDeleteModal').modal('show');
}

function showRestoreConfirmModal(file) {
  document.getElementById('backupToRestore').value = file;
  document.getElementById('confirmRestoreText').textContent = `Are you sure you want to restore from backup: ${file}? This will overwrite the current database!`;
  $('#confirmRestoreModal').modal('show');
}

// Delete backup confirmation
document.getElementById('confirmDeleteBackupBtn').addEventListener('click', async function (e) {
  e.preventDefault();
  const file = document.getElementById('backupToDelete').value;

  try {
    ModalUtils.showSpinner()
    const response = await fetch('/backup', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ file })
    });

    ModalUtils.hideSpinner()
    const data = await response.json();

    $('#confirmBackupDeleteModal').modal('hide');

    showBackupResult(data.message || data.error, response.ok ? 'success' : 'error');
    if (response.ok) {
      // Refresh the page after successful delete
      setTimeout(() => { window.location.reload(); }, 1000);
    } else {
      loadBackups();
    }
  } catch (error) {
    ModalUtils.hideSpinner()
    $('#confirmBackupDeleteModal').modal('hide');
    showBackupResult('Error deleting backup.', 'error');
    console.error('Delete backup error:', error);
  }
});

// Restore backup confirmation
document.getElementById('confirmRestoreBtn').addEventListener('click', async function (e) {
  e.preventDefault();
  const file = document.getElementById('backupToRestore').value;

  try {
    ModalUtils.showSpinner()
    const btn = this;
    const originalText = btn.textContent;
    btn.textContent = 'Restoring...';
    btn.disabled = true;

    const response = await fetch('/restore', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ file })
    });

    ModalUtils.hideSpinner()
    const result = await response.json();

    $('#confirmRestoreModal').modal('hide');

    showBackupResult(result.message || result.error, response.ok ? 'success' : 'error');

    btn.textContent = originalText;
    btn.disabled = false;

    if (response.ok) {
      // Refresh the page after successful restore
      setTimeout(() => { window.location.reload(); }, 1000);
    }

  } catch (error) {
    ModalUtils.hideSpinner()
    $('#confirmRestoreModal').modal('hide');
    showBackupResult('Error restoring backup.', 'error');
    console.error('Restore backup error:', error);
    const btn = this;
    btn.textContent = 'Restore';
    btn.disabled = false;
  }
});

function showBackupResult(message, type = 'info') {
  const cleanupModal = () => {
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
  };

  if (type === 'success') {
    const messageElement = document.getElementById('successModalMessage');
    messageElement.textContent = message;
    $('#successModal').modal('show');
    $('#successModal').off('hidden.bs.modal').on('hidden.bs.modal', cleanupModal);
  } else if (type === 'error') {
    const messageElement = document.getElementById('errorModalMessage');
    messageElement.textContent = message;
    $('#errorModal').modal('show');
    $('#errorModal').off('hidden.bs.modal').on('hidden.bs.modal', cleanupModal);
  } else {
    const messageElement = document.getElementById('successModalMessage');
    messageElement.textContent = message;
    $('#successModal').modal('show');
    $('#successModal').off('hidden.bs.modal').on('hidden.bs.modal', cleanupModal);
  }
}

if (!authToken) {
  console.error('No authentication token found. Please login first.');
  showBackupResult('Authentication required. Please login first.', 'error');
} else {
  loadBackups();
}

document.addEventListener('DOMContentLoaded', function () {
  const errorModal = document.getElementById('errorModal');
  if (errorModal) {
    errorModal.addEventListener('hidden.bs.modal', function () {
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    });
  }

  const successModal = document.getElementById('successModal');
  if (successModal) {
    successModal.addEventListener('hidden.bs.modal', function () {
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    });
  }
  const dateFilterInput = document.getElementById('backupDateFilter');
  if (dateFilterInput) {
    dateFilterInput.addEventListener('input', function () {
      filterBackupsByDate(this.value);
    });
  }
});
</script>
<!-- Script for backing up database (End) -->

<!-- Script for adding leave balances for employees (Start) -->
<script>
function getAuthHeaders() {
  const token = sessionStorage.getItem("adminToken");
  if (!token) {
    console.warn("No admin token found");
    return null;
  }
  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${token}`
  };
}

// Show error modal only after the specified modal closes (never stack)
function showErrorAfterModalClose(modalId, message) {
  var $modalEl = $('#' + modalId);
  if ($modalEl.hasClass("show")) {
    $modalEl.one('hidden.bs.modal', function handler() {
      ModalUtils.showerror(message);
    });
    $modalEl.modal('hide');
  } else {
    ModalUtils.showerror(message);
  }
}

function submitLeaveRequest() {
  const headers = getAuthHeaders();
  if (!headers) {
    ModalUtils.showerror("Authentication required. Please log in again.");
    return;
  }

  const data = {
    employee_id: document.getElementById("members").value,
    leave_type: document.getElementById("leaveType").value,
    leave_amount: document.getElementById("leaveAmount").value
  };

  // Validate required fields
  if (!data.employee_id || !data.leave_type || !data.leave_amount) {
    ModalUtils.showerror("Please fill in all required fields.");
    return;
  }

  ModalUtils.showSpinner();
  fetch("/create_leave_balance", {
    method: "POST",
    headers: headers,
    body: JSON.stringify(data)
  })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(body => {
      // Close the leave modal first, then show success modal and refresh table data
      var $leaveModalEl = $('#leaveRequestModal');
      if ($leaveModalEl.hasClass("show")) {
        $leaveModalEl.one('hidden.bs.modal', function handler() {
          setTimeout(function() {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
            ModalUtils.showSuccess(body.message || "Leave balance created successfully.", function() {
              loadLeaveBalances(); // Refresh the table after success modal is closed
            });
          }, 200);
        });
        $leaveModalEl.modal('hide');
      } else {
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
        ModalUtils.showSuccess(body.message || "Leave balance created successfully.", function() {
          loadLeaveBalances(); // Refresh the table after success modal is closed
        });
      }
    })
    .catch(error => {
      console.error("Error:", error);
      let errorMessage = "An unexpected error occurred. Please try again later.";
      if (error.message.includes("403")) {
        errorMessage = "Access denied. Please check your permissions.";
      } else if (error.message.includes("401")) {
        errorMessage = "Session expired. Please log in again.";
      }
      showErrorAfterModalClose("leaveRequestModal", errorMessage);
    })
    .finally(() => {
      ModalUtils.hideSpinner();
    });
}

function toggleSelectionList() {
  const applyTo = document.getElementById("applyTo").value;
  const selectionList = document.getElementById("selectionList");
  selectionList.innerHTML = '<option value="">Loading...</option>';

  const headers = getAuthHeaders();
  if (!headers) {
    showErrorAfterModalClose("holidayModal", "Authentication required. Please log in again.");
    return;
  }

  ModalUtils.showSpinner();
  fetch(`/get_selection_data?type=${applyTo}`, {
    headers: headers
  })
    .then(response => {
      if (!response.ok) {
        if (response.status === 403) {
          throw new Error("403: Access denied. You don't have permission to view this data.");
        } else if (response.status === 401) {
          throw new Error("401: Session expired. Please log in again.");
        } else {
          throw new Error(`Failed to load selection data (${response.status})`);
        }
      }
      return response.json();
    })
    .then(data => {
      selectionList.innerHTML = '<option value="" disabled>-- Select an option --</option>';
      if (applyTo === "both") {
        if (data.employees && data.teams) {
          // Employees
          data.employees.forEach(emp => {
            const option = document.createElement("option");
            option.value = 'emp_' + emp.id; // Prefix for employees
            option.textContent = emp.email && emp.email.trim()
              ? emp.email
              : `Employee ID: ${emp.id}`;
            option.setAttribute('data-type', 'employee');
            selectionList.appendChild(option);
          });
          // Teams
          data.teams.forEach(team => {
            const option = document.createElement("option");
            option.value = 'team_' + team.id; // Prefix for teams
            option.textContent = team.name;
            option.setAttribute('data-type', 'team');
            selectionList.appendChild(option);
          });
        }
      } else if (applyTo === "employees") {
        if (Array.isArray(data)) {
          data.forEach(emp => {
            const option = document.createElement("option");
            option.value = emp.id;
            option.textContent = emp.email && emp.email.trim()
              ? emp.email
              : `Employee ID: ${emp.id}`;
            selectionList.appendChild(option);
          });
        }
      } else {
        // For teams or any other type, just use the name
        if (Array.isArray(data)) {
          data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = item.name;
            selectionList.appendChild(option);
          });
        }
      }
    })
    .catch(error => {
      console.error("Error loading options:", error);
      selectionList.innerHTML = '<option value="">Failed to load options</option>';
      if (error.message.startsWith("403") || error.message.startsWith("401")) {
        showErrorAfterModalClose("holidayModal", error.message.replace(/^\d+: /, ""));
      } else {
        ModalUtils.showerror(error.message);
      }
    })
    .finally(() => {
      ModalUtils.hideSpinner();
    });
}

// Enhanced focus trap (no backdrop cleanup here!)
document.addEventListener('DOMContentLoaded', function() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modalEl => {
    modalEl.addEventListener('shown.bs.modal', function() {
      const focusableElements = this.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (focusableElements.length > 0) {
        focusableElements[0].focus();
      }
    });
  });

  // Add token validation on page load
  const token = sessionStorage.getItem("adminToken");
  if (!token) {
    console.warn("No authentication token found. Some features may not work.");
  }

  // Add global error handler for unhandled promise rejections
  window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    ModalUtils.showerror("An unexpected error occurred. Please try again.");
  });
});

// Optional: Only use this for dev/debug purposes (not in production)
function forceCloseAllModals() {
  $('.modal.show').each(function () {
    $(this).modal('hide');
  });
  setTimeout(() => {
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
  }, 500);
}

function refreshAuthToken() {
  // Implement token refresh logic here if your API supports it
  console.log("Token refresh functionality not implemented");
}
</script>
<!-- Script for adding leave balances for employees (End) -->
    
<!-- Script for logging out (Start) -->
<script>
  // Script for logging out (Start)
document.querySelector(".logout-btn").addEventListener("click", function () {
  $("#logoutModal").modal("show"); // Show modal using jQuery
});

document
  .getElementById("confirmLogout")
  .addEventListener("click", function () {
    sessionStorage.removeItem("adminToken");
    window.location.href = "/admin_login";
  });

document
  .getElementById("cancelLogout")
  .addEventListener("click", function () {
    $("#logoutModal").modal("hide"); // Hide modal using jQuery
  });

document
  .getElementById("closeLogoutModal")
  .addEventListener("click", function () {
    $("#logoutModal").modal("hide"); // Also hide on "X"
  });
// Script for logging out (End)
</script>
<!-- Script for logging out (End) -->

<!-- Script that redirects admin back to login page if the token doesn't exist (Start) -->
<script>
  if (!token) {
    alert("Not authenticated. Redirecting to login.");
    window.location.href = "/admin_login";
  }
</script>
<!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

<!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start) -->
<script>
  function getToken() {
    return sessionStorage.getItem("adminToken");
  }

  function checkSessionConflict() {
    const token = getToken();
    if (!token) return;

    fetch("/check_jti", {
      method: "GET",
      headers: {
        Authorization: "Bearer " + token,
      },
    })
      .then((response) => {
        if (response.status === 403) {
          throw new Error("session_conflict");
        }
        return response.json();
      })
      .then((data) => {
        if (data.error === "session_conflict") {
          throw new Error("session_conflict");
        }
      })
      .catch((err) => {
        if (err.message === "session_conflict") {
          // Show modal (Bootstrap 4)
          $('#sessionConflictModal').modal({
            backdrop: 'static',
            keyboard: false
          });
          $('#sessionConflictModal').modal('show');

          // Attach event listener only once
          const logoutBtn = document.getElementById("confirmLogoutBetweenTabs");
          if (!logoutBtn.dataset.bound) {
            logoutBtn.addEventListener("click", () => {
              sessionStorage.removeItem("adminToken");
              window.location.href = "/admin_login";
            });
            logoutBtn.dataset.bound = "true";
          }
        }
      });
  }

  // Initial check + every 30 seconds
  checkSessionConflict();
  setInterval(checkSessionConflict, 30000);
</script>
<!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

<!-- Script for checking admin if they have access to this page (Start) -->
<script>
  // Only run this if the backend passed access_denied = True
  const accessDenied = {{ 'true' if access_denied else 'false' }};
  if (accessDenied) {
    // Bootstrap 4: use jQuery modal API
    $('#accessDeniedModal').modal('show');

    document.getElementById("forceLogoutBtn").addEventListener("click", function () {
      // Trigger the logout logic manually
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    });
  }
</script>
<!-- Script for checking admin if they have access to this page (End) -->


  </body>
</html>
