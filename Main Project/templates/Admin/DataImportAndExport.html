<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
                    <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
      
        <div class="main-panel">
          
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="card mb-4">
  <div class="card-body">
    <div class="d-flex align-items-center">
      <div class="me-3">
        <i class="mdi mdi-clipboard-text text-danger" style="font-size: 36px;"></i>
      </div>
      <div>
        <h4 class="card-title mb-1">Note :</h4>
        <p class="card-text mb-0">
          Import only works if the columns between the import file and database table match.
        </p>
        <small class="text-muted">Last updated: <span id="last-updated-time">2025-07-16 08:25:29</span></small>
      </div>
    </div>
  </div>
</div>
                    <h4 class="card-title">Import Employee Data</h4>
                    <form id="importEmployeeForm" enctype="multipart/form-data">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <div class="form-group">
                        <label for="employeeCSV">Upload CSV file:</label>
                        <input type="file" class="form-control" id="employeeCSV" name="file" required>
                      </div>
                      <button type="submit" class="btn btn-primary mr-2">Import Data</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            
    
          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <footer class="footer">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                    >Copyright Â© bootstrapdash.com 2020</span
                  >
                  <span
                    class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                  >
                    Free
                    <a href="https://www.bootstrapdash.com/" target="_blank"
                      >Bootstrap dashboard templates</a
                    >
                    from Bootstrapdash.com</span
                  >
                </div>
              </div>
            </div>
          </footer>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

     <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-success">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="successModalLabel">Success</h5>
            <button type="button" class="close text-white" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="successModalMessage">
            <!-- Message will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-danger">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="close text-white" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="errorModalMessage">
            <!-- Message will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Dismiss</button>
          </div>
        </div>
      </div>
    </div>

<!-- Session Conflict Modal -->
<div
  class="modal fade"
  id="sessionConflictModal"
  tabindex="-1"
  aria-labelledby="sessionConflictLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="sessionConflictLabel">Session Conflict</h5>
      </div>
      <div class="modal-body">
        <p>
          <strong
            >Someone has logged into your account from another tab or
            device.</strong
          >
        </p>
        <p>You will be logged out for security reasons.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Logout</h5>
        <button type="button" class="close" id="closeLogoutModal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelLogout">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmLogout">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Access Denied Modal -->
<div
  class="modal fade"
  id="accessDeniedModal"
  tabindex="-1"
  aria-labelledby="accessDeniedLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
      </div>
      <div class="modal-body">
        <p>Only Super Admins are allowed to access this page.</p>
      </div>
      <div class="modal-footer">
        <button id="redirectBtn" type="button" class="btn btn-danger">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner Modal -->
<div class="modal fade" id="loadingSpinnerModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0 bg-transparent shadow-none">
      <div class="modal-body text-center">
        <div class="spinner-border text-white" style="width: 4rem; height: 4rem;" role="status">
          <span class="sr-only"></span>
        </div>
        <div class="mt-3 text-white font-weight-bold">Please wait...</div>
      </div>
    </div>
  </div>
</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- container-scroller -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- Custom js for this page-->
    <script src="../../static/Admin/js/file-upload.js"></script>
    <!-- End custom js for this page-->
     <!-- plugin js for this page -->
    <script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>
    <!-- End plugin js for this page -->
   
<!-- Script for spinner logic and displaying success and error (Start) -->
<script>

window.ModalUtils = (function() {
  /**
   * Show the loading spinner modal.
   */
  function showSpinner() {
    $('#loadingSpinnerModal').modal('show');
  }

  /**
   * Hide the loading spinner modal.
   */
  function hideSpinner() {
    $('#loadingSpinnerModal').modal('hide');
  }

  /**
   * Show the success modal with a message.
   * @param {string} message - Message to display in the modal body.
   * @param {function} [onClose] - Optional callback after modal is closed.
   */
  function showSuccess(message, onClose) {
    $('#successModalMessage').html(message);
    $('#successModal').modal('show');

    // Remove any previously bound handlers to avoid stacking callbacks
    $('#successModal').off('hidden.bs.modal');

    if (typeof onClose === 'function') {
      $('#successModal').on('hidden.bs.modal', function() {
        onClose();
      });
    }
  }

  /**
   * Show the error modal with a message.
   * @param {string} message - Message to display in the modal body.
   * @param {function} [onClose] - Optional callback after modal is closed.
   */
  function showError(message, onClose) {
    $('#errorModalMessage').html(message);
    $('#errorModal').modal('show');

    // Remove any previously bound handlers to avoid stacking callbacks
    $('#errorModal').off('hidden.bs.modal');

    if (typeof onClose === 'function') {
      $('#errorModal').on('hidden.bs.modal', function() {
        onClose();
      });
    }
  }

  /**
   * Hide the success modal.
   */
  function hideSuccess() {
    $('#successModal').modal('hide');
  }

  /**
   * Hide the error modal.
   */
  function hideError() {
    $('#errorModal').modal('hide');
  }

  return {
    showSpinner,
    hideSpinner,
    showSuccess,
    showError,
    hideSuccess,
    hideError
  };
})();
</script>
<!-- Script for spinner logic and displaying success and error (End) -->

<!-- Script for importing (Start) -->
<script>
  function getAdminToken() {
    return sessionStorage.getItem('adminToken');
  }

  // Generic import function that can handle any entity type
  function handleImport(entityType, formElement) {
    let csrfToken = document.querySelector('input[name="csrf_token"]').value;
    let adminToken = getAdminToken();
    if (!adminToken) {
      ModalUtils.showError('Missing admin token. Please log in again.', () => window.location.reload());
      return;
    }

    let formData = new FormData(formElement);
    formData.append("csrf_token", csrfToken);

    ModalUtils.showSpinner();
    
    // Use the new generic route pattern
    fetch(`/import/${entityType}`, {
      method: "POST",
      body: formData,
      headers: {
        'Authorization': 'Bearer ' + adminToken
      }
    })
    .then(response => response.json())
    .then(data => {
      ModalUtils.hideSpinner();
      if(data.success || data.message) {
        ModalUtils.showSuccess(data.message || `${entityType} import successful!`, () => window.location.reload());
      } else {
        ModalUtils.showError(data.error || data.message || `${entityType} import failed.`, () => window.location.reload());
      }
    })
    .catch(error => {
      ModalUtils.hideSpinner();
      console.error(`Error importing ${entityType}:`, error);
      ModalUtils.showError(`Error importing ${entityType}.`, () => window.location.reload());
    });
  }

  // Event listeners for different import forms
  document.getElementById("importEmployeeForm")?.addEventListener("submit", function (e) {
    e.preventDefault();
    handleImport('employees', this);
  });

</script>
<!-- Script for importing (End) -->

<!-- Script for logging out (Start, spinner integrated) -->
<script>
    // Logout modal logic (unchanged, but added spinner to logout)
  document.addEventListener("DOMContentLoaded", function () {
    const logoutBtn = document.querySelector(".logout-btn");
    const logoutModal = document.getElementById("logoutModal");
    const confirmLogout = document.getElementById("confirmLogout");
    const closeLogoutModal = document.getElementById("closeLogoutModal");
    const cancelLogout = document.getElementById("cancelLogout");

    function openModal() {
        logoutModal.style.display = "block";
        logoutModal.classList.add("show");
    }
    function closeModal() {
        logoutModal.style.display = "none";
        logoutModal.classList.remove("show");
    }
    logoutBtn.addEventListener("click", function () {
        openModal();
    });
    closeLogoutModal.addEventListener("click", closeModal);
    cancelLogout.addEventListener("click", closeModal);
    confirmLogout.addEventListener("click", function () {
        ModalUtils.showSpinner();
        fetch("{{ url_for('login_bp.admin_logout') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `csrf_token={{ csrf_token() }}`,
        })
        .then(response => {
            ModalUtils.hideSpinner();
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
        .catch(error => {
            ModalUtils.hideSpinner();
            console.error("Logout failed:", error);
        });
    });
  });

  document.querySelector(".logout-btn").addEventListener("click", function () {
    $("#logoutModal").modal("show");
  });

  document.getElementById("confirmLogout").addEventListener("click", function () {
    ModalUtils.showSpinner();
    setTimeout(function() {
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    }, 600); // Short delay for spinner visibility
  });

  document.getElementById("cancelLogout").addEventListener("click", function () {
    $("#logoutModal").modal("hide");
  });

  document.getElementById("closeLogoutModal").addEventListener("click", function () {
    $("#logoutModal").modal("hide");
  });
</script>
<!-- Script for logging out (End) -->

<!-- Script that redirects admin back to login page if the token doesn't exist (Start, spinner integrated) -->
<script>
  if (!token) {
    showSpinner && ModalUtils.showSpinner();
    setTimeout(function() {
      alert("Not authenticated. Redirecting to login.");
      window.location.href = "/admin_login";
    }, 600);
  }
</script>
<!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

<!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start, spinner integrated) -->
<script>
  function getToken() {
    return sessionStorage.getItem("adminToken");
  }

  function checkSessionConflict() {
    const token = getToken();
    if (!token) return;

    fetch("/check_jti", {
      method: "GET",
      headers: {
        Authorization: "Bearer " + token,
      },
    })
      .then((response) => {
        if (response.status === 403) {
          throw new Error("session_conflict");
        }
        return response.json();
      })
      .then((data) => {
        if (data.error === "session_conflict") {
          throw new Error("session_conflict");
        }
      })
      .catch((err) => {
        if (err.message === "session_conflict") {
          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById("sessionConflictModal"),
            {
              backdrop: "static",
              keyboard: false,
            }
          );
          modal.show();

          // Attach event listener only once
          const logoutBtn = document.getElementById("confirmLogoutBetweenTabs");
          if (!logoutBtn.dataset.bound) {
            logoutBtn.addEventListener("click", () => {
              ModalUtils.showSpinner();
              setTimeout(function() {
                sessionStorage.removeItem("adminToken");
                window.location.href = "/admin_login";
              }, 600);
            });
            logoutBtn.dataset.bound = "true";
          }
        }
      });
  }

  // Initial check + every 30 seconds
  checkSessionConflict();
  setInterval(checkSessionConflict, 30000);
</script>
<!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

<!-- Script for checking admin if they have access to this page (Start, spinner integrated) -->
<script>
  // Only run this if the backend passed access_denied = True
  const accessDenied = {{ 'true' if access_denied else 'false' }};
  if (accessDenied) {
    const accessModal = new bootstrap.Modal(document.getElementById("accessDeniedModal"));
    accessModal.show();

    document.getElementById("forceLogoutBtn").addEventListener("click", function () {
      ModalUtils.showSpinner();
      setTimeout(function() {
        sessionStorage.removeItem("adminToken");
        window.location.href = "/admin_login";
      }, 600);
    });
  }
</script>
<!-- Script for checking admin if they have access to this page (End) -->
 
  </body>
</html>
