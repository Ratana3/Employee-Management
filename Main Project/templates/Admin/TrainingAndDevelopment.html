<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}">
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
                    <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
      
        <div class="main-panel">
          
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                                          <div class="card mb-4">
  <div class="card-body">
    <div class="d-flex align-items-center">
      <div class="me-3">
        <i class="mdi mdi-alert text-danger" style="font-size: 36px;"></i>
      </div>
      <div>
        <h4 class="card-title mb-1">Warning</h4>
        <p class="card-text mb-0">
          If you delete a module , the skill assessment and the certificate that use that specific module will also be deleted 
        </p>
        <small class="text-muted">Last updated: <span id="last-updated-time">2025-07-16 08:25:29</span></small>
      </div>
    </div>
  </div>
</div>
                    <h4 class="card-title">- Training modules </h4>
                    <p class="card-description">. Create new training modules  :</p>
                    <form class="forms-sample">
                      <button type="submit" class="btn btn-primary mr-2" id="createModuleBtn">Create new module</button>
                      <div class="form-group mb-3" style="border: 1px solid black; margin-top: 10px;">
  <input type="text" id="moduleSearch" class="form-control" placeholder="Search modules...">
</div>
                  <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>
                            Module name
                          </th>
                          <th>
                            Created at
                          </th>
                          <th>
                            Updated at
                          </th>
                          <th>
                            Actions
                          </th>
                        </tr>
                      </thead>
                      <tbody id="moduleTableBody">

                      </tbody>
                    </table>
                  </div>
                  <div id="moduleTablePagination" class="my-2"></div>
                    </form>
                  </div>
                </div>
              </div>
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">- Skill Assessments</h4>
                        <p class="card-description">Evaluate employee skills and recommend areas for improvement</p>
                        <button type="button" class="btn btn-primary" id="assignAssessmentBtn">Assign Assessment</button>
 <div class="input-group mb-3" style="margin-top: 10px;">
  <input type="text" id="assessmentSearchInput" class="form-control" placeholder="Search certificates by email, module, or status" style="border: 1px solid black;">
</div>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table" id="assessmentTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Skill Name</th>
                                        <th>Assessment Date</th>
                                        <th>Score</th>
                                        <th>Feedback</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="assessmentTableBody">
                                    <!-- Dynamic rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="assessmentTablePagination" class="my-2"></div>
                    </div>
                </div>
            </div>
            
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">- Certificate management </h4>
                    <p class="card-description">. Issue certificates for employees  </p>
                    <form class="forms-sample">
                      <button type="button" class="btn btn-primary mr-2" data-toggle="modal" data-target="#issueCertificateModal">Issue certificate</button>
                      <div class="mb-3" style="margin-top: 10px;">
  <input type="text" id="certificateSearchInput" class="form-control" placeholder="Search certificates by email, module, or status" style="border: 1px solid black;">

</div>

                  <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Employee ID</th>
                          <th>Employee Email</th>
                          <th>Module Name</th>
                          <th>Issued Date</th>
                          <th>Certificate Status</th>
                          <th>Score</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="certificateTableBody">
                        
                        </tbody>
                    </table>
                  </div>
                  <div id="certificateTablePagination" class="my-2"></div>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">- Learning Resources Management</h4>
                    <p class="card-description">. Manage guides, tutorials, and knowledge articles</p>
              
                    <form class="forms-sample">
                      <button type="button" class="btn btn-primary mr-2" data-toggle="modal" data-target="#addLearningResourceModal">
                        Add New Resource
                      </button>
              <div class="form-group mt-3">
  <input type="text" id="searchInput" class="form-control" placeholder="Search learning resources..." style="border: 1px solid black;">
</div>
                      <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Title</th>
                              <th>Description</th>
                              <th>Type</th>
                              <th>Content</th>
                              <th>Created At</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="learningResourceTableBody">
                            <!-- JS will dynamically populate this -->
                          </tbody>
                        </table>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">- Badges and Acknowledgements</h4>
                    <p class="card-description">Give badges or acknowledgments for employee contributions</p>
              
                    <form class="forms-sample">
                      <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#addBadgeModal">
                        Add New Badge
                      </button>
                                    <div class="mb-3">
                        <input type="text" id="badgeSearchInput" class="form-control" placeholder="Search badges by name or description..." style="border: 1px solid black;">
                      </div>

                      <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Badge Name</th>
                              <th>Description</th>
                              <th>Image</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="badgeTableBody">
                            <!-- JavaScript will dynamically insert badge rows here -->
                          </tbody>
                        </table>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              
            </div>


            <!-- Modal for deleting learning resource -->
            <div class="modal fade" id="deleteResourceModal" tabindex="-1" role="dialog" aria-labelledby="deleteResourceModalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                  </div>
                  <div class="modal-body">
                    Are you sure you want to delete this learning resource?
                    <input type="hidden" id="deleteResourceId">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Modal for creating new learning resources -->
            <div class="modal fade" id="addLearningResourceModal" tabindex="-1" role="dialog" aria-labelledby="addLearningResourceModalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <form id="addLearningResourceForm">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addLearningResourceModalLabel">Add New Learning Resource</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
            
                      <div class="form-group">
                        <label for="resourceTitle">Title</label>
                        <input type="text" class="form-control" id="resourceTitle" name="title" required>
                      </div>
            
                      <div class="form-group">
                        <label for="resourceDescription">Description</label>
                        <textarea class="form-control" id="resourceDescription" name="description" required></textarea>
                      </div>
            
                      <div class="form-group">
                        <label for="resourceType">Type</label>
                        <select class="form-control" id="resourceType" name="resource_type" required>
                          <option value="Guide">Guide</option>
                          <option value="Tutorial">Tutorial</option>
                          <option value="Article">Article</option>
                        </select>
                      </div>
            
                      <div class="form-group">
                        <label for="resourceContent">Content (URL or full text)</label>
                        <textarea class="form-control" id="resourceContent" name="content" required></textarea>
                      </div>
            
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-success">Save Resource</button>
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            

<!-- Add Badge Modal -->
<div class="modal fade" id="addBadgeModal" tabindex="-1" role="dialog" aria-labelledby="addBadgeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="addBadgeForm" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Badge</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="add-badge-name">Badge Name</label>
            <input type="text" class="form-control" id="add-badge-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="add-badge-desc">Description</label>
            <textarea class="form-control" id="add-badge-desc" name="description" required></textarea>
          </div>
          <div class="form-group">
            <label for="add-badge-icon">Badge Image</label>
            <input type="file" class="form-control" id="add-badge-icon" name="icon" accept="image/*" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Badge</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Edit Badge Modal -->
<div class="modal fade" id="editBadgeModal" tabindex="-1" role="dialog" aria-labelledby="editBadgeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="editBadgeForm" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Badge</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-badge-id" name="badge_id">
          <div class="form-group">
            <label for="edit-badge-name">Badge Name</label>
            <input type="text" class="form-control" id="edit-badge-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="edit-badge-desc">Description</label>
            <textarea class="form-control" id="edit-badge-desc" name="description" required></textarea>
          </div>
          <div class="form-group">
            <label for="edit-badge-icon">Badge Image (leave blank to keep current)</label>
            <input type="file" class="form-control" id="edit-badge-icon" name="icon" accept="image/*">
            <small id="current-icon-preview" class="form-text text-muted mt-2">
              Current: <img id="current-badge-icon" src="" alt="Current Icon" style="height: 100px; width: 100px;">
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update Badge</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Assign Badge Modal -->
<div class="modal fade" id="assignBadgeModal" tabindex="-1" role="dialog" aria-labelledby="assignBadgeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="assignBadgeForm" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Assign Badge</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="assign-badge-id" name="badge_id">
          <div class="form-group">
            <label for="assign-type">Assign To</label>
            <select class="form-control" id="assign-type" name="type" required>
              <option value="">Select type</option>
              <option value="employee">Employee</option>
              <option value="team">Team</option>
            </select>
          </div>
          <div class="form-group">
            <label for="assign-target">Select Target</label>
            <select class="form-control" id="assign-target" name="target_id" required>
              <option value="">Select a target</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Remove Badge Assignments Modal -->
<div class="modal fade" id="removeBadgeAssignmentsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Remove Badge Assignments</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="removeAssignmentsTableContainer">
          <!-- Table will be injected here -->
        </div>
      </div>
      <div class="modal-footer">
        <button id="removeAssignmentsBulkBtn" type="button" class="btn btn-danger">Remove Selected</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”´ Delete Badge Modal -->
<div class="modal fade" id="deleteBadgeModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Delete Badge</h5>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this badge?
        <input type="hidden" id="delete-badge-id">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="deleteBadge()">Yes, Delete</button>
      </div>
    </div>
  </div>
</div>


<!-- ðŸ” View Badge Modal -->
<div class="modal fade" id="viewBadgeModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>View Badge</h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <h6 id="view-badge-name"></h6>
        <p id="view-badge-desc"></p>
        <img id="view-badge-icon" width="100" height="100"/>
      </div>
    </div>
  </div>
</div>


  <!-- Modal for viewing learning resources -->
  <div class="modal fade" id="viewResourceModal" tabindex="-1" role="dialog" aria-labelledby="viewResourceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewResourceModalLabel">Resource Details</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <h4 id="viewTitle"></h4>
          <p><strong>Type:</strong> <span id="viewType"></span></p>
          <p><strong>Description:</strong></p>
          <p id="viewDescription"></p>
          <p><strong>Content:</strong></p>
          <p id="viewContent"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for editing learning resource -->
  <div class="modal fade" id="editResourceModal" tabindex="-1" role="dialog" aria-labelledby="editResourceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form id="editLearningResourceForm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Learning Resource</h5>
            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editResourceId">
  
            <div class="form-group">
              <label for="editTitle">Title</label>
              <input type="text" class="form-control" id="editTitle" required>
            </div>
  
            <div class="form-group">
              <label for="editDescription">Description</label>
              <textarea class="form-control" id="editDescription" required></textarea>
            </div>
  
            <div class="form-group">
              <label for="editType">Type</label>
              <select class="form-control" id="editType" required>
                <option value="Guide">Guide</option>
                <option value="Tutorial">Tutorial</option>
                <option value="Article">Article</option>
              </select>
            </div>
  
            <div class="form-group">
              <label for="editContent">Content</label>
              <textarea class="form-control" id="editContent" required></textarea>
            </div>
  
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Update</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
            <!-- Create Module Modal -->
<div class="modal fade" id="createModuleModal" tabindex="-1" role="dialog" aria-labelledby="createModuleLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Create New Training Module</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <form id="createModuleForm">
                  <div class="form-group">
                      <label for="module-name">Module Name</label>
                      <input type="text" class="form-control" id="module-name" name="module_name" required>
                  </div>
                  <div class="form-group">
                      <label for="module-description">Description</label>
                      <textarea class="form-control" id="module-description" name="module_description" required></textarea>
                  </div>
                  <div class="form-group">
                      <label for="module-deadline">Deadline</label>
                      <input type="date" class="form-control" id="module-deadline" name="module_deadline" required>
                  </div>
                  <button type="submit" class="btn btn-success">Create Module</button>
                  <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
              </form>
          </div>
      </div>
  </div>
</div>

<!-- Assign Assessment Modal -->
<div class="modal fade" id="assignAssessmentModal" tabindex="-1" role="dialog" aria-labelledby="assignAssessmentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <form id="assignAssessmentForm">
              <div class="modal-header">
                  <h5 class="modal-title">Assign Skill Assessment</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                    <label for="employee-id">Employee</label>
                    <select class="form-control" id="employee-id" name="employee_id" required></select>
                </div>
                <div class="form-group">
                    <label for="skill-name">Skill</label>
                    <select class="form-control" id="skill-name" name="module_id" required></select>
                </div>
                <div class="form-group">
                    <label for="assessment-date">Date</label>
                    <input type="date" class="form-control" id="assessment-date" name="assessment_date" required>
                </div>
                <div class="form-group">
                    <label for="feedback">Feedback</label>
                    <textarea class="form-control" id="feedback" name="feedback" required></textarea>
                </div>
                <hr>
                <h5>Questions</h5>
                <div id="questions-container"></div>
                <button type="button" class="btn btn-secondary mt-2" id="add-question-btn">Add Question</button>
              </div>
              <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Assign</button>
              </div>
          </form>
      </div>
  </div>
</div>

<!-- Modal for certificate issue -->
<div class="modal fade" id="issueCertificateModal" tabindex="-1" role="dialog" aria-labelledby="issueCertificateLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="issueCertificateLabel">Issue New Certificate</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <form id="issueCertificateForm">
                  <div class="form-group">
                      <label for="employee-id">Employee</label>
                      <select class="form-control" id="certificate-employee-id" name="employee_id" required>
                          <option value="" disabled selected>Select Employee</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="module-id">Training Module</label>
                      <select class="form-control" id="issue-Certificate" name="module_id" required>
                          <option value="" disabled selected>Select Module</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="issued-date">Issued Date</label>
                      <input type="date" class="form-control" id="issued-date" name="issued_date" required>
                  </div>
                  <div class="form-group">
                      <label for="certificate-status">Certificate Status</label>
                      <select class="form-control" id="certificate-status" name="certificate_status" required>
                          <option value="Pending">Pending</option>
                          <option value="Issued">Issued</option>
                          <option value="Revoked">Revoked</option>
                      </select>
                  </div>

                  
                  <button type="submit" class="btn btn-success">Issue Certificate</button>
                  <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
              </form>
          </div>
      </div>
  </div>
</div>

<!-- Edit Module Modal -->
<div class="modal fade" id="editModuleModal" tabindex="-1" aria-labelledby="editModuleLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModuleLabel">Edit Training Module</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editModuleForm">
          <input type="hidden" id="editModuleId">
          <div class="form-group">
            <label for="editModuleName">Module Name</label>
            <input type="text" class="form-control" id="editModuleName" required>
          </div>
          <div class="form-group">
            <label for="editModuleDescription">Description</label>
            <textarea class="form-control" id="editModuleDescription" required></textarea>
          </div>
          <div class="form-group">
            <label for="editModuleDeadline">Deadline</label>
            <input type="date" class="form-control" id="editModuleDeadline" required>
        </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- View Module details Modal -->
<div class="modal fade" id="viewModuleModal" tabindex="-1" aria-labelledby="viewModuleLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewModuleLabel">Module Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Module Name:</strong> <span id="viewModuleName"></span></p>
        <p><strong>Description:</strong> <span id="viewModuleDescription"></span></p>
        <p><strong>Deadline:</strong> <span id="viewModuleDeadline"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- View Assessment Modal -->
<div class="modal fade" id="viewSkillAssessmentModal" tabindex="-1" role="dialog" aria-labelledby="viewSkillAssessmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document"> <!-- wider dialog -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">View Skill Assessment</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Employee ID:</strong> <span id="viewEmployeeId"></span></p>
        <p><strong>Employee email:</strong> <span id="viewEmployeeEmailAssessment"></span></p>
        <p><strong>Skill:</strong> <span id="viewSkillName"></span></p>
        <p><strong>Date:</strong> <span id="viewAssessmentDate"></span></p>
        <p><strong>Score:</strong> <span id="viewScore"></span></p>
        <p><strong>Feedback:</strong> <span id="viewFeedback"></span></p>

        <hr>
        <h5>Questions & Options</h5>
        <div id="viewQuestionsContainer"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- The modal for editing skill assessments -->
<div class="modal" id="editSkillAssessmentModal" tabindex="-1" aria-labelledby="editSkillAssessmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="editSkillAssessmentModalLabel">Edit Skill Assessment</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
          </div>
          <div class="modal-body">
              <!-- Form to edit assessment -->
              <form id="editSkillAssessmentForm">
                <input type="hidden" id="editSkillAssessmentId" />
                <input type="hidden" id="editEmployeeId" />
                  <div class="mb-3">
                      <label for="editSkillName" class="form-label">Skill Name</label>
                      <input type="text" id="editSkillName" class="form-control"  />
                  </div>
                  <div class="mb-3">
                      <label for="editAssessmentDate" class="form-label">Assessment Date</label>
                      <input type="date" id="editAssessmentDate" class="form-control"  />
                  </div>
                  <div class="mb-3">
                      <label for="editScore" class="form-label">Score</label>
                      <input type="number" id="editScore" class="form-control"  />
                  </div>
                  <div class="mb-3">
                      <label for="editFeedback" class="form-label">Feedback</label>
                      <textarea id="editFeedback" class="form-control" ></textarea>
                  </div>
                  <div class="mb-3">
                      <label for="editModule" class="form-label">Module</label>
                      <select id="editModule" class="form-control" ></select>
                  </div>

                  <!-- Container for questions and options -->
                   <label>Questions</label>
                  <div id="edit-questions-container"></div>

                  <!-- Button to add a new question -->
                  <button type="button" class="btn btn-primary" id="addQuestionBtn">Add Question</button>

                  <!-- Save changes button -->
                  <button type="submit" class="btn btn-success mt-3">Save Changes</button>
              </form>
          </div>
      </div>
  </div>
</div>


<!-- Delete Confirmation Modal for skill assessment -->
<div class="modal fade" id="deleteSkillAssessmentModal" tabindex="-1" role="dialog" aria-labelledby="deleteSkillAssessmentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Delete Skill Assessment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              Are you sure you want to delete this skill assessment?
              <input type="hidden" id="deleteAssessmentId">
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-danger" id="confirmDeleteAssessment">Delete</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
      </div>
  </div>
</div>

<!-- View Certificate Modal -->
<div class="modal fade" id="viewCertificateModal" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Certificate Details</h5>
              <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <p><strong>Employee email:</strong> <span id="viewEmployeeEmailCertificate"></span></p>
              <p><strong>Module name:</strong> <span id="viewModuleId"></span></p>
              <p><strong>Issued Date:</strong> <span id="viewIssuedDate"></span></p>
              <p><strong>Status:</strong> <span id="viewCertificateStatus"></span></p>
              <p><strong>Score:</strong> <span id="viewProgressPercentage"></span></p>

          </div>
      </div>
  </div>
</div>

<!-- Edit Certificate Modal -->
<div class="modal fade" id="editCertificateModal" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Edit Certificate</h5>
              <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="editCertificateForm">
                  <input type="hidden" id="editCertificateId">
                  <div class="mb-3">
                      <label>Module</label>
                      <select id="editModule-Certificate" class="form-control">
                        <option value="" disabled>Select Module</option>
                    </select>
                    
                  </div>
                  <div class="mb-3">
                      <label>Issued Date</label>
                      <input type="date" id="editIssuedDate" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label>Score</label>
                    <input type="number" step="0.01" id="editProgressPercentage" class="form-control"/>
                </div>
                  
                  <div class="mb-3">
                      <label>Status</label>
                      <select id="editCertificateStatus" class="form-control">
                          <option value="Pending">Pending</option>
                          <option value="Issued">Issued</option>
                          <option value="Revoked">Revoked</option>
                      </select>
                  </div>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
              </form>
          </div>
      </div>
  </div>
</div>

<!-- Delete Certificate Modal -->
<div class="modal fade" id="deleteCertificateModal" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Delete Certificate</h5>
              <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <p>Are you sure you want to delete this certificate?</p>
              <input type="hidden" id="deleteCertificateId">
              <button type="button" id="confirmDeleteCertificate" class="btn btn-danger">Delete</button>
          </div>
      </div>
  </div>
</div>


<!-- Delete Confirmation Modal for Module -->
<div class="modal fade" id="deleteModuleModal" tabindex="-1" role="dialog" aria-labelledby="deleteModuleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Module</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this module?
          <input type="hidden" id="deleteModuleId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="confirmDeleteModule">Delete</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  

   <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-success">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Success</h5>
          </div>
          <div class="modal-body" id="successMessage">
            Action completed successfully.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              onclick="location.reload()"
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="errorMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Dismiss</button>
      </div>
    </div>
  </div>
</div>


    <!-- Generic Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel">Message</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody">
        <!-- message text goes here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Session Conflict Modal -->
<div
  class="modal fade"
  id="sessionConflictModal"
  tabindex="-1"
  aria-labelledby="sessionConflictLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="sessionConflictLabel">Session Conflict</h5>
      </div>
      <div class="modal-body">
        <p>
          <strong
            >Someone has logged into your account from another tab or
            device.</strong
          >
        </p>
        <p>You will be logged out for security reasons.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Logout</h5>
        <button type="button" class="close" id="closeLogoutModal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelLogout">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmLogout">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Access Denied Modal -->
<div
  class="modal fade"
  id="accessDeniedModal"
  tabindex="-1"
  aria-labelledby="accessDeniedLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
      </div>
      <div class="modal-body">
        <p>Only Super Admins are allowed to access this page.</p>
      </div>
      <div class="modal-footer">
        <button id="redirectBtn" type="button" class="btn btn-danger">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Clear Score Modal -->
<div class="modal fade" id="confirmClearScoreModal" tabindex="-1" aria-labelledby="confirmClearScoreModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="confirmClearScoreModalLabel">Confirm Clear Score</h5>
        
      </div>
      <div class="modal-body">
        Are you sure you want to <b>clear the score</b> for this assessment? This cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmClearScoreButton">Yes, Clear Score</button>
      </div>
    </div>
  </div>
</div>

    <!-- Loading Spinner Modal -->
    <div
      class="modal fade"
      id="loadingSpinnerModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 bg-transparent shadow-none">
          <div class="modal-body text-center">
            <div
              class="spinner-border text-white"
              style="width: 4rem; height: 4rem"
              role="status"
            >
              <span class="sr-only"></span>
            </div>
            <div class="mt-3 text-white font-weight-bold">Please wait...</div>
          </div>
        </div>
      </div>
    </div>

          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <footer class="footer">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                    >Copyright Â© bootstrapdash.com 2020</span
                  >
                  <span
                    class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                  >
                    Free
                    <a href="https://www.bootstrapdash.com/" target="_blank"
                      >Bootstrap dashboard templates</a
                    >
                    from Bootstrapdash.com</span
                  >
                </div>
              </div>
            </div>
          </footer>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

 <!-- Add these in the <head> or before closing </body> -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- container-scroller -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- Custom js for this page-->
    <script src="../../static/Admin/js/file-upload.js"></script>
    <!-- End custom js for this page-->
     <!-- plugin js for this page -->
    <script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>
    <!-- End plugin js for this page -->

    <!-- Spinner logic (add once, for all modals and actions) -->
<script>
function showSpinner() {
  if (!window._spinnerOpen) {
    $('#loadingSpinnerModal').modal({
      backdrop: 'static',
      keyboard: false
    });
    window._spinnerOpen = true;
  }
}
function hideSpinner() {
  $('#loadingSpinnerModal').modal('hide');
  window._spinnerOpen = false;
}
</script>

<!-- Script for giving badges and acknowledgements (WITH SPINNER) -->
<script>
  // Spinner logic
  function showSpinner() {
    if (!window._spinnerOpen) {
      $('#loadingSpinnerModal').modal({
        backdrop: 'static',
        keyboard: false
      });
      window._spinnerOpen = true;
    }
  }
  function hideSpinner() {
    $('#loadingSpinnerModal').modal('hide');
    window._spinnerOpen = false;
  }

  document.addEventListener("DOMContentLoaded", () => {
    fetchBadges();
    document.getElementById("badgeSearchInput").addEventListener("input", filterBadges);
  });

  let allBadges = [];

  function getAuthHeaders() {
    const token = sessionStorage.getItem("adminToken");
    if (!token) {
      console.error("No adminToken found in sessionStorage.");
      showError("Authentication required. Please login first.");
      return null;
    }
    return {
      "Authorization": "Bearer " + token,
      "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
    };
  }

  function showSuccess(message) {
    document.getElementById("successMessage").innerText = message;
    if (typeof bootstrap !== 'undefined') {
      const modal = new bootstrap.Modal(document.getElementById('successModal'));
      modal.show();
    } else {
      $('#successModal').modal('show');
    }
  }

  function showError(message) {
    document.getElementById("errorMessage").innerText = message;
    if (typeof bootstrap !== 'undefined') {
      const modal = new bootstrap.Modal(document.getElementById('errorModal'));
      modal.show();
    } else {
      $('#errorModal').modal('show');
    }
  }

  function viewBadgeDetails(badgeId) {
    const headers = getAuthHeaders();
    if (!headers) return;
    showSpinner();
    fetch(`/admin/badges/${badgeId}`, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(badge => {
        document.getElementById("view-badge-name").innerText = badge.name;
        document.getElementById("view-badge-desc").innerText = badge.description;
        document.getElementById("view-badge-icon").src = badge.icon_url;
        $('#viewBadgeModal').modal('show');
        hideSpinner();
      })
      .catch(error => {
        hideSpinner();
        console.error('Error fetching badge details:', error);
        showError('Failed to load badge details.');
      });
  }

  function openEditBadgeModal(badgeId) {
    const headers = getAuthHeaders();
    if (!headers) return;
    showSpinner();
    fetch(`/admin/badges/${badgeId}`, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(badge => {
        document.getElementById("edit-badge-id").value = badge.badge_id;
        document.getElementById("edit-badge-name").value = badge.name;
        document.getElementById("edit-badge-desc").value = badge.description;
        document.getElementById("current-badge-icon").src = badge.icon_url;
        $('#editBadgeModal').modal('show');
        hideSpinner();
      })
      .catch(error => {
        hideSpinner();
        console.error('Error fetching badge for editing:', error);
        showError('Failed to load badge for editing.');
      });
  }

  const editBadgeForm = document.getElementById("editBadgeForm");
  editBadgeForm.addEventListener("submit", function (e) {
    e.preventDefault();
    saveEditedBadge();
  });

  const addBadgeForm = document.getElementById("addBadgeForm");
  addBadgeForm.addEventListener("submit", function (e) {
    e.preventDefault();
    addBadge();
  });

  const assignBadgeForm = document.getElementById("assignBadgeForm");
  assignBadgeForm.addEventListener("submit", function(e) {
    e.preventDefault();
    assignBadge();
  });

  function openAssignModal(badgeId) {
    document.getElementById("assign-badge-id").value = badgeId;
    document.getElementById("assign-type").value = "";
    document.getElementById("assign-target").innerHTML = '<option value="">Select a target</option>';
    $('#assignBadgeModal').modal('show');
  }

  document.getElementById("assign-type").addEventListener("change", function () {
    const type = this.value;
    const targetDropdown = document.getElementById("assign-target");
    const headers = getAuthHeaders();
    if (!headers) return;
    targetDropdown.innerHTML = '<option value="">Loading...</option>';
    showSpinner();
    fetch(`/admin/assign-options?type=${type}`, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(data => {
        targetDropdown.innerHTML = '<option value="">Select a target</option>';
        data.forEach(item => {
          const option = document.createElement("option");
          option.value = item.id;
          option.text = item.name || 'ID: ' + item.id;
          targetDropdown.appendChild(option);
        });
        hideSpinner();
      })
      .catch(error => {
        hideSpinner();
        console.error('Error loading assign options:', error);
        targetDropdown.innerHTML = '<option value="">Error loading options</option>';
        showError('Failed to load assignment options.');
      });
  });

  function assignBadge() {
    const formData = new FormData(assignBadgeForm);
    showSpinner();
    fetch('/admin/assign_badge', {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + sessionStorage.getItem("adminToken"),
        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
      },
      body: formData
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      return res.json();
    })
    .then(data => {
      hideSpinner();
      $('#assignBadgeModal').modal('hide');
      assignBadgeForm.reset();
      showSuccess("Badge assigned successfully!");
      setTimeout(fetchBadges, 500);
    })
    .catch(error => {
      hideSpinner();
      console.error('Error assigning badge:', error);
      showError('Failed to assign badge. Please try again.');
    });
  }

  function fetchBadges() {
    const headers = getAuthHeaders();
    if (!headers) return;
    showSpinner();
    fetch("/admin/badges_with_assignments", { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(badges => {
        allBadges = badges;
        renderBadges(allBadges);
        hideSpinner();
      })
      .catch(error => {
        hideSpinner();
        console.error('Error fetching badges:', error);
        showError('Failed to load badges.');
      });
  }

  function renderBadges(badges) {
    const tableBody = document.getElementById("badgeTableBody");
    if (!tableBody) {
      console.warn("badgeTableBody not found in DOM.");
      return;
    }
    tableBody.innerHTML = "";

    badges.forEach(badge => {
      let assignmentHTML = badge.assignments.length > 0
        ? `<ul class="mb-0">` + badge.assignments.map(a =>
            `<li><strong>${a.type}</strong>: ${a.target} <small class="text-muted">(${a.assigned_at})</small></li>`).join("")
            + `</ul>`
        : `<span class="text-muted">No assignments</span>`;

      const row = `
        <tr>
          <td>${badge.badge_name}</td>
          <td>${badge.description}</td>
          <td>${assignmentHTML}</td>
          <td>
            <button type="button" class="btn btn-primary btn-sm" onclick="viewBadgeDetails(${badge.badge_id})">View</button>
            <button type="button" class="btn btn-info btn-sm" onclick="openEditBadgeModal(${badge.badge_id})">Edit</button>
            <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteBadge(${badge.badge_id})">Delete</button>
            <button type="button" class="btn btn-success btn-sm" onclick="openAssignModal(${badge.badge_id})">Assign</button>
            <button type="button" class="btn btn-warning btn-sm" onclick="openRemoveBadgeAssignmentsModal(${badge.badge_id})">Remove Assignment</button>
          </td>
        </tr>
      `;
      tableBody.insertAdjacentHTML("beforeend", row);
    });
  }

  function filterBadges() {
    const searchTerm = document.getElementById("badgeSearchInput").value.toLowerCase();
    const filtered = allBadges.filter(badge =>
      badge.badge_name.toLowerCase().includes(searchTerm) ||
      badge.description.toLowerCase().includes(searchTerm)
    );
    renderBadges(filtered);
  }

  function addBadge() {
    const form = document.getElementById("addBadgeForm");
    const formData = new FormData(form);
    showSpinner();
    fetch('/admin/badges', {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + sessionStorage.getItem("adminToken"),
        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
      },
      body: formData,
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      return res.json();
    })
    .then(data => {
      hideSpinner();
      $('#addBadgeModal').modal('hide');
      form.reset();
      showSuccess("Badge added successfully!");
      setTimeout(() => { fetchBadges(); }, 500);
    })
    .catch(error => {
      hideSpinner();
      console.error('Error adding badge:', error);
      showError('Failed to add badge. Please try again.');
    });
  }

  function saveEditedBadge() {
    const id = document.getElementById("edit-badge-id").value;
    const form = document.getElementById("editBadgeForm");
    const formData = new FormData(form);
    showSpinner();
    fetch(`/admin/badges/${id}`, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + sessionStorage.getItem("adminToken"),
        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
      },
      body: formData,
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      return res.json();
    })
    .then(data => {
      hideSpinner();
      $('#editBadgeModal').modal('hide');
      form.reset();
      showSuccess("Badge updated successfully!");
      setTimeout(() => { fetchBadges(); }, 500);
    })
    .catch(error => {
      hideSpinner();
      console.error('Error updating badge:', error);
      showError('Failed to update badge. Please try again.');
    });
  }

  function confirmDeleteBadge(id) {
    document.getElementById("delete-badge-id").value = id;
    $('#deleteBadgeModal').modal('show');
  }

  function deleteBadge() {
    const id = document.getElementById("delete-badge-id").value;
    showSpinner();
    fetch(`/admin/badges/${id}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + sessionStorage.getItem("adminToken"),
        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content,
      },
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      return res.json();
    })
    .then(data => {
      hideSpinner();
      $('#deleteBadgeModal').modal('hide');
      showSuccess("Badge deleted successfully!");
      setTimeout(() => { fetchBadges(); }, 500);
    })
    .catch(error => {
      hideSpinner();
      console.error('Error deleting badge:', error);
      showError('Failed to delete badge. Please try again.');
    });
  }

  function openViewBadge(id) {
    const headers = getAuthHeaders();
    if (!headers) return;
    showSpinner();
    fetch(`/admin/badges/${id}`, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(badge => {
        document.getElementById("view-badge-name").innerText = badge.name;
        document.getElementById("view-badge-desc").innerText = badge.description;
        document.getElementById("view-badge-icon").src = badge.icon_url;
        $('#viewBadgeModal').modal('show');
        hideSpinner();
      })
      .catch(error => {
        hideSpinner();
        console.error('Error fetching badge details:', error);
        showError('Failed to load badge details.');
      });
  }

  // ----------- REMOVE BADGE ASSIGNMENTS LOGIC -----------
  function openRemoveBadgeAssignmentsModal(badgeId) {
    const headers = getAuthHeaders();
    if (!headers) return;
    showSpinner();
    fetch('/admin/remove_badge_assignment', {
      method: "POST",
      headers: { ...headers, "Content-Type": "application/json" },
      body: JSON.stringify({ badge_id: badgeId })
    })
      .then(res => {
        if (!res.ok) throw new Error("Failed to load assignments");
        return res.json();
      })
      .then(data => {
        renderRemoveAssignmentsTable(badgeId, data.assignments || []);
        $('#removeBadgeAssignmentsModal').modal('show');
        hideSpinner();
      })
      .catch(err => {
        hideSpinner();
        showError('Failed to load assignments.');
      });
  }

  function renderRemoveAssignmentsTable(badgeId, assignments) {
    let html = `<table class="table table-bordered">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAllAssignments"></th>
          <th>Type</th>
          <th>Target</th>
          <th>Assigned At</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
    `;

    assignments.forEach(a => {
      html += `
        <tr>
          <td><input type="checkbox" class="remove-assign-checkbox" data-type="${a.type}" data-id="${a.id}"></td>
          <td>${a.type}</td>
          <td>${a.target}</td>
          <td>${a.assigned_at}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="removeSingleAssignment(${badgeId}, '${a.type}', '${a.id}')">Remove</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    document.getElementById('removeAssignmentsTableContainer').innerHTML = html;

    // Select all logic
    document.getElementById('selectAllAssignments').addEventListener('change', function() {
      document.querySelectorAll('.remove-assign-checkbox').forEach(cb => cb.checked = this.checked);
    });

    // Bulk remove logic
    document.getElementById('removeAssignmentsBulkBtn').onclick = function() {
      const checked = Array.from(document.querySelectorAll('.remove-assign-checkbox:checked'));
      if (checked.length === 0) {
        showError("No assignments selected.");
        return;
      }

      const grouped = { employee: [], team: [] };
      checked.forEach(cb => {
        grouped[cb.dataset.type].push(cb.dataset.id);
      });

      let promises = [];
      if (grouped.employee.length) {
        promises.push(sendRemoveAssignments(badgeId, 'employee', grouped.employee));
      }
      if (grouped.team.length) {
        promises.push(sendRemoveAssignments(badgeId, 'team', grouped.team));
      }

      showSpinner();
      Promise.all(promises)
        .then(() => {
          hideSpinner();
          openRemoveBadgeAssignmentsModal(badgeId); // Refresh assignments after removal
          showSuccess("Selected assignments removed.");
        })
        .catch(() => {
          hideSpinner();
          showError("Failed to remove assignments.");
        });
    };
  }

  function removeSingleAssignment(badgeId, type, id) {
    showSpinner();
    sendRemoveAssignments(badgeId, type, [id])
      .then(() => {
        hideSpinner();
        openRemoveBadgeAssignmentsModal(badgeId); // Refresh assignments after removal
        showSuccess("Assignment removed.");
      })
      .catch(() => {
        hideSpinner();
        showError("Failed to remove assignment.");
      });
  }

  function sendRemoveAssignments(badgeId, type, ids) {
    const headers = getAuthHeaders();
    headers["Content-Type"] = "application/json";
    return fetch('/admin/remove_badge_assignment', {
      method: "POST",
      headers,
      body: JSON.stringify({
        badge_id: badgeId,
        type,
        target_ids: ids
      })
    })
    .then(res => {
      if (!res.ok) throw new Error("Failed to remove assignment");
      return res.json();
    });
  }
</script>
<!-- Script for giving badges and acknowledgements (End) -->

<!-- Script for adding and displaying learning resources (Start) -->
<script>
  // Spinner logic (reuse if needed)
  function showSpinner() {
    if (!window._spinnerOpen) {
      $('#loadingSpinnerModal').modal({
        backdrop: 'static',
        keyboard: false
      });
      window._spinnerOpen = true;
    }
  }
  function hideSpinner() {
    $('#loadingSpinnerModal').modal('hide');
    window._spinnerOpen = false;
  }

  // Helper: Formats date to a human-friendly format
  function formatDateHuman(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date)) return 'N/A';
    return date.toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  }

  const token = sessionStorage.getItem('adminToken');

  // Utility to show success modal with message
  function showSuccess(message) {
    document.getElementById('successMessage').textContent = message;
    $('#successModal').modal('show');
  }

  // Utility to show error modal with message
  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    $('#errorModal').modal('show');
  }

  // View Resource
  function viewResourceDetails(id) {
    showSpinner();
    fetch(`/learning_resources/${id}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      hideSpinner();
      document.getElementById('viewTitle').innerText = data.title;
      document.getElementById('viewType').innerText = data.resource_type;
      document.getElementById('viewDescription').innerText = data.description;
      document.getElementById('viewContent').innerText = data.content;
      if (document.getElementById('viewCreatedAt')) {
        document.getElementById('viewCreatedAt').innerText = formatDateHuman(data.created_at);
      }
      $('#viewResourceModal').modal('show');
    })
    .catch(error => {
      hideSpinner();
      showError('Failed to load resource details.');
    });
  }

  // Edit Resource
  function editResource(id) {
    showSpinner();
    fetch(`/learning_resources/${id}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      hideSpinner();
      document.getElementById('editResourceId').value = data.resource_id;
      document.getElementById('editTitle').value = data.title;
      document.getElementById('editDescription').value = data.description;
      document.getElementById('editType').value = data.resource_type;
      document.getElementById('editContent').value = data.content;
      $('#editResourceModal').modal('show');
    })
    .catch(error => {
      hideSpinner();
      showError('Failed to load resource for editing.');
    });
  }

  // Show Delete Modal
  function deleteResource(id) {
    document.getElementById('deleteResourceId').value = id;
    $('#deleteResourceModal').modal('show');
  }

  let allLearningResources = []; // store all resources here

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('addLearningResourceForm');
    const tableBody = document.getElementById('learningResourceTableBody');
    const searchInput = document.getElementById('searchInput');

        const editForm = document.getElementById('editLearningResourceForm');
  // Handle Edit Form Submission
  editForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const resourceId = document.getElementById('editResourceId').value;

    const updatedData = {
      title: document.getElementById('editTitle').value,
      description: document.getElementById('editDescription').value,
      resource_type: document.getElementById('editType').value,
      content: document.getElementById('editContent').value
    };

    showSpinner();
    fetch(`/learning_resources/update/${resourceId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(updatedData)
    })
    .then(res => res.json())
    .then(response => {
      hideSpinner();
      if (response.success) {
        $('#editResourceModal').modal('hide');
        showSuccess('Resource updated successfully.');
        // Reload resources after editing
        loadAllLearningResources();
      } else {
        showError('Failed to update resource.');
      }
    })
    .catch(err => {
      hideSpinner();
      console.error('Update error:', err);
      showError('Something went wrong while updating.');
    });
  });

    // Function for rendering filtered data
    function renderLearningResources(filteredResources) {
      tableBody.innerHTML = '';
      filteredResources.forEach(resource => {
        const row = `<tr>
          <td>${resource.title}</td>
          <td>${resource.description}</td>
          <td>${resource.resource_type}</td>
          <td>${resource.content}</td>
          <td>${formatDateHuman(resource.created_at)}</td>
          <td>
            <button type="button" class="btn btn-info" onclick="event.preventDefault(); viewResourceDetails(${resource.resource_id})">View</button>
            <button type="button" class="btn btn-warning" onclick="event.preventDefault(); editResource(${resource.resource_id})">Edit</button>
            <button type="button" class="btn btn-danger" onclick="event.preventDefault(); deleteResource(${resource.resource_id})">Delete</button>
          </td>
        </tr>`;
        tableBody.insertAdjacentHTML('beforeend', row);
      });
    }

    // Search/filter client-side
    searchInput.addEventListener('input', function () {
      const searchTerm = this.value.trim().toLowerCase();
      const filtered = allLearningResources.filter(resource => {
        const combinedText = `${resource.title} ${resource.description} ${resource.resource_type} ${resource.content}`.toLowerCase();
        return combinedText.includes(searchTerm);
      });
      renderLearningResources(filtered);
    });

    // Handle Confirm Delete Button Click
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
      const id = document.getElementById('deleteResourceId').value;
      showSpinner();
      fetch(`/learning_resources/delete/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(response => {
        hideSpinner();
        if (response.success) {
          $('#deleteResourceModal').modal('hide');
          showSuccess('Resource deleted successfully.');
          // Remove from local array and update table
          allLearningResources = allLearningResources.filter(r => r.resource_id != id);
          renderLearningResources(allLearningResources.filter(resource => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const combinedText = `${resource.title} ${resource.description} ${resource.resource_type} ${resource.content}`.toLowerCase();
            return combinedText.includes(searchTerm);
          }));
        } else {
          showError('Delete failed.');
        }
      })
      .catch(error => {
        hideSpinner();
        console.error('Delete error:', error);
        showError('Something went wrong while deleting.');
      });
    });

    // Handle Add Form Submission
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const data = {
        title: document.getElementById('resourceTitle').value,
        description: document.getElementById('resourceDescription').value,
        resource_type: document.getElementById('resourceType').value,
        content: document.getElementById('resourceContent').value
      };

      showSpinner();
      fetch('/add_learning_resources', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        hideSpinner();
        if (response.success) {
          $('#addLearningResourceModal').modal('hide');
          form.reset();
          showSuccess('Resource added successfully.');
          // Fetch all resources again to sync state
          loadAllLearningResources();
        } else {
          showError('Error saving resource.');
        }
      })
      .catch(error => {
        hideSpinner();
        console.error('Add error:', error);
        showError('Something went wrong while adding.');
      });
    });

    // Load all resources and store in memory
    function loadAllLearningResources() {
      showSpinner();
      fetch('/learning_resources', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        hideSpinner();
        allLearningResources = data;
        // Initially display all
        renderLearningResources(allLearningResources);
      })
      .catch(error => {
        hideSpinner();
        showError('Failed to load learning resources.');
      });
    }

    // Initial load
    loadAllLearningResources();
  });
</script>
<!-- Script for adding and displaying learning resources (End) -->

  <!-- Script for inserting, editing,deleting and display details of training modules (Start) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Spinner logic
  function showSpinner() {
    if (!window._spinnerOpen) {
      $('#loadingSpinnerModal').modal({
        backdrop: 'static',
        keyboard: false
      });
      window._spinnerOpen = true;
    }
  }
  function hideSpinner() {
    $('#loadingSpinnerModal').modal('hide');
    window._spinnerOpen = false;
  }

  const PAGE_SIZE = 40; // Change this to set rows per page
  let allModules = [];
  let filteredModules = [];
  let currentPage = 1;

    const createModuleBtn = document.getElementById("createModuleBtn");
    const moduleModal = new bootstrap.Modal(document.getElementById("createModuleModal"));
    const editModal = new bootstrap.Modal(document.getElementById("editModuleModal"));
    const deleteModal = new bootstrap.Modal(document.getElementById("deleteModuleModal"));
    const successModal = new bootstrap.Modal(document.getElementById("successModal"));
    const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
    const moduleForm = document.getElementById("createModuleForm");

    const token = sessionStorage.getItem("adminToken");
    if (!token) {
      document.getElementById("errorMessage").textContent = "Authentication token missing. Please login again.";
      errorModal.show();
      return;
    }

    createModuleBtn.addEventListener("click", function (e) {
      e.preventDefault();
      moduleModal.show();
    });

moduleForm.addEventListener("submit", function (event) {
      event.preventDefault();

      const formData = new FormData(moduleForm);
      const data = {};
      formData.forEach((value, key) => { data[key] = value });

      showSpinner();
      fetch("/insert_module", {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        hideSpinner();
        moduleModal.hide();
        if (data.message === "Module added successfully") {
          setTimeout(() => {
            document.getElementById("successMessage").textContent = "Module added successfully.";
            successModal.show();
            moduleForm.reset();
            fetchModules();
          }, 300);
        } else {
          document.getElementById("errorMessage").textContent = data.message || "Failed to add module.";
          errorModal.show();
        }
      })
      .catch(err => {
        hideSpinner();
        console.error(err);
        document.getElementById("errorMessage").textContent = "An unexpected error occurred.";
        errorModal.show();
      });
    });

document.getElementById("editModuleForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const moduleId = document.getElementById("editModuleId").value;
      const updatedModule = {
        module_name: document.getElementById("editModuleName").value,
        description: document.getElementById("editModuleDescription").value,
        deadline: document.getElementById("editModuleDeadline").value,
      };

      showSpinner();
      fetch(`/update_module/${moduleId}`, {
        method: "PUT",
        body: JSON.stringify(updatedModule),
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        hideSpinner();
        editModal.hide();
        if (data.success) {
          setTimeout(() => {
            document.getElementById("successMessage").textContent = "Module updated successfully.";
            successModal.show();
            fetchModules();
          }, 300);
        } else {
          document.getElementById("errorMessage").textContent = data.message || "Failed to update module.";
          errorModal.show();
        }
      })
      .catch(err => {
        hideSpinner();
        console.error(err);
        document.getElementById("errorMessage").textContent = "An unexpected error occurred.";
        errorModal.show();
      });
    });

 document.getElementById("confirmDeleteModule").addEventListener("click", function () {
      const moduleId = document.getElementById("deleteModuleId").value;
      showSpinner();
      fetch(`/delete_module/${moduleId}`, {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        hideSpinner();
        if (data.success) {
          deleteModal.hide();
          setTimeout(() => {
            document.getElementById("successMessage").textContent = "Module deleted successfully.";
            successModal.show();
            fetchModules();
          }, 300);
        } else {
          document.getElementById("errorMessage").textContent = data.message || "Failed to delete module.";
          errorModal.show();
        }
      })
      .catch(err => {
        hideSpinner();
        console.error(err);
        document.getElementById("errorMessage").textContent = "An unexpected error occurred.";
        errorModal.show();
      });
    });

function fetchModules() {
    showSpinner();
    fetch("/get_modules", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      hideSpinner();
      allModules = data.modules || [];
      filteredModules = allModules.slice();
      currentPage = 1;
      renderModuleTable();
      renderPagination();
    })
    .catch(() => {
      hideSpinner();
    });
  }

    // Helper: Formats date to a human-friendly format, e.g. "Jun 3, 2025, 11:26 AM"
function formatDateHuman(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  if (isNaN(date)) return 'N/A';
  // Example: "Jun 3, 2025, 11:26 AM"
  return date.toLocaleString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
}

// Helper: Formats date to YYYY-MM-DD for <input type="date">
function formatDateForInput(dateString) {
  const date = new Date(dateString);
  if (isNaN(date)) return "";
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
}

function renderModuleTable() {
    const tableBody = document.getElementById("moduleTableBody");
    if (!tableBody) return;
    tableBody.innerHTML = "";

    // Calculate displayed items for current page
    const startIdx = (currentPage - 1) * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageModules = filteredModules.slice(startIdx, endIdx);

    if (pageModules.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No modules found.</td></tr>`;
      return;
    }

    pageModules.forEach(module => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${module.module_name}</td>
        <td>${formatDateHuman(module.created_at)}</td>
        <td>${formatDateHuman(module.updated_at)}</td>
        <td>
          <button type="button" class="btn btn-success view-module-btn" data-name="${module.module_name}" data-description="${module.description}" data-deadline="${module.deadline}">View</button>
          <button type="button" class="btn btn-info edit-module-btn" data-id="${module.module_id}" data-name="${module.module_name}" data-description="${module.description}" data-deadline="${module.deadline}">Edit</button>
          <button type="button" class="btn btn-danger delete-module-btn" data-id="${module.module_id}" data-name="${module.module_name}">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    attachViewEventListeners();
    attachEditModuleEventListeners();
    attachDeleteEventListeners();
  }


  function renderPagination() {
    const paginationWrapper = document.getElementById("moduleTablePagination");
    if (!paginationWrapper) return;
    paginationWrapper.innerHTML = "";

    const totalItems = filteredModules.length;
    const totalPages = Math.ceil(totalItems / PAGE_SIZE);
    if (totalPages <= 1) return;

    // Helper to create page buttons
    function createPageBtn(page, label = null, isActive = false, isDisabled = false) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
      btn.textContent = label || page;
      btn.disabled = isDisabled;
      btn.addEventListener('click', () => {
        currentPage = page;
        renderModuleTable();
        renderPagination();
      });
      return btn;
    }

    // Prev button
    paginationWrapper.appendChild(createPageBtn(currentPage - 1, 'Prev', false, currentPage === 1));

    // Smart page numbers
    if (totalPages <= 7) {
      for (let page = 1; page <= totalPages; page++) {
        paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
      }
    } else {
      paginationWrapper.appendChild(createPageBtn(1, null, currentPage === 1));
      if (currentPage > 4) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.className = 'mx-1';
        paginationWrapper.appendChild(dots);
      }
      let start = Math.max(2, currentPage - 1);
      let end = Math.min(totalPages - 1, currentPage + 1);
      for (let page = start; page <= end; page++) {
        paginationWrapper.appendChild(createPageBtn(page, null, page === currentPage));
      }
      if (currentPage < totalPages - 3) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.className = 'mx-1';
        paginationWrapper.appendChild(dots);
      }
      paginationWrapper.appendChild(createPageBtn(totalPages, null, currentPage === totalPages));
    }

    // Next button
    paginationWrapper.appendChild(createPageBtn(currentPage + 1, 'Next', false, currentPage === totalPages));
  }

  const ModulesearchInput = document.getElementById("moduleSearch");
  if (ModulesearchInput) {
    ModulesearchInput.addEventListener("input", function () {
      const filter = this.value.toLowerCase();
      filteredModules = allModules.filter(module =>
        module.module_name.toLowerCase().includes(filter) ||
        (module.description && module.description.toLowerCase().includes(filter)) ||
        (module.deadline && formatDateHuman(module.deadline).toLowerCase().includes(filter))
      );
      currentPage = 1;
      renderModuleTable();
      renderPagination();
    });
  }

function attachViewEventListeners() {
  document.querySelectorAll(".view-module-btn").forEach(button => {
    button.addEventListener("click", function () {
      document.getElementById("viewModuleName").textContent = this.dataset.name;
      document.getElementById("viewModuleDescription").textContent = this.dataset.description;
      document.getElementById("viewModuleDeadline").textContent = formatDateHuman(this.dataset.deadline);
      new bootstrap.Modal(document.getElementById("viewModuleModal")).show();
    });
  });
}

    function attachEditModuleEventListeners() {
      document.querySelectorAll(".edit-module-btn").forEach(button => {
        button.addEventListener("click", function () {
          document.getElementById("editModuleId").value = this.dataset.id;
          document.getElementById("editModuleName").value = this.dataset.name;
          document.getElementById("editModuleDescription").value = this.dataset.description;
          document.getElementById("editModuleDeadline").value = formatDateForInput(this.dataset.deadline);
          editModal.show();
        });
      });
    }

    function attachDeleteEventListeners() {
      document.querySelectorAll(".delete-module-btn").forEach(button => {
        button.addEventListener("click", function () {
          document.getElementById("deleteModuleId").value = this.dataset.id;
          deleteModal.show();
        });
      });
    }

    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
    }

    // Add search filter
    const searchInput = document.getElementById("moduleSearch");
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        document.querySelectorAll("#moduleTableBody tr").forEach(row => {
          const match = row.textContent.toLowerCase().includes(filter);
          row.style.display = match ? "" : "none";
        });
      });
    }

    fetchModules();
  });
</script>
  <!-- Script for inserting, editing,deleting and display details of training modules (End) -->

<!-- Script for inserting, editing,deleting and display details of skill assessments (Start) -->
<script>
   // Spinner logic
  function showSpinner() {
    if (!window._spinnerOpen) {
      $('#loadingSpinnerModal').modal({
        backdrop: 'static',
        keyboard: false
      });
      window._spinnerOpen = true;
    }
  }
  function hideSpinner() {
    $('#loadingSpinnerModal').modal('hide');
    window._spinnerOpen = false;
  }
  function formatDateHuman(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date)) return 'N/A';
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}
function formatDateToInput(dateStr) {
    if (!dateStr) return "";
    return dateStr.split('T')[0];
}
    document.addEventListener("DOMContentLoaded", function () {
      const ASSESSMENT_PAGE_SIZE = 40; 
let allAssessments = [];
let filteredAssessments = [];
let currentAssessmentPage = 1;

document.addEventListener("click", function(e) {
      if (e.target && e.target.classList.contains("clear-score-btn")) {
        const assessmentId = e.target.getAttribute("data-id");
        $("#confirmClearScoreModal").modal('show')
        document.getElementById("confirmClearScoreButton").onclick = function () {
          const headers = getAuthHeaders();
          if (!headers) return;

          showSpinner();
          fetch(`/update_assessment/${assessmentId}`, {
            method: "PUT",
            headers: headers,
            body: JSON.stringify({ score: null, is_completed: false })
          })
          .then(res => {
            hideSpinner();
            if (!res.ok) throw new Error("Failed to clear score");
            return res.json();
          })
          .then(data => {
            if (data.success) {
              showSuccessModal("Score cleared successfully.");
              fetchSkillAssessments();
              $("#confirmClearScoreModal").modal('hide')
            } else {
              showErrorModal("Failed to clear score.");
            }
          })
          .catch(err => {
            hideSpinner();
            showErrorModal("Something went wrong: " + err.message);
          });
        };
      }
    });

// Function to get authorization headers with token
        function getAuthHeaders() {
            const token = sessionStorage.getItem('adminToken');
            if (!token) {
                console.error('No admin token found in sessionStorage');
                alert('Authentication token not found. Please log in again.');
                // Optionally redirect to login page
                // window.location.href = '/login';
                return null;
            }
            
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            };
        }

            // Function to show success modal
    function showSuccessModal(message) {
        document.getElementById("successMessage").textContent = message;
        $("#successModal").modal("show");
    }

    // Function to show error modal
    function showErrorModal(message) {
    document.getElementById("errorMessage").textContent = message;
    $("#errorModal").modal("show");
}

    // Function to hide a modal and wait for it to be fully hidden
    function hideModal(modalId) {
        return new Promise((resolve) => {
            const modalElement = $("#" + modalId);
            modalElement.one('hidden.bs.modal', resolve);
            modalElement.modal("hide");
        });
    }

        // Ensure that the table body element exists before manipulating it
        const tableBody = document.getElementById("assessmentTableBody");
        if (!tableBody) {
            console.error("Element with id 'assessmentTableBody' not found");
            return;
        }
        
        console.log("DOM loaded. Checking for edit-add-question-btn...");
        const addQuestionButton = document.getElementById("addQuestionBtn");

        if (addQuestionButton) {
            console.log("Button found. Adding event listener...");
            addQuestionButton.addEventListener("click", () => {
                const container = document.getElementById("edit-questions-container");
                const newBlock = createEditableQuestionBlock({ question_text: "", options: [] });
                container.appendChild(newBlock);
            });
        } else {
            console.error("Edit add question button not found!");
        }

function fetchSkillAssessments() {
  const headers = getAuthHeaders();
  if (!headers) return;
  showSpinner();
  fetch("/get_assessments", {
    method: "GET",
    headers: headers
  })
  .then(response => {
    hideSpinner();
    if (!response.ok) {
      if (response.status === 401) {
        showErrorModal("Authentication failed. Please log in again.");
        return;
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    allAssessments = data.assessments || [];
    filteredAssessments = allAssessments.slice();
    currentAssessmentPage = 1;
    renderAssessmentTable();
    renderAssessmentPagination();
  })
  .catch(error => {
    hideSpinner();
    console.error("Error fetching assessments:", error);
    showErrorModal("Failed to fetch assessments. Please try again.");
  });
}

function renderAssessmentTable() {
  const tableBody = document.getElementById("assessmentTableBody");
  tableBody.innerHTML = "";
  const startIdx = (currentAssessmentPage - 1) * ASSESSMENT_PAGE_SIZE;
  const endIdx = startIdx + ASSESSMENT_PAGE_SIZE;
  const pageItems = filteredAssessments.slice(startIdx, endIdx);

  if (pageItems.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No skill assessments available.</td></tr>`;
    return;
  }

  pageItems.forEach(assessment => {
    const hasScore = assessment.score !== null && assessment.score !== undefined && assessment.score !== "";
    const row = `
      <tr>
          <td>${assessment.employee_id}</td>
          <td>${assessment.module_name}</td>
          <td>${formatDateHuman(assessment.assessment_date)}</td>
          <td>${hasScore ? assessment.score : 'No score'}</td>
          <td>${assessment.feedback}</td>
          <td>
              <button class="btn btn-success view-btn" 
                  data-id="${assessment.assessment_id}"
                  data-employee="${assessment.employee_id}" 
                  data-skill="${assessment.module_name}" 
                  data-date="${assessment.assessment_date}" 
                  data-score="${assessment.score}" 
                  data-feedback="${assessment.feedback}">
                  View
              </button>
              <button class="btn btn-info edit-btn" 
                  data-id="${assessment.assessment_id}" 
                  data-module-id="${assessment.module_id}" 
                  data-date="${assessment.assessment_date}" 
                  data-score="${assessment.score}" 
                  data-feedback="${assessment.feedback}">
                  Edit
              </button>
              <button class="btn btn-danger delete-btn" data-id="${assessment.assessment_id}">
                  Delete
              </button>
              ${hasScore 
                  ? `<button class="btn btn-warning clear-score-btn" data-id="${assessment.assessment_id}">Clear Score</button>`
                  : ""
              }
          </td>
      </tr>
    `;
    tableBody.innerHTML += row;
  });
  attachEventListeners();
  attachEditEventListeners();
}

function renderAssessmentPagination() {
  const paginationWrapper = document.getElementById("assessmentTablePagination");
  paginationWrapper.innerHTML = "";

  const totalItems = filteredAssessments.length;
  const totalPages = Math.ceil(totalItems / ASSESSMENT_PAGE_SIZE);
  if (totalPages <= 1) return;

  function createPageBtn(page, label = null, isActive = false, isDisabled = false) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
    btn.textContent = label || page;
    btn.disabled = isDisabled;
    btn.addEventListener('click', () => {
      currentAssessmentPage = page;
      renderAssessmentTable();
      renderAssessmentPagination();
    });
    return btn;
  }

  // Prev button
  paginationWrapper.appendChild(createPageBtn(currentAssessmentPage - 1, 'Prev', false, currentAssessmentPage === 1));

  // Smart page numbers
  if (totalPages <= 7) {
    for (let page = 1; page <= totalPages; page++) {
      paginationWrapper.appendChild(createPageBtn(page, null, page === currentAssessmentPage));
    }
  } else {
    paginationWrapper.appendChild(createPageBtn(1, null, currentAssessmentPage === 1));
    if (currentAssessmentPage > 4) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'mx-1';
      paginationWrapper.appendChild(dots);
    }
    let start = Math.max(2, currentAssessmentPage - 1);
    let end = Math.min(totalPages - 1, currentAssessmentPage + 1);
    for (let page = start; page <= end; page++) {
      paginationWrapper.appendChild(createPageBtn(page, null, page === currentAssessmentPage));
    }
    if (currentAssessmentPage < totalPages - 3) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'mx-1';
      paginationWrapper.appendChild(dots);
    }
    paginationWrapper.appendChild(createPageBtn(totalPages, null, currentAssessmentPage === totalPages));
  }

  // Next button
  paginationWrapper.appendChild(createPageBtn(currentAssessmentPage + 1, 'Next', false, currentAssessmentPage === totalPages));
}


    // SEARCH/FILTER FOR SKILL ASSESSMENT TABLE
document.getElementById("assessmentSearchInput").addEventListener("input", function () {
  const query = this.value.toLowerCase();
  filteredAssessments = allAssessments.filter(a => 
    (typeof a.employee_id === "string" && a.employee_id.toLowerCase().includes(query)) ||
    (typeof a.employee_id === "number" && a.employee_id.toString().toLowerCase().includes(query)) || // handles numbers
    (typeof a.module_name === "string" && a.module_name.toLowerCase().includes(query)) ||
    (a.assessment_date && formatDateHuman(a.assessment_date).toLowerCase().includes(query)) ||
    (a.feedback && typeof a.feedback === "string" && a.feedback.toLowerCase().includes(query)) ||
    (a.score !== null && a.score !== undefined && String(a.score).toLowerCase().includes(query))
  );
  currentAssessmentPage = 1;
  renderAssessmentTable();
  renderAssessmentPagination();
});

        document.getElementById("confirmDeleteAssessment").addEventListener("click", function () {
            const assessmentId = document.getElementById("deleteAssessmentId").value;
            const headers = getAuthHeaders();
            if (!headers) return;
            showSpinner();
            fetch(`/delete_assessment/${assessmentId}`, {
                method: "DELETE",
                headers: headers
            })
            .then(response => {
              hideSpinner();
                if (!response.ok) {
                    if (response.status === 401) {
                        showErrorModal("Authentication failed. Please log in again.");
                        return;
                    }
                    return response.json().then(data => { 
                        throw new Error(data.error || "Error deleting assessment"); 
                    });
                }
                return response.json();
            })
            .then(data => {               
                console.log("Delete success:", data);
                showSuccessModal("Delete success", data);
                hideModal("deleteSkillAssessmentModal");
                fetchSkillAssessments();
            })
            .catch(error => {
              hideSpinner();
                console.error("Delete error:", error);
                showErrorModal("Failed to delete assessment" + error.message);
            });
        });

        function attachEventListeners() {
        document.querySelectorAll(".view-btn").forEach(button => {
            button.addEventListener("click", function () {
                const assessmentId = this.getAttribute("data-id");
                const headers = getAuthHeaders();
                if (!headers) return;
                showSpinner();
                fetch(`/get_assessment_details/${assessmentId}`, {
                    method: "GET",
                    headers: headers
                })
                    .then(response => {
                        hideSpinner();
                        if (!response.ok) {
                            if (response.status === 401) {
                                showErrorModal("Authentication failed. Please log in again.");
                                return;
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.success) {
                            showErrorModal("Error loading details" + data.message);
                            return;
                        }

                        const a = data.assessment;
                        document.getElementById("viewEmployeeId").textContent = a.employee_id;
                        document.getElementById("viewEmployeeEmailAssessment").textContent = a.email;
                        document.getElementById("viewSkillName").textContent = a.skill_name;
                        document.getElementById("viewAssessmentDate").textContent = formatDateHuman(a.assessment_date);
                        document.getElementById("viewScore").textContent = a.score || 'No score';
                        document.getElementById("viewFeedback").textContent = a.feedback;

                        const container = document.getElementById("viewQuestionsContainer");
                        container.innerHTML = ""; 

                        a.questions.forEach((q, i) => {
                            const qDiv = document.createElement("div");
                            qDiv.classList.add("mb-3");
                            const qHtml = `<p><strong>Q${i + 1}:</strong> ${q.question_text}</p>`;
                            const oHtml = q.options.map(opt =>
                                `<li class="${opt.is_checked ? 'text-success fw-bold' : ''}">
                                    ${opt.option_text} ${opt.is_checked ? 'âœ…' : ''}
                                </li>`
                            ).join("");
                            qDiv.innerHTML = `${qHtml}<ul>${oHtml}</ul>`;
                            container.appendChild(qDiv);
                        });
                        new bootstrap.Modal(document.getElementById("viewSkillAssessmentModal")).show();
                    })
                    .catch(error => {
                      hideSpinner();
                        console.error("Failed to load assessment details:", error);
                        showErrorModal("Failed to fetch assessment details.");
                    });
            });
        });

            document.querySelectorAll(".delete-btn").forEach(button => {
                button.addEventListener("click", function () {
                    document.getElementById("deleteAssessmentId").value = this.getAttribute("data-id");
                    $('#deleteSkillAssessmentModal').modal('show');
                });
            });

        }

        function fetchTrainingModules() {
            const headers = getAuthHeaders();
            if (!headers) return;
            showSpinner();
            return fetch("/get_modules", {
                method: "GET",
                headers: headers
            })
                .then(response => {
                  hideSpinner();
                    if (!response.ok) {
                        if (response.status === 401) {
                            showErrorModal("Authentication failed. Please log in again.");
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const moduleSelect = document.getElementById("editModule");
                    moduleSelect.innerHTML = "";
                    data.modules.forEach(module => {
                        const option = document.createElement("option");
                        option.value = module.module_id;
                        option.textContent = module.module_name;
                        moduleSelect.appendChild(option);
                    });
                })
                .catch(error => {
                  hideSpinner();
                    console.error("Error fetching training modules:", error);
                    showErrorModal("Failed to fetch training modules. Please try again.");
                });
        }

        // Function to create a block of question with options
        function createEditableQuestionBlock(question) {
            console.debug("Creating editable question block for:", question);

            const questionDiv = document.createElement("div");
            questionDiv.classList.add("question-block");

            // Question input field
            const questionInput = document.createElement("input");
            questionInput.type = "text";
            questionInput.value = question.question_text;
            questionInput.placeholder = "Enter question text";
            questionInput.classList.add("form-control", "mb-2");
            questionInput.name = "questions[]";
            questionDiv.appendChild(questionInput);

            console.debug(`Created question input for: ${question.question_text}`);

            // Container for options
            const optionsContainer = document.createElement("div");

            console.debug(`Creating options for question ID: ${question.question_id}`);
            question.options.forEach((option, index) => {
                console.debug(`Creating option #${index + 1} for question ID: ${question.question_id}`);

                const optionDiv = document.createElement("div");
                optionDiv.classList.add("form-group", "d-flex", "align-items-center", "gap-2", "mb-1");

                const optionInput = document.createElement("input");
                optionInput.type = "text";
                optionInput.value = option.option_text;
                optionInput.placeholder = "Option text";
                optionInput.classList.add("form-control", "me-2", "option-text");
                optionInput.name = `questions[${question.question_id}][options][${index}]`;

                console.debug(`Option #${index + 1} text: ${option.option_text}`);

                // Create checkbox for correct answer
                const isCorrectCheckbox = document.createElement("input");
                isCorrectCheckbox.type = "checkbox";
                isCorrectCheckbox.classList.add("form-check-input", "is-correct");
                isCorrectCheckbox.name = `questions[${question.question_id}][options][${index}][is_checked]`;
                isCorrectCheckbox.checked = option.is_checked;

                console.debug(`Option #${index + 1} is_checked state: ${option.is_checked}`);

                const checkboxLabel = document.createElement("label");
                checkboxLabel.classList.add("form-check-label");
                checkboxLabel.textContent = "Correct Answer";

                optionDiv.appendChild(optionInput);
                optionDiv.appendChild(isCorrectCheckbox);
                optionDiv.appendChild(checkboxLabel);

                const removeOptionBtn = document.createElement("button");
                removeOptionBtn.type = "button";
                removeOptionBtn.classList.add("btn", "btn-danger");
                removeOptionBtn.textContent = "Remove Option";
                removeOptionBtn.addEventListener("click", () => {
                    console.debug(`Removing option #${index + 1} for question ID: ${question.question_id}`);
                    optionDiv.remove();
                });

                optionDiv.appendChild(removeOptionBtn);
                optionsContainer.appendChild(optionDiv);
            });

            // Add new option button for this question
            const addOptionBtn = document.createElement("button");
            addOptionBtn.type = "button";
            addOptionBtn.classList.add("btn", "btn-secondary", "mt-2");
            addOptionBtn.textContent = "Add Option";
            addOptionBtn.addEventListener("click", () => {
                console.debug(`Adding new option for question ID: ${question.question_id}`);
                const optionDiv = document.createElement("div");
                optionDiv.classList.add("d-flex", "mb-2");

                const optionInput = document.createElement("input");
                optionInput.type = "text";
                optionInput.placeholder = "Option text";
                optionInput.classList.add("form-control", "me-2", "option-text");

                const isCorrectCheckbox = document.createElement("input");
                isCorrectCheckbox.type = "checkbox";
                isCorrectCheckbox.classList.add("form-check-input", "is-correct");

                const checkboxLabel = document.createElement("label");
                checkboxLabel.classList.add("form-check-label");
                checkboxLabel.textContent = "Correct Answer";

                optionDiv.appendChild(optionInput);
                optionDiv.appendChild(isCorrectCheckbox);
                optionDiv.appendChild(checkboxLabel);

                const removeOptionBtn = document.createElement("button");
                removeOptionBtn.type = "button";
                removeOptionBtn.classList.add("btn", "btn-danger");
                removeOptionBtn.textContent = "Remove Option";
                removeOptionBtn.addEventListener("click", () => {
                    console.debug("Removing newly added option");
                    optionDiv.remove();
                });

                optionDiv.appendChild(removeOptionBtn);
                optionsContainer.appendChild(optionDiv);
            });

            console.debug(`Adding new option button for question ID: ${question.question_id}`);
            questionDiv.appendChild(optionsContainer);
            questionDiv.appendChild(addOptionBtn);

            // Button to remove this question
            const removeQuestionBtn = document.createElement("button");
            removeQuestionBtn.type = "button";
            removeQuestionBtn.classList.add("btn", "btn-danger", "mt-2");
            removeQuestionBtn.textContent = "Remove Question";
            removeQuestionBtn.addEventListener("click", () => {
                console.debug(`Removing question ID: ${question.question_id}`);
                questionDiv.remove();
            });

            questionDiv.appendChild(removeQuestionBtn);

            console.debug(`Editable question block for question ID ${question.question_id} created successfully`);

            return questionDiv;
        }
      function formatDateToInput(dateStr) {
    if (!dateStr) return "";
    // Handles both 'YYYY-MM-DD' and 'YYYY-MM-DDTHH:MM:SS'
    return dateStr.split('T')[0];
}

function attachEditEventListeners() {
    document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", function () {
            const assessmentId = this.getAttribute("data-id");
            document.getElementById("editSkillAssessmentId").value = assessmentId;
            const headers = getAuthHeaders();
            if (!headers) return;

            fetch(`/get_assessment_details/${assessmentId}`, {
                method: "GET",
                headers: headers
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            showErrorModal("Authentication failed. Please log in again.");
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const a = data.assessment;

                        // Set all main fields
                        document.getElementById("editEmployeeId").value = a.employee_id || "";
                        document.getElementById("editSkillName").value = a.skill_name || ""; // Only if you want to display name
                        document.getElementById("editAssessmentDate").value = formatDateToInput(a.assessment_date) || "";
                        document.getElementById("editScore").value = a.score || "";
                        document.getElementById("editFeedback").value = a.feedback || "";
                        const clearBtn = document.getElementById("clearScoreBtn");
                    if (clearBtn) {
                        clearBtn.onclick = function () {
                            // Open confirmation modal
                             $("#confirmClearScoreModal").modal('show')

                            document.getElementById("confirmClearScoreButton").onclick = function () {
                                const headers = getAuthHeaders();
                                if (!headers) return;

                                fetch(`/update_assessment/${assessmentId}`, {
                                    method: "PUT",
                                    headers: headers,
                                    body: JSON.stringify({ score: null })
                                })
                                .then(res => {
                                    if (!res.ok) throw new Error("Failed to clear score");
                                    return res.json();
                                })
                                .then(data => {
                                    if (data.success) {
                                        showSuccessModal("Score cleared successfully.");
                                        document.getElementById("editScore").value = "";
                                        fetchSkillAssessments();
                                        $("#confirmClearScoreModal").modal('hide')
                                    } else {
                                        showErrorModal("Failed to clear score.");
                                    }
                                })
                                .catch(err => {
                                    showErrorModal("Something went wrong: " + err.message);
                                });
                            };
                        };
                    }

                        // Set module dropdown if available
                        const moduleSelect = document.getElementById("editModule");
                        if (moduleSelect && a.module_id) {
                            moduleSelect.value = a.module_id;
                        }

                        // Clear and repopulate questions/options
                        const container = document.getElementById("edit-questions-container");
                        container.innerHTML = "";
                        if (Array.isArray(a.questions)) {
                            a.questions.forEach(q => {
                                const block = createEditableQuestionBlock(q);
                                container.appendChild(block);
                            });
                        }

                        // Open the modal
                        $('#editSkillAssessmentModal').modal('show');
                    } else {
                        showErrorModal("Error loading assessment details: " + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error("Failed to fetch assessment details for editing:", error);
                    showErrorModal("Failed to fetch assessment details for editing.");
                });
        });
    });
}
  

// Button to add new question
        document.getElementById("addQuestionBtn").addEventListener("click", () => {
            const container = document.getElementById("edit-questions-container");
            const newBlock = createEditableQuestionBlock({ question_text: "", options: [] });
            container.appendChild(newBlock);
            console.debug("Added new question block.");
        });

        // Adding a new question with basic template
        document.getElementById("add-question-btn").addEventListener("click", () => {
            const qIndex = document.querySelectorAll(".question-block").length;
            const container = document.createElement("div");
            container.classList.add("question-block", "border", "p-2", "mt-2");

            container.innerHTML = `
                <div class="form-group">
                    <label>Question</label>
                    <input type="text" class="form-control question-text" placeholder="Enter question text" required>
                </div>
                <div class="options-container"></div>
                <button type="button" class="btn btn-sm btn-outline-primary add-option-btn">Add Option</button>
                <button type="button" class="btn btn-sm btn-outline-danger remove-question-btn float-end">Remove Question</button>
            `;

            document.getElementById("questions-container").appendChild(container);
            setupOptionButtons(container);
            console.debug(`New question block added. Total questions: ${qIndex + 1}`);
        });

        // Setup option buttons
        function setupOptionButtons(container) {
            const addBtn = container.querySelector(".add-option-btn");
            const optionContainer = container.querySelector(".options-container");

            addBtn.addEventListener("click", () => {
                const optIndex = optionContainer.children.length;
                const optionDiv = document.createElement("div");
                optionDiv.classList.add("form-group", "d-flex", "align-items-center", "gap-2", "mb-1");

                optionDiv.innerHTML = `
                    <input type="text" class="form-control option-text" placeholder="Option text" required>
                    <label class="ms-2">
                        <input type="checkbox" class="form-check-input is-correct"> Mark as correct option
                    </label>
                    <button type="button" class="btn btn-sm btn-danger remove-option-btn">âœ–</button>
                `;

                optionContainer.appendChild(optionDiv);

                optionDiv.querySelector(".remove-option-btn").addEventListener("click", () => {
                    console.debug("Removing option:", optionDiv);
                    optionDiv.remove();
                });
            });

            container.querySelector(".remove-question-btn").addEventListener("click", () => {
                console.debug("Removing question:", container);
                container.remove();
            });
        }

        // Submitting the edited form
        document.getElementById("editSkillAssessmentForm").addEventListener("submit", function (e) {
            e.preventDefault();  // Prevent default form submission
            console.debug("Form submission started.");

            const assessmentId = document.getElementById("editSkillAssessmentId").value;
            const moduleId = document.getElementById("editModule").value;
            const assessmentDate = document.getElementById("editAssessmentDate").value;
            const score = document.getElementById("editScore").value;
            const feedback = document.getElementById("editFeedback").value;

            console.debug(`Form values: 
                assessmentId: ${assessmentId},
                moduleId: ${moduleId},
                assessmentDate: ${assessmentDate},
                score: ${score},
                feedback: ${feedback}`);

            const questions = [];
            const questionBlocks = document.querySelectorAll("#edit-questions-container .question-block");
            console.debug(`Found ${questionBlocks.length} question blocks.`);

            questionBlocks.forEach((block, index) => {
                console.debug(`Processing question block #${index + 1}`);

                const questionTextInput = block.querySelector("input[name='questions[]']");
                const optionsInputs = block.querySelectorAll(".option-text");
                const checkboxes = block.querySelectorAll(".is-correct");

                console.debug(`Question text input value: ${questionTextInput ? questionTextInput.value : "No question text input"}`);
                console.debug(`Found ${optionsInputs.length} option inputs in this block.`);

                const options = [];
                optionsInputs.forEach((optionInput, j) => {
                    const isCorrectCheckbox = checkboxes[j];
                    const is_checked = isCorrectCheckbox ? isCorrectCheckbox.checked : false;

                    console.debug(`Option #${j + 1}: Text: ${optionInput.value}, Is correct: ${is_checked}`);

                    if (optionInput.value.trim() !== "") {  // Ensure the option has text
                        options.push({
                            option_text: optionInput.value,
                            is_checked: is_checked // Fixed variable name
                        });
                    }
                });

                if (questionTextInput && questionTextInput.value.trim() !== "") {
                    console.debug(`Adding question: ${questionTextInput.value} with ${options.length} options.`);
                    questions.push({
                        question_text: questionTextInput.value,
                        options: options
                    });
                } else {
                    console.debug("Skipping question due to empty question text input.");
                }
            });

            console.debug(`Total questions to be sent: ${questions.length}`);
            
            // Ensure questions array is always included, even if empty
            const payload = {
                module_id: moduleId,
                assessment_date: assessmentDate,
                score: (score === "" || score.toLowerCase() === "null") ? null : score,
                feedback: feedback,
                questions: questions.length ? questions : []  // Send empty array if no questions
            };

            console.debug("Payload to be sent to the server:", JSON.stringify(payload, null, 2));

            const headers = getAuthHeaders();
            if (!headers) return;

            fetch(`/update_assessment/${assessmentId}`, {
                method: "PUT",
                headers: headers,
                body: JSON.stringify(payload)
            })
            .then(res => {
                console.debug("Received response from server.");
                if (!res.ok) {
                    if (res.status === 401) {
                        showErrorModal("Authentication failed. Please log in again.");
                        return;
                    }
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.debug("Server response data:", data);

                if (data.success) {
                    console.debug("Assessment updated successfully.");
                    showSuccessModal("Assessment updated successfully");
                    hideModal("editSkillAssessmentModal");
                    fetchSkillAssessments(); // Refresh assessments table
                } else {
                    console.error("Update failed:", data.error);
                    showErrorModal("Failed to update assessment.");
                }
            })
            .catch(err => {
                console.error("Error updating assessment:", err);
                showErrorModal("Failed to update assessment.");
            });
        });

        document.getElementById("assignAssessmentBtn").addEventListener("click", function () {
            //new bootstrap.Modal(document.getElementById("assignAssessmentModal")).show();
            $('#assignAssessmentModal').modal('show')
        });
        
        // Fetch employees
        const employeeHeaders = getAuthHeaders();
        if (employeeHeaders) {
            fetch("/get_employees", {
                method: "GET",
                headers: employeeHeaders
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            showErrorModal("Authentication failed. Please log in again.");
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const employeeSelect = document.getElementById("employee-id");
                    data.forEach(employee => {
                        const option = document.createElement("option");
                        option.value = employee.employee_id;
                        option.textContent = employee.email || `User ID : ${employee.employee_id}`;
                        employeeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching employees:", error);
                    showErrorModal("Failed to fetch employees. Please try again.");
                });
        }
        
        // Fetch modules for assignment
        const moduleHeaders = getAuthHeaders();
        if (moduleHeaders) {
            fetch("/get_modules", {
                method: "GET",
                headers: moduleHeaders
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            showErrorModal("Authentication failed. Please log in again.");
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const skillSelect = document.getElementById("skill-name");
                    data.modules.forEach(module => {
                        const option = document.createElement("option");
                        option.value = module.module_id;
                        option.textContent = module.module_name;
                        skillSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching training modules:", error);
                    showErrorModal("Failed to fetch training modules. Please try again.");
                });
        }

document.getElementById("assignAssessmentForm").addEventListener("submit", function (event) {
    event.preventDefault();

    // Require at least one question before submitting!
    const questionBlocks = document.querySelectorAll("#questions-container .question-block");
    if (questionBlocks.length === 0) {
        showErrorModal("Please add at least one question to the assessment before submitting.");
        return;
    }

    // Optionally, you can also check that each question has at least one option
    let hasEmptyQuestion = false;
    let hasQuestionWithoutOption = false;
    questionBlocks.forEach(block => {
        const questionText = block.querySelector(".question-text").value.trim();
        if (!questionText) hasEmptyQuestion = true;
        const optionInputs = block.querySelectorAll(".option-text");
        let hasOption = false;
        optionInputs.forEach(optInput => {
            if (optInput.value.trim() !== "") hasOption = true;
        });
        if (!hasOption) hasQuestionWithoutOption = true;
    });
    if (hasEmptyQuestion) {
        showErrorModal("All questions must have text.");
        return;
    }
    if (hasQuestionWithoutOption) {
        showErrorModal("Each question must have at least one option.");
        return;
    }

    const data = {
        employee_id: document.getElementById("employee-id").value,
        module_id: document.getElementById("skill-name").value,
        assessment_date: document.getElementById("assessment-date").value,
        feedback: document.getElementById("feedback").value,
        questions: []
    };

    questionBlocks.forEach(block => {
        const questionText = block.querySelector(".question-text").value;
        const options = [];
        block.querySelectorAll(".option-text").forEach((optInput, i) => {
            options.push({
                option_text: optInput.value,
                is_checked: block.querySelectorAll(".is-correct")[i].checked
            });
        });
        data.questions.push({
            question_text: questionText,
            options: options
        });
    });

    const headers = getAuthHeaders();
    if (!headers) return;

    showSpinner();

    fetch("/assign_assessment", {
        method: "POST",
        body: JSON.stringify(data),
        headers: headers
    })
    .then(response => {
        if (!response.ok) {
            hideSpinner();
            if (response.status === 401) {
                showErrorModal("Authentication failed. Please log in again.");
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(response => {
        hideSpinner();
        if (response.success) {
            hideModal("assignAssessmentModal");
            showSuccessModal("Assessment assigned successfully!");
            document.getElementById("assignAssessmentForm").reset();
            document.getElementById("questions-container").innerHTML = "";
            fetchSkillAssessments()
        } else {
            showErrorModal("Error: " + response.message);
        }
    })
    .catch(error => {
        hideSpinner();
        console.error("Error submitting form:", error);
        showErrorModal("Something went wrong!");
    });
});

fetchSkillAssessments();
        fetchTrainingModules();
    });
    // --- Modal stacking scroll fix ---
$(document).ready(function () {
    $('#errorModal').on('hidden.bs.modal', function () {
        // If any other modal is still open, add 'modal-open' back to body
        if ($('.modal.show').length > 0) {
            $('body').addClass('modal-open');
        }
    });
});
</script>
<!-- Script for inserting, editing,deleting and display details of skill assessments (End) -->

<!-- Script for inserting, editing,deleting and display details of certificates (Start) -->
<script>
      // Spinner logic
    function showSpinner() {
        if (!window._spinnerOpen) {
            $('#loadingSpinnerModal').modal({
                backdrop: 'static',
                keyboard: false
            });
            window._spinnerOpen = true;
        }
    }
    function hideSpinner() {
        $('#loadingSpinnerModal').modal('hide');
        window._spinnerOpen = false;
    }
    // Function to get the stored token from sessionStorage
    function getAuthToken() {
        return sessionStorage.getItem('adminToken');
    }

    // Function to get headers with authentication
    function getAuthHeaders() {
        const token = getAuthToken();
        const headers = {
            "Content-Type": "application/json"
        };
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            headers["X-CSRFToken"] = csrfToken.content;
        }
        
        // Add Authorization header if token is available
        if (token) {
            headers["Authorization"] = `Bearer ${token}`;
        }
        
        return headers;
    }

    // Function to show success modal
    function showSuccessModal(message) {
        document.getElementById("successMessage").textContent = message;
        $("#successModal").modal("show");
    }

    // Function to show error modal
    function showErrorModal(message) {
        document.getElementById("errorMessage").textContent = message;
        $("#errorModal").modal("show");
    }

    // Function to hide a modal and wait for it to be fully hidden
    function hideModal(modalId) {
        return new Promise((resolve) => {
            const modalElement = $("#" + modalId);
            modalElement.one('hidden.bs.modal', resolve);
            modalElement.modal("hide");
        });
    }

    const CERT_PAGE_SIZE = 40; // Change for rows per page
let allCertificates = [];
let filteredCertificates = [];
let currentCertPage = 1;

function fetchCertificates() {
    showSpinner();
    fetch("/get_certificates", {
        headers: getAuthHeaders()
    })
    .then(response => {
        hideSpinner();
        if (response.status === 401) {
            showErrorModal("Authentication required. Please log in again.");
            return;
        }
        if (response.status === 403) {
            showErrorModal("Access denied. You don't have permission to view certificates.");
            return;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return;
        allCertificates = Array.isArray(data.certificates) ? data.certificates : [];
        filteredCertificates = allCertificates.slice();
        currentCertPage = 1;
        renderCertificateTable();
        renderCertificatePagination();
    })
    .catch(error => {
        hideSpinner();
        console.error("Error fetching certificates:", error);
        showErrorModal("An error occurred while fetching certificates.");
    });
}

function renderCertificateTable() {
    const tableBody = document.getElementById("certificateTableBody");
    tableBody.innerHTML = "";

    const startIdx = (currentCertPage - 1) * CERT_PAGE_SIZE;
    const endIdx = startIdx + CERT_PAGE_SIZE;
    const pageItems = filteredCertificates.slice(startIdx, endIdx);

    if (pageItems.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No certificates available.</td></tr>`;
        return;
    }

    pageItems.forEach(cert => {
        tableBody.innerHTML += `
            <tr>
                <td>${cert.employee_id}</td>
                <td>${cert.employee_email}</td>
                <td>${cert.module_name}</td>
                <td>${formatDateHuman(cert.issued_date)}</td>
                <td>${cert.certificate_status}</td>
                <td>${cert.score || 0}</td>
                <td>
                    <button class="btn btn-success view-certificate-btn"
                        data-id="${cert.certificate_id}"
                        data-employee="${cert.employee_email}"
                        data-module="${cert.module_name}"
                        data-date="${cert.issued_date}"
                        data-status="${cert.certificate_status}"
                        data-score="${cert.score || 0}">
                        View
                    </button>
                    <button class="btn btn-info edit-certificate-btn"
                        data-id="${cert.certificate_id}"
                        data-module-id="${cert.module_id}"
                        data-date="${cert.issued_date}"
                        data-status="${cert.certificate_status}"
                        data-score="${cert.score || 0}">
                        Edit
                    </button>
                    <button class="btn btn-danger delete-certificate-btn" data-id="${cert.certificate_id}">
                        Delete
                    </button>
                </td>
            </tr>
        `;
    });

    attachEventListeners();
}

function renderCertificatePagination() {
    const paginationWrapper = document.getElementById("certificateTablePagination");
    paginationWrapper.innerHTML = "";

    const totalItems = filteredCertificates.length;
    const totalPages = Math.ceil(totalItems / CERT_PAGE_SIZE);
    if (totalPages <= 1) return;

    function createPageBtn(page, label = null, isActive = false, isDisabled = false) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn btn-sm btn-light mx-1${isActive ? ' active' : ''}`;
        btn.textContent = label || page;
        btn.disabled = isDisabled;
        btn.addEventListener('click', () => {
            currentCertPage = page;
            renderCertificateTable();
            renderCertificatePagination();
        });
        return btn;
    }

    // Prev button
    paginationWrapper.appendChild(createPageBtn(currentCertPage - 1, 'Prev', false, currentCertPage === 1));

    // Smart page numbers
    if (totalPages <= 7) {
        for (let page = 1; page <= totalPages; page++) {
            paginationWrapper.appendChild(createPageBtn(page, null, page === currentCertPage));
        }
    } else {
        paginationWrapper.appendChild(createPageBtn(1, null, currentCertPage === 1));
        if (currentCertPage > 4) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.className = 'mx-1';
            paginationWrapper.appendChild(dots);
        }
        let start = Math.max(2, currentCertPage - 1);
        let end = Math.min(totalPages - 1, currentCertPage + 1);
        for (let page = start; page <= end; page++) {
            paginationWrapper.appendChild(createPageBtn(page, null, page === currentCertPage));
        }
        if (currentCertPage < totalPages - 3) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.className = 'mx-1';
            paginationWrapper.appendChild(dots);
        }
        paginationWrapper.appendChild(createPageBtn(totalPages, null, currentCertPage === totalPages));
    }

    // Next button
    paginationWrapper.appendChild(createPageBtn(currentCertPage + 1, 'Next', false, currentCertPage === totalPages));
}

    function setupCertificateSearch() {
    const searchInput = document.getElementById("certificateSearchInput");
    searchInput.addEventListener("input", function () {
        const query = this.value.toLowerCase();
        filteredCertificates = allCertificates.filter(cert => {
            return (
                cert.employee_email.toLowerCase().includes(query) ||
                cert.module_name.toLowerCase().includes(query) ||
                cert.certificate_status.toLowerCase().includes(query)
            );
        });
        currentCertPage = 1;
        renderCertificateTable();
        renderCertificatePagination();
    });
}
    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed.");
        try {
            fetchEmployees();
            fetchModules();
            fetchCertificates();
            handleCertificateIssue();
            setupCertificateSearch();
        } catch (error) {
            console.error("Error initializing functions:", error);
        }
    });
  
    function attachEventListeners() {
        console.log("Attaching event listeners...");
  
        document.getElementById("confirmDeleteCertificate").addEventListener("click", async function () {
            const certificateId = document.getElementById("deleteCertificateId").value;
            if (!certificateId) return;
            showSpinner();
            try {
                const response = await fetch(`/delete_certificate/${certificateId}`, {
                    method: "DELETE",
                    headers: getAuthHeaders()
                });
                hideSpinner();
                if (response.status === 401) {
                    await hideModal("deleteCertificateModal");
                    showErrorModal("Authentication required. Please log in again.");
                    return;
                }
                if (response.status === 403) {
                    await hideModal("deleteCertificateModal");
                    showErrorModal("Access denied. You don't have permission to perform this action.");
                    return;
                }

                const data = await response.json();
                
                if (data && data.success) {
                    await hideModal("deleteCertificateModal");
                    showSuccessModal("Certificate deleted successfully!");
                } else {
                    await hideModal("deleteCertificateModal");
                    showErrorModal("Error deleting certificate: " + (data.error || "Unknown error"));
                }
            } catch (error) {
                hideSpinner();
                console.error("Error deleting certificate:", error);
                await hideModal("deleteCertificateModal");
                showErrorModal("An error occurred while deleting the certificate.");
            }
        });

function formatDateToInputCert(dateStr) {
    if (!dateStr) return "";
    // Try to parse with Date constructor
    const dateObj = new Date(dateStr);
    if (isNaN(dateObj.getTime())) {
        console.warn("Could not parse date:", dateStr);
        return "";
    }
    // Format to YYYY-MM-DD
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    const formatted = `${year}-${month}-${day}`;
    console.log("formatDateToInputCert parsed:", formatted);
    return formatted;
}

document.querySelectorAll(".edit-certificate-btn").forEach(button => {
    button.addEventListener("click", function (event) {
        event.preventDefault();
        // Get all data attributes and log them
        const certificateId = event.target.dataset.id;
        const moduleId = event.target.dataset.moduleId;
        const issuedDateRaw = event.target.dataset.date;
        const issuedDate = formatDateToInputCert(issuedDateRaw);
        const certificateStatus = event.target.dataset.status;
        const score = event.target.dataset.score;

        console.log("Edit modal data:");
        console.log({
            certificateId,
            moduleId,
            issuedDateRaw,
            issuedDate,
            certificateStatus,
            score
        });

        // Populate modal fields and log after assignment
        document.getElementById("editCertificateId").value = certificateId;
        document.getElementById("editModule-Certificate").value = moduleId;
        document.getElementById("editIssuedDate").value = issuedDate;
        document.getElementById("editCertificateStatus").value = certificateStatus;
        document.getElementById("editProgressPercentage").value = score;

        // Log field values after setting
        console.log("Input values set:");
        console.log({
            editCertificateId: document.getElementById("editCertificateId").value,
            editModuleCertificate: document.getElementById("editModule-Certificate").value,
            editIssuedDate: document.getElementById("editIssuedDate").value,
            editCertificateStatus: document.getElementById("editCertificateStatus").value,
            editProgressPercentage: document.getElementById("editProgressPercentage").value
        });

        $("#editCertificateModal").modal("show");
    });
});
        document.querySelectorAll(".view-certificate-btn").forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault();
            document.getElementById("viewEmployeeEmailCertificate").textContent = this.dataset.employee;
            document.getElementById("viewModuleId").textContent = this.dataset.module;
            document.getElementById("viewIssuedDate").textContent = formatDateHuman(this.dataset.date);
            document.getElementById("viewCertificateStatus").textContent = this.dataset.status;
            document.getElementById("viewProgressPercentage").textContent = this.dataset.score;

            $("#viewCertificateModal").modal("show");
        });
    });
  
        document.getElementById("editCertificateForm").addEventListener("submit", async function(event) {
            event.preventDefault();
  
            const certificateId = document.getElementById("editCertificateId").value;
            const moduleId = document.getElementById("editModule-Certificate").value;
            const issuedDate = document.getElementById("editIssuedDate").value;
            const certificateStatus = document.getElementById("editCertificateStatus").value;
            const progress = document.getElementById("editProgressPercentage").value;
  
            const requestData = {
                module_id: moduleId,
                issued_date: issuedDate,
                certificate_status: certificateStatus,
                score: progress
            };
            showSpinner();
            try {
                const response = await fetch(`/update_certificate/${certificateId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                hideSpinner();
                if (response.status === 401) {
                    await hideModal("editCertificateModal");
                    showErrorModal("Authentication required. Please log in again.");
                    return;
                }
                if (response.status === 403) {
                    await hideModal("editCertificateModal");
                    showErrorModal("Access denied. You don't have permission to perform this action.");
                    return;
                }

                const data = await response.json();
                
                if (data && data.success) {
                    await hideModal("editCertificateModal");
                    showSuccessModal("Certificate updated successfully!");
                } else {
                    await hideModal("editCertificateModal");
                    showErrorModal("Error updating certificate: " + (data.error || "Unknown error"));
                }
            } catch (error) {
                hideSpinner();
                console.error("Error updating certificate:", error);
                await hideModal("editCertificateModal");
                showErrorModal("An error occurred while updating the certificate.");
            }
        });
  
        document.querySelectorAll(".delete-certificate-btn").forEach(button => {
            button.addEventListener("click", function (event) {
                event.preventDefault();
                document.getElementById("deleteCertificateId").value = this.dataset.id;
                $("#deleteCertificateModal").modal("show");
            });
        });
    }
  
    function fetchEmployees() {
        showSpinner();
        fetch("/get_employees", {
            headers: getAuthHeaders()
        })
        .then(response => {
            hideSpinner();
            if (response.status === 401) {
                console.warn("Authentication required for fetching employees.");
                return;
            }
            if (response.status === 403) {
                console.warn("Access denied for fetching employees.");
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return;
            
            const employeeSelect = document.getElementById("certificate-employee-id");
            employeeSelect.innerHTML = '<option value="" disabled selected>Select Employee</option>';
  
            data.forEach(emp => {
                if (emp.email && emp.email.trim() !== "") {
                    employeeSelect.innerHTML += `<option value="${emp.employee_id}">${emp.email}</option>`;
                }
            });
        })
        .catch(error => { 
          hideSpinner();
          console.error("Error fetching employees:", error)

        });
    }
  
function fetchModules() {
    showSpinner();
    fetch("/get_modules", {
        headers: getAuthHeaders()
    })
    .then(response => {
        hideSpinner();
        if (response.status === 401) {
            console.warn("Authentication required for fetching modules.");
            return;
        }
        if (response.status === 403) {
            console.warn("Access denied for fetching modules.");
            return;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return;
        // Both selects: edit and issue
        const editModuleSelect = document.getElementById("editModule-Certificate");
        const issueModuleSelect = document.getElementById("issue-Certificate");
        if (editModuleSelect) {
            editModuleSelect.innerHTML = '<option value="" disabled selected>Select Module</option>';
        }
        if (issueModuleSelect) {
            issueModuleSelect.innerHTML = '<option value="" disabled selected>Select Module</option>';
        }
        data.modules?.forEach(module => {
            if (editModuleSelect) {
                editModuleSelect.innerHTML += `<option value="${module.module_id}">${module.module_name}</option>`;
            }
            if (issueModuleSelect) {
                issueModuleSelect.innerHTML += `<option value="${module.module_id}">${module.module_name}</option>`;
            }
        });
    })
    .catch(error => {
        hideSpinner();
        console.error("Error fetching modules:", error);
    });
}

function handleCertificateIssue() {
        var $form = $('#issueCertificateForm');
        if ($form.length === 0) return;
        $form.on('submit', function (event) {
            event.preventDefault();
            var requestData = {
                employee_id: $('#certificate-employee-id').val(),
                module_id: $('#issue-Certificate').val(),
                issued_date: $('#issued-date').val(),
                certificate_status: $('#certificate-status').val()
            };
            showSpinner();
            fetch("/issue_certificate", {
                method: "POST",
                headers: getAuthHeaders(),
                body: JSON.stringify(requestData)
            })
            .then(function(response) {
                hideSpinner();
                if (response.status === 401) {
                    hideModalThenShowError4('issueCertificateModal', "Authentication required. Please log in again.");
                    return null;
                }
                if (response.status === 403) {
                    hideModalThenShowError4('issueCertificateModal', "Access denied. You don't have permission to issue certificates.");
                    return null;
                }
                return response.json();
            })
            .then(function(data) {
                if (data === null) return;
                if (data && data.message) {
                    $('#issueCertificateModal').modal('hide');
                    $form[0].reset();
                    $('#issueCertificateModal').one('hidden.bs.modal', function handler() {
                        showSuccessModal("Certificate issued successfully!");
                    });
                } else {
                    hideModalThenShowError4('issueCertificateModal', "Error: " + (data.error || "Unknown error"));
                }
            })
            .catch(function(error) {
                hideSpinner();
                console.error("Error issuing certificate:", error);
                hideModalThenShowError4('issueCertificateModal', "An error occurred while issuing the certificate.");
            });
        });
    }

// Bootstrap 4 pattern: hide a modal, then show error modal after it's fully hidden
function hideModalThenShowError4(hideModalId, errorMessage) {
    var $modal = $('#' + hideModalId);
    if ($modal.hasClass('show')) {
        $modal.one('hidden.bs.modal', function handler() {
            showErrorModal(errorMessage);
        });
        $modal.modal('hide');
    } else {
        showErrorModal(errorMessage);
    }
}

    // Function to set the authentication token in sessionStorage
    function setAuthToken(token) {
        sessionStorage.setItem('adminToken', token);
    }

    // Function to clear the authentication token from sessionStorage
    function clearAuthToken() {
        sessionStorage.removeItem('adminToken');
    }

    // Make these functions available globally if needed
    window.setAuthToken = setAuthToken;
    window.clearAuthToken = clearAuthToken;

</script>
<!-- Script for inserting, editing,deleting and display details of certificates (End) -->

<!-- Script for logging out (Start) -->
<script>
  document.querySelector(".logout-btn").addEventListener("click", function () {
    $("#logoutModal").modal("show"); // Show modal using jQuery
  });

  document
    .getElementById("confirmLogout")
    .addEventListener("click", function () {
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    });

  document
    .getElementById("cancelLogout")
    .addEventListener("click", function () {
      $("#logoutModal").modal("hide"); // Hide modal using jQuery
    });

  document
    .getElementById("closeLogoutModal")
    .addEventListener("click", function () {
      $("#logoutModal").modal("hide"); // Also hide on "X"
    });
</script>
<!-- Script for logging out (End) -->

<!-- Script that redirects admin back to login page if the token doesn't exist (Start) -->
<script>
  if (!token) {
    alert("Not authenticated. Redirecting to login.");
    window.location.href = "/admin_login";
  }
</script>
<!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

<!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start) -->
<script>
  function getToken() {
    return sessionStorage.getItem("adminToken");
  }

  function checkSessionConflict() {
    const token = getToken();
    if (!token) return;

    fetch("/check_jti", {
      method: "GET",
      headers: {
        Authorization: "Bearer " + token,
      },
    })
      .then((response) => {
        if (response.status === 403) {
          throw new Error("session_conflict");
        }
        return response.json();
      })
      .then((data) => {
        if (data.error === "session_conflict") {
          throw new Error("session_conflict");
        }
      })
      .catch((err) => {
        if (err.message === "session_conflict") {
          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById("sessionConflictModal"),
            {
              backdrop: "static",
              keyboard: false,
            }
          );
          modal.show();

          // Attach event listener only once
          const logoutBtn = document.getElementById("confirmLogoutBetweenTabs");
          if (!logoutBtn.dataset.bound) {
            logoutBtn.addEventListener("click", () => {
              sessionStorage.removeItem("adminToken");
              window.location.href = "/admin_login";
            });
            logoutBtn.dataset.bound = "true";
          }
        }
      });
  }

  // Initial check + every 30 seconds
  checkSessionConflict();
  setInterval(checkSessionConflict, 30000);
</script>
<!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

<!-- Script for checking admin if they have access to this page (Start) -->
<script>
  // Only run this if the backend passed access_denied = True
  const accessDenied = {{ 'true' if access_denied else 'false' }};
  if (accessDenied) {
    const accessModal = new bootstrap.Modal(document.getElementById("accessDeniedModal"));
    accessModal.show();

    document.getElementById("forceLogoutBtn").addEventListener("click", function () {
      // Trigger the logout logic manually
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    });
  }
</script>
<!-- Script for checking admin if they have access to this page (End) -->

  </body>
</html>
