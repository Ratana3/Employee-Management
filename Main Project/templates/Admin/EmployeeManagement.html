<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="card mb-4">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="me-3">
                            <i
                              class="mdi mdi-account-alert text-danger"
                              style="font-size: 36px"
                            ></i>
                          </div>
                          <div>
                            <h4 class="card-title mb-1">
                              Employees management
                            </h4>
                            <p class="card-text mb-0">
                              This table shows employees that work in the
                              company and employee's account status has be
                              activated before they can login.
                            </p>
                            <small class="text-muted"
                              >Last updated:
                              <span id="last-updated-time"
                                >2025-07-16 08:25:29</span
                              ></small
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                    <h4 class="card-title">Search employee :</h4>
                    <div class="form-group">
                      <div class="input-group mb-3">
                        <input
                          type="text"
                          id="employeeSearch"
                          class="form-control"
                          placeholder="Search by name, email, department..."
                          style="border: 1px solid black; color: black"
                        />
                        <div class="input-group-append">
                          <button
                            class="btn btn-primary"
                            type="button"
                            id="searchButton"
                          >
                            <i class="mdi mdi-magnify"></i> Search
                          </button>
                        </div>
                      </div>
                    </div>
                    <p class="card-description">
                      Search user by email, name, department, etc.
                    </p>

                    <!-- Employee data table -->
                    <div
                      class="table-responsive"
                      style="max-height: 500px; overflow-y: auto"
                    >
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Employee ID</th>
                            <th>Profile</th>
                            <th>Account Status</th>
                            <th>First name</th>
                            <th>Last name</th>
                            <th>Status</th>
                            <th>Email</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody id="employeeTableBody"></tbody>
                      </table>
                    </div>

                    <!-- Loading indicator -->
                    <div
                      id="loadingIndicator"
                      class="text-center my-3"
                      style="display: none"
                    >
                      <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>

                    <!-- Pagination controls -->
                    <nav aria-label="Employee pagination" class="mt-4">
                      <ul
                        class="pagination justify-content-center"
                        id="pagination"
                      >
                        <!-- Pagination will be added here by JavaScript -->
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Add New Employee</h4>

                    <!-- Info alert about required fields -->
                    <div class="alert alert-info mb-4">
                      <i class="mdi mdi-information-outline mr-2"></i>
                      Fields marked with <span class="text-danger">*</span> are
                      required. You can complete other details later by editing
                      the employee profile.
                    </div>

                    <!-- Error message container -->
                    <div
                      id="rolesTeamsFetchError"
                      class="alert alert-danger"
                      style="display: none"
                    ></div>

                    <form
                      class="forms-sample"
                      id="addNewEmployeeForm"
                      enctype="multipart/form-data"
                    >
                      <input
                        type="hidden"
                        name="csrf_token"
                        value="{{ csrf_token() }}"
                      />

                      <!-- Main tabs for form organization -->
                      <ul
                        class="nav nav-tabs mb-4"
                        id="employeeFormTabs"
                        role="tablist"
                      >
                        <li class="nav-item">
                          <a
                            class="nav-link active"
                            id="basic-tab"
                            data-toggle="tab"
                            href="#basic"
                            role="tab"
                          >
                            Basic Information
                          </a>
                        </li>
                        <li class="nav-item">
                          <a
                            class="nav-link"
                            id="contact-tab"
                            data-toggle="tab"
                            href="#contact"
                            role="tab"
                          >
                            Contact Details
                          </a>
                        </li>
                        <li class="nav-item">
                          <a
                            class="nav-link"
                            id="additional-tab"
                            data-toggle="tab"
                            href="#additional"
                            role="tab"
                          >
                            Additional Information
                          </a>
                        </li>
                      </ul>

                      <!-- Tab content -->
                      <div class="tab-content" id="employeeFormContent">
                        <!-- Basic Information Tab -->
                        <div
                          class="tab-pane fade show active"
                          id="basic"
                          role="tabpanel"
                        >
                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="profileImage">Profile Image</label>
                                <input
                                  type="file"
                                  class="form-control file-upload-info"
                                  id="profileImage"
                                  name="profile"
                                  accept="image/*"
                                  onchange="previewImage(event)"
                                />
                              </div>
                              <div
                                class="form-group"
                                id="imagePreviewSection"
                                style="display: none"
                              >
                                <img
                                  id="imagePreview"
                                  src=""
                                  alt="Image Preview"
                                  class="img-thumbnail"
                                  style="max-width: 200px; max-height: 200px"
                                />
                              </div>
                            </div>

                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="team_id_dropdown">Team</label>
                                <select
                                  class="form-control"
                                  name="team_id"
                                  id="team_id_dropdown"
                                >
                                  <option value="">Select team</option>
                                  <!-- Will be populated dynamically -->
                                </select>
                              </div>
                              <div class="form-group">
                                <label for="role_id_dropdown">Role</label>
                                <select
                                  class="form-control"
                                  name="role_id"
                                  id="role_id_dropdown"
                                >
                                  <option value="">Select role</option>
                                  <!-- Will be populated dynamically -->
                                </select>
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="first_name"
                                  >First Name
                                  <span class="text-danger">*</span></label
                                >
                                <input
                                  type="text"
                                  class="form-control"
                                  id="first_name"
                                  name="first_name"
                                />
                                <div class="invalid-feedback">
                                  First name is required
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="last_name"
                                  >Last Name
                                  <span class="text-danger">*</span></label
                                >
                                <input
                                  type="text"
                                  class="form-control"
                                  id="last_name"
                                  name="last_name"
                                />
                                <div class="invalid-feedback">
                                  Last name is required
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="email"
                                  >Email
                                  <span class="text-danger">*</span></label
                                >
                                <input
                                  type="email"
                                  class="form-control"
                                  id="add_employee_email"
                                  name="add_employee_email"
                                />
                                <div class="invalid-feedback">
                                  Valid email is required
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="password"
                                  >Password
                                  <span class="text-danger">*</span></label
                                >
                                <div class="input-group">
                                  <input
                                    type="password"
                                    class="form-control"
                                    id="add_employee_password"
                                    name="add_employee_password"
                                    minlength="8"
                                  />
                                  <div class="input-group-append">
                                    <button
                                      class="btn btn-outline-secondary"
                                      type="button"
                                      id="togglePassword"
                                    >
                                      <i class="mdi mdi-eye"></i>
                                    </button>
                                  </div>
                                </div>
                                <small class="form-text text-muted"
                                  >Password must be at least 8 characters</small
                                >
                                <div class="invalid-feedback">
                                  Password is required (min 8 characters)
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="gender">Gender</label>
                                <select
                                  class="form-control"
                                  name="add_employee_gender"
                                  id="add_employee_gender"
                                >
                                  <option value="" selected>
                                    Select gender
                                  </option>
                                  <option value="M">Male</option>
                                  <option value="F">Female</option>
                                  <option value="O">Other</option>
                                </select>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="date_of_birth">Date of Birth</label>
                                <input
                                  type="date"
                                  class="form-control"
                                  id="add_employee_date_of_birth"
                                  name="add_employee_date_of_birth"
                                />
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Contact Details Tab -->
                        <div class="tab-pane fade" id="contact" role="tabpanel">
                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="phone_number">Phone Number</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="add_employee_phone_number"
                                  name="add_employee_phone_number"
                                  placeholder="+855 012 345 678"
                                />
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="department">Department</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="add_employee_department"
                                  name="add_employee_department"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="address1">Address Line 1</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="add_employee_address1"
                                  name="add_employee_address1"
                                />
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="address2">Address Line 2</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="add_employee_address2"
                                  name="add_employee_address2"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="city">City</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="add_employee_city"
                                  name="add_employee_city"
                                />
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="date_hired">Date Hired</label>
                                <input
                                  type="date"
                                  class="form-control"
                                  id="add_employee_date_hired"
                                  name="add_employee_date_hired"
                                />
                                <small class="form-text text-muted"
                                  >If not set, today's date will be used</small
                                >
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Additional Information Tab -->
                        <div
                          class="tab-pane fade"
                          id="additional"
                          role="tabpanel"
                        >
                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="salary">Salary</label>
                                <div class="input-group">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                  </div>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="add_employee_salary"
                                    name="add_employee_salary"
                                    step="0.01"
                                    min="0"
                                  />
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="skills">Skills</label>
                                <textarea
                                  class="form-control"
                                  id="add_employee_skills"
                                  name="add_employee_skills"
                                  rows="2"
                                  placeholder="Separate skills with commas"
                                ></textarea>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="certification"
                                  >Certifications</label
                                >
                                <textarea
                                  class="form-control"
                                  id="add_employee_certification"
                                  name="add_employee_certification"
                                  rows="2"
                                  placeholder="Separate certifications with commas"
                                ></textarea>
                              </div>
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="education">Education</label>
                                <textarea
                                  class="form-control"
                                  id="add_employee_education"
                                  name="add_employee_education"
                                  rows="2"
                                ></textarea>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="form-group">
                                <label for="language">Languages</label>
                                <textarea
                                  class="form-control"
                                  id="add_employee_language"
                                  name="add_employee_language"
                                  rows="2"
                                  placeholder="Separate languages with commas"
                                ></textarea>
                              </div>
                            </div>
                          </div>

                          <div class="form-group">
                            <label for="hobbies">Hobbies</label>
                            <textarea
                              class="form-control"
                              id="add_employee_hobbies"
                              name="add_employee_hobbies"
                              rows="2"
                              placeholder="Separate hobbies with commas"
                            ></textarea>
                          </div>
                        </div>
                      </div>

                      <!-- Form buttons -->
                      <div class="mt-4 pt-3 border-top">
                        <button type="submit" class="btn btn-primary mr-2">
                          <i class="mdi mdi-account-plus mr-1"></i> Add Employee
                        </button>
                        <button class="btn btn-light" type="reset">
                          <i class="mdi mdi-refresh mr-1"></i> Reset Form
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <!-- Button to open main team management modal -->
                    <button
                      class="btn btn-success"
                      data-toggle="modal"
                      data-target="#teamManagementActionsModal"
                      style="margin-bottom: 20px"
                    >
                      + Manage Team
                    </button>
                    <h4 class="card-title">- Add Team</h4>
                    <form id="teamForm" class="forms-sample">
                      <label for="team_name">Team Name:</label>
                      <input
                        type="text"
                        id="team_name"
                        name="team_name"
                        required
                        class="form-control"
                      />

                      <label for="team_lead">Team Lead:</label>
                      <select
                        id="team_lead"
                        name="team_lead"
                        required
                        class="form-control"
                      >
                        <!-- Options will be loaded via JS -->
                      </select>

                      <label for="members">Select Members:</label>
                      <select
                        id="members"
                        name="members"
                        multiple
                        required
                        class="form-control"
                      >
                        <!-- Options will be loaded via JS -->
                      </select>

                      <button
                        type="submit"
                        class="btn btn-primary"
                        style="margin-top: 5px"
                      >
                        Create Team
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <footer class="footer">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                    >Copyright © bootstrapdash.com 2020</span
                  >
                  <span
                    class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                  >
                    Free
                    <a href="https://www.bootstrapdash.com/" target="_blank"
                      >Bootstrap dashboard templates</a
                    >
                    from Bootstrapdash.com
                  </span>
                </div>
              </div>
            </div>
          </footer>
        </div>
      </div>
    </div>

    <!-- Error Modal for Password -->
    <div
      class="modal fade"
      id="passwordErrorModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="passwordErrorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="passwordErrorModalLabel">Error</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="passwordErrorMessage">
            User must have password.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
              id="passwordErrorModalCloseBtn"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Actions Modal -->
    <div
      class="modal fade"
      id="teamManagementActionsModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="teamManagementActionsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="teamManagementActionsModalLabel">
              Team Management
            </h5>
          </div>
          <div class="modal-body text-center">
            <button
              class="btn btn-info mb-2"
              id="openEditTeamMainModalBtn"
              type="button"
            >
              Edit Team
            </button>
            <button
              class="btn btn-success"
              onclick="window.openAddEmployeeToTeamModal()"
            >
              Add Employee to Team
            </button>
            <button
              class="btn btn-warning mb-2"
              onclick="window.openRemoveEmployeeFromTeamModal()"
            >
              Remove Employee from Team
            </button>
            <button
              class="btn btn-danger mb-2"
              onclick="window.openDeleteTeamListModal()"
            >
              Delete Team
            </button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Teams List Modal (to pick a team to edit) -->
    <div
      class="modal fade"
      id="teamsListModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="teamsListModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="teamsListModalLabel">
              Select a Team to Edit
            </h5>
          </div>
          <div class="modal-body" style="max-height: 400px; overflow-y: auto">
            <!-- Search bar for team name -->
            <div class="form-group mb-3">
              <input
                type="text"
                class="form-control"
                id="teamsListSearch"
                placeholder="Search by team name or lead..."
                autocomplete="off"
              />
            </div>
            <table class="table table-bordered" id="teamsListTable">
              <thead>
                <tr>
                  <th>Team Name</th>
                  <th>Team Lead</th>
                  <th>Created At</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS will populate this -->
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Team Modal  -->
    <div
      class="modal fade"
      id="editTeamModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="editTeamModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <form id="editTeamForm">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editTeamModalLabel">Edit Team</h5>
            </div>
            <div class="modal-body">
              <input type="hidden" id="edit_team_id" name="team_id" />
              <!-- NEW: Dual role hidden fields -->
              <input
                type="hidden"
                id="edit_team_lead_employee_id"
                name="team_lead_employee_id"
              />
              <input
                type="hidden"
                id="edit_team_lead_admin_id"
                name="team_lead_admin_id"
              />
              <div class="form-group">
                <label for="edit_team_name">Team Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit_team_name"
                  name="team_name"
                  required
                />
              </div>
              <div class="form-group">
                <label for="team_lead_search">Search Team Lead</label>
                <input
                  type="text"
                  class="form-control"
                  id="team_lead_search"
                  placeholder="Type to search employees/admins..."
                  autocomplete="off"
                />
              </div>
              <div class="form-group">
                <label for="edit_team_lead_email"
                  >Current Team Lead Email</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit_team_lead_email"
                  name="team_lead_email"
                  disabled
                />
              </div>
              <div class="form-group">
                <label>Assign New Team Lead:</label>
                <div style="max-height: 200px; overflow-y: auto">
                  <table
                    class="table table-bordered table-sm"
                    id="teamLeadTable"
                  >
                    <thead>
                      <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS will populate this -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">
                Save Changes
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Select Team Modal for Adding Employee -->
    <div
      class="modal fade"
      id="addEmployeeTeamSelectModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="addEmployeeTeamSelectModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addEmployeeTeamSelectModalLabel">
              Select a Team to Add Employee
            </h5>
          </div>
          <div class="modal-body" style="max-height: 400px; overflow-y: auto">
            <div class="form-group mb-3">
              <input
                type="text"
                class="form-control"
                id="addEmpTeamsListSearch"
                placeholder="Search by team name or lead..."
                autocomplete="off"
              />
            </div>
            <table class="table table-bordered" id="addEmpTeamsListTable">
              <thead>
                <tr>
                  <th>Team Name</th>
                  <th>Team Lead</th>
                  <th>Created At</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS will populate this -->
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Employee To the Team Modal -->
    <div
      class="modal fade"
      id="addEmployeeModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="addEmployeeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <form id="addEmployeeForm">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addEmployeeModalLabel">
                Add Employee to Team
              </h5>
            </div>
            <div class="modal-body">
              <input type="hidden" id="add_employee_team_id" name="team_id" />
              <div class="mb-2" id="addEmpTeamDetails">
                <!-- JS will fill in team name/lead/created -->
              </div>
              <div>
                <label>Team Members:</label>
                <div style="max-height: 300px; overflow-y: auto">
                  <table
                    class="table table-bordered table-sm"
                    id="addEmpTeamMembersTable"
                  >
                    <thead>
                      <tr>
                        <th>Employee Email</th>
                        <th>Role</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS will populate this -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="window.cancelPendingAdds()"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="window.savePendingAddUsers()"
              >
                Save Changes
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Message Modal -->
    <div
      class="modal fade"
      id="messageModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="messageModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalLabel">Message</h5>
          </div>
          <div class="modal-body" id="messageModalBody">
            <!-- Message goes here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for editing employee details -->
    <div
      class="modal fade"
      id="editEmployeeModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="editEmployeeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="editEmployeeModalLabel">
              Edit Employee
            </h5>
            <button
              type="button"
              class="close text-white"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form
              id="updateEmployeeForm"
              method="POST"
              enctype="multipart/form-data"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <input type="hidden" name="employee_id" id="employee-id" />

              <div class="card mb-3">
                <div class="card-body text-center">
                  <div class="d-flex flex-column align-items-center">
                    <img
                      id="currentProfileImage"
                      src=""
                      alt="Profile Image"
                      style="
                        width: 100px;
                        height: 100px;
                        border-radius: 50%;
                        object-fit: cover;
                      "
                      data-original-src=""
                    />
                    <button
                      type="button"
                      class="btn btn-info mt-3"
                      id="uploadButton"
                      style="width: 140px"
                    >
                      Upload image
                    </button>
                    <input
                      type="file"
                      id="editProfileImage"
                      name="profile"
                      style="display: none"
                      accept="image/*"
                    />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="first-name">First Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="first-name"
                  name="first_name"
                />
              </div>
              <div class="form-group">
                <label for="last-name">Last Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="last-name"
                  name="last_name"
                />
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                />
              </div>
              <div class="form-group">
                <label for="password"
                  >Password (leave blank to keep unchanged)</label
                >
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="form-control"
                />
              </div>
              <div class="form-group">
                <label for="phone_number">Phone number</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone_number"
                  name="phone_number"
                />
              </div>
              <div class="form-group">
                <label for="date_of_birth">Date of Birth</label>
                <input
                  type="date"
                  class="form-control"
                  id="date_of_birth"
                  name="date_of_birth"
                />
              </div>
              <div class="form-group">
                <label for="gender">Gender</label>
                <select class="form-control" id="gender" name="gender">
                  <option value="">Select Gender</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                  <option value="O">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="department">Department</label>
                <input
                  type="text"
                  class="form-control"
                  id="department"
                  name="department"
                />
              </div>
              <div class="form-group">
                <label for="education">Education</label>
                <input
                  type="text"
                  class="form-control"
                  id="education"
                  name="education"
                />
              </div>
              <div class="form-group">
                <label for="language">Language</label>
                <input
                  type="text"
                  class="form-control"
                  id="language"
                  name="language"
                />
              </div>
              <div class="form-group">
                <label for="hobbies">Hobbies</label>
                <input
                  type="text"
                  class="form-control"
                  id="hobbies"
                  name="hobbies"
                />
              </div>
              <div class="form-group">
                <label for="certification">Certification</label>
                <input
                  type="text"
                  class="form-control"
                  id="certification"
                  name="certification"
                />
              </div>
              <div class="form-group">
                <label for="skills">Skills</label>
                <input
                  type="text"
                  class="form-control"
                  id="skills"
                  name="skills"
                />
              </div>
              <div class="form-group">
                <label for="address1">Address 1</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit_employee_address1"
                  name="edit_employee_address1"
                />
              </div>
              <div class="form-group">
                <label for="address2">Address 2</label>
                <input
                  type="text"
                  class="form-control"
                  id="address2"
                  name="address2"
                />
              </div>
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" class="form-control" id="city" name="city" />
              </div>
              <div class="form-group">
                <label for="salary">Salary</label>
                <input
                  type="number"
                  class="form-control"
                  id="salary"
                  name="salary"
                />
              </div>
              <div class="form-group">
                <label for="status">Status</label>
                <select class="form-control" id="status" name="status">
                  <option value="" disabled>-- Select Status --</option>
                  <option value="Clock in">Clock in</option>
                  <option value="Clock out">Clock out</option>
                  <option value="Break">Break</option>
                </select>
              </div>
              <div class="form-group">
                <label for="date_hired">Date Hired</label>
                <input
                  type="date"
                  class="form-control"
                  id="date_hired"
                  name="date_hired"
                />
              </div>
              <div class="form-group">
                <label for="date_terminated">Date Terminated</label>
                <input
                  type="date"
                  class="form-control"
                  id="edit_date_terminated"
                  name="date_terminated"
                />
              </div>
              <div class="form-group">
                <label for="team_id">Team</label>
                <select
                  class="form-control"
                  name="team_id"
                  id="edit_team_id_dropdown"
                >
                  <option value="" disabled>-- Select team --</option>
                  <!-- Populated dynamically -->
                </select>
              </div>
              <div class="form-group">
                <label for="role_id">Role</label>
                <select
                  class="form-control"
                  name="role_id"
                  id="edit_role_id_dropdown"
                >
                  <option value="" disabled>-- Select role --</option>
                  <!-- Populated dynamically -->
                </select>
              </div>
              <div class="form-group">
                <label for="account_status">Account Status</label>
                <input
                  type="text"
                  class="form-control"
                  id="account_status"
                  name="account_status"
                />
              </div>
              <div class="form-group">
                <label for="created">Created</label>
                <input
                  type="date"
                  class="form-control"
                  id="created"
                  name="created"
                />
              </div>
              <!-- Removed shift, shift_start_time, shift_end_time, location, is_rotating fields -->
              <button type="submit" class="btn btn-success">
                Save changes
              </button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Close
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Details of employee modal -->
    <div
      class="modal fade"
      id="idCardModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="idCardModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div
            class="card"
            style="
              border: 1px solid #ccc;
              padding: 15px;
              border-radius: 12px;
              background-color: #f8f9fa;
            "
          >
            <div
              class="card-header text-center"
              style="
                background-color: #007bff;
                color: white;
                font-weight: bold;
                font-size: 1.5rem;
                border-radius: 8px 8px 0 0;
              "
            >
              View Details
            </div>
            <div class="card-body">
              <input type="hidden" name="employee_id" id="employee-id" />
              <div class="text-center mb-4">
                <img
                  id="profileImage"
                  src="../../static/default_resource.png"
                  alt="Employee Photo"
                  style="
                    width: 100px;
                    height: 100px;
                    border-radius: 50%;
                    border: 3px solid #007bff;
                  "
                />
              </div>
              <div class="text-center mb-3">
                <h5
                  id="employeeRole"
                  class="mb-0"
                  style="font-weight: bold"
                ></h5>
              </div>
              <div style="line-height: 1.6">
                <div><b>ID:</b> <span id="employeeID"></span></div>
                <div>
                  <b>First Name:</b> <span id="employeefirstName"></span>
                </div>
                <div><b>Last Name:</b> <span id="employeelastName"></span></div>
                <!-- Removed Position -->
                <div><b>Email:</b> <span id="employeeEmail"></span></div>
                <div><b>Phone:</b> <span id="employeePhone"></span></div>
                <div><b>Department:</b> <span id="employeeDept"></span></div>
                <div>
                  <b>Education:</b> <span id="employeeEducation"></span>
                </div>
                <div><b>Language:</b> <span id="employeeLanguage"></span></div>
                <div><b>Hobbies:</b> <span id="employeeHobbies"></span></div>
                <div>
                  <b>Certification:</b> <span id="employeeCertification"></span>
                </div>
                <div><b>Skills:</b> <span id="employeeSkill"></span></div>
                <div><b>Team:</b> <span id="employeeTeam"></span></div>
                <!-- Removed Team Role -->
                <div><b>Status:</b> <span id="status"></span></div>
                <div>
                  <b>Account Status:</b> <span id="account_status"></span>
                </div>
                <div>
                  <b>Date Hired:</b> <span id="employeeDateHired"></span>
                </div>
                <div>
                  <b>Date Terminated:</b> <span id="date_terminated"></span>
                </div>
                <div><b>Salary:</b> <span id="salary"></span></div>
                <div><b>Created:</b> <span id="created"></span></div>
                <div>
                  <b>Address 1:</b> <span id="employee_details_address1"></span>
                </div>
                <div><b>Address 2:</b> <span id="address2"></span></div>
                <div><b>City:</b> <span id="city"></span></div>
                <div>
                  <b>Date of Birth:</b> <span id="date_of_birth_detail"></span>
                </div>
                <div><b>Gender:</b> <span id="gender_detail"></span></div>
                <!-- Removed Shift -->
              </div>
            </div>
            <div class="card-footer text-center">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete employee modal -->
    <div
      id="deleteUserModal"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title" id="deleteUserModalLabel">
              Confirm Delete
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <!-- Modal Body -->
          <div class="modal-body">
            <p>
              Are you sure you want to delete this user? This action cannot be
              undone.
            </p>
          </div>
          <!-- Modal Footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDelete()"
            >
              Confirm
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      class="modal fade"
      id="confirmationModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="confirmationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header badge-success">
            <h5 class="modal-title" id="confirmationModalLabel">
              Confirm Action
            </h5>
          </div>
          <div class="modal-body" id="confirmationMessage">Are you sure?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              Cancel
            </button>
            <button id="confirmActionBtn" type="button" class="btn btn-success">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div
      id="successModal"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title" id="successModalLabel">Success</h5>
          </div>
          <!-- Modal Body -->
          <div class="modal-body">
            <p id="successMessage">Employee deleted successfully!</p>
          </div>
          <!-- Modal Footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              data-dismiss="modal"
              id="successModalCloseBtn"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div
      class="modal fade"
      id="errorModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="errorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
          </div>
          <div class="modal-body" id="errorMessage">Something went wrong.</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for alerting super_admin when admins have no access to any route -->
    <div
      class="modal fade"
      id="warningModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="warningLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content border-warning">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="warningLabel">Warning</h5>
          </div>
          <div class="modal-body">
            This admin now has no access to any routes.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-warning" data-dismiss="modal">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Session Conflict Modal -->
    <div
      class="modal fade"
      id="sessionConflictModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="sessionConflictLabel"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="sessionConflictLabel">
              Session Conflict
            </h5>
          </div>
          <div class="modal-body">
            <p>
              <strong
                >Someone has logged into your account from another tab or
                device.</strong
              >
            </p>
            <p>You will be logged out for security reasons.</p>
          </div>
          <div class="modal-footer justify-content-center">
            <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal fade"
      id="logoutModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="logoutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
            <button
              type="button"
              class="close"
              id="closeLogoutModal"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to logout?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelLogout">
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmLogout">
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Access Denied Modal -->
    <div
      class="modal fade"
      id="accessDeniedModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="accessDeniedLabel"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-danger">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
          </div>
          <div class="modal-body">
            <p>Only Super Admins are allowed to access this page.</p>
          </div>
          <div class="modal-footer">
            <button id="redirectBtn" type="button" class="btn btn-danger">
              Go to Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Remove Employee From the Team Modal -->
    <div
      class="modal fade"
      id="removeEmployeeModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="removeEmployeeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <form id="removeEmployeeForm" onsubmit="return false;">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="removeEmployeeModalLabel">
                Remove Employee from Team
              </h5>
            </div>
            <div class="modal-body">
              <input
                type="hidden"
                id="remove_employee_team_id"
                name="team_id"
              />
              <div class="mb-2" id="removeEmpTeamDetails">
                <!-- JS will fill in team name/lead/created -->
              </div>
              <div>
                <label>Team Members:</label>
                <div style="max-height: 300px; overflow-y: auto">
                  <table
                    class="table table-bordered table-sm"
                    id="removeEmpTeamMembersTable"
                  >
                    <thead>
                      <tr>
                        <th>Employee Email</th>
                        <th>Role</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS will populate this -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="window.cancelPendingRemoves()"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-danger"
                onclick="window.savePendingRemoveUsers()"
              >
                Save Changes
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Password error modal -->
    <div
      class="modal fade"
      id="passwordErrorModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="passwordErrorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="passwordErrorModalLabel">Error</h5>
            <button
              type="button"
              class="close text-white"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="passwordErrorMessage">
            User must have password.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger"
              data-dismiss="modal"
              id="passwordErrorModalCloseBtn"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Team: Team Selection Modal -->
    <div
      class="modal fade"
      id="deleteTeamListModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteTeamListModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteTeamListModalLabel">
              Select Team to Delete
            </h5>
          </div>
          <div class="modal-body" style="max-height: 400px; overflow-y: auto">
            <input
              class="form-control mb-2"
              id="deleteTeamsListSearch"
              placeholder="Search teams..."
            />
            <table
              class="table table-bordered table-sm"
              id="deleteTeamsListTable"
            >
              <thead>
                <tr>
                  <th>Team Name</th>
                  <th>Team Lead</th>
                  <th>Created At</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS will fill this -->
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Team Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteTeamConfirmModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteTeamConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteTeamConfirmModalLabel">
              Confirm Delete Team
            </h5>
          </div>
          <div class="modal-body" id="deleteTeamConfirmBody">
            <!-- JS will fill in team info -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirmDeleteTeamBtn"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Remove Employee: Select Team Modal -->
    <div
      class="modal fade"
      id="removeEmployeeTeamSelectModal"
      tabindex="-1"
      aria-labelledby="removeEmployeeTeamSelectModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="removeEmployeeTeamSelectModalLabel">
              Select a Team
            </h5>
            <button
              type="button"
              class="btn-close"
              data-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" style="max-height: 400px; overflow-y: auto">
            <input
              id="removeEmpTeamsListSearch"
              type="text"
              class="form-control mb-3"
              placeholder="Search teams..."
            />
            <div class="table-responsive">
              <table
                id="removeEmpTeamsListTable"
                class="table table-striped table-bordered mb-0"
              >
                <thead>
                  <tr>
                    <th>Team Name</th>
                    <th>Team Lead Email</th>
                    <th>Created At</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS will populate rows here, or show "No teams found" -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner Modal -->
    <div
      class="modal fade"
      id="loadingSpinnerModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 bg-transparent shadow-none">
          <div class="modal-body text-center">
            <div
              class="spinner-border text-white"
              style="width: 4rem; height: 4rem"
              role="status"
            >
              <span class="sr-only"></span>
            </div>
            <div class="mt-3 text-white font-weight-bold">Please wait...</div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Other vendor scripts (if they do NOT include jQuery/Bootstrap again) -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- Your custom scripts -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <script src="../../static/Admin/js/file-upload.js"></script>

    <!-- Script for displaying loading, success, and error modals (Start) -->
    <script>
      /**
       * Modal Utility - A global utility for managing Bootstrap 4 modals
       * - Loading spinner with timeout prevention
       * - Success messages
       * - Error messages
       */
      const ModalUtility = (function () {
        // Configuration
        const config = {
          spinnerTimeout: 30000, // 30 seconds max for spinner to prevent it getting stuck
          successAutoHide: 3000, // Auto-hide success message after 3 seconds
          defaultErrorMessage:
            "An unexpected error occurred. Please try again.",
          defaultSuccessMessage: "Operation completed successfully!",
        };

        // Track active timers for cleanup
        let activeTimers = {
          spinner: null,
          success: null,
        };

        /**
         * Shows the loading spinner
         * @param {number} customTimeout - Optional custom timeout in milliseconds
         * @returns {Promise} - Resolves when spinner is shown
         */
        function showSpinner(customTimeout) {
          return new Promise((resolve) => {
            // Clear any existing spinner timeout
            if (activeTimers.spinner) {
              clearTimeout(activeTimers.spinner);
              activeTimers.spinner = null;
            }

            // Show spinner modal
            $("#loadingSpinnerModal").modal("show");

            // Set safety timeout to ensure spinner doesn't get stuck
            const timeout = customTimeout || config.spinnerTimeout;
            activeTimers.spinner = setTimeout(() => {
              console.warn("Spinner timeout reached. Force hiding spinner.");
              hideSpinner();
            }, timeout);

            // Wait for modal to be fully shown before resolving
            $("#loadingSpinnerModal").on("shown.bs.modal", function () {
              resolve();
              // Remove the event listener to prevent memory leaks
              $(this).off("shown.bs.modal");
            });
          });
        }

        /**
         * Hides the loading spinner
         * @returns {Promise} - Resolves when spinner is hidden
         */
        function hideSpinner() {
          return new Promise((resolve) => {
            // Clear spinner timeout if it exists
            if (activeTimers.spinner) {
              clearTimeout(activeTimers.spinner);
              activeTimers.spinner = null;
            }

            // If modal is not visible, resolve immediately
            if (!$("#loadingSpinnerModal").hasClass("show")) {
              resolve();
              return;
            }

            // Hide spinner modal
            $("#loadingSpinnerModal").modal("hide");

            // Wait for modal to be fully hidden before resolving
            $("#loadingSpinnerModal").on("hidden.bs.modal", function () {
              resolve();
              // Remove the event listener to prevent memory leaks
              $(this).off("hidden.bs.modal");
            });
          });
        }

        /**
         * Shows a success message
         * @param {string} message - The success message to display
         * @param {boolean} autoHide - Whether to auto-hide the message after the configured time
         * @returns {Promise} - Resolves when success modal is shown
         */
        function showSuccess(
          message = config.defaultSuccessMessage,
          autoHide = true
        ) {
          return new Promise((resolve) => {
            // Clear any existing success timeout
            if (activeTimers.success) {
              clearTimeout(activeTimers.success);
              activeTimers.success = null;
            }

            // Update message and show modal
            $("#successMessage").text(message);
            $("#successModal").modal("show");

            // Set auto-hide timeout if enabled
            if (autoHide) {
              activeTimers.success = setTimeout(() => {
                hideSuccess();
              }, config.successAutoHide);
            }

            // Wait for modal to be fully shown before resolving
            $("#successModal").on("shown.bs.modal", function () {
              resolve();
              // Remove the event listener to prevent memory leaks
              $(this).off("shown.bs.modal");
            });
          });
        }

        /**
         * Hides the success modal
         * @returns {Promise} - Resolves when success modal is hidden
         */
        function hideSuccess() {
          return new Promise((resolve) => {
            // Clear success timeout if it exists
            if (activeTimers.success) {
              clearTimeout(activeTimers.success);
              activeTimers.success = null;
            }

            // If modal is not visible, resolve immediately
            if (!$("#successModal").hasClass("show")) {
              resolve();
              return;
            }

            // Hide success modal
            $("#successModal").modal("hide");

            // Wait for modal to be fully hidden before resolving
            $("#successModal").on("hidden.bs.modal", function () {
              resolve();
              // Remove the event listener to prevent memory leaks
              $(this).off("hidden.bs.modal");
            });
          });
        }

        /**
         * Shows an error message
         * @param {string|Error} error - The error message or Error object
         * @returns {Promise} - Resolves when error modal is shown
         */
        function showError(error = config.defaultErrorMessage) {
          return new Promise((resolve) => {
            // Handle different error input types
            let errorMsg = config.defaultErrorMessage;

            if (typeof error === "string") {
              errorMsg = error;
            } else if (error instanceof Error) {
              errorMsg = error.message || config.defaultErrorMessage;
            } else if (
              error &&
              error.responseJSON &&
              error.responseJSON.message
            ) {
              // Handle jQuery AJAX error format
              errorMsg = error.responseJSON.message;
            } else if (error && error.statusText) {
              // Handle HTTP error
              errorMsg = `${error.statusText} (${error.status})`;
            }

            // Update message and show modal
            $("#errorMessage").text(errorMsg);
            $("#errorModal").modal("show");

            // Wait for modal to be fully shown before resolving
            $("#errorModal").on("shown.bs.modal", function () {
              resolve();
              // Remove the event listener to prevent memory leaks
              $(this).off("shown.bs.modal");
            });
          });
        }

        /**
         * Hides the error modal
         * @returns {Promise} - Resolves when error modal is hidden
         */
        function hideError() {
          return new Promise((resolve) => {
            // If modal is not visible, resolve immediately
            if (!$("#errorModal").hasClass("show")) {
              resolve();
              return;
            }

            // Hide error modal
            $("#errorModal").modal("hide");

            // Wait for modal to be fully hidden before resolving
            $("#errorModal").on("hidden.bs.modal", function () {
              resolve();
              // Remove the event listener to prevent memory leaks
              $(this).off("hidden.bs.modal");
            });
          });
        }

        /**
         * Handles an asynchronous operation with automatic spinner management
         * @param {Function} asyncFn - The async function to execute
         * @param {Object} options - Configuration options
         * @param {boolean} options.showSuccessMessage - Whether to show success message on completion
         * @param {string} options.successMessage - Custom success message
         * @param {boolean} options.showErrorMessage - Whether to show error message on failure
         * @param {number} options.spinnerTimeout - Custom spinner timeout
         * @returns {Promise} - Resolves with the result of the async function
         */
        async function handleAsync(asyncFn, options = {}) {
          const opts = {
            showSuccessMessage: true,
            successMessage: config.defaultSuccessMessage,
            showErrorMessage: true,
            spinnerTimeout: config.spinnerTimeout,
            ...options,
          };

          try {
            await showSpinner(opts.spinnerTimeout);
            const result = await asyncFn();
            await hideSpinner();

            if (opts.showSuccessMessage) {
              await showSuccess(opts.successMessage);
            }

            return result;
          } catch (error) {
            await hideSpinner();

            if (opts.showErrorMessage) {
              await showError(error);
            }

            throw error; // Rethrow so calling code can handle it if needed
          }
        }

        /**
         * Updates configuration settings
         * @param {Object} newConfig - New configuration values
         */
        function configure(newConfig = {}) {
          Object.assign(config, newConfig);
        }

        // Initialize event listeners
        function init() {
          // Handle close button clicks
          $("#successModalCloseBtn").on("click", hideSuccess);

          // Clean up any active timers when modals are manually closed
          $("#loadingSpinnerModal").on("hidden.bs.modal", function () {
            if (activeTimers.spinner) {
              clearTimeout(activeTimers.spinner);
              activeTimers.spinner = null;
            }
          });

          $("#successModal").on("hidden.bs.modal", function () {
            if (activeTimers.success) {
              clearTimeout(activeTimers.success);
              activeTimers.success = null;
            }
          });
        }

        // Run initialization when document is ready
        $(document).ready(init);

        // Public API
        return {
          showSpinner,
          hideSpinner,
          showSuccess,
          hideSuccess,
          showError,
          hideError,
          handleAsync,
          configure,
        };
      })();
    </script>
    <!-- Script for displaying loading, success, and error modals (End) -->

    <!-- Script for deleting a team (Start) -->
    <script>
      // --- Modal Stack Logic for Team Delete Flow ---

      let deleteTeamsListData = [];
      let teamToDelete = null;

      // Modal stack for managing modal transitions
      const modalStack = [];

      function showModalStack(modalSelector) {
        // Hide the top modal if any
        if (modalStack.length > 0) {
          $(modalStack[modalStack.length - 1]).modal("hide");
        }
        modalStack.push(modalSelector);
        $(modalSelector).modal("show");
      }

      function hideModalStack(modalSelector) {
        $(modalSelector).modal("hide");
        // Remove this modal from stack
        const idx = modalStack.lastIndexOf(modalSelector);
        if (idx !== -1) modalStack.splice(idx, 1);
        // Show the previous modal if any
        if (modalStack.length > 0) {
          setTimeout(() => {
            $(modalStack[modalStack.length - 1]).modal("show");
          }, 300); // slight delay to allow Bootstrap to finish closing
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        window.openDeleteTeamListModal = function () {
          showModalStack("#deleteTeamListModal");
          loadDeleteTeamsList();
          const search = document.getElementById("deleteTeamsListSearch");
          if (search) search.value = "";
        };

        async function loadDeleteTeamsList() {
          try {
            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            deleteTeamsListData = data.teams || [];
            renderDeleteTeamsListTable(deleteTeamsListData, "");
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to load teams list.");
          }
        }

        function renderDeleteTeamsListTable(teams, filterText) {
          const tbody = document.querySelector("#deleteTeamsListTable tbody");
          if (!tbody) return;
          tbody.innerHTML = "";
          const filter =
            typeof filterText === "string" ? filterText.toLowerCase() : "";
          teams
            .filter((team) => {
              const name =
                typeof team.team_name === "string"
                  ? team.team_name.toLowerCase()
                  : "";
              const lead =
                typeof team.team_lead_employee_email === "string"
                  ? team.team_lead_employee_email.toLowerCase()
                  : typeof team.team_lead_admin_email === "string"
                  ? team.team_lead_admin_email.toLowerCase()
                  : "";
              return !filter || name.includes(filter) || lead.includes(filter);
            })
            .forEach((team) => {
              let leadEmail = "";
              if (typeof team.team_lead_employee_email === "string")
                leadEmail = team.team_lead_employee_email;
              else if (typeof team.team_lead_admin_email === "string")
                leadEmail = team.team_lead_admin_email;
              else
                leadEmail =
                  '<span class="text-danger font-italic">No Team Lead</span>';
              const teamObj = JSON.stringify(team).replace(/"/g, "&quot;");
              const tr = document.createElement("tr");
              tr.innerHTML = `
          <td>${team.team_name}</td>
          <td>${leadEmail}</td>
          <td>${team.created_at}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick='window.openDeleteTeamConfirmModal(${teamObj})'>Delete</button>
          </td>
        `;
              tbody.appendChild(tr);
            });
        }

        const deleteTeamsListSearch = document.getElementById(
          "deleteTeamsListSearch"
        );
        if (deleteTeamsListSearch) {
          deleteTeamsListSearch.addEventListener("input", function () {
            renderDeleteTeamsListTable(deleteTeamsListData, this.value);
          });
        }

        window.openDeleteTeamConfirmModal = function (team) {
          teamToDelete = team;
          document.getElementById("deleteTeamConfirmBody").innerHTML = `
      <b>Are you sure you want to delete this team? (Anything that is related to this team will be deleted)</b><br>
      <b>Team Name:</b> ${team.team_name}<br>
      <b>Team Lead:</b> ${
        team.team_lead_employee_email ||
        team.team_lead_admin_email ||
        '<span class="text-danger font-italic">No Team Lead</span>'
      }<br>
      <b>Created At:</b> ${team.created_at}
    `;
          hideModalStack("#deleteTeamListModal");
          showModalStack("#deleteTeamConfirmModal");
        };

        document.getElementById("confirmDeleteTeamBtn").onclick =
          async function () {
            if (!teamToDelete) return;

            try {
              const token = sessionStorage.getItem("adminToken");
              const formData = new FormData();
              formData.append("team_id", teamToDelete.team_id);

              // Use the handleAsync helper for cleaner code
              await ModalUtility.handleAsync(
                async () => {
                  const response = await fetch("/team_management/delete", {
                    method: "POST",
                    headers: { Authorization: "Bearer " + token },
                    body: formData,
                  });

                  const result = await response.json();

                  if (!response.ok) {
                    const errorMsg =
                      result && (result.error || result.message)
                        ? result.error || result.message
                        : "Failed to delete team.";
                    throw new Error(errorMsg);
                  }

                  return result;
                },
                {
                  successMessage: "Team deleted successfully.",
                  spinnerTimeout: 20000, // 20 seconds timeout for delete operation
                }
              );

              // If we get here, the operation was successful
              hideModalStack("#deleteTeamConfirmModal");
            } catch (error) {
              // Error is already handled by handleAsync
              hideModalStack("#deleteTeamConfirmModal");
            }
          };
      });
    </script>
    <!-- Script for deleting a team (End) -->

    <!-- Script for removing employee from the team (Start) -->
    <script>
      let removeEmpTeamsListData = [];
      let removeEmpSelectedTeam = null;
      let removeEmpAllUsers = [];
      let removeEmpTeamMembers = [];
      let pendingRemoveUsers = [];

      document.addEventListener("DOMContentLoaded", function () {
        window.openRemoveEmployeeFromTeamModal = async function () {
          await $("#removeEmployeeTeamSelectModal").modal("show");
          loadRemoveEmpTeamsList();
          const search = document.getElementById("removeEmpTeamsListSearch");
          if (search) search.value = "";
        };

        async function loadRemoveEmpTeamsList() {
          try {
            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            removeEmpTeamsListData = data.teams || [];
            renderRemoveEmpTeamsListTable(removeEmpTeamsListData, "");
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to load teams list.");
          }
        }

        function renderRemoveEmpTeamsListTable(teams, filterText) {
          const tbody = document.querySelector(
            "#removeEmpTeamsListTable tbody"
          );
          if (!tbody) return;
          tbody.innerHTML = "";
          const filter = (
            typeof filterText === "string" ? filterText : ""
          ).toLowerCase();
          const filteredTeams = teams.filter((team) => {
            const name =
              typeof team.team_name === "string"
                ? team.team_name.toLowerCase()
                : "";
            const lead =
              typeof team.team_lead_employee_email === "string"
                ? team.team_lead_employee_email.toLowerCase()
                : typeof team.team_lead_admin_email === "string"
                ? team.team_lead_admin_email.toLowerCase()
                : "";
            return !filter || name.includes(filter) || lead.includes(filter);
          });

          if (filteredTeams.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="4" class="text-center text-muted">No teams found.</td>`;
            tbody.appendChild(tr);
            return;
          }

          filteredTeams.forEach((team) => {
            let leadEmail = "";
            if (typeof team.team_lead_employee_email === "string") {
              leadEmail = team.team_lead_employee_email;
            } else if (typeof team.team_lead_admin_email === "string") {
              leadEmail = team.team_lead_admin_email;
            } else {
              leadEmail =
                '<span class="text-danger font-italic">No Team Lead</span>';
            }
            const teamObj = JSON.stringify(team).replace(/"/g, "&quot;");
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${team.team_name}</td>
        <td>${leadEmail}</td>
        <td>${team.created_at}</td>
        <td>
          <button class="btn btn-info btn-sm" onclick='window.openRemoveEmployeeChooseModal(${teamObj})'>Choose</button>
        </td>
      `;
            tbody.appendChild(tr);
          });
        }

        const removeEmpTeamsListSearch = document.getElementById(
          "removeEmpTeamsListSearch"
        );
        if (removeEmpTeamsListSearch) {
          removeEmpTeamsListSearch.addEventListener("input", function () {
            renderRemoveEmpTeamsListTable(removeEmpTeamsListData, this.value);
          });
        }

        window.openRemoveEmployeeChooseModal = async function (team) {
          try {
            const token = sessionStorage.getItem("adminToken");

            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: { Authorization: "Bearer " + token },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            removeEmpAllUsers = data.users || [];
            const teamWithMembers = (data.teams || []).find(
              (t) => String(t.team_id) === String(team.team_id)
            );
            removeEmpSelectedTeam = teamWithMembers || team;
            removeEmpTeamMembers =
              teamWithMembers && Array.isArray(teamWithMembers.members)
                ? teamWithMembers.members
                : [];

            pendingRemoveUsers = [];
            document.getElementById("remove_employee_team_id").value =
              removeEmpSelectedTeam.team_id;
            document.getElementById("removeEmpTeamDetails").innerHTML = `
        <b>Team Name:</b> ${removeEmpSelectedTeam.team_name}<br>
        <b>Team Lead:</b> ${
          removeEmpSelectedTeam.team_lead_employee_email ||
          removeEmpSelectedTeam.team_lead_admin_email ||
          '<span class="text-danger font-italic">No Team Lead</span>'
        }<br>
        <b>Created At:</b> ${removeEmpSelectedTeam.created_at}
      `;
            renderRemoveEmpTeamMembersTable();

            // Ensure modal transitions are sequential
            await new Promise((resolve) => {
              $("#removeEmployeeTeamSelectModal").modal("hide");
              $("#removeEmployeeTeamSelectModal").on(
                "hidden.bs.modal",
                function () {
                  $(this).off("hidden.bs.modal");
                  resolve();
                }
              );
            });

            await new Promise((resolve) => {
              $("#removeEmployeeModal").modal("show");
              $("#removeEmployeeModal").on("shown.bs.modal", function () {
                $(this).off("shown.bs.modal");
                resolve();
              });
            });
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to load team details.");
          }
        };

        function renderRemoveEmpTeamMembersTable() {
          const tbody = document.querySelector(
            "#removeEmpTeamMembersTable tbody"
          );
          if (!tbody) return;
          tbody.innerHTML = "";

          removeEmpTeamMembers.forEach((user) => {
            const willBeRemoved = pendingRemoveUsers.some(
              (u) =>
                String(u.user_type) === String(user.user_type) &&
                String(u.id) === String(user.id)
            );
            let buttonHtml = "";
            if (willBeRemoved) {
              buttonHtml = `<button type="button" class="btn btn-sm btn-warning" disabled>Will be removed</button>`;
            } else {
              buttonHtml = `<button type="button" class="btn btn-sm btn-danger" onclick="window.stageUserToRemoveHandler('${user.email.replace(
                /'/g,
                "\\'"
              )}', ${user.id}, '${user.user_type}')">Remove</button>`;
            }
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${user.email}</td>
        <td>${user.role || ""} </td>
        <td>${buttonHtml}</td>
      `;
            tbody.appendChild(tr);
          });
        }

        window.stageUserToRemoveHandler = function (
          userEmail,
          userId,
          userType
        ) {
          const userObj = removeEmpTeamMembers.find(
            (u) =>
              u.id == userId &&
              u.email === userEmail &&
              u.user_type === userType
          );
          if (
            userObj &&
            !pendingRemoveUsers.some(
              (u) =>
                String(u.user_type) === String(userObj.user_type) &&
                String(u.id) === String(userObj.id)
            )
          ) {
            pendingRemoveUsers.push(userObj);
            renderRemoveEmpTeamMembersTable();
          }
        };

        window.savePendingRemoveUsers = async function () {
          if (!pendingRemoveUsers.length) {
            $("#removeEmployeeModal").modal("hide");
            return;
          }

          try {
            const teamId = removeEmpSelectedTeam.team_id;
            const token = sessionStorage.getItem("adminToken");

            // Use handleAsync for the entire operation with progress tracking
            await ModalUtility.handleAsync(
              async () => {
                // Process each user removal sequentially
                for (let user of pendingRemoveUsers) {
                  const formData = new FormData();
                  formData.append("team_id", teamId);
                  if (user.user_type === "admin") {
                    formData.append("admin_id", user.id);
                  } else {
                    formData.append("employee_id", user.id);
                  }

                  const response = await fetch(
                    "/team_management/remove_member",
                    {
                      method: "POST",
                      headers: { Authorization: "Bearer " + token },
                      body: formData,
                    }
                  );

                  // Check response (optional, can be removed if server doesn't return meaningful errors)
                  if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(
                      errorData.message || `Failed to remove user ${user.email}`
                    );
                  }
                }
              },
              {
                // Custom options for this specific operation
                successMessage: "All selected users removed from team.",
                spinnerTimeout: 60000, // 60 seconds timeout for potentially long operation
              }
            );

            // Only if all operations succeed, close all modals
            await sequentialModalClose([
              "#removeEmployeeModal",
              "#removeEmployeeTeamSelectModal",
              "#teamsListModal",
              "#teamManagementActionsModal",
            ]);
          } catch (error) {
            // Error is already handled by handleAsync
            console.error("Error removing team members:", error);
          }
        };

        // Helper function to close modals in sequence
        async function sequentialModalClose(modalSelectors) {
          for (const selector of modalSelectors) {
            await new Promise((resolve) => {
              $(selector).modal("hide");
              $(selector).on("hidden.bs.modal", function () {
                $(this).off("hidden.bs.modal");
                resolve();
              });
            });
          }
        }

        window.cancelPendingRemoves = function () {
          pendingRemoveUsers = [];
          $("#removeEmployeeModal").modal("hide");
        };
      });
    </script>
    <!-- Script for removing employee from the team (End) -->

    <!-- Script for adding employee to the team (Start) -->
    <script>
      /**
       * Add Employee to Team Script - Updated with Better Member Detection
       * Current Date and Time (UTC): 2025-08-03 11:42:47
       * Current User's Login: Ratana3
       */
      let addEmpTeamsListData = [];
      let addEmpSelectedTeam = null;
      let addEmpAllUsers = [];
      let addEmpTeamMembers = [];
      let pendingAddUsers = [];

      document.addEventListener("DOMContentLoaded", function () {
        // Enable debug mode to help troubleshoot team member detection
        const DEBUG_MODE = true;

        function logDebug(...args) {
          if (DEBUG_MODE) {
            console.log("[TeamMembersDebug]", ...args);
          }
        }

        var addEmployeeForm = document.getElementById("addEmployeeForm");
        if (addEmployeeForm) {
          addEmployeeForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            try {
              const token = sessionStorage.getItem("adminToken");
              const formData = new FormData(event.target);

              await ModalUtility.handleAsync(
                async () => {
                  const response = await fetch(
                    "/team_management/add_employee",
                    {
                      method: "POST",
                      headers: { Authorization: "Bearer " + token },
                      body: formData,
                    }
                  );

                  const result = await response.json();

                  if (!response.ok) {
                    throw new Error(
                      result.message || "Failed to add employee."
                    );
                  }

                  return result;
                },
                {
                  successMessage: "Employee added to team.",
                  spinnerTimeout: 30000, // 30 seconds timeout
                }
              );

              // If successful, close the modal
              await closeModalWithPromise("#addEmployeeModal");
            } catch (error) {
              // Error already handled by handleAsync
              await closeModalWithPromise("#addEmployeeModal");
            }
          });
        }

        window.openAddEmployeeToTeamModal = function () {
          $("#addEmployeeTeamSelectModal").modal("show");
          loadAddEmpTeamsList();
          const search = document.getElementById("addEmpTeamsListSearch");
          if (search) search.value = "";
        };

        async function loadAddEmpTeamsList() {
          try {
            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            addEmpTeamsListData = data.teams || [];
            renderAddEmpTeamsListTable(addEmpTeamsListData, "");
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to load teams list.");
          }
        }

        function renderAddEmpTeamsListTable(teams, filterText) {
          const tbody = document.querySelector("#addEmpTeamsListTable tbody");
          if (!tbody) return;
          tbody.innerHTML = "";
          const filter = (
            typeof filterText === "string" ? filterText : ""
          ).toLowerCase();
          teams
            .filter((team) => {
              const name =
                typeof team.team_name === "string"
                  ? team.team_name.toLowerCase()
                  : "";
              const lead = team.team_lead_email
                ? team.team_lead_email.toLowerCase()
                : "";
              return !filter || name.includes(filter) || lead.includes(filter);
            })
            .forEach((team) => {
              let leadEmail =
                team.team_lead_email ||
                '<span class="text-danger font-italic">No Team Lead</span>';

              // Add member count if available
              let memberCount = "";
              if (team.members && Array.isArray(team.members)) {
                memberCount = `<span class="badge badge-info">${team.members.length} members</span>`;
              }

              const teamObj = JSON.stringify(team).replace(/"/g, "&quot;");
              const tr = document.createElement("tr");
              tr.innerHTML = `
    <td>${team.team_name}</td>
    <td>${leadEmail}</td>
    <td>${team.created_at || "N/A"} ${memberCount}</td>
    <td>
      <button class="btn btn-info btn-sm" onclick='window.openAddEmployeeChooseModal(${teamObj})'>Choose</button>
    </td>
  `;
              tbody.appendChild(tr);
            });
        }

        const addEmpTeamsListSearch = document.getElementById(
          "addEmpTeamsListSearch"
        );
        if (addEmpTeamsListSearch) {
          addEmpTeamsListSearch.addEventListener("input", function () {
            renderAddEmpTeamsListTable(addEmpTeamsListData, this.value);
          });
        }

        async function fetchAddEmpAllUsers() {
          try {
            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            // Clean up the roles for dual-role users
            (data.users || []).forEach((user) => {
              if (user.role && user.role.split(" / ").length > 1) {
                // Only keep unique values, so "admin / admin" becomes "admin"
                const uniqueRoles = [...new Set(user.role.split(" / "))];
                user.role = uniqueRoles.join(" / ");
              }
            });

            return data.users || [];
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to fetch users.");
            return [];
          }
        }

        window.openAddEmployeeChooseModal = async function (team) {
          try {
            const token = sessionStorage.getItem("adminToken");

            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: { Authorization: "Bearer " + token },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            // Clean up roles for dual-role users
            (data.users || []).forEach((user) => {
              if (user.role && user.role.split(" / ").length > 1) {
                const uniqueRoles = [...new Set(user.role.split(" / "))];
                user.role = uniqueRoles.join(" / ");
              }
            });

            addEmpAllUsers = data.users || [];
            const teamWithMembers = (data.teams || []).find(
              (t) => String(t.team_id) === String(team.team_id)
            );

            addEmpSelectedTeam = teamWithMembers || team;

            // Ensure we have a members array
            addEmpTeamMembers =
              teamWithMembers && Array.isArray(teamWithMembers.members)
                ? teamWithMembers.members
                : [];

            logDebug(
              `Team ${addEmpSelectedTeam.team_name} has ${addEmpTeamMembers.length} members`
            );

            // Log member details for debugging
            if (addEmpTeamMembers.length > 0) {
              logDebug(
                "Team members:",
                addEmpTeamMembers.map((m) => ({
                  email: m.email,
                  id: m.id,
                  admin_id: m.admin_id,
                  employee_id: m.employee_id,
                  user_type: m.user_type,
                }))
              );
            }

            pendingAddUsers = [];

            document.getElementById("add_employee_team_id").value =
              addEmpSelectedTeam.team_id;
            document.getElementById("addEmpTeamDetails").innerHTML = `
        <b>Team Name:</b> ${addEmpSelectedTeam.team_name}<br>
        <b>Team Lead:</b> ${
          addEmpSelectedTeam.team_lead_email ||
          '<span class="text-danger font-italic">No Team Lead</span>'
        }<br>
        <b>Members:</b> ${addEmpTeamMembers.length} team members<br>
        <b>Created At:</b> ${addEmpSelectedTeam.created_at || "N/A"}
      `;

            renderAddEmpTeamMembersTable();

            // Ensure modal transitions are sequential
            await closeModalWithPromise("#addEmployeeTeamSelectModal");
            await showModalWithPromise("#addEmployeeModal");
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to load team details.");
            console.error("Error loading team details:", error);
          }
        };

        function renderAddEmpTeamMembersTable() {
          const tbody = document.querySelector("#addEmpTeamMembersTable tbody");
          if (!tbody) {
            logDebug("Could not find #addEmpTeamMembersTable tbody");
            return;
          }
          tbody.innerHTML = "";

          // Count of users by state for diagnostics
          let alreadyMembersCount = 0;
          let pendingAddCount = 0;
          let availableToAddCount = 0;

          addEmpAllUsers.forEach((user) => {
            // Enhanced check for already being a member - consider both email and IDs
            const isAlready = addEmpTeamMembers.some((member) => {
              // Matching by email is most reliable
              if (
                member.email &&
                member.email.toLowerCase() === user.email.toLowerCase()
              ) {
                logDebug(`User ${user.email} matched as member by email`);
                return true;
              }

              // If no email match, try matching by admin_id
              if (
                member.admin_id &&
                user.admin_id &&
                String(member.admin_id) === String(user.admin_id)
              ) {
                logDebug(
                  `User ${user.email} matched as member by admin_id: ${user.admin_id}`
                );
                return true;
              }

              // If no admin_id match, try matching by employee_id
              if (
                member.employee_id &&
                user.employee_id &&
                String(member.employee_id) === String(user.employee_id)
              ) {
                logDebug(
                  `User ${user.email} matched as member by employee_id: ${user.employee_id}`
                );
                return true;
              }

              // Last resort, try matching by id field (for backward compatibility)
              if (
                member.id &&
                user.id &&
                String(member.id) === String(user.id) &&
                member.user_type === user.user_type
              ) {
                logDebug(
                  `User ${user.email} matched as member by id: ${user.id} and user_type: ${user.user_type}`
                );
                return true;
              }

              return false;
            });

            const willBeAdded = pendingAddUsers.some(
              (u) => u.email.toLowerCase() === user.email.toLowerCase()
            );

            // Update counters for diagnostics
            if (isAlready) {
              alreadyMembersCount++;
            } else if (willBeAdded) {
              pendingAddCount++;
            } else {
              availableToAddCount++;
            }

            let buttonHtml = "";
            let buttonClass = "";
            let rowClass = "";

            if (isAlready) {
              buttonHtml = `<button type="button" class="btn btn-sm btn-secondary" disabled>Member</button>`;
              rowClass = "table-secondary"; // Light gray background for current members
            } else if (willBeAdded) {
              buttonHtml = `<button type="button" class="btn btn-sm btn-warning" disabled>Pending</button>`;
              rowClass = "table-warning"; // Light yellow background for pending additions
            } else {
              buttonHtml = `<button type="button" class="btn btn-sm btn-success" onclick="window.stageUserToTeamHandler('${user.email.replace(
                /'/g,
                "\\'"
              )}', ${user.id})">Add</button>`;
            }

            const tr = document.createElement("tr");
            if (rowClass) tr.className = rowClass;

            // Get user details for display
            const userRole = user.role || "";
            const userIdDetails =
              user.admin_id && user.employee_id
                ? `<small class="text-muted">(Admin #${user.admin_id}, Emp #${user.employee_id})</small>`
                : user.admin_id
                ? `<small class="text-muted">(Admin #${user.admin_id})</small>`
                : user.employee_id
                ? `<small class="text-muted">(Emp #${user.employee_id})</small>`
                : "";

            tr.innerHTML = `
        <td>${user.email} ${userIdDetails}</td>
        <td>${userRole}</td>
        <td>${buttonHtml}</td>
      `;
            tbody.appendChild(tr);
          });

          // Log counts for diagnostics
          logDebug(
            `User counts in team member table - Already members: ${alreadyMembersCount}, Pending: ${pendingAddCount}, Available: ${availableToAddCount}`
          );
        }

        window.stageUserToTeamHandler = function (userEmail, userId) {
          const userObj = addEmpAllUsers.find(
            (u) => u.email.toLowerCase() === userEmail.toLowerCase()
          );

          if (!userObj) {
            logDebug(
              `Could not find user with email ${userEmail} in addEmpAllUsers`
            );
            return;
          }

          // Check if already being added using email (more reliable than id)
          const alreadyPending = pendingAddUsers.some(
            (u) => u.email.toLowerCase() === userEmail.toLowerCase()
          );

          if (!alreadyPending) {
            logDebug(`Adding user ${userEmail} to pending list`);
            pendingAddUsers.push(userObj);
            renderAddEmpTeamMembersTable();
          } else {
            logDebug(`User ${userEmail} already in pending list`);
          }
        };

        window.savePendingAddUsers = async function () {
          if (!pendingAddUsers.length) {
            logDebug("No pending users to add, closing modal");
            await closeModalWithPromise("#addEmployeeModal");
            return;
          }

          try {
            const teamId = addEmpSelectedTeam.team_id;
            const token = sessionStorage.getItem("adminToken");

            logDebug(
              `Saving ${pendingAddUsers.length} users to team ${teamId}`
            );

            // Use handleAsync for the entire operation with progress tracking
            await ModalUtility.handleAsync(
              async () => {
                // Process each user addition sequentially
                for (let user of pendingAddUsers) {
                  logDebug(`Adding user ${user.email} to team ${teamId}`);

                  const formData = new FormData();
                  formData.append("team_id", teamId);
                  formData.append("user_email", user.email);

                  const response = await fetch("/team_management/add_user", {
                    method: "POST",
                    headers: { Authorization: "Bearer " + token },
                    body: formData,
                  });

                  if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(
                      data.error || `Failed to add user ${user.email}`
                    );
                  }

                  logDebug(
                    `Successfully added user ${user.email} to team ${teamId}`
                  );
                }
              },
              {
                // Custom options for this specific operation
                successMessage: `${pendingAddUsers.length} user${
                  pendingAddUsers.length !== 1 ? "s" : ""
                } added to team.`,
                spinnerTimeout: 60000, // 60 seconds timeout for potentially long operation
              }
            );

            // Only if all operations succeed, close all modals
            await sequentialModalClose([
              "#addEmployeeModal",
              "#addEmployeeTeamSelectModal",
              "#teamsListModal",
              "#teamManagementActionsModal",
            ]);
          } catch (error) {
            // Error is already handled by handleAsync
            console.error("Error adding users:", error);
          }
        };

        window.cancelPendingAdds = function () {
          pendingAddUsers = [];
          $("#addEmployeeModal").modal("hide");
        };

        // Helper function to close a modal with Promise
        function closeModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("hide");
            $(modalSelector).on("hidden.bs.modal", function () {
              $(this).off("hidden.bs.modal");
              resolve();
            });
          });
        }

        // Helper function to show a modal with Promise
        function showModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("show");
            $(modalSelector).on("shown.bs.modal", function () {
              $(this).off("shown.bs.modal");
              resolve();
            });
          });
        }

        // Helper function to close modals in sequence
        async function sequentialModalClose(modalSelectors) {
          for (const selector of modalSelectors) {
            await closeModalWithPromise(selector);
          }
        }
      });
    </script>
    <!-- Script for adding employee to the team (End) -->

    <!-- Script for editing team details (Start) -->
    <script>
      /**
       * Team Editing Script - Fixed Modal Transitions
       * Current Date: 2025-08-02 19:39:26
       * Current User: Ratana3
       */
      // edit-team.js
      let teamsListData = [];
      let allUsers = [];
      let currentTeamLeadId = null;
      let currentTeamLeadType = null;
      let teamLeadTableClickAttached = false;

      document.addEventListener("DOMContentLoaded", function () {
        // Add click handler for the Edit Team button (merged from separate script)
        const editTeamBtn = document.getElementById("openEditTeamMainModalBtn");
        if (editTeamBtn) {
          console.log("[INFO] Found Edit Team button, attaching click handler");
          editTeamBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (typeof window.openEditTeamMainModal === "function") {
              window.openEditTeamMainModal();
            } else {
              console.error("[ERROR] openEditTeamMainModal function not found");
            }
          });
        } else {
          console.error(
            "[ERROR] Edit Team button with ID 'openEditTeamMainModalBtn' not found"
          );
        }

        // Log all modal events to help debug
        [
          "show.bs.modal",
          "shown.bs.modal",
          "hide.bs.modal",
          "hidden.bs.modal",
        ].forEach(function (event) {
          $(document).on(event, ".modal", function () {
            console.log(
              `[MODAL EVENT] ${event} on ${this.id || "unnamed modal"}`
            );
          });
        });

        // Remove Team Member Modal Submission
        var removeForm = document.getElementById("removeTeamMemberForm");
        if (removeForm) {
          removeForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            try {
              const token = sessionStorage.getItem("adminToken");
              const formData = new FormData(event.target);

              await ModalUtility.handleAsync(
                async () => {
                  const response = await fetch(
                    "/team_management/remove_member",
                    {
                      method: "POST",
                      headers: { Authorization: "Bearer " + token },
                      body: formData,
                    }
                  );

                  const result = await response.json();

                  if (!response.ok) {
                    throw new Error(
                      result.error || "Failed to remove team member."
                    );
                  }

                  return result;
                },
                {
                  successMessage: "Team member removed successfully.",
                  spinnerTimeout: 30000, // 30 seconds timeout
                }
              );

              // If successful, close the modal
              await closeModalWithPromise("#removeTeamMemberModal");
            } catch (error) {
              // Error already handled by handleAsync
              await closeModalWithPromise("#removeTeamMemberModal");
            }
          });
        }

        // Edit Team Modal Submission
        var editForm = document.getElementById("editTeamForm");
        if (editForm) {
          editForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            try {
              const token = sessionStorage.getItem("adminToken");
              const formData = new FormData(event.target);

              // Set both lead fields
              formData.set(
                "team_lead_employee_id",
                document.getElementById("edit_team_lead_employee_id").value ||
                  ""
              );
              formData.set(
                "team_lead_admin_id",
                document.getElementById("edit_team_lead_admin_id").value || ""
              );

              await ModalUtility.handleAsync(
                async () => {
                  const response = await fetch("/team_management/edit", {
                    method: "POST",
                    headers: { Authorization: "Bearer " + token },
                    body: formData,
                  });

                  const result = await response.json();

                  if (!response.ok) {
                    throw new Error(result.error || "Team update failed.");
                  }

                  return result;
                },
                {
                  successMessage: "Team updated successfully.",
                  spinnerTimeout: 30000, // 30 seconds timeout
                }
              );

              // If successful, close the modal
              await closeModalWithPromise("#editTeamModal");
            } catch (error) {
              // Error already handled by handleAsync
              await closeModalWithPromise("#editTeamModal");
            }
          });
        }

        // Function to display specific error messages in a modal
        window.queueErrorModal = function (message) {
          ModalUtility.showError(message);
        };

        // Fetch and render the teams list
        async function loadTeamsList() {
          try {
            await ModalUtility.showSpinner();

            const response = await fetch("/api/teams", {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            const data = await response.json();

            await ModalUtility.hideSpinner();

            teamsListData = data.teams || [];
            renderTeamsListTable(teamsListData, "");
          } catch (error) {
            await ModalUtility.hideSpinner();
            await ModalUtility.showError("Failed to load teams list.");
          }
        }

        // Make loadTeamsList globally available
        window.loadTeamsList = loadTeamsList;

        function renderTeamsListTable(teams, filterText) {
          const tbody = document.querySelector("#teamsListTable tbody");
          if (!tbody) {
            console.error("Could not find #teamsListTable tbody in DOM!");
            return;
          }
          tbody.innerHTML = "";
          const filter = (
            typeof filterText === "string" ? filterText : ""
          ).toLowerCase();
          teams
            .filter((team) => {
              const name =
                typeof team.team_name === "string"
                  ? team.team_name.toLowerCase()
                  : "";
              // Use unified team_lead_email for filter and display
              const lead =
                typeof team.team_lead_email === "string"
                  ? team.team_lead_email.toLowerCase()
                  : "";
              return !filter || name.includes(filter) || lead.includes(filter);
            })
            .forEach((team) => {
              let leadEmail = "";
              if (
                typeof team.team_lead_email === "string" &&
                team.team_lead_email
              ) {
                leadEmail = team.team_lead_email;
              } else {
                leadEmail =
                  '<span class="text-danger font-italic">No Team Lead</span>';
              }
              const teamObj = JSON.stringify(team).replace(/"/g, "&quot;");
              const tr = document.createElement("tr");
              tr.innerHTML = `
          <td>${team.team_name}</td>
          <td>${leadEmail}</td>
          <td>${team.created_at}</td>
          <td>
            <button class="btn btn-info btn-sm" onclick='window.openEditTeamModalFromList(${teamObj})'>Edit</button>
          </td>
        `;
              tbody.appendChild(tr);
            });
        }

        const teamsListSearch = document.getElementById("teamsListSearch");
        if (teamsListSearch) {
          teamsListSearch.addEventListener("input", function () {
            renderTeamsListTable(teamsListData, this.value);
          });
        }

        window.openTeamsListModal = function () {
          showModalWithPromise("#teamsListModal").then(() => {
            loadTeamsList();
            if (teamsListSearch) teamsListSearch.value = "";
          });
        };

        window.openRemoveMemberModal = function (team_id, employee_id) {
          document.getElementById("remove_member_team_id").value = team_id;
          document.getElementById("remove_member_employee_id").value =
            employee_id;
          showModalWithPromise("#removeTeamMemberModal");
        };

        window.openEditTeamModal = function (team) {
          const editTeamId = document.getElementById("edit_team_id");
          if (editTeamId) editTeamId.value = team.team_id;
          const editTeamName = document.getElementById("edit_team_name");
          if (editTeamName) editTeamName.value = team.team_name;
          // Set both lead IDs!
          const editTeamLeadEmployeeId = document.getElementById(
            "edit_team_lead_employee_id"
          );
          const editTeamLeadAdminId = document.getElementById(
            "edit_team_lead_admin_id"
          );
          if (editTeamLeadEmployeeId)
            editTeamLeadEmployeeId.value = team.team_lead_employee_id || "";
          if (editTeamLeadAdminId)
            editTeamLeadAdminId.value = team.team_lead_admin_id || "";

          showModalWithPromise("#editTeamModal");
        };

        $("#editTeamModal").on("hidden.bs.modal", function (e) {
          showModalWithPromise("#teamManagementActionsModal");
        });

        // Helper function to close a modal with Promise
        function closeModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("hide");
            $(modalSelector).on("hidden.bs.modal", function () {
              $(this).off("hidden.bs.modal");
              resolve();
            });
          });
        }

        // Helper function to show a modal with Promise
        function showModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("show");
            $(modalSelector).on("shown.bs.modal", function () {
              $(this).off("shown.bs.modal");
              resolve();
            });
          });
        }

        // Helper function to clear all modal backdrops
        function clearAllModalBackdrops() {
          document.querySelectorAll(".modal-backdrop").forEach((backdrop) => {
            backdrop.parentNode.removeChild(backdrop);
          });

          // Remove modal open class and inline styles from body
          document.body.classList.remove("modal-open");
          document.body.style.paddingRight = "";
          document.body.style.overflow = "";
        }

        // Helper function to close modals in sequence
        async function sequentialModalClose(modalSelectors) {
          for (const selector of modalSelectors) {
            await closeModalWithPromise(selector);
          }
        }
      });

      /**
       * FIXED: Better error handling in fetchAllUsersFromTeams
       * Current Date: 2025-08-02 19:39:26
       * Current User: Ratana3
       */
      async function fetchAllUsersFromTeams() {
        // Add a safety timeout to prevent stuck spinner
        const spinnerTimeout = setTimeout(() => {
          console.warn(
            "[WARN] User fetch spinner timeout triggered after 5 seconds"
          );
          if (typeof ModalUtility !== "undefined") {
            ModalUtility.hideSpinner();
          }
        }, 5000);

        try {
          const response = await fetch("/api/teams", {
            headers: {
              Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
            },
          });

          if (!response.ok) {
            throw new Error(
              `API error: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();

          // Clean up the roles for dual-role users
          (data.users || []).forEach((user) => {
            if (user.role && user.role.split(" / ").length > 1) {
              const uniqueRoles = [...new Set(user.role.split(" / "))];
              user.role = uniqueRoles.join(" / ");
            }
          });

          clearTimeout(spinnerTimeout);
          return data.users || [];
        } catch (error) {
          console.error("[ERROR] Failed to fetch users:", error);
          clearTimeout(spinnerTimeout);
          throw error; // Re-throw to be handled by the caller
        }
      }

      /**
       * FIXED: Function to render team lead table
       * Current Date: 2025-08-02 19:39:26
       * Current User: Ratana3
       */
      function renderTeamLeadTable(users, filterText, currentLeadId) {
        const table = document.getElementById("teamLeadTable");
        if (!table) {
          console.error("teamLeadTable not found in DOM!");
          return;
        }
        const tbody = table.querySelector("tbody");
        if (!tbody) {
          console.error("teamLeadTable tbody not found in DOM!");
          return;
        }
        tbody.innerHTML = "";

        const userMap = {};
        users.forEach((user) => {
          if (!user.email) return;
          const email = user.email.toLowerCase();
          if (!userMap[email] || user.user_type === "admin") {
            userMap[email] = user;
          }
        });

        let uniqueUsers = Object.values(userMap);

        if (filterText) {
          uniqueUsers = uniqueUsers.filter(
            (user) =>
              user.email.toLowerCase().includes(filterText) ||
              (user.role && user.role.toLowerCase().includes(filterText))
          );
        }

        uniqueUsers.forEach((user) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
  <td>${user.email}</td>
  <td>${user.role || ""}</td>
  <td>
    <button class="btn btn-sm ${
      user.employee_id == currentTeamLeadId || user.id == currentTeamLeadId
        ? "btn-secondary"
        : "btn-primary"
    } assign-lead-btn"
      data-id="${user.id}"
      data-email="${user.email}"
      data-user-type="${user.user_type}"
      ${
        user.employee_id == currentTeamLeadId || user.id == currentTeamLeadId
          ? "disabled"
          : ""
      }
    >${
      user.employee_id == currentTeamLeadId || user.id == currentTeamLeadId
        ? "Current Lead"
        : "Assign"
    }</button>
  </td>
`;
          tbody.appendChild(tr);
        });
      }

      /**
       * FIXED: Function to attach team lead table click handler
       * Current Date: 2025-08-02 19:39:26
       * Current User: Ratana3
       */
      function attachTeamLeadTableClickHandler() {
        const table = document.getElementById("teamLeadTable");
        if (!table) return;

        table.addEventListener("click", function (e) {
          if (e.target.classList.contains("assign-lead-btn")) {
            const id = e.target.getAttribute("data-id");
            const email = e.target.getAttribute("data-email");
            const userType = e.target.getAttribute("data-user-type");

            // Find selected user
            const selectedUser = allUsers.find(
              (u) => u.id == id && u.email == email
            );
            const editTeamLeadEmail = document.getElementById(
              "edit_team_lead_email"
            );

            // Handle dual-role user
            if (
              selectedUser &&
              selectedUser.admin_id &&
              selectedUser.employee_id
            ) {
              document.getElementById("edit_team_lead_employee_id").value =
                selectedUser.employee_id;
              document.getElementById("edit_team_lead_admin_id").value =
                selectedUser.admin_id;
            } else if (userType === "employee") {
              document.getElementById("edit_team_lead_employee_id").value = id;
              document.getElementById("edit_team_lead_admin_id").value = "";
            } else if (userType === "admin") {
              document.getElementById("edit_team_lead_admin_id").value = id;
              document.getElementById("edit_team_lead_employee_id").value = "";
            }

            // Update displayed email
            if (editTeamLeadEmail) editTeamLeadEmail.value = email;

            // Update current lead ID
            currentTeamLeadId = id;

            // Re-render table
            const searchInput = document.getElementById("team_lead_search");
            renderTeamLeadTable(
              allUsers,
              searchInput ? searchInput.value.toLowerCase() : "",
              currentTeamLeadId
            );
          }
        });

        teamLeadTableClickAttached = true;
      }

      /**
       * FIXED: Edit Team Modal From List function with improved error handling
       * Current Date: 2025-08-02 19:39:26
       * Current User: Ratana3
       */
      window.openEditTeamModalFromList = async function (team) {
        console.log("[DEBUG] Edit team row clicked for team:", team.team_name);

        // Set a safety timeout to prevent stuck spinner
        const spinnerTimeout = setTimeout(() => {
          console.warn("[WARN] Edit team spinner safety timeout triggered");
          if (typeof ModalUtility !== "undefined") {
            ModalUtility.hideSpinner();
          }
        }, 5000);

        try {
          // Close the teams list modal first
          $("#teamsListModal").modal("hide");

          // Clear backdrops to prevent stacking issues
          setTimeout(function () {
            $(".modal-backdrop").remove();
            $("body").removeClass("modal-open").css({
              overflow: "",
              "padding-right": "",
            });

            // Set up form fields
            const editTeamId = document.getElementById("edit_team_id");
            if (editTeamId) editTeamId.value = team.team_id;

            const editTeamName = document.getElementById("edit_team_name");
            if (editTeamName) editTeamName.value = team.team_name;

            // Set both lead IDs if present
            const editTeamLeadEmployeeId = document.getElementById(
              "edit_team_lead_employee_id"
            );
            const editTeamLeadAdminId = document.getElementById(
              "edit_team_lead_admin_id"
            );
            const editTeamLeadEmail = document.getElementById(
              "edit_team_lead_email"
            );

            if (editTeamLeadEmployeeId) {
              editTeamLeadEmployeeId.value = team.team_lead_employee_id || "";
            }

            if (editTeamLeadAdminId) {
              editTeamLeadAdminId.value = team.team_lead_admin_id || "";
            }

            if (editTeamLeadEmail) {
              editTeamLeadEmail.value = team.team_lead_email || "";
            }

            // Show spinner for user fetch
            if (typeof ModalUtility !== "undefined") {
              ModalUtility.showSpinner();
            }

            // Fetch users with proper error handling
            fetchAllUsersFromTeams()
              .then((users) => {
                allUsers = users;

                // Find current lead
                let currentLead = null;
                if (team.team_lead_employee_id) {
                  currentLead = allUsers.find(
                    (user) =>
                      user.employee_id == team.team_lead_employee_id ||
                      user.id == team.team_lead_employee_id
                  );
                }

                if (!currentLead && team.team_lead_admin_id) {
                  currentLead = allUsers.find(
                    (user) =>
                      user.admin_id == team.team_lead_admin_id ||
                      user.id == team.team_lead_admin_id
                  );
                }

                currentTeamLeadId = currentLead
                  ? currentLead.employee_id || currentLead.id
                  : "";
                currentTeamLeadType = currentLead ? currentLead.user_type : "";

                // Set up team lead search
                renderTeamLeadTable(allUsers, "", currentTeamLeadId);
                const searchInput = document.getElementById("team_lead_search");
                if (searchInput) {
                  searchInput.value = "";
                  searchInput.oninput = function () {
                    renderTeamLeadTable(
                      allUsers,
                      searchInput.value.toLowerCase(),
                      currentTeamLeadId
                    );
                  };
                }

                // Attach click handler if not already done
                if (!teamLeadTableClickAttached) {
                  attachTeamLeadTableClickHandler();
                }

                // Hide spinner now that data is loaded
                if (typeof ModalUtility !== "undefined") {
                  ModalUtility.hideSpinner();
                }

                // Show edit modal
                $("#editTeamModal").modal("show");

                // Clear the safety timeout
                clearTimeout(spinnerTimeout);
              })
              .catch((error) => {
                console.error("[ERROR] Failed to fetch team data:", error);
                if (typeof ModalUtility !== "undefined") {
                  ModalUtility.hideSpinner();
                  ModalUtility.showError(
                    "Failed to load team data: " +
                      (error.message || "Unknown error")
                  );
                }
                clearTimeout(spinnerTimeout);
              });
          }, 300);
        } catch (error) {
          console.error("[ERROR] Error in edit team modal:", error);
          if (typeof ModalUtility !== "undefined") {
            ModalUtility.hideSpinner();
            ModalUtility.showError("An error occurred while editing the team.");
          }
          clearTimeout(spinnerTimeout);
        }
      };

      /**
       * Fixed Modal Transition Function with Better Error Handling
       * Current Date: 2025-08-02 19:39:26
       * Current User: Ratana3
       */
      window.openEditTeamMainModal = function () {
        console.log(
          "[DEBUG] Edit team button clicked at",
          new Date().toISOString()
        );

        // Set a timeout safety net to hide spinner if anything goes wrong
        const spinnerSafetyTimeout = setTimeout(() => {
          console.warn(
            "[WARN] Spinner safety timeout triggered - forcing spinner to hide"
          );
          if (
            typeof ModalUtility !== "undefined" &&
            typeof ModalUtility.hideSpinner === "function"
          ) {
            ModalUtility.hideSpinner();
          }
        }, 5000); // 5 second safety net

        try {
          // Step 1: Close the current modal
          $("#teamManagementActionsModal").modal("hide");

          // Step 2: Wait for animation to complete and clear backdrops
          setTimeout(function () {
            try {
              // Clear any leftover backdrops and reset body
              $(".modal-backdrop").remove();
              $("body").removeClass("modal-open").css({
                overflow: "",
                "padding-right": "",
              });

              // Step 3: Show the teams list modal
              $("#teamsListModal").modal("show");

              // Step 4: Load teams after modal is visible - with error handling
              $("#teamsListModal").on("shown.bs.modal", function () {
                $(this).off("shown.bs.modal"); // Prevent multiple calls

                try {
                  // Cancel the safety timeout as we've reached this point
                  clearTimeout(spinnerSafetyTimeout);

                  // Load teams data
                  if (typeof window.loadTeamsList === "function") {
                    window.loadTeamsList().catch((error) => {
                      console.error("[ERROR] Failed to load teams:", error);
                      if (typeof ModalUtility !== "undefined") {
                        ModalUtility.hideSpinner();
                        ModalUtility.showError(
                          "Failed to load teams list. Please try again."
                        );
                      }
                    });
                  } else {
                    console.error("[ERROR] loadTeamsList function not found");
                    if (typeof ModalUtility !== "undefined") {
                      ModalUtility.hideSpinner();
                      ModalUtility.showError(
                        "System error: Teams list function not available."
                      );
                    }
                  }
                } catch (innerError) {
                  console.error(
                    "[ERROR] Error in modal shown handler:",
                    innerError
                  );
                  if (typeof ModalUtility !== "undefined") {
                    ModalUtility.hideSpinner();
                    ModalUtility.showError(
                      "An error occurred while loading teams."
                    );
                  }
                }
              });
            } catch (timeoutError) {
              console.error("[ERROR] Error in timeout callback:", timeoutError);
              clearTimeout(spinnerSafetyTimeout);
              if (typeof ModalUtility !== "undefined") {
                ModalUtility.hideSpinner();
                ModalUtility.showError(
                  "An error occurred while preparing the teams list."
                );
              }
            }
          }, 300); // 300ms delay allows for modal closing animation
        } catch (outerError) {
          console.error("[ERROR] Error in openEditTeamMainModal:", outerError);
          clearTimeout(spinnerSafetyTimeout);
          if (typeof ModalUtility !== "undefined") {
            ModalUtility.hideSpinner();
            ModalUtility.showError("An error occurred. Please try again.");
          }
        }
      };
    </script>
    <!-- Script for editing team details (End) -->

    <!-- Script for populating the employees in the dropdown and list when submitting a new team (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = sessionStorage.getItem("adminToken");
        if (!token) {
          await ModalUtility.showError("Unauthorized. Please log in.");
          return;
        }

        // Initialize pagination and search state
        let currentPage = 1;
        let searchTerm = "";
        let departmentFilterValue = ""; // Changed variable name to avoid confusion
        let statusFilterValue = ""; // Changed variable name to avoid confusion

        // Function to load employees with pagination and filtering
        async function loadEmployeeData() {
          console.log("[loadEmployeeData] START");

          try {
            await ModalUtility.showSpinner();

            // Build query parameters
            const params = new URLSearchParams({
              page: currentPage,
              per_page: 40,
            });

            if (searchTerm) params.set("search", searchTerm);
            if (departmentFilterValue)
              params.set("department", departmentFilterValue);
            if (statusFilterValue) params.set("status", statusFilterValue);

            console.log(
              "[loadEmployeeData] Fetching /team_management_data with:",
              params.toString()
            );

            const response = await fetch(
              `/team_management_data?${params.toString()}`,
              {
                headers: {
                  Authorization: "Bearer " + token,
                },
              }
            );

            console.log(
              "[loadEmployeeData] Fetch response status:",
              response.status
            );

            if (!response.ok) {
              throw new Error(
                `Failed to fetch employee data (Status: ${response.status})`
              );
            }

            const data = await response.json();
            console.log("[loadEmployeeData] Data received:", data);

            const employees = data.selectable_employees || [];

            // Clear existing options
            const teamLeadSelect = document.getElementById("team_lead");
            const membersSelect = document.getElementById("members");

            if (teamLeadSelect) {
              teamLeadSelect.innerHTML =
                '<option value="">Select Team Lead</option>';
            }

            if (membersSelect) {
              membersSelect.innerHTML =
                '<option value="">Select Members</option>';
            }

            // Populate dropdowns
            employees.forEach((emp) => {
              const option = new Option(
                emp.email || `Employee ID: ${emp.employee_id}`,
                emp.employee_id
              );

              if (teamLeadSelect) {
                teamLeadSelect.appendChild(option.cloneNode(true));
              }

              if (membersSelect) {
                membersSelect.appendChild(option.cloneNode(true));
              }
            });

            // If pagination is displayed, update it
            if (data.pagination && document.getElementById("pagination")) {
              renderPagination(data.pagination);
            }

            console.log(
              "[loadEmployeeData] END - hideSpinner called (success)"
            );
            await ModalUtility.hideSpinner();
          } catch (error) {
            console.error("[loadEmployeeData] ERROR:", error);
            await ModalUtility.hideSpinner();
            await ModalUtility.showError(
              "Could not load employee list: " + error.message
            );
          }
        }

        // Function to render pagination controls
        function renderPagination(pagination) {
          const paginationElement = document.getElementById("pagination");
          if (!paginationElement) return;

          let html = "";

          // Previous button
          html += `<li class="page-item ${
            pagination.page <= 1 ? "disabled" : ""
          }">
      <a class="page-link" href="#" ${
        pagination.page > 1 ? 'data-page="' + (pagination.page - 1) + '"' : ""
      }>Previous</a>
    </li>`;

          // Page numbers
          for (let i = 1; i <= pagination.pages; i++) {
            html += `<li class="page-item ${
              pagination.page === i ? "active" : ""
            }">
        <a class="page-link" href="#" data-page="${i}">${i}</a>
      </li>`;
          }

          // Next button
          html += `<li class="page-item ${
            pagination.page >= pagination.pages ? "disabled" : ""
          }">
      <a class="page-link" href="#" ${
        pagination.page < pagination.pages
          ? 'data-page="' + (pagination.page + 1) + '"'
          : ""
      }>Next</a>
    </li>`;

          paginationElement.innerHTML = html;

          // Add event listeners to pagination links
          paginationElement.querySelectorAll("a[data-page]").forEach((link) => {
            link.addEventListener("click", function (e) {
              e.preventDefault();
              currentPage = parseInt(this.getAttribute("data-page"));
              loadEmployeeData();
            });
          });
        }

        // Add event listeners for search and filters if they exist
        const searchInput = document.getElementById("employee-search");
        if (searchInput) {
          searchInput.addEventListener("input", function () {
            searchTerm = this.value.trim();
            currentPage = 1; // Reset to first page when searching

            // Use debounce to avoid excessive API calls during typing
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
              loadEmployeeData();
            }, 300);
          });
        }

        const departmentFilterElement =
          document.getElementById("department-filter");
        if (departmentFilterElement) {
          departmentFilterElement.addEventListener("change", function () {
            departmentFilterValue = this.value;
            currentPage = 1;
            loadEmployeeData();
          });
        }

        const statusFilterElement = document.getElementById("status-filter");
        if (statusFilterElement) {
          statusFilterElement.addEventListener("change", function () {
            statusFilterValue = this.value;
            currentPage = 1;
            loadEmployeeData();
          });
        }

        // Initial load with proper error handling
        try {
          await ModalUtility.handleAsync(loadEmployeeData, {
            showSuccessMessage: false, // Don't show success message for initial load
            showErrorMessage: true,
            spinnerTimeout: 30000, // 30 seconds timeout
          });
        } catch (error) {
          console.error("Initial data load failed:", error);
          // Error is already handled by handleAsync
        }
      });
    </script>
    <!-- Script for populating the employees in the dropdown and list when submitting a new team (End) -->

    <!-- Script for adding a new team (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const teamLeadSelect = document.getElementById("team_lead");
        const membersSelect = document.getElementById("members");
        const teamForm = document.getElementById("teamForm");

        if (!teamLeadSelect || !membersSelect || !teamForm) {
          console.error("Team form elements not found in DOM");
          return;
        }

        // Load users for dropdowns
        await loadUsersForDropdowns();

        // Set up form submission handler
        teamForm.addEventListener("submit", handleFormSubmission);

        /**
         * Loads all users (employees and admins) for dropdown selection
         */
        async function loadUsersForDropdowns() {
          try {
            await ModalUtility.showSpinner();

            // Fetch users data from /api/teams endpoint
            const response = await fetch("/api/teams", {
              method: "GET",
              headers: {
                Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
                Accept: "application/json",
              },
            });

            if (!response.ok) {
              throw new Error(
                `Failed to fetch users data (Status: ${response.status})`
              );
            }

            const data = await response.json();

            // Check if we have valid users data
            if (!data.users || !Array.isArray(data.users)) {
              throw new Error("Invalid users data received from server");
            }

            // Log the raw users data for debugging
            console.log("[DEBUG] Raw users data:", data.users);

            // Sort users alphabetically by email
            const sortedUsers = data.users.sort((a, b) => {
              return a.email.toLowerCase().localeCompare(b.email.toLowerCase());
            });

            // Clear existing options
            teamLeadSelect.innerHTML =
              '<option value="">Select Team Lead</option>';
            membersSelect.innerHTML = "";

            // Keep track of which users we've added to check for missing ones
            const addedEmails = [];

            // Populate both dropdowns with ALL users
            sortedUsers.forEach((user) => {
              // Skip users without email (shouldn't happen, but just in case)
              if (!user.email) return;

              addedEmails.push(user.email);

              // Determine what label to show - simplified role display
              let roleLabel;
              if (user.user_type === "employee") {
                roleLabel = "Employee";
              } else if (user.role) {
                // If role contains slashes (dual role), take the first part
                const primaryRole = user.role.split("/")[0].trim();
                // Capitalize first letter of role
                roleLabel =
                  primaryRole.charAt(0).toUpperCase() + primaryRole.slice(1);
              } else {
                roleLabel = "Admin"; // Fallback
              }

              const userLabel = `${user.email} (${roleLabel})`;

              // Create option for team lead dropdown - use email as value since backend accepts it
              const leadOption = document.createElement("option");
              leadOption.value = user.email;
              leadOption.textContent = userLabel;
              teamLeadSelect.appendChild(leadOption);

              // Only add to members dropdown if user has an employee_id
              if (user.employee_id) {
                const memberOption = document.createElement("option");
                memberOption.value = user.employee_id;
                memberOption.textContent = userLabel;
                membersSelect.appendChild(memberOption);
              }
            });

            // Log success and which emails were added
            console.log(
              `[INFO] Added ${
                addedEmails.length
              } users to dropdowns: ${addedEmails.join(", ")}`
            );

            // Double-check for vonxbone1@gmail.com
            if (addedEmails.includes("vonxbone1@gmail.com")) {
              console.log(
                "[INFO] vonxbone1@gmail.com was successfully added to dropdowns"
              );
            } else {
              console.warn(
                "[WARNING] vonxbone1@gmail.com was NOT found in the users data!"
              );
            }

            // Initialize Select2 if it's available
            if (typeof $.fn.select2 !== "undefined") {
              $("#members").select2({
                placeholder: "Select team members",
                allowClear: true,
                width: "100%",
              });
            }
          } catch (error) {
            console.error("Error loading users for team form:", error);
            await ModalUtility.showError(
              "Failed to load users. Please refresh the page and try again."
            );
          } finally {
            await ModalUtility.hideSpinner();
          }
        }

        /**
         * Handles form submission for team creation
         */
        async function handleFormSubmission(event) {
          event.preventDefault();

          const token = sessionStorage.getItem("adminToken");
          if (!token) {
            await ModalUtility.showError("Unauthorized: Please log in.");
            return;
          }

          const teamName = document.getElementById("team_name").value;
          const teamLead = teamLeadSelect.value;
          const members = Array.from(membersSelect.selectedOptions).map(
            (opt) => opt.value
          );

          // Validate form
          if (!teamName) {
            await ModalUtility.showError("Please enter a team name.");
            return;
          }

          if (!teamLead) {
            await ModalUtility.showError("Please select a team lead.");
            return;
          }

          if (!members.length) {
            await ModalUtility.showError(
              "Please select at least one team member."
            );
            return;
          }

          // Create form data for submission
          const formData = new FormData();
          formData.append("team_name", teamName);
          formData.append("team_lead", teamLead); // Backend accepts email or ID

          // Add all selected members
          members.forEach((memberId) => {
            formData.append("members", memberId);
          });

          // Log what we're sending to the server
          console.log("[INFO] Submitting team with:", {
            team_name: teamName,
            team_lead: teamLead,
            members: members,
          });

          try {
            // Use handleAsync for cleaner code with automatic spinner management
            await ModalUtility.handleAsync(
              async () => {
                const response = await fetch("/team_management", {
                  method: "POST",
                  headers: {
                    Authorization: "Bearer " + token,
                  },
                  body: formData,
                });

                // Handle HTTP errors first
                if (!response.ok) {
                  const result = await response.json();
                  throw new Error(
                    result.error || `Team creation failed (${response.status})`
                  );
                }

                // Parse the response
                const result = await response.json();

                // If successful, reset the form and Select2 if used
                teamForm.reset();
                if (typeof $.fn.select2 !== "undefined") {
                  $("#members").val(null).trigger("change");
                }

                // Log success
                console.log(
                  `[SUCCESS] Team "${teamName}" created successfully at 2025-08-02 16:15:45 by Ratana3`
                );

                // Return the result message for the success modal
                return result.message || "Team created successfully.";
              },
              {
                successMessage: "Team created successfully.",
                spinnerTimeout: 30000, // 30 seconds timeout
                showSuccessMessage: false, // We'll handle success message ourselves
              }
            );

            // Custom success modal with reload behavior
            await ModalUtility.showSuccess("Team created successfully!");

            // Add click handler to reload page after closing success modal
            $("#successModalCloseBtn")
              .off("click")
              .on("click", function () {
                window.location.reload();
              });

            // Auto reload after 3 seconds if user doesn't click
            setTimeout(() => {
              window.location.reload();
            }, 3000);
          } catch (error) {
            // Error is already handled by handleAsync, but we log it for debugging
            console.error("Team creation error:", error);
          }
        }
      });
    </script>
    <!-- Script for adding a new team (End) -->

    <!-- Script for adding new employees (Start) -->
    <script>
      /**
       * Add Employee Form Handler Script
       * Current Date and Time (UTC): 2025-08-03 09:57:32
       * Current User's Login: Ratana3
       */
      document.addEventListener("DOMContentLoaded", function () {
        // Tab navigation behavior
        document
          .querySelectorAll('#employeeFormTabs a[data-toggle="tab"]')
          .forEach(function (tabLink) {
            tabLink.addEventListener("show.bs.tab", function (e) {
              let form = document.getElementById("addNewEmployeeForm");
              if (form) form.noValidate = true;
            });
          });

        // Form validation setup
        var form = document.getElementById("addNewEmployeeForm");
        if (form) {
          form.addEventListener("submit", function (e) {
            form.noValidate = false;
            if (!form.checkValidity()) {
              e.preventDefault();
              e.stopPropagation();
              form.classList.add("was-validated");
            }
          });
        }

        // Set up password toggle visibility
        const togglePasswordBtn = document.getElementById("togglePassword");
        if (togglePasswordBtn) {
          togglePasswordBtn.addEventListener("click", function () {
            const passwordField = document.getElementById(
              "add_employee_password"
            );
            if (passwordField) {
              if (passwordField.type === "password") {
                passwordField.type = "text";
                this.innerHTML = '<i class="mdi mdi-eye-off"></i>';
              } else {
                passwordField.type = "password";
                this.innerHTML = '<i class="mdi mdi-eye"></i>';
              }
            }
          });
        }

        // Cache control to ensure fresh data from server
        const cacheBuster = new Date().getTime();

        // Mark required fields visually
        const requiredFields = [
          "first_name",
          "last_name",
          "add_employee_email",
          "add_employee_password",
        ];
        requiredFields.forEach((field) => {
          const label = document.querySelector(`label[for="${field}"]`);
          if (
            label &&
            !label.innerHTML.includes('<span class="text-danger">')
          ) {
            label.innerHTML += ' <span class="text-danger">*</span>';
          }
        });

        // Load teams and roles data
        loadTeamsAndRoles();

        async function loadTeamsAndRoles() {
          try {
            await ModalUtility.showSpinner();

            const response = await fetch(`/add_employee?_=${cacheBuster}`, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
                Accept: "application/json",
              },
            });

            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              throw new Error(
                "Server did not return JSON. Check authentication or route."
              );
            }

            const data = await response.json();

            // Populate teams
            const teamSelect = document.getElementById("team_id_dropdown");
            if (teamSelect && data.teams && Array.isArray(data.teams)) {
              // Clear existing options first
              teamSelect.innerHTML = '<option value="">Select Team</option>';

              data.teams.forEach((team) => {
                const opt = document.createElement("option");
                opt.value = team.team_id;
                opt.textContent = team.team_name;
                teamSelect.appendChild(opt);
              });
            }

            // Populate roles
            const roleSelect = document.getElementById("role_id_dropdown");
            if (roleSelect && data.roles && Array.isArray(data.roles)) {
              // Clear existing options first
              roleSelect.innerHTML = '<option value="">Select Role</option>';

              data.roles.forEach((role) => {
                const opt = document.createElement("option");
                opt.value = role.role_id;
                opt.textContent =
                  role.role_name.charAt(0).toUpperCase() +
                  role.role_name.slice(1);
                roleSelect.appendChild(opt);
              });
            }

            await ModalUtility.hideSpinner();
          } catch (err) {
            await ModalUtility.hideSpinner();

            console.error("Failed to fetch teams/roles:", err);
            const errorBox = document.getElementById("rolesTeamsFetchError");
            if (errorBox) {
              errorBox.textContent =
                "Could not load teams or roles. Please try again or contact admin.";
              errorBox.style.display = "block";
            }
          }
        }

        // Smart form validation - required core fields + optional additional fields
        function validateEmployeeForm(formData) {
          // CORE REQUIRED FIELDS - Must have these to create a valid employee
          const requiredFields = [
            "first_name",
            "last_name",
            "email", // This will be mapped to add_employee_email below
            "password", // This will be mapped to add_employee_password below
          ];

          // Map form field names to backend field names
          const fieldMappings = {
            email: "add_employee_email",
            password: "add_employee_password",
            gender: "add_employee_gender",
            date_of_birth: "add_employee_date_of_birth",
            phone_number: "add_employee_phone_number",
            department: "add_employee_department",
            address1: "add_employee_address1",
            address2: "add_employee_address2",
            city: "add_employee_city",
            date_hired: "add_employee_date_hired",
            salary: "add_employee_salary",
            skills: "add_employee_skills",
            certification: "add_employee_certification",
            education: "add_employee_education",
            language: "add_employee_language",
            hobbies: "add_employee_hobbies",
          };

          // Check required fields
          for (const field of requiredFields) {
            const formField = fieldMappings[field] || field;
            if (
              !formData.get(formField) ||
              formData.get(formField).trim() === ""
            ) {
              return {
                valid: false,
                message: `${field.replace(
                  "_",
                  " "
                )} is required to create an employee`,
                field: formField,
              };
            }
          }

          // Email validation
          const email = formData.get("add_employee_email");
          if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            return {
              valid: false,
              message: "Please enter a valid email address",
              field: "add_employee_email",
            };
          }

          // Password validation - at least 8 characters
          const password = formData.get("add_employee_password");
          if (password && password.length < 8) {
            return {
              valid: false,
              message: "Password must be at least 8 characters long",
              field: "add_employee_password",
            };
          }

          // Optional field validation - only if values are provided

          // Phone number format check (if provided)
          const phoneNumber = formData.get("add_employee_phone_number");
          if (
            phoneNumber &&
            phoneNumber.trim() !== "" &&
            !/^\+?[\d\s\-()]{7,}$/.test(phoneNumber)
          ) {
            return {
              valid: false,
              message: "Please enter a valid phone number",
              field: "add_employee_phone_number",
            };
          }

          // Date format validation (if provided)
          const dateFields = [
            { form: "add_employee_date_hired", backend: "date_hired" },
            { form: "add_employee_date_of_birth", backend: "date_of_birth" },
          ];

          for (const field of dateFields) {
            const dateValue = formData.get(field.form);
            if (
              dateValue &&
              dateValue.trim() !== "" &&
              !isValidDate(dateValue)
            ) {
              return {
                valid: false,
                message: `Please enter a valid date for ${field.backend.replace(
                  "_",
                  " "
                )}`,
                field: field.form,
              };
            }
          }

          return { valid: true };
        }

        // Helper to validate date format
        function isValidDate(dateString) {
          const regex = /^\d{4}-\d{2}-\d{2}$/;
          if (!regex.test(dateString)) return false;

          const date = new Date(dateString);
          return date instanceof Date && !isNaN(date);
        }

        // Add default values for important but optional fields
        function addDefaultValues(formData) {
          // Default account status to 'activated' if not provided
          if (
            !formData.get("account_status") ||
            formData.get("account_status").trim() === ""
          ) {
            formData.set("account_status", "Deactivated");
          }

          // Default status to 'clock out' if not provided
          if (!formData.get("status") || formData.get("status").trim() === "") {
            formData.set("status", "clock out");
          }

          // Set current date as date_hired if not provided
          if (
            !formData.get("add_employee_date_hired") ||
            formData.get("add_employee_date_hired").trim() === ""
          ) {
            const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
            formData.set("date_hired", today);
          }

          // Map form fields to backend field names
          const formFieldMappings = {
            add_employee_email: "email",
            add_employee_password: "password",
            add_employee_gender: "gender",
            add_employee_date_of_birth: "date_of_birth",
            add_employee_phone_number: "phone_number",
            add_employee_department: "department",
            add_employee_address1: "address1",
            add_employee_address2: "address2",
            add_employee_city: "city",
            add_employee_date_hired: "date_hired",
            add_employee_salary: "salary",
            add_employee_skills: "skills",
            add_employee_certification: "certification",
            add_employee_education: "education",
            add_employee_language: "language",
            add_employee_hobbies: "hobbies",
          };

          // Create a new FormData object for the backend fields
          const mappedFormData = new FormData();

          // Copy over existing form fields that don't need mapping
          for (const [key, value] of formData.entries()) {
            if (!key.startsWith("add_employee_") && key !== "csrf_token") {
              mappedFormData.append(key, value);
            }
          }

          // Map form fields to backend fields
          for (const [formField, backendField] of Object.entries(
            formFieldMappings
          )) {
            const value = formData.get(formField);
            if (value) {
              mappedFormData.append(backendField, value);
            }
          }

          // Copy over csrf_token and file data
          if (formData.get("csrf_token")) {
            mappedFormData.append("csrf_token", formData.get("csrf_token"));
          }

          if (formData.get("profile")) {
            mappedFormData.append("profile", formData.get("profile"));
          }

          return mappedFormData;
        }

        // Script for adding new employees
        document
          .getElementById("addNewEmployeeForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            // Create FormData from the form
            let formData = new FormData(this);

            // Validate form before submission
            const validation = validateEmployeeForm(formData);
            if (!validation.valid) {
              await ModalUtility.showError(validation.message);

              // Focus on the invalid field after modal is closed
              if (validation.field) {
                const fieldElement = document.getElementById(validation.field);
                if (fieldElement) {
                  fieldElement.focus();
                  fieldElement.classList.add("is-invalid");

                  // Remove invalid class when user starts typing
                  fieldElement.addEventListener(
                    "input",
                    function () {
                      this.classList.remove("is-invalid");
                    },
                    { once: true }
                  );
                }
              }
              return;
            }

            // Map form field names to backend field names and add default values
            formData = addDefaultValues(formData);

            const token = sessionStorage.getItem("adminToken");

            // Show a processing message for better UX during potentially slow operations
            const processingMessage = document.createElement("div");
            processingMessage.className = "alert alert-info mt-3";
            processingMessage.id = "processingMessage";
            processingMessage.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm mr-2" role="status">
            <span class="sr-only">Processing...</span>
          </div>
          <div>Adding new employee... This may take a moment.</div>
        </div>
      `;

            // Find submit button and insert message before it
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn && submitBtn.parentNode) {
              submitBtn.parentNode.insertBefore(processingMessage, submitBtn);
              // Disable submit button to prevent double submission
              submitBtn.disabled = true;
            } else {
              this.appendChild(processingMessage);
            }

            try {
              await ModalUtility.showSpinner();

              // Log form data being sent (for debugging)
              console.log("[DEBUG] Form data being sent:");
              for (const [key, value] of formData.entries()) {
                if (key !== "profile") {
                  // Don't log binary data
                  console.log(`${key}: ${value}`);
                } else {
                  console.log(`${key}: [binary data]`);
                }
              }

              const response = await fetch("/add_employee", {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              });

              await ModalUtility.hideSpinner();

              // Remove processing message
              const msgElement = document.getElementById("processingMessage");
              if (msgElement) msgElement.remove();

              // Re-enable submit button
              if (submitBtn) submitBtn.disabled = false;

              if (response.ok) {
                // Success case
                const data = await response.json();
                const employeeId = data.employee_id || "";
                console.log(
                  `[DEBUG] Employee added successfully with ID: ${employeeId}`
                );

                // Set success message with detail about optional fields
                let successMsg = "Employee added successfully!";

                // Check if key optional fields were empty
                let emptyFields = [];
                [
                  { id: "add_employee_phone_number", label: "phone number" },
                  { id: "add_employee_department", label: "department" },
                  { id: "team_id_dropdown", label: "team" },
                  { id: "role_id_dropdown", label: "role" },
                ].forEach((field) => {
                  const element = document.getElementById(field.id);
                  if (
                    element &&
                    (!element.value || element.value.trim() === "")
                  ) {
                    emptyFields.push(field.label);
                  }
                });

                if (emptyFields.length > 0) {
                  successMsg += `<hr><div class="text-warning">
              <small>Remember to complete the employee profile later by adding: 
              ${emptyFields.join(", ")}.</small>
            </div>`;
                }

                // Show success message with custom HTML
                // We need to use the direct modal approach since ModalUtility doesn't support HTML
                document.getElementById("successMessage").innerHTML =
                  successMsg;
                await showModalWithPromise("#successModal");

                // Set up redirect on close
                $("#successModalCloseBtn")
                  .off("click")
                  .on("click", function () {
                    window.location.href = `/employeemanagement${
                      employeeId ? "?highlight=" + employeeId : ""
                    }`;
                  });
              } else {
                // Error case - try to get detailed error message
                try {
                  const data = await response.json();
                  const msg =
                    data.error || data.message || "Something went wrong.";
                  await ModalUtility.showError(msg);
                  console.error(`[ERROR] Server returned error: ${msg}`);
                } catch (textError) {
                  // If JSON parsing fails, try to get text error
                  const text = await response.text();
                  await ModalUtility.showError(text || "Something went wrong.");
                  console.error(
                    `[ERROR] Server returned non-JSON error: ${text}`
                  );
                }
              }
            } catch (error) {
              await ModalUtility.hideSpinner();

              // Remove processing message
              const msgElement = document.getElementById("processingMessage");
              if (msgElement) msgElement.remove();

              // Re-enable submit button
              if (submitBtn) submitBtn.disabled = false;

              console.error(
                `[ERROR] Exception in form submission: ${error.message}`
              );
              await ModalUtility.showError(
                error.message || "Something went wrong."
              );
            }
          });

        // Reset field validation state when form is reset
        document
          .getElementById("addNewEmployeeForm")
          .addEventListener("reset", function () {
            const invalidFields = this.querySelectorAll(".is-invalid");
            invalidFields.forEach((field) =>
              field.classList.remove("is-invalid")
            );
          });

        // Helper function to show a modal with Promise
        function showModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("show");
            $(modalSelector).on("shown.bs.modal", function () {
              $(this).off("shown.bs.modal");
              resolve();
            });
          });
        }

        // Add image preview functionality
        window.previewImage = function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("imagePreview").src = e.target.result;
              document.getElementById("imagePreviewSection").style.display =
                "block";
            };
            reader.readAsDataURL(file);
          }
        };
      });
    </script>
    <!-- Script for adding new employees (End) -->

    <!-- script for password visibility toggle and tab validation (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Password visibility toggle
        const togglePassword = document.getElementById("togglePassword");
        const password = document.getElementById("password");

        if (togglePassword && password) {
          togglePassword.addEventListener("click", function () {
            const type =
              password.getAttribute("type") === "password"
                ? "text"
                : "password";
            password.setAttribute("type", type);
            this.querySelector("i").classList.toggle("mdi-eye");
            this.querySelector("i").classList.toggle("mdi-eye-off");
          });
        }

        // Add validation class to tabs
        const formTabs = document.querySelectorAll(
          "#employeeFormTabs .nav-link"
        );
        const requiredFields = document.querySelectorAll(
          "input[required], select[required]"
        );

        // Function to check if a tab has any invalid fields
        function validateTab(tabId) {
          const tab = document.getElementById(tabId);
          if (!tab) return true;

          const fields = tab.querySelectorAll(
            "input[required], select[required]"
          );
          let isValid = true;

          fields.forEach((field) => {
            if (!field.value.trim()) {
              isValid = false;
              field.classList.add("is-invalid");
            } else {
              field.classList.remove("is-invalid");
            }
          });

          return isValid;
        }

        // Validate current tab when switching
        if (formTabs.length > 0) {
          formTabs.forEach((tab) => {
            tab.addEventListener("click", function (e) {
              const currentTabId = document
                .querySelector("#employeeFormTabs .active")
                .getAttribute("href")
                .substring(1);
              if (!validateTab(currentTabId)) {
                e.preventDefault();
                e.stopPropagation();
              }
            });
          });
        }

        // Clear validation state when typing
        requiredFields.forEach((field) => {
          field.addEventListener("input", function () {
            this.classList.remove("is-invalid");
          });
        });
      });
    </script>
    <!-- script for password visibility toggle and tab validation (End) -->

    <!-- Script to make admin to be able to search for specific employee (Start) -->
    <script>
      function filterEmployeeTable() {
        const input = document.getElementById("employeeSearchInput");
        const filter = input.value.toLowerCase();
        const table = document.getElementById("employeeTableBody");
        const rows = table.getElementsByTagName("tr");

        Array.from(rows).forEach((row) => {
          const cells = row.getElementsByTagName("td");
          let match = false;

          Array.from(cells).forEach((cell) => {
            if (cell.textContent.toLowerCase().includes(filter)) {
              match = true;
            }
          });

          row.style.display = match ? "" : "none";
        });
      }
    </script>
    <!-- Script to make admin to be able to search for specific employee (End) -->

    <!-- Script for displaying employee's data into table (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Pagination state
        let currentPage = 1;
        const perPage = 40;
        let totalPages = 1;
        let currentSearchTerm = "";

        // Initial fetch without images for faster loading
        fetchEmployees(1, false);

        // Setup search functionality
        const searchInput = document.getElementById("employeeSearch");
        const searchButton = document.getElementById("searchButton");

        if (searchInput) {
          // Search on Enter key
          searchInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              performSearch();
            }
          });

          // Real-time search as user types (optional)
          searchInput.addEventListener("input", function () {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
              performSearch();
            }, 500); // 500ms delay to avoid too many requests
          });
        }

        // Search button click handler
        if (searchButton) {
          searchButton.addEventListener("click", performSearch);
        }

        function performSearch() {
          const searchTerm = searchInput.value.trim();
          currentSearchTerm = searchTerm;
          currentPage = 1; // Reset to first page when searching
          fetchEmployees(1, false, searchTerm);
        }

        async function fetchEmployees(
          page = 1,
          loadImages = false,
          searchTerm = ""
        ) {
          try {
            // Show loading spinner
            await ModalUtility.showSpinner();

            // Build query parameters
            const params = new URLSearchParams({
              page: page,
              per_page: perPage,
              load_images: loadImages,
              query: searchTerm,
            });

            const response = await fetch(`/employeemanagement_data?${params}`, {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            if (!response.ok) {
              throw new Error(
                `Failed to fetch employee data (Status: ${response.status})`
              );
            }

            const data = await response.json();

            // Hide spinner after processing data
            await ModalUtility.hideSpinner();

            populateEmployeeTable(data.employees);

            // Update pagination if available
            if (data.pagination) {
              renderSmartPagination(data.pagination);
              totalPages = data.pagination.pages;
            }

            // If we initially loaded without images, we can load them now
            if (!loadImages && data.employees.length > 0) {
              loadEmployeeImages(data.employees.map((e) => e.employee_id));
            }
          } catch (err) {
            await ModalUtility.hideSpinner();

            console.error("Error fetching employees:", err);
            await ModalUtility.showError(
              "Failed to load employee data. Please try again."
            );
          }
        }

        // Helper to load images separately after initial table load
        async function loadEmployeeImages(employeeIds) {
          if (employeeIds.length === 0) return;

          try {
            const params = new URLSearchParams({
              page: 1,
              per_page: employeeIds.length,
              load_images: true,
              query: currentSearchTerm,
            });

            const response = await fetch(`/employeemanagement_data?${params}`, {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("adminToken"),
              },
            });

            const data = await response.json();

            // Update images in the already displayed table
            data.employees.forEach((emp) => {
              if (emp.profile_image) {
                const imgElement = document.getElementById(
                  `emp-img-${emp.employee_id}`
                );
                if (imgElement) imgElement.src = emp.profile_image;
              }
            });
          } catch (error) {
            console.error("Error loading employee images:", error);
            // No need to show an error modal for image loading failures
          }
        }

        // Smart pagination controls
        function renderSmartPagination(pagination) {
          const paginationElement = document.getElementById("pagination");
          if (!paginationElement) return;

          let html = "";
          const windowSize = 2;

          if (pagination.pages > 1) {
            // Previous button
            html += `<li class="page-item ${
              pagination.page <= 1 ? "disabled" : ""
            }">
        <a class="page-link" href="#" ${
          pagination.page > 1
            ? 'onclick="changePage(' +
              (pagination.page - 1) +
              '); return false;"'
            : ""
        }>Previous</a>
      </li>`;

            // Always show first page
            html += `<li class="page-item ${
              pagination.page === 1 ? "active" : ""
            }">
        <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
      </li>`;

            // Left ellipsis
            if (pagination.page - windowSize > 2) {
              html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
            }

            // Page window
            const startPage = Math.max(2, pagination.page - windowSize);
            const endPage = Math.min(
              pagination.pages - 1,
              pagination.page + windowSize
            );
            for (let i = startPage; i <= endPage; i++) {
              html += `<li class="page-item ${
                pagination.page === i ? "active" : ""
              }">
          <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
        </li>`;
            }

            // Right ellipsis
            if (pagination.page + windowSize < pagination.pages - 1) {
              html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
            }

            // Always show last page
            if (pagination.pages > 1)
              html += `<li class="page-item ${
                pagination.page === pagination.pages ? "active" : ""
              }">
          <a class="page-link" href="#" onclick="changePage(${
            pagination.pages
          }); return false;">${pagination.pages}</a>
        </li>`;

            // Next button
            html += `<li class="page-item ${
              pagination.page >= pagination.pages ? "disabled" : ""
            }">
        <a class="page-link" href="#" ${
          pagination.page < pagination.pages
            ? 'onclick="changePage(' +
              (pagination.page + 1) +
              '); return false;"'
            : ""
        }>Next</a>
      </li>`;
          }

          paginationElement.innerHTML = html;
        }

        // Global function to change page
        window.changePage = function (page) {
          currentPage = page;
          fetchEmployees(page, false, currentSearchTerm);
          // Scroll to top of table
          const tableContainer = document.querySelector(".table-responsive");
          if (tableContainer) tableContainer.scrollTop = 0;
        };

        function populateEmployeeTable(employees) {
          const tbody = document.getElementById("employeeTableBody");
          tbody.innerHTML = "";

          if (!employees || !Array.isArray(employees)) {
            console.error("Invalid or missing 'employees' array");
            return;
          }

          if (employees.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center">No employees found</td></tr>`;
            return;
          }

          employees.forEach((emp) => {
            const tr = document.createElement("tr");

            // Placeholder for images that will load later
            const profileHTML = `<img src="${
              emp.profile_image || "/assets/images/default-profile.png"
            }" 
                     alt="Profile Image" 
                     style="width: 50px; height: 50px; border-radius: 50%;" 
                     id="emp-img-${emp.employee_id}" />`;

            let accStatusClass = "badge-danger";
            const accountStatus = emp.account_status?.toLowerCase() || "";
            if (accountStatus === "activated") accStatusClass = "badge-success";
            else if (accountStatus === "terminated")
              accStatusClass = "badge-dark";
            let workStatusClass = "badge-success";
            const workStatus = emp.status?.toLowerCase() || "";
            if (["clock out", "clockout"].includes(workStatus))
              workStatusClass = "badge-danger";
            else if (workStatus === "break") workStatusClass = "badge-warning";
            let statusActionButton = "";
            if (accountStatus === "activated") {
              statusActionButton = `<button class="badge badge-danger" onclick="showConfirmationModal('deactivate', ${emp.employee_id})">Deactivate</button>`;
            } else {
              statusActionButton = `<button class="badge badge-success" onclick="showConfirmationModal('activate', ${emp.employee_id})">Activate</button>`;
            }
            const terminateButton =
              accountStatus === "terminated"
                ? ""
                : `<button class="badge badge-dark" onclick="showConfirmationModal('terminate', ${emp.employee_id})">Terminate</button>`;

            tr.innerHTML = `
<td>${emp.employee_id || "Empty"}</td>
<td>${profileHTML}</td>
<td><label class="badge ${accStatusClass}">${
              emp.account_status || "Empty"
            }</label></td>
<td>${emp.first_name || "Empty"}</td>
<td>${emp.last_name || "Empty"}</td>
<td><label class="badge ${workStatusClass}">${
              emp.status || "Empty"
            }</label></td>
<td>${emp.email || "Empty"}</td>
<td>
  <form onsubmit="return confirm('Are you sure you want to delete this employee?');">
    <button type="button" class="badge badge-primary" onclick="openDeletePopup('${
      emp.employee_id
    }')">Delete</button>
  </form>
  ${statusActionButton}
  ${terminateButton}
  <button type="button" class="badge badge-info" data-toggle="modal" data-target="#idCardModal"
    data-employeeid="${emp.employee_id || "N/A"}"
    data-education="${emp.education || "N/A"}"
    data-language="${emp.language || "N/A"}"
    data-hobbies="${emp.hobbies || "N/A"}"
    data-certification="${emp.certification || "N/A"}"
    data-skill="${emp.skills || "N/A"}"
    data-team="${emp.team || "N/A"}"
    data-firstname="${emp.first_name || "N/A"}"
    data-lastname="${emp.last_name || "N/A"}"
    data-email="${emp.email || "N/A"}"
    data-password="${emp.password || "N/A"}"
    data-phone_number="${emp.phone_number || "N/A"}"
    data-department="${emp.department || "N/A"}"
    data-address1_details="${emp.address1 || "N/A"}"
    data-city="${emp.city || "N/A"}"
    data-address2="${emp.address2 || "N/A"}"
    data-salary="${emp.salary || "N/A"}"
    data-status="${emp.status || "N/A"}"
    data-date_hired="${emp.date_hired || "N/A"}"
    data-date_terminated="${emp.date_terminated || "N/A"}"
    data-created="${emp.created || "N/A"}"
    data-account_status="${emp.account_status || "N/A"}"
    data-profile="${emp.profile_image || "N/A"}"
    data-date_of_birth_detail="${emp.date_of_birth || "N/A"}"
    data-gender_detail="${emp.gender || "N/A"}"
  >
    Detail
  </button>
  <button type="button" class="badge badge-warning" data-toggle="modal" data-target="#editEmployeeModal"
    data-id="${emp.employee_id || "N/A"}"
    data-education="${emp.education || "N/A"}"
    data-language="${emp.language || "N/A"}"
    data-hobbies="${emp.hobbies || "N/A"}"
    data-certification="${emp.certification || "N/A"}"
    data-skill="${emp.skills || "N/A"}"
    data-team="${emp.team || "N/A"}"
    data-firstname="${emp.first_name || "N/A"}"
    data-lastname="${emp.last_name || "N/A"}"
    data-email="${emp.email || "N/A"}"
    data-password="${emp.password || "N/A"}"
    data-phone_number="${emp.phone_number || "N/A"}"
    data-department="${emp.department || "N/A"}"
    data-address1="${emp.address1 || "N/A"}"
    data-city="${emp.city || "N/A"}"
    data-address2="${emp.address2 || "N/A"}"
    data-salary="${emp.salary || "N/A"}"
    data-status="${emp.status || "N/A"}"
    data-date_hired="${emp.date_hired || "N/A"}"
    data-date_terminated="${emp.date_terminated || "N/A"}"
    data-created="${emp.created || "N/A"}"
    data-account_status="${emp.account_status || "N/A"}"
    data-profile="${emp.profile_image || "N/A"}"
    data-date_of_birth="${emp.date_of_birth || "N/A"}"
    data-gender="${emp.gender || "N/A"}"
    data-team_id="${emp.team_id || ""}"
    data-role_id="${emp.role_id || ""}"
    >   
    Edit
  </button>
</td>
`;
            tbody.appendChild(tr);
          });
        }

        let currentAction = null;
        let currentEmployeeId = null;

        window.showConfirmationModal = function (action, employeeId) {
          currentAction = action;
          currentEmployeeId = employeeId;

          const messages = {
            activate: "Are you sure you want to activate this employee?",
            deactivate: "Are you sure you want to deactivate this employee?",
            terminate: "Are you sure you want to terminate this employee?",
          };

          document.getElementById("confirmationMessage").innerText =
            messages[action];
          showModalWithPromise("#confirmationModal");
        };

        document
          .getElementById("confirmActionBtn")
          .addEventListener("click", async () => {
            if (!currentAction || !currentEmployeeId) return;

            try {
              await ModalUtility.showSpinner();

              // Close the confirmation modal first
              await closeModalWithPromise("#confirmationModal");

              const url = `/${currentAction}/${currentEmployeeId}`;
              const response = await fetch(url, {
                method: "PATCH",
                headers: {
                  Authorization:
                    "Bearer " + sessionStorage.getItem("adminToken"),
                },
              });

              if (!response.ok) {
                throw new Error(`Action failed with status ${response.status}`);
              }

              const data = await response.json();

              await ModalUtility.hideSpinner();

              // Show success message
              await ModalUtility.showSuccess(
                data.message || "Action completed successfully."
              );

              // Refresh current page
              fetchEmployees(currentPage, false, currentSearchTerm);
            } catch (err) {
              await ModalUtility.hideSpinner();
              await ModalUtility.showError(
                err.message || "Something went wrong."
              );
            }
          });

        // Reload employees after any success action
        $("#successModal").on("hidden.bs.modal", function () {
          fetchEmployees(currentPage, false, currentSearchTerm);
        });

        // Helper function to show a modal with Promise
        function showModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("show");
            $(modalSelector).on("shown.bs.modal", function () {
              $(this).off("shown.bs.modal");
              resolve();
            });
          });
        }

        // Helper function to close a modal with Promise
        function closeModalWithPromise(modalSelector) {
          return new Promise((resolve) => {
            $(modalSelector).modal("hide");
            $(modalSelector).on("hidden.bs.modal", function () {
              $(this).off("hidden.bs.modal");
              resolve();
            });
          });
        }

        // Empty placeholder functions that might be implemented elsewhere
        window.activateEmployee = function (employeeId) {
          /* ... */
        };
        window.deactivateEmployee = function (employeeId) {
          /* ... */
        };
        window.terminateEmployee = function (employeeId) {
          /* ... */
        };
      });
    </script>
    <!-- Script for displaying employee's data into table (End) -->

    <!-- Script for editing employees modal (Start) -->
    <script>
      function formatDateToInput(dateString) {
        if (!dateString || dateString === "N/A") return "";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "";
        return date.toISOString().split("T")[0];
      }

      function formatTimeToInput(timeString) {
        if (!timeString || timeString === "N/A") return "";
        return timeString.length >= 5 ? timeString.slice(0, 5) : "";
      }

      async function fetchEmployeeAndDropdowns(employeeId) {
        try {
          await ModalUtility.showSpinner();

          const response = await fetch(`/update_employee/${employeeId}`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
            },
          });

          if (!response.ok) {
            throw new Error(
              `Failed to fetch employee data (Status: ${response.status})`
            );
          }

          const data = await response.json();

          await ModalUtility.hideSpinner();
          return data;
        } catch (err) {
          await ModalUtility.hideSpinner();
          throw err;
        }
      }

      // Helper function to show a modal with Promise
      function showModalWithPromise(modalSelector) {
        return new Promise((resolve) => {
          $(modalSelector).modal("show");
          $(modalSelector).on("shown.bs.modal", function () {
            $(this).off("shown.bs.modal");
            resolve();
          });
        });
      }

      // Helper function to close a modal with Promise
      function closeModalWithPromise(modalSelector) {
        return new Promise((resolve) => {
          $(modalSelector).modal("hide");
          $(modalSelector).on("hidden.bs.modal", function () {
            $(this).off("hidden.bs.modal");
            resolve();
          });
        });
      }

      $("#editEmployeeModal").on("show.bs.modal", async function (event) {
        try {
          const button = $(event.relatedTarget);
          const employeeId = button.data("id");
          if (!employeeId) return;

          const data = await fetchEmployeeAndDropdowns(employeeId);

          const emp = data.employee || {};
          const modal = $(this);
          modal.find("#employee-id").val(emp.employee_id || "");
          modal.find("#first-name").val(emp.first_name || "");
          modal.find("#last-name").val(emp.last_name || "");
          modal.find("#email").val(emp.email || "");
          modal.find("#password").val("");
          modal.find("#phone_number").val(emp.phone_number || "");
          modal.find("#department").val(emp.department || "");
          modal.find("#education").val(emp.education || "");
          modal.find("#language").val(emp.language || "");
          modal.find("#hobbies").val(emp.hobbies || "");
          modal.find("#certification").val(emp.certification || "");
          modal.find("#skills").val(emp.skills || "");
          modal.find("#address1").val(emp.address1 || "");
          modal.find("#address2").val(emp.address2 || "");
          modal.find("#city").val(emp.city || "");
          modal.find("#salary").val(emp.salary || "");
          modal.find("#status").val(emp.status || "");
          modal.find("#date_hired").val(formatDateToInput(emp.date_hired));
          modal
            .find("#edit_date_terminated")
            .val(formatDateToInput(emp.date_terminated));
          modal.find("#account_status").val(emp.account_status || "");
          modal
            .find("#date_of_birth")
            .val(formatDateToInput(emp.date_of_birth));
          modal.find("#gender").val(emp.gender || "");
          modal.find("#created").val(formatDateToInput(emp.created));

          if (emp.profile_image && emp.profile_image !== "N/A") {
            modal
              .find("#currentProfileImage")
              .attr("src", emp.profile_image)
              .attr("data-original-src", emp.profile_image);
          } else {
            modal
              .find("#currentProfileImage")
              .attr("src", "placeholder-image-url")
              .attr("data-original-src", "placeholder-image-url");
          }

          const teamSelect = document.getElementById("edit_team_id_dropdown");
          if (teamSelect && data.teams && Array.isArray(data.teams)) {
            teamSelect.innerHTML = '<option value="">Select team</option>';
            data.teams.forEach((team) => {
              const opt = document.createElement("option");
              opt.value = team.team_id;
              opt.textContent = team.team_name;
              teamSelect.appendChild(opt);
            });
            teamSelect.value = emp.team_id || "";
          }

          const roleSelect = document.getElementById("edit_role_id_dropdown");
          if (roleSelect && data.roles && Array.isArray(data.roles)) {
            roleSelect.innerHTML = '<option value="">Select role</option>';
            data.roles.forEach((role) => {
              const opt = document.createElement("option");
              opt.value = role.role_id;
              opt.textContent =
                role.role_name.charAt(0).toUpperCase() +
                role.role_name.slice(1);
              roleSelect.appendChild(opt);
            });
            roleSelect.value = emp.role_id || "";
          }
        } catch (error) {
          await ModalUtility.hideSpinner();
          await ModalUtility.showError(
            "Failed to load employee data: " + error.message
          );
          // Close the modal since we couldn't load the data properly
          $(this).modal("hide");
        }
      });

      $("#uploadButton").on("click", function () {
        $("#editProfileImage").click();
      });

      $("#editProfileImage").on("change", function (event) {
        const file = event.target.files[0];
        if (file) {
          const previewURL = URL.createObjectURL(file);
          $("#currentProfileImage").attr("src", previewURL);
        }
      });

      $("#editEmployeeModal").on("hidden.bs.modal", function () {
        const originalImageSrc = $(this)
          .find("#currentProfileImage")
          .attr("data-original-src");
        $("#currentProfileImage").attr("src", originalImageSrc);
      });

      $("#updateEmployeeForm").on("submit", async function (event) {
        event.preventDefault();

        try {
          const employeeId = $("#employee-id").val();
          const form = event.target;
          const formData = new FormData(form);
          const token = sessionStorage.getItem("adminToken");

          await ModalUtility.handleAsync(
            async () => {
              const response = await fetch(`/update_employee/${employeeId}`, {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              });

              if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || "Failed to update employee.");
              }

              return await response.json();
            },
            {
              spinnerTimeout: 30000, // 30 seconds timeout
              showSuccessMessage: false, // We'll handle success message ourselves
            }
          );

          // Close the edit modal first
          await closeModalWithPromise("#editEmployeeModal");

          // Show success message and set up reload
          $("#successMessage").text("Employee updated successfully!");
          await showModalWithPromise("#successModal");

          $("#successModalCloseBtn")
            .off("click")
            .on("click", function () {
              window.location.reload();
            });
        } catch (error) {
          await ModalUtility.hideSpinner();
          await ModalUtility.showError(
            error.message || "An unexpected error occurred."
          );
        }
      });
    </script>
    <!-- Script for editing employees modal (End) -->

    <!-- Script for the details of employee modal (Start) -->
    <script>
      function formatDateToInput(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "";
        return date.toISOString().split("T")[0];
      }

      $("#idCardModal").on("show.bs.modal", function (event) {
        try {
          var button = $(event.relatedTarget);

          // Extract all data from the button
          var employeeid = button.data("employeeid");
          var profileImage = button.data("profile");
          var firstname = button.data("firstname");
          var lastname = button.data("lastname");
          var education = button.data("education");
          var language = button.data("language");
          var hobbies = button.data("hobbies");
          var certification = button.data("certification");
          var skill = button.data("skill");
          var shift = button.data("shift");
          var team = button.data("team");
          var teamrole = button.data("teamrole");
          var position = button.data("position");
          var email = button.data("email");
          var phone = button.data("phone_number");
          var department = button.data("department");
          var dateHired = button.data("date_hired");
          var dateTerminated = button.data("date_terminated");
          var salary = button.data("salary");
          var status = button.data("status");
          var created = button.data("created");
          var account_status = button.data("account_status");
          var address1 = button.data("address1_details");
          var city = button.data("city");
          var address2 = button.data("address2");
          var date_of_birth_detail = button.data("date_of_birth_detail");
          var gender_detail = button.data("gender_detail");
          var shift_name = button.data("shift");
          var shift_start_time = button.data("shift_start_time");
          var shift_end_time = button.data("shift_end_time");
          var location = button.data("location");

          // Create shift text if all components are available
          const shiftText =
            shift_name && shift_start_time && shift_end_time && location
              ? `${shift_name} (${shift_start_time} - ${shift_end_time}) at ${location}`
              : "N/A";

          var modal = $(this);

          // Set profile image with fallback
          if (profileImage && profileImage !== "N/A") {
            modal.find("#profileImage").attr("src", profileImage);
          } else {
            modal
              .find("#profileImage")
              .attr("src", "../../static/default_resource.png");
          }

          // Populate all text fields in the modal
          modal.find("#employeeID").text(employeeid);
          modal.find("#employeefirstName").text(firstname || "N/A");
          modal.find("#employeelastName").text(lastname || "N/A");
          modal.find("#employeePosition").text(position || "N/A");
          modal.find("#employeeEmail").text(email || "N/A");
          modal.find("#employeePhone").text(phone || "N/A");
          modal.find("#employeeDept").text(department || "N/A");
          modal.find("#employeeEducation").text(education || "N/A");
          modal.find("#employeeLanguage").text(language || "N/A");
          modal.find("#employeeHobbies").text(hobbies || "N/A");
          modal.find("#employeeCertification").text(certification || "N/A");
          modal.find("#employeeSkill").text(skill || "N/A");
          modal.find("#employeeTeam").text(team || "N/A");
          modal.find("#employeeTeamrole").text(teamrole || "N/A");
          modal.find("#status").text(status || "N/A");
          modal.find("#account_status").text(account_status || "N/A");
          modal.find("#employeeDateHired").text(dateHired || "N/A");
          modal
            .find("#date_terminated")
            .text(formatDateToInput(dateTerminated) || "N/A");
          modal.find("#salary").text(salary || "N/A");
          modal.find("#created").text(formatDateToInput(created) || "N/A");
          modal.find("#address1_details").text(address1 || "N/A");
          modal.find("#address2").text(address2 || "N/A");
          modal.find("#city").text(city || "N/A");
          modal
            .find("#date_of_birth_detail")
            .text(formatDateToInput(date_of_birth_detail) || "N/A");
          modal.find("#gender_detail").text(gender_detail || "N/A");
          modal.find("#employeeShift").text(shiftText);
        } catch (error) {
          // Handle any errors that might occur during modal population
          console.error("Error populating employee details modal:", error);

          // Show error message in the modal instead of failing silently
          $(this).find(".modal-body").html(`
      <div class="alert alert-danger">
        <strong>Error:</strong> Failed to load employee details. Please try again.
      </div>
    `);

          // Option to close this modal and show error modal
          setTimeout(() => {
            $(this).modal("hide");
            if (typeof ModalUtility !== "undefined") {
              ModalUtility.showError(
                "Failed to load employee details. Please try again."
              );
            }
          }, 2000);
        }
      });

      // Add support for closing modal using escape key
      $(document).on("keydown", function (e) {
        if (e.key === "Escape" && $("#idCardModal").hasClass("show")) {
          $("#idCardModal").modal("hide");
        }
      });
    </script>
    <!-- Script for the details of employee modal (End) -->

    <!-- Script for deleting employee (Start) -->
    <script>
      // Script for deleting employee (Bootstrap 4 compatible)
      let selectedEmployeeId = null; // To store the ID of the employee to be deleted

      // Helper function to show a modal with Promise
      function showModalWithPromise(modalSelector) {
        return new Promise((resolve) => {
          $(modalSelector).modal("show");
          $(modalSelector).on("shown.bs.modal", function () {
            $(this).off("shown.bs.modal");
            resolve();
          });
        });
      }

      // Helper function to close a modal with Promise
      function closeModalWithPromise(modalSelector) {
        return new Promise((resolve) => {
          $(modalSelector).modal("hide");
          $(modalSelector).on("hidden.bs.modal", function () {
            $(this).off("hidden.bs.modal");
            resolve();
          });
        });
      }

      // Open the delete confirmation popup (Bootstrap 4 modal)
      async function openDeletePopup(employeeId) {
        try {
          selectedEmployeeId = employeeId; // Store the employee ID
          await showModalWithPromise("#deleteUserModal");
        } catch (error) {
          console.error("Error showing delete confirmation modal:", error);
          await ModalUtility.showError(
            "Failed to open delete confirmation dialog."
          );
        }
      }

      // Close the delete confirmation popup (Bootstrap 4 modal)
      async function closeDeletePopup() {
        try {
          selectedEmployeeId = null; // Reset the selected employee ID
          await closeModalWithPromise("#deleteUserModal");
        } catch (error) {
          console.error("Error closing delete modal:", error);
        }
      }

      // Confirm delete action
      async function confirmDelete() {
        if (!selectedEmployeeId) {
          await ModalUtility.showError("No employee selected for deletion.");
          return;
        }

        const token = sessionStorage.getItem("adminToken");
        if (!token) {
          await ModalUtility.showError(
            "Authentication token not found. Please log in again."
          );
          return;
        }

        try {
          // Close the delete confirmation modal first
          await closeModalWithPromise("#deleteUserModal");

          // Use handleAsync for the deletion operation
          const result = await ModalUtility.handleAsync(
            async () => {
              const response = await fetch(
                `/delete_employee/${selectedEmployeeId}`,
                {
                  method: "DELETE",
                  headers: {
                    Authorization: `Bearer ${token}`,
                  },
                }
              );

              if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || "Failed to delete the employee.");
              }

              return await response.json();
            },
            {
              // Custom options for this specific operation
              showSuccessMessage: false, // We'll handle the success message ourselves
              spinnerTimeout: 30000, // 30 seconds timeout for potentially slow operation
            }
          );

          // Show success message with auto-close after 3 seconds
          document.getElementById("successMessage").innerText =
            result.message || "Employee deleted successfully.";
          await showModalWithPromise("#successModal");

          // Set up auto-close and page reload
          setTimeout(async () => {
            await closeModalWithPromise("#successModal");
            window.location.reload();
          }, 3000);

          // Also set up manual close with reload
          $("#successModal")
            .off("hidden.bs.modal")
            .on("hidden.bs.modal", function () {
              window.location.reload();
            });

          // Reset the selected employee ID
          selectedEmployeeId = null;
        } catch (error) {
          console.error("Delete error:", error);
          await ModalUtility.showError(
            error.message || "Failed to delete the employee."
          );

          // Reset the selected employee ID on error too
          selectedEmployeeId = null;
        }
      }
    </script>
    <!-- Script for deleting employee (End) -->

    <!-- Script to display image in when adding new employee (Start) -->
    <script>
      function previewImage(event) {
        const file = event.target.files[0];
        const imagePreviewSection = document.getElementById(
          "imagePreviewSection"
        );
        const imagePreview = document.getElementById("imagePreview");

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreview.src = e.target.result;
            imagePreviewSection.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          imagePreviewSection.style.display = "none";
        }
      }
    </script>
    <!-- Script to display image in when adding new employee (End) -->

    <!-- Script for logging out (Start) -->
    <script>
      document
        .querySelector(".logout-btn")
        .addEventListener("click", async function () {
          await showModalWithPromise("#logoutModal");
        });

      document
        .getElementById("confirmLogout")
        .addEventListener("click", async function () {
          try {
            // Close the logout confirmation modal first
            await closeModalWithPromise("#logoutModal");

            // Show spinner while logout processes
            await ModalUtility.showSpinner();

            // Add a safety timeout to hide spinner if redirect fails
            const redirectTimeout = setTimeout(() => {
              ModalUtility.hideSpinner();
              ModalUtility.showError(
                "Logout may have failed. Please try again."
              );
            }, 5000);

            // Remove token
            sessionStorage.removeItem("adminToken");

            // Only clear the timeout if we successfully start navigation
            window.addEventListener(
              "beforeunload",
              function () {
                clearTimeout(redirectTimeout);
              },
              { once: true }
            );

            // Log the action for audit purposes (optional)
            console.log(
              `User Ratana3 logged out at ${new Date().toISOString()}`
            );

            // Redirect to login page
            window.location.href = "/admin_login";
          } catch (error) {
            console.error("Error during logout:", error);
            await ModalUtility.hideSpinner();
            await ModalUtility.showError(
              "An error occurred during logout. Please try again."
            );
          }
        });

      document
        .getElementById("cancelLogout")
        .addEventListener("click", async function () {
          await closeModalWithPromise("#logoutModal");
        });

      document
        .getElementById("closeLogoutModal")
        .addEventListener("click", async function () {
          await closeModalWithPromise("#logoutModal");
        });

      // Helper function to show a modal with Promise
      function showModalWithPromise(modalSelector) {
        return new Promise((resolve) => {
          $(modalSelector).modal("show");
          $(modalSelector).on("shown.bs.modal", function () {
            $(this).off("shown.bs.modal");
            resolve();
          });
        });
      }

      // Helper function to close a modal with Promise
      function closeModalWithPromise(modalSelector) {
        return new Promise((resolve) => {
          $(modalSelector).modal("hide");
          $(modalSelector).on("hidden.bs.modal", function () {
            $(this).off("hidden.bs.modal");
            resolve();
          });
        });
      }
    </script>
    <!-- Script for logging out (End) -->

    <!-- Script that redirects admin back to login page if the token doesn't exist (Start) -->
    <script>
      // Authentication check script
      (async function () {
        try {
          const token = sessionStorage.getItem("adminToken");
          if (!token) {
            // Check if ModalUtility exists, otherwise fall back to simpler methods
            if (typeof ModalUtility !== "undefined") {
              await ModalUtility.showSpinner();

              // Short timeout to allow spinner to display before redirect
              await new Promise((resolve) => setTimeout(resolve, 600));

              // Hide spinner before showing error
              await ModalUtility.hideSpinner();

              // Show authentication error with auto-redirect
              await ModalUtility.showError(
                "Not authenticated. Redirecting to login."
              );

              // Log the authentication failure (helps with security auditing)
              console.log(
                `Authentication failure detected at ${new Date().toISOString()}`
              );
              console.log(`Current user session (Ratana3) invalid or expired`);

              // Redirect to login page
              window.location.href = "/admin_login";
            } else {
              // Fallback if ModalUtility is not available
              if (typeof showSpinner === "function") showSpinner();

              setTimeout(function () {
                if (typeof hideSpinner === "function") hideSpinner();
                alert("Not authenticated. Redirecting to login.");
                window.location.href = "/admin_login";
              }, 600);
            }
          } else {
            // Optional: Log successful authentication check
            console.log(
              `Authentication check passed for user Ratana3 at ${new Date().toISOString()}`
            );

            // Optional: Verify token expiration if needed
            // checkTokenExpiration(token);
          }
        } catch (error) {
          console.error("Error during authentication check:", error);

          // Ensure we redirect to login even if an error occurs
          setTimeout(function () {
            window.location.href = "/admin_login";
          }, 1000);
        }
      })();

      // Helper function to check token expiration (optional implementation)
      function checkTokenExpiration(token) {
        try {
          // This is a simplified example - actual implementation would depend on your token structure
          const tokenData = JSON.parse(atob(token.split(".")[1]));
          const expirationTime = tokenData.exp * 1000; // Convert to milliseconds

          if (Date.now() >= expirationTime) {
            console.warn("Token has expired. Redirecting to login.");
            sessionStorage.removeItem("adminToken");
            window.location.href = "/admin_login";
          }
        } catch (e) {
          console.error("Error checking token expiration:", e);
        }
      }
    </script>
    <!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

    <!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start) -->
    <script>
      /**
       * Session conflict checker script
       * Checks if the current token is being used in another session
       * Current Date: 2025-08-02 13:43:11
       * Current User: Ratana3
       */
      function getToken() {
        return sessionStorage.getItem("adminToken");
      }

      // Helper function to show a modal with Promise (Bootstrap 4 version)
      function showModalWithPromise(modalSelector, options = {}) {
        return new Promise((resolve) => {
          // Bootstrap 4 uses jQuery to initialize modals
          $(modalSelector).modal({
            backdrop: options.backdrop || "static",
            keyboard: options.keyboard || false,
            show: true,
          });

          $(modalSelector).on("shown.bs.modal", function () {
            $(this).off("shown.bs.modal");
            resolve();
          });
        });
      }

      async function checkSessionConflict() {
        try {
          const token = getToken();
          if (!token) return;

          const response = await fetch("/check_jti", {
            method: "GET",
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          if (response.status === 403) {
            throw new Error("session_conflict");
          }

          const data = await response.json();

          if (data.error === "session_conflict") {
            throw new Error("session_conflict");
          }
        } catch (err) {
          if (err.message === "session_conflict") {
            // Bootstrap 4 modal initialization
            await showModalWithPromise("#sessionConflictModal");

            // Attach event listener only once using jQuery's .one()
            $("#confirmLogoutBetweenTabs")
              .off("click")
              .on("click", async function () {
                try {
                  // Use ModalUtility if available, otherwise fallback to normal functions
                  if (typeof ModalUtility !== "undefined") {
                    await ModalUtility.showSpinner();

                    // Wait briefly to show the spinner
                    await new Promise((resolve) => setTimeout(resolve, 600));

                    // Remove token and redirect
                    sessionStorage.removeItem("adminToken");
                    window.location.href = "/admin_login";
                  } else {
                    // Fallback to original implementation
                    if (typeof showSpinner === "function") showSpinner();

                    setTimeout(function () {
                      sessionStorage.removeItem("adminToken");
                      window.location.href = "/admin_login";
                    }, 600);
                  }
                } catch (error) {
                  console.error("Error during session conflict logout:", error);

                  // Ensure we still logout even if there's an error
                  sessionStorage.removeItem("adminToken");
                  window.location.href = "/admin_login";
                }
              });
          } else {
            // Handle other types of errors
            console.error("Session check error:", err);
          }
        }
      }

      // Make sure sessionConflictModal exists in the DOM
      $(document).ready(function () {
        // If the modal doesn't exist, create it
        if (!$("#sessionConflictModal").length) {
          $("body").append(`
      <div class="modal fade" id="sessionConflictModal" tabindex="-1" role="dialog" aria-labelledby="sessionConflictModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="sessionConflictModalLabel">Session Conflict Detected</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display:none;">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Your account (${
                document.currentUser || "Ratana3"
              }) is currently logged in elsewhere. For security reasons, you'll be logged out from this session.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="confirmLogoutBetweenTabs">OK, Log me out</button>
            </div>
          </div>
        </div>
      </div>
    `);
        }

        // Initial check and start interval
        checkSessionConflict();
        setInterval(checkSessionConflict, 30000);
      });
    </script>
    <!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

    <!-- Script for checking admin if they have access to this page (Start) -->
    <script>
        /**
       * Access Denied Handler Script
       * Displays access denied modal when permission is insufficient
       * Current Date: 2025-08-02 14:09:03
       * Current User: Ratana3
       */
      document.addEventListener('DOMContentLoaded', function() {
        // Only run this if the backend passed access_denied = True
        const accessDenied = {{ 'true' if access_denied else 'false' }};

        if (accessDenied) {
          try {
            // Make sure the modal exists in the DOM
            if (!$('#accessDeniedModal').length) {
              createAccessDeniedModal();
            }

            // Bootstrap 4 modal initialization using jQuery
            $('#accessDeniedModal').modal({
              backdrop: 'static',
              keyboard: false,
              show: true
            });

            // Set up logout handler using jQuery
            $('#forceLogoutBtn').off('click').on('click', async function() {
              try {
                // Close the modal first
                $('#accessDeniedModal').modal('hide');

                // Use ModalUtility if available, otherwise fallback
                if (typeof ModalUtility !== 'undefined') {
                  await ModalUtility.showSpinner();

                  // Short delay to ensure UI updates
                  await new Promise(resolve => setTimeout(resolve, 600));

                  // Log the forced logout for audit purposes
                  console.log(`[ACCESS DENIED] User Ratana3 forced to logout at 2025-08-02 14:09:03 due to insufficient permissions`);

                  // Remove authentication token and redirect
                  sessionStorage.removeItem("adminToken");
                  window.location.href = "/admin_login";
                } else {
                  // Fallback to original implementation
                  if (typeof showSpinner === 'function') showSpinner();

                  setTimeout(function() {
                    sessionStorage.removeItem("adminToken");
                    window.location.href = "/admin_login";
                  }, 600);
                }
              } catch (error) {
                console.error("Error during forced logout:", error);

                // Ensure logout happens even if there's an error
                sessionStorage.removeItem("adminToken");
                window.location.href = "/admin_login";
              }
            });

            // Log access denied event for security auditing
            console.warn(`[SECURITY] Access denied for user Ratana3 at 2025-08-02 14:09:03`);

          } catch (error) {
            console.error("Error showing access denied modal:", error);

            // Fallback alert if modal fails
            alert("Access denied. You don't have permission to view this page.");
            window.location.href = "/admin_dashboard";
          }
        }

        // Helper function to create the modal if it doesn't exist
        function createAccessDeniedModal() {
          const modalHTML = `
            <div class="modal fade" id="accessDeniedModal" tabindex="-1" role="dialog" aria-labelledby="accessDeniedModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="accessDeniedModalLabel">Access Denied</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display:none;">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="text-center mb-4">
                      <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                      <p>You do not have permission to access this page or perform this action.</p>
                      <p class="small text-muted">User: Ratana3 | Time: 2025-08-02 14:09:03</p>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Back</button>
                    <button type="button" class="btn btn-danger" id="forceLogoutBtn">Logout</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          $('body').append(modalHTML);
        }
      });
    </script>
    <!-- Script for checking admin if they have access to this page (End) -->
  </body>
</html>
