<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <style>
/* Simple styles for the collapsible */
.collapsible-route {
  background: #f7f7f7;
  border: 1px solid #d8dee4;
  border-radius: 4px;
  margin-bottom: 10px;
  padding: 0;
}
.collapsible-header {
  padding: 12px 16px;
  cursor: pointer;
  font-weight: bold;
  user-select: none;
  display: flex;
  align-items: center;
}
.collapsible-header .arrow {
  margin-right: 8px;
  font-size: 1.1em;
  transition: transform 0.2s;
}
.collapsible-header[aria-expanded="true"] .arrow {
  transform: rotate(90deg);
}
.collapsible-content {
  display: none;
  padding: 12px 20px 8px 32px;
  border-top: 1px solid #eee;
  background: #fff;
}
.collapsible-content.active {
  display: block;
}
</style>
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
                    <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
      
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">     
  <h4 class="card-title">Request access to route actions</h4>
  <p class="card-description">Select actions you want to request for each route:</p>
  <div class="mb-2">
  <input type="text" id="route-search" class="form-control" placeholder="Search routes...">
</div>
  <form id="request-form">
    <div id="routes-container">
      <!-- Will be filled by JS with route/action checkboxes -->
      <div class="text-center">Loading routes...</div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Request Selected Access</button>
  </form>

  <div id="status-message" class="mt-2"></div>

  <div class="card mt-4">
    <div class="card-body">
      <h4 class="card-title">Your Requests</h4>
      <div class="mb-2">
  <input type="text" id="request-search" class="form-control" placeholder="Search requests...">
</div>
      <div class="table-responsive">
        <table class="table" id="approval-table">
          <thead>
            <tr>
              <th>Request ID</th>
              <th>Page</th>
              <th>Action</th>
              <th>Status</th>
              <th>Requested At</th>
            </tr>
          </thead>
          <tbody>
            <!-- Will be filled by JS -->
          </tbody>
        </table>
      </div>
      <nav aria-label="Request table pagination" class="mt-3">
  <ul class="pagination justify-content-center" id="requests-pagination">
    <!-- JS will fill in the page buttons -->
  </ul>
</nav>
    </div>
  </div>
</div>
                </div>
              </div>

            </div>
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                      <div class="card-body">
    <div class="d-flex align-items-center">
      <div class="me-3">
        <i class="mdi mdi-account-alert text-danger" style="font-size: 36px;"></i>
      </div>
      <div>
        <h4 class="card-title mb-1">Timesheet Management</h4>
        <p class="card-text mb-0">
          Admin can only generate timesheet for employees that have clock in and clock out time in the date that they input , if they don't have clock in and clock out 
          time then their timesheet cannot be generated.
        </p>
        <small class="text-muted">Last updated: <span id="last-updated-time">2025-07-16 08:25:29</span></small>
      </div>
    </div>
  </div>
                    <h4 class="card-title">- Timesheet Management</h4>   
<input class="form-control" type="text" id="search-bar" placeholder="Search for an employee..." onkeyup="searchEmployees()">
<div class="table-responsive">
<table class="table">
    <thead>
        <tr>
            <th>Employee Name</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="employee-list"></tbody>
</table>
</div>
<nav id="employee-pagination" class="mt-3"></nav>

<div class="col-12 grid-margin stretch-card">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title"> Generated timesheet</h4>  
      <input type="text" id="searchTimesheet" class="form-control" placeholder="Search timesheets..." oninput="searchTimesheets()">

      <div class="table-responsive">
        <table class="table" id="timesheetTable">
          <thead>
              <tr>
                  <th>Timesheet ID</th>
                  <th>Employee Name</th>
                  <th>Log Date</th>
                  <th>Total Work Hours</th>
                  <th>Total Break Time</th>
                  <th>Overtime</th>
                  <th>Status</th>
                  <th>Actions</th>
              </tr>
          </thead>
          <tbody id="timesheet-details">
              <!-- Data will be inserted here by JavaScript -->
          </tbody>
        </table>
        </div>
        <nav id="timesheet-pagination" class="mt-3"></nav>
    </div>
  </div>
</div>

                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">- Ticketing system</h4>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search tickets...">
                    <div class="table-responsive">
                    <table class="table" id="ticketsTable">
                      <thead>
                          <tr>
                              <th>Ticket ID</th>
                              <th>Employee</th>
                              <th>Category</th>
                              <th>Subject</th>
                              <th>Priority</th>
                              <th>Status</th>
                              <th>Created</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody id="ticketsTableBody">
                          <!-- Table rows will be populated here -->
                      </tbody>
                      </table>
                  </div>
                  <nav id="tickets-pagination" class="mt-3"></nav>
                  </div>
                </div>
              </div>
            </div>

    
          <!-- content-wrapper ends -->
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>


<!-- Generate Timesheet Modal (Bootstrap 4) -->
<div class="modal fade" id="generateTimesheetModal" tabindex="-1" role="dialog" aria-labelledby="generateTimesheetModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="generateTimesheetModalLabel">Generate Timesheet</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <label for="timesheet-date" class="form-label">Select Date:</label>
        <input type="date" id="timesheetDate" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-generate">Generate</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Timesheet Modal (Bootstrap 4) -->
<div class="modal fade" id="editTimesheetModal" tabindex="-1" role="dialog" aria-labelledby="editTimesheetModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTimesheetModalLabel">Edit Timesheet</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editTimesheetForm">
          <input type="hidden" id="editTimesheetId">
          <!-- Overtime Inputs -->
          <div class="mb-3">
            <label for="editOvertimeHours" class="form-label">Overtime (Hours:Minutes:Seconds)</label>
            <div class="d-flex">
              <input type="number" class="form-control mr-2" id="editOvertimeHours" placeholder="Hours" required>
              <input type="number" class="form-control mr-2" id="editOvertimeMinutes" placeholder="Minutes" required>
              <input type="number" class="form-control" id="editOvertimeSeconds" placeholder="Seconds" required>
            </div>
          </div>
          <!-- Work Time Inputs -->
          <div class="mb-3">
            <label for="editWorkHours" class="form-label">Work Time (Hours:Minutes:Seconds)</label>
            <div class="d-flex">
              <input type="number" class="form-control mr-2" id="editWorkHours" placeholder="Hours" required>
              <input type="number" class="form-control mr-2" id="editWorkMinutes" placeholder="Minutes" required>
              <input type="number" class="form-control" id="editWorkSeconds" placeholder="Seconds" required>
            </div>
          </div>
          <!-- Break Time Inputs -->
          <div class="mb-3">
            <label for="editBreakTime" class="form-label">Break Time (Hours:Minutes:Seconds)</label>
            <div class="d-flex">
              <input type="number" class="form-control mr-2" id="editBreakHours" placeholder="Hours" required>
              <input type="number" class="form-control mr-2" id="editBreakMinutes" placeholder="Minutes" required>
              <input type="number" class="form-control" id="editBreakSeconds" placeholder="Seconds" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="submitEditTimesheet()">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Timesheet Modal (Bootstrap 4) -->
<div class="modal fade" id="deleteTimesheetModal" tabindex="-1" role="dialog" aria-labelledby="deleteTimesheetModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTimesheetModalLabel">Confirm Deletion</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this timesheet?</p>
        <input type="hidden" id="deleteTimesheetId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="confirmDeleteTimesheet()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- View Ticket Details Modal (Bootstrap 4) -->
<div class="modal fade" id="viewTicketModal" tabindex="-1" role="dialog" aria-labelledby="viewTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTicketModalLabel">Ticket Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="viewTicketBody">
                <!-- Ticket details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ticket Modal (Bootstrap 4) -->
<div class="modal fade" id="editTicketModal" tabindex="-1" role="dialog" aria-labelledby="editTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTicketModalLabel">Edit Ticket</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTicketForm">
                    <input type="hidden" id="editTicketId">
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">Category</label>
                        <select class="form-control" id="editCategory" required>
                            <option value="Support">Technical</option>
                            <option value="HR">HR</option>
                            <option value="IT">Finance</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="editSubject" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPriority" class="form-label">Priority</label>
                        <select class="form-control" id="editPriority" required>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Status</label>
                        <select class="form-control" id="editStatus" required>
                            <option value="Open">Open</option>
                            <option value="Pending">Pending</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTicket()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Respond to Ticket Modal (Bootstrap 4) -->
<div class="modal fade" id="respondTicketModal" tabindex="-1" role="dialog" aria-labelledby="respondTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="respondTicketModalLabel">Respond to Ticket</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="respondTicketId" />
                <div id="respondTicketInfo" class="mb-3">
                    <!-- Ticket info will be populated here -->
                </div>
                <div id="respondToResponsesContainer">
                    <!-- Each response (with its own input) will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal (Bootstrap 4) -->
<div class="modal fade" id="deleteTicketModal" tabindex="-1" role="dialog" aria-labelledby="deleteTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTicketModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this ticket? This action cannot be undone.</p>
                <div id="deleteTicketInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTicket()">Delete Ticket</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal (Bootstrap 4) -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle mr-2"></i>Success
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="successModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal (Bootstrap 4) -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Error
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="errorModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Session Conflict Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="sessionConflictModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="sessionConflictLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="sessionConflictLabel">Session Conflict</h5>
        <!-- Bootstrap 4 close button -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
          <strong>
            Someone has logged into your account from another tab or
            device.
          </strong>
        </p>
        <p>You will be logged out for security reasons.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal (Bootstrap 4) -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeLogoutModal">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelLogout" data-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmLogout">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Access Denied Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="accessDeniedModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="accessDeniedLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Only Super Admins are allowed to access this page.</p>
      </div>
      <div class="modal-footer">
        <button id="redirectBtn" type="button" class="btn btn-danger">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Timesheet Modal (Bootstrap 4) -->
<div class="modal fade" id="viewTimesheetModal" tabindex="-1" role="dialog" aria-labelledby="viewTimesheetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTimesheetModalLabel">Timesheet Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered mb-0">
          <tbody>
            <tr><th>ID</th><td id="viewTimesheetId"></td></tr>
            <tr><th>Employee</th><td id="viewEmployeeName"></td></tr>
            <tr><th>Date</th><td id="viewLogDate"></td></tr>
            <tr><th>Total Work Hours</th><td id="viewTotalWorkHours"></td></tr>
            <tr><th>Total Break Time</th><td id="viewTotalBreakTime"></td></tr>
            <tr><th>Overtime</th><td id="viewOvertime"></td></tr>
            <tr><th>Status</th><td id="viewStatus"></td></tr>
            <tr><th>Created At</th><td id="viewCreatedAt"></td></tr>
            <tr><th>Updated At</th><td id="viewUpdatedAt"></td></tr>
          </tbody>
        </table>
        <hr>
        <h6 class="mt-3">Breaks</h6>
        <div id="viewBreaksTableWrapper">
          <table class="table table-sm table-striped" id="viewBreaksTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Type</th>
                <th>Start</th>
                <th>End</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody id="viewBreaksTableBody">
              <!-- Breaks will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner Modal (Bootstrap 4) -->
<div
  class="modal fade"
  id="loadingSpinnerModal"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0 bg-transparent shadow-none">
      <div class="modal-body text-center">
        <div
          class="spinner-border text-white"
          style="width: 4rem; height: 4rem"
          role="status"
        >
          <span class="sr-only">Loading...</span>
        </div>
        <div class="mt-3 text-white font-weight-bold">Please wait...</div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery and Popper.js (required for Bootstrap 4) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<!-- Bootstrap 4 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>

<!-- Your other scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
<script src="../../static/Admin/js/off-canvas.js"></script>
<script src="../../static/Admin/js/hoverable-collapse.js"></script>
<script src="../../static/Admin/js/template.js"></script>
<script src="../../static/Admin/js/file-upload.js"></script>
<script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>

    <!-- Script for spinner logic and displaying success and error (Start) -->
<script>
  window.ModalUtils = (function () {
    let spinnerVisible = false;

    function showSpinner() {
      if (spinnerVisible) return;
      spinnerVisible = true;
      $("#loadingSpinnerModal").modal({
        backdrop: "static",
        keyboard: false,
        show: true,
      });
    }

    function hideSpinner() {
      spinnerVisible = false;
      $("#loadingSpinnerModal").modal("hide");
    }

    function cleanUpModalBackdrops() {
      setTimeout(function () {
        $(".modal-backdrop").remove();
        $("body").removeClass("modal-open").css("padding-right", "");
      }, 250);
    }

    function showSuccess(message, onClose) {
      $("#successModalMessage").html(message);
      $("#successModal").modal("show");
      $("#successModal").off("hidden.bs.modal");
      if (typeof onClose === "function") {
        const handler = function () {
          $("#successModal").off("hidden.bs.modal", handler);
          cleanUpModalBackdrops();
          onClose();
        };
        $("#successModal").on("hidden.bs.modal", handler);
      } else {
        $("#successModal").on("hidden.bs.modal", cleanUpModalBackdrops);
      }
    }

    function showerror(message, onClose) {
      $("#errorModalMessage").html(message);
      $("#errorModal").modal("show");
      $("#errorModal").off("hidden.bs.modal");
      if (typeof onClose === "function") {
        const handler = function () {
          $("#errorModal").off("hidden.bs.modal", handler);
          cleanUpModalBackdrops();
          onClose();
        };
        $("#errorModal").on("hidden.bs.modal", handler);
      } else {
        $("#errorModal").on("hidden.bs.modal", cleanUpModalBackdrops);
      }
    }

    function hideSuccess() {
      $("#successModal").modal("hide");
      cleanUpModalBackdrops();
    }
    function hideError() {
      $("#errorModal").modal("hide");
      cleanUpModalBackdrops();
    }

    return {
      showSpinner,
      hideSpinner,
      showSuccess,
      showerror,
      hideSuccess,
      hideError,
    };
  })();
</script>
    <!-- Script for spinner logic and displaying success and error (End) -->
     
<!-- Script for admin to request access to actions for a specific page (Start) -->
<script>
  // Utility: Get admin token from sessionStorage
  function getAdminToken() {
    return sessionStorage.getItem("adminToken");
  }
  // Utility: Add Authorization header if token exists
  function makeAuthHeaders() {
    const token = getAdminToken();
    return token ? { "Authorization": "Bearer " + token } : {};
  }
  // Get logged-in admin ID from JWT (adjust claim as needed)
  function getCurrentAdminId() {
    const token = getAdminToken();
    if (!token) return null;
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.admin_id;
    } catch (err) {
      console.error("JWT decode error:", err);
      return null;
    }
  }

  // --- 1. Load all routes and actions, and pre-check those the admin already has ---
  let originalRoutesHTML = '';
  let routesData = [];

  async function loadRoutesAndActions() {
    const container = document.getElementById('routes-container');
    container.innerHTML = 'Loading...';

    const adminId = getCurrentAdminId();
    if (!adminId) {
      container.innerHTML = '<div class="text-danger">Unable to identify admin.</div>';
      return;
    }
    ModalUtils.showSpinner();
    try {
      const res = await fetch(`/routes_request?admin_id=${adminId}`, {
        headers: makeAuthHeaders()
      });
      const data = await res.json();
      ModalUtils.hideSpinner();
      if (!res.ok) throw new Error("Failed to fetch routes: " + data.error);
      if (!data.routes) throw new Error("No routes returned");
      routesData = data.routes; // Save for filtering

      renderRoutes(routesData);

      // Add collapsible logic
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', function() {
          const expanded = this.getAttribute('aria-expanded') === 'true';
          this.setAttribute('aria-expanded', !expanded);
          const content = this.nextElementSibling;
          if (content) {
            content.classList.toggle('active', !expanded);
          }
        });
        header.addEventListener('keydown', function(e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            this.click();
          }
        });
      });
    } catch (e) {
      ModalUtils.hideSpinner();
      console.error("Error in loadRoutesAndActions:", e);
      container.innerHTML = `<div class="text-danger">Failed to load routes/actions. ${e.message}</div>`;
      ModalUtils.showerror("Failed to load routes/actions. " + e.message);
    }
  }

  function renderRoutes(routes) {
    const container = document.getElementById('routes-container');
    let html = '';
    routes.forEach(route => {
      html += `
        <div class="collapsible-route">
          <div class="collapsible-header" tabindex="0" aria-expanded="false">
            <span class="arrow">&#9654;</span>${route.route_name}
            <span class="text-muted" style="font-weight:normal; font-size:90%;margin-left:8px;">(${route.description || ''})</span>
          </div>
          <div class="collapsible-content">
            ${route.actions.map(action => {
              const alreadyGranted = !!action.granted;
              return `
                <div class="form-check form-check-inline" style="margin-bottom:6px;">
                  <input class="form-check-input" type="checkbox" 
                    name="action_${route.route_id}[]" 
                    value="${action.action_id}" id="route_${route.route_id}_action_${action.action_id}"
                    ${alreadyGranted ? 'checked disabled' : ''}>
                  <label class="form-check-label" for="route_${route.route_id}_action_${action.action_id}">
                    ${action.action_name} : ( ${action.description} )
                    ${alreadyGranted ? '<span class="badge bg-success ms-2" style="color:white">Already Granted</span>' : ''}
                  </label>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });
    container.innerHTML = html || '<div class="text-muted">No routes found.</div>';
  }

  // Search bar logic
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('route-search');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchValue = this.value.trim().toLowerCase();
        if (!searchValue) {
          renderRoutes(routesData);
        } else {
          // Filter routes by route_name or description
          const filtered = routesData.filter(route =>
            route.route_name.toLowerCase().includes(searchValue) ||
            (route.description && route.description.toLowerCase().includes(searchValue))
          );
          renderRoutes(filtered);
        }
        // Re-attach collapsible logic after rendering
        document.querySelectorAll('.collapsible-header').forEach(header => {
          header.addEventListener('click', function() {
            const expanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !expanded);
            const content = this.nextElementSibling;
            if (content) {
              content.classList.toggle('active', !expanded);
            }
          });
          header.addEventListener('keydown', function(e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              this.click();
            }
          });
        });
      });
    }
  });

  // --- 2. Load admin's requests table ---
  let allRequestsData = [];
  let currentPage = 1;
  const REQUESTS_PER_PAGE = 20; // Change this for more/fewer per page

  async function loadRequestsTable() {
    const tbody = document.querySelector('#approval-table tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
    ModalUtils.showSpinner();
    try {
      const res = await fetch('/my_requests', {
        headers: makeAuthHeaders()
      });
      const data = await res.json();
      ModalUtils.hideSpinner();
      if (!res.ok) throw new Error("Failed to fetch requests: " + data.error);

      allRequestsData = data.requests || [];
      currentPage = 1; // Reset to first page on reload
      renderRequestsTable();
      renderRequestsPagination();
    } catch (e) {
      ModalUtils.hideSpinner();
      console.error("Error in loadRequestsTable:", e);
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger">Failed to load requests. ${e.message}</td></tr>`;
      ModalUtils.showerror("Failed to load requests. " + e.message);
    }
  }

  function renderRequestsTable() {
    const tbody = document.querySelector('#approval-table tbody');
    tbody.innerHTML = '';
    if (!allRequestsData.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">No requests found.</td></tr>';
      return;
    }
    const startIdx = (currentPage - 1) * REQUESTS_PER_PAGE;
    const endIdx = startIdx + REQUESTS_PER_PAGE;
    const pageData = allRequestsData.slice(startIdx, endIdx);
    pageData.forEach(req => {
      tbody.innerHTML += `
        <tr>
          <td>${req.id}</td>
          <td>${req.route_name}</td>
          <td>${req.action_name}</td>
          <td>
            <span class="badge bg-${req.status === 'approved' ? 'success' : req.status === 'pending' ? 'warning' : 'danger'} text-capitalize">
              ${req.status}
            </span>
          </td>
          <td>${req.requested_at ? new Date(req.requested_at).toLocaleString() : ''}</td>
        </tr>
      `;
    });
  }

  function renderRequestsPagination() {
    const totalPages = Math.ceil(allRequestsData.length / REQUESTS_PER_PAGE) || 1;
    const pagination = document.getElementById('requests-pagination');
    pagination.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item${currentPage === 1 ? ' disabled' : ''}`;
    prevLi.innerHTML = `<button class="page-link" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>Previous</button>`;
    prevLi.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderRequestsTable();
        renderRequestsPagination();
      }
    };
    pagination.appendChild(prevLi);

    // Page numbers (show up to 5, with ellipsis if needed)
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }

    if (startPage > 1) {
      pagination.appendChild(createPageBtn(1));
      if (startPage > 2) {
        pagination.appendChild(createEllipsis());
      }
    }
    for (let i = startPage; i <= endPage; i++) {
      pagination.appendChild(createPageBtn(i));
    }
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        pagination.appendChild(createEllipsis());
      }
      pagination.appendChild(createPageBtn(totalPages));
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item${currentPage === totalPages ? ' disabled' : ''}`;
    nextLi.innerHTML = `<button class="page-link" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>Next</button>`;
    nextLi.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderRequestsTable();
        renderRequestsPagination();
      }
    };
    pagination.appendChild(nextLi);
  }

  function createPageBtn(pageNum) {
    const li = document.createElement('li');
    li.className = `page-item${pageNum === currentPage ? ' active' : ''}`;
    li.innerHTML = `<button class="page-link">${pageNum}</button>`;
    li.onclick = () => {
      if (pageNum !== currentPage) {
        currentPage = pageNum;
        renderRequestsTable();
        renderRequestsPagination();
      }
    };
    return li;
  }

  function createEllipsis() {
    const li = document.createElement('li');
    li.className = 'page-item disabled';
    li.innerHTML = `<span class="page-link">â€¦</span>`;
    return li;
  }

  // ---- Optional: Live search integration (if you have search from earlier) ----
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('request-search');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const value = this.value.trim().toLowerCase();
        // Optionally: store full original data elsewhere, or fetch again to reset
        let filtered = allRequestsData;
        if (value) {
          filtered = allRequestsData.filter(req =>
            (req.route_name && req.route_name.toLowerCase().includes(value)) ||
            (req.action_name && req.action_name.toLowerCase().includes(value)) ||
            (req.status && req.status.toLowerCase().includes(value)) ||
            (req.id && req.id.toString().includes(value))
          );
        }
        // Use filtered data for current render (does not mutate allRequestsData)
        const temp = allRequestsData;
        allRequestsData = filtered;
        currentPage = 1;
        renderRequestsTable();
        renderRequestsPagination();
        allRequestsData = temp;
      });
    }
  });

  // --- 3. Submit selected actions as requests ---
  document.getElementById('request-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = e.target;
    let requests = [];
    form.querySelectorAll('[name^="action_"]').forEach(checkbox => {
      if (checkbox.checked && !checkbox.disabled) {
        const route_id = checkbox.name.match(/^action_(\d+)\[\]/)[1];
        requests.push({
          route_id: parseInt(route_id),
          action_id: parseInt(checkbox.value)
        });
      }
    });
    if (!requests.length) {
      ModalUtils.showerror("Please select at least one action.");
      return;
    }
    ModalUtils.showSpinner();
    try {
      const res = await fetch('/request-access', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...makeAuthHeaders()
        },
        body: JSON.stringify({ requests })
      });
      const result = await res.json();
      ModalUtils.hideSpinner();
      if (res.ok) {
        ModalUtils.showSuccess("Request submitted!");
        form.querySelectorAll('[name^="action_"]').forEach(cb => { if (!cb.disabled) cb.checked = false; });
        loadRequestsTable();
      } else {
        ModalUtils.showerror(result.error || 'Failed to submit request.');
      }
    } catch (e) {
      ModalUtils.hideSpinner();
      console.error("Error in request submission:", e);
      ModalUtils.showerror("Request failed. " + e.message);
    }
  });

  // --- Initial load ---
  window.addEventListener('DOMContentLoaded', function () {
    loadRoutesAndActions();
    loadRequestsTable();
  });
</script>
<!-- Script for admin to request access to actions for a specific page (End) -->

<!-- Script for handling ticketing system table (Start) -->
<script>
  // Use ModalUtils for spinner, success, and error modals

let currentTicketIdToDelete = null;

let allTickets = [];
let filteredTickets = [];
let ticketCurrentPage = 1;
const TICKET_PAGE_SIZE = 20;

document.addEventListener('DOMContentLoaded', function() {
  loadTickets();
  document.getElementById('searchInput').addEventListener('input', function() {
    loadTickets(this.value);
  });
});

// Load tickets from server
function loadTickets(searchQuery = '') {
  let url = '/get-tickets';
  if (searchQuery) {
    url += `?search=${encodeURIComponent(searchQuery)}`;
  }
  ModalUtils.showSpinner();
  fetch(url, {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    }
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    if (response.ok && data.tickets) {
      allTickets = data.tickets;
      filteredTickets = allTickets;
      ticketCurrentPage = 1;
      populateTicketsTablePaginated();
      renderTicketPagination();
    } else {
      ModalUtils.showerror(data.message || 'Failed to load tickets');
    }
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    console.error('Error:', error);
    ModalUtils.showerror('Failed to load tickets');
  });
}

function populateTicketsTablePaginated() {
  const tbody = document.getElementById('ticketsTableBody');
  tbody.innerHTML = '';
  if (!filteredTickets.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center">No matching tickets found</td></tr>`;
    return;
  }
  const startIdx = (ticketCurrentPage - 1) * TICKET_PAGE_SIZE;
  const endIdx = startIdx + TICKET_PAGE_SIZE;
  const pageTickets = filteredTickets.slice(startIdx, endIdx);

  pageTickets.forEach(ticket => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ticket.ticket_id}</td>
      <td>${ticket.email || 'N/A'}</td>
      <td><span class="badge bg-info">${ticket.category}</span></td>
      <td>${ticket.subject}</td>
      <td><span class="badge ${getPriorityBadgeClass(ticket.priority)}">${ticket.priority}</span></td>
      <td><span class="badge ${getStatusBadgeClass(ticket.status)}">${ticket.status}</span></td>
      <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
      <td>
        <div>
          <button type="button" class="btn btn-sm btn-primary" onclick="viewTicket(${ticket.ticket_id})" title="View Details">
            View
          </button>
          <button type="button" class="btn btn-sm btn-success" onclick="respondToTicket(${ticket.ticket_id})" title="Respond">
            Respond
          </button>
          <button type="button" class="btn btn-sm btn-warning" onclick="editTicket(${ticket.ticket_id})" title="Edit">
            Edit
          </button>
          <button type="button" class="btn btn-sm btn-danger" onclick="deleteTicket(${ticket.ticket_id}, '${ticket.subject}')" title="Delete">
            Delete
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderTicketPagination() {
  const container = document.getElementById("tickets-pagination");
  if (!container) return;
  container.innerHTML = "";

  const totalPages = Math.ceil(filteredTickets.length / TICKET_PAGE_SIZE) || 1;
  if (totalPages === 1) return; // No pagination needed

  function createPageBtn(pageNum, active) {
    const li = document.createElement('li');
    li.className = `page-item${active ? " active" : ""}`;
    const btn = document.createElement('button');
    btn.type = "button";
    btn.className = "page-link";
    btn.textContent = pageNum;
    btn.onclick = () => {
      if (ticketCurrentPage !== pageNum) {
        ticketCurrentPage = pageNum;
        populateTicketsTablePaginated();
        renderTicketPagination();
      }
    };
    li.appendChild(btn);
    return li;
  }

  function createEllipsis() {
    const li = document.createElement('li');
    li.className = "page-item disabled";
    li.innerHTML = '<span class="page-link">â€¦</span>';
    return li;
  }

  const ul = document.createElement('ul');
  ul.className = "pagination justify-content-center";

  // Prev button
  const prevLi = document.createElement('li');
  prevLi.className = `page-item${ticketCurrentPage === 1 ? " disabled" : ""}`;
  const prevBtn = document.createElement('button');
  prevBtn.type = "button";
  prevBtn.className = "page-link";
  prevBtn.textContent = "Previous";
  prevBtn.onclick = () => {
    if (ticketCurrentPage > 1) {
      ticketCurrentPage--;
      populateTicketsTablePaginated();
      renderTicketPagination();
    }
  };
  prevLi.appendChild(prevBtn);
  ul.appendChild(prevLi);

  // Page numbers (smart display up to 5, ellipsis if needed)
  let startPage = Math.max(1, ticketCurrentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  if (endPage - startPage < 4) {
    startPage = Math.max(1, endPage - 4);
  }
  if (startPage > 1) {
    ul.appendChild(createPageBtn(1, ticketCurrentPage === 1));
    if (startPage > 2) ul.appendChild(createEllipsis());
  }
  for (let i = startPage; i <= endPage; i++) {
    ul.appendChild(createPageBtn(i, ticketCurrentPage === i));
  }
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) ul.appendChild(createEllipsis());
    ul.appendChild(createPageBtn(totalPages, ticketCurrentPage === totalPages));
  }

  // Next button
  const nextLi = document.createElement('li');
  nextLi.className = `page-item${ticketCurrentPage === totalPages ? " disabled" : ""}`;
  const nextBtn = document.createElement('button');
  nextBtn.type = "button";
  nextBtn.className = "page-link";
  nextBtn.textContent = "Next";
  nextBtn.onclick = () => {
    if (ticketCurrentPage < totalPages) {
      ticketCurrentPage++;
      populateTicketsTablePaginated();
      renderTicketPagination();
    }
  };
  nextLi.appendChild(nextBtn);
  ul.appendChild(nextLi);

  container.appendChild(ul);
}

function searchTickets(searchQuery = '') {
  loadTickets(searchQuery);
}

function viewTicket(ticketId) {
  ModalUtils.showSpinner();
  fetch(`/view-ticket/${ticketId}`, {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    }
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    if (response.ok && !data.error) {
      populateViewModal(data);
      $('#viewTicketModal').modal('show');
    } else {
      ModalUtils.showerror(data.error || data.message || 'Failed to load ticket details');
    }
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    console.error('Error:', error);
    ModalUtils.showerror('Failed to load ticket details');
  });
}

function populateViewModal(ticket) {
  const modalBody = document.getElementById('viewTicketBody');
  modalBody.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6>Ticket Information</h6>
        <p><strong>Ticket ID:</strong> #${ticket.ticket_id}</p>
        <p><strong>Employee ID:</strong> ${ticket.employee_id}</p>
        <p><strong>Employee:</strong> ${ticket.employee_name || '-'}</p>
        <p><strong>Email:</strong> ${ticket.email || '-'}</p>
        <p><strong>Category:</strong> <span class="badge bg-info">${ticket.category}</span></p>
        <p><strong>Priority:</strong> <span class="badge ${getPriorityBadgeClass(ticket.priority)}">${ticket.priority}</span></p>
        <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(ticket.status)}">${ticket.status}</span></p>
        <p><strong>File Path:</strong> <code>${ticket.file_path || '-'}</code></p>
        <p><strong>Created:</strong> ${ticket.created_at ? new Date(ticket.created_at).toLocaleString() : '-'}</p>
        <p><strong>Updated:</strong> ${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : '-'}</p>
      </div>
      <div class="col-md-6">
        <h6>Subject</h6>
        <p>${ticket.subject}</p>
        <h6>Description</h6>
        <p>${ticket.description}</p>
      </div>
    </div>
    ${Array.isArray(ticket.responses) && ticket.responses.length > 0 ? `
      <hr>
      <div class="row">
        <div class="col-12">
          <h6>Responses</h6>
          ${ticket.responses.map(resp => `
            <div class="border rounded p-2 mb-2 bg-light">
              <p class="mb-1">
                <strong>Response ID:</strong> ${resp.response_id || '-'}<br>
                <strong>Ticket ID:</strong> ${resp.ticket_id || '-'}<br>
                <strong>Employee ID:</strong> ${resp.employee_id || '-'}<br>
                <strong>Employee Response:</strong> ${resp.response || '-'}<br>
                <strong>Responded By:</strong> ${resp.responded_by || '-'}<br>
                <strong>Responded At:</strong> ${resp.responded_at ? new Date(resp.responded_at).toLocaleString() : '-'}<br>
                <strong>Admin Response:</strong> ${resp.admin_response || '-'}<br>
                <strong>Responded By Admin:</strong> ${resp.responded_by_admin || '-'}
              </p>
            </div>
          `).join('')}
        </div>
      </div>
    ` : '<hr><div class="row"><div class="col-12"><p class="text-muted text-center">No responses yet.</p></div></div>'}
  `;
}

function editTicket(ticketId) {
  ModalUtils.showSpinner();
  fetch(`/get-ticket/${ticketId}`, {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    }
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    if (response.ok && !data.error) {
      populateEditModal(data);
      $('#editTicketModal').modal('show');
    } else {
      ModalUtils.showerror(data.error || data.message || 'Failed to load ticket for editing');
    }
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    console.error('Error:', error);
    ModalUtils.showerror('Failed to load ticket for editing');
  });
}

function populateEditModal(ticket) {
  document.getElementById('editTicketId').value = ticket.ticket_id;
  document.getElementById('editCategory').value = ticket.category;
  document.getElementById('editSubject').value = ticket.subject;
  document.getElementById('editDescription').value = ticket.description;
  document.getElementById('editPriority').value = ticket.priority;
  document.getElementById('editStatus').value = ticket.status;
}

function updateTicket() {
  const ticketData = {
    ticket_id: document.getElementById('editTicketId').value,
    category: document.getElementById('editCategory').value,
    subject: document.getElementById('editSubject').value,
    description: document.getElementById('editDescription').value,
    priority: document.getElementById('editPriority').value,
    status: document.getElementById('editStatus').value
  };
  ModalUtils.showSpinner();
  fetch('/edit-ticket', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(ticketData)
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    $('#editTicketModal').modal('hide');
    if (response.ok && !data.error) {
      ModalUtils.showSuccess(data.message || 'Ticket updated successfully!');
      loadTickets();
    } else {
      ModalUtils.showerror(data.error || data.message || `Error ${response.status}: Unauthorized or failed to update ticket.`);
    }
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    console.error('Error:', error);
    ModalUtils.showerror('Failed to update ticket');
  });
}

function respondToTicket(ticketId) {
  ModalUtils.showSpinner();
  fetch(`/view-ticket/${ticketId}`, {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    }
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    if (response.ok && !data.error) {
      populateRespondModal(data);
      $('#respondTicketModal').modal('show');
    } else {
      ModalUtils.showerror(data.error || data.message || 'Failed to load ticket for response');
    }
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    console.error('Error:', error);
    ModalUtils.showerror('Failed to load ticket for response');
  });
}

function populateRespondModal(ticket) {
  document.getElementById('respondTicketId').value = ticket.ticket_id;
  document.getElementById('respondTicketInfo').innerHTML = `
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="card-title">Ticket #${ticket.ticket_id} - ${ticket.subject}</h6>
        <p class="card-text"><strong>Employee:</strong> ${ticket.email}</p>
        <p class="card-text"><strong>Category:</strong> ${ticket.category}</p>
        <p class="card-text"><strong>Description:</strong> ${ticket.description}</p>
      </div>
    </div>
  `;
  let responseBlocks = "";
  if (Array.isArray(ticket.responses) && ticket.responses.length > 0) {
    ticket.responses.forEach(resp => {
      responseBlocks += `
        <div class="border rounded p-2 mb-3 bg-light">
          <p class="mb-1">
            <strong>Response ID:</strong> ${resp.response_id || '-'}<br>
            <strong>Employee ID:</strong> ${resp.employee_id || '-'}<br>
            <strong>Employee Response:</strong> ${resp.response || '-'}<br>
            <strong>Responded By:</strong> ${resp.responded_by || '-'}<br>
            <strong>Responded At:</strong> ${resp.responded_at ? new Date(resp.responded_at).toLocaleString() : '-'}
          </p>
          <div class="mb-2">
            <label for="adminResponse_${resp.response_id}" class="form-label">Your Response</label>
            <textarea class="form-control" id="adminResponse_${resp.response_id}" rows="2" required placeholder="Enter your response...">${resp.admin_response ? resp.admin_response : ''}</textarea>
          </div>
          <button type="button" class="btn btn-success btn-sm" onclick="sendSpecificResponse(${ticket.ticket_id}, ${resp.response_id})">Send Response</button>
          <span id="responseStatus_${resp.response_id}" class="ms-2"></span>
        </div>
      `;
    });
  } else {
    responseBlocks = '<div class="text-muted text-center">No employee responses yet.</div>';
  }
  document.getElementById('respondToResponsesContainer').innerHTML = responseBlocks;
}

function sendSpecificResponse(ticketId, responseId) {
  const textarea = document.getElementById(`adminResponse_${responseId}`);
  const responseText = textarea.value.trim();
  const statusElem = document.getElementById(`responseStatus_${responseId}`);
  if (!responseText) {
    statusElem.textContent = "Please enter a response!";
    statusElem.className = "text-danger ms-2";
    return;
  }
  ModalUtils.showSpinner();
  fetch('/respond-ticket', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      ticket_id: ticketId,
      response_id: responseId,
      admin_response: responseText
    })
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    if (response.ok && !data.error) {
      // Show success modal and update status element after modal closes
      ModalUtils.showSuccess(data.message || "Response sent!", function () {
        statusElem.textContent = "Response sent!";
        statusElem.className = "text-success ms-2";
      });
    } else {
      // Show error modal and update status element after modal closes
      ModalUtils.showerror(data.error || data.message || `Error ${response.status}: Failed to send response.`, function () {
        statusElem.textContent = data.error || data.message || `Error ${response.status}: Failed to send response.`;
        statusElem.className = "text-danger ms-2";
      });
    }
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    // Show error modal and update status element after modal closes
    ModalUtils.showerror("Error sending response", function () {
      statusElem.textContent = "Error sending response";
      statusElem.className = "text-danger ms-2";
    });
  });
}

function deleteTicket(ticketId, ticketSubject) {
  currentTicketIdToDelete = ticketId;
  document.getElementById('deleteTicketInfo').innerHTML = `
    <strong>Ticket #${ticketId}:</strong> ${ticketSubject}
  `;
  $('#deleteTicketModal').modal('show');
}

function confirmDeleteTicket() {
  if (!currentTicketIdToDelete) return;
  ModalUtils.showSpinner();
  fetch(`/delete-ticket/${currentTicketIdToDelete}`, {
    method: 'DELETE',
    headers: {
      'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken'),
      'Content-Type': 'application/json'
    }
  })
  .then(async response => {
    ModalUtils.hideSpinner();
    let data;
    try { data = await response.json(); } catch { data = {}; }
    $('#deleteTicketModal').modal('hide');
    if (response.ok && !data.error) {
      ModalUtils.showSuccess(data.message || 'Ticket deleted successfully!');
      loadTickets();
    } else {
      ModalUtils.showerror(data.error || data.message || `Error ${response.status}: Unauthorized or failed to delete ticket.`);
    }
    currentTicketIdToDelete = null;
  })
  .catch(error => {
    ModalUtils.hideSpinner();
    console.error('Error:', error);
    ModalUtils.showerror('Failed to delete ticket');
    currentTicketIdToDelete = null;
  });
}

function getPriorityBadgeClass(priority) {
  switch (priority.toLowerCase()) {
    case 'low': return 'bg-success';
    case 'medium': return 'bg-warning';
    case 'high': return 'bg-danger';
    case 'critical': return 'bg-dark text-white';
    default: return 'bg-secondary';
  }
}

function getStatusBadgeClass(status) {
  switch (status.toLowerCase()) {
    case 'open': return 'bg-secondary';
    case 'in progress': return 'bg-warning';
    case 'responded': return 'bg-info';
    case 'resolved': return 'bg-success';
    case 'closed': return 'bg-danger';
    default: return 'bg-secondary';
  }
}

</script>
<!-- Script for handling ticketing system table (End) -->

    <!-- Script for displaying, editing, deleting, adding timesheet (Start) -->
<script>
  // All modal and spinner logic now uses ModalUtils (Bootstrap 4 compatible)

function formatTimeHMSS(hms) {
    if (!hms || hms === "0:0:0" || hms === "00:00:00") return "0 seconds";
    let [h, m, s] = hms.split(":").map(Number);
    let out = [];
    if (h > 0) out.push(`${h} hour${h > 1 ? "s" : ""}`);
    if (m > 0) out.push(`${m} minute${m > 1 ? "s" : ""}`);
    if (s > 0 || out.length === 0) out.push(`${s} second${s > 1 ? "s" : ""}`);
    return out.join(" ");
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("Page Loaded: Fetching Employees and Timesheets...");
    fetchEmployees("");
    fetchTimesheets();
    const generateBtn = document.getElementById("confirm-generate");
    if (generateBtn) {
        generateBtn.removeEventListener("click", generateTimesheet);
        generateBtn.addEventListener("click", generateTimesheet);
    }
    const searchInput = document.getElementById("searchTimesheet");
    if (searchInput) {
        searchInput.addEventListener("keyup", searchTimesheets);
    }
    const employeeSearchInput = document.getElementById("search-bar");
    if (employeeSearchInput) {
        employeeSearchInput.addEventListener("input", searchEmployees);
    }
});

const getAuthHeaders = () => ({
    "Content-Type": "application/json",
    "Authorization": "Bearer " + sessionStorage.getItem("adminToken")
});

let allTimesheets = [];
let filteredTimesheets = [];
let timesheetCurrentPage = 1;
const TIMESHEET_PAGE_SIZE = 10;

let allEmployees = [];

function fetchTimesheets() {
    ModalUtils.showSpinner();
    fetch('/get-timesheet-details', { headers: getAuthHeaders() })
        .then(res => res.json())
        .then(data => {
            ModalUtils.hideSpinner();
            allTimesheets = data.timesheets || [];
            filteredTimesheets = allTimesheets;
            timesheetCurrentPage = 1;
            updateTimesheetTablePaginated();
            renderTimesheetPagination();
        })
        .catch(err => {
            ModalUtils.hideSpinner();
            displayFetchError("fetching timesheets", err);
        });
}

function searchTimesheets() {
    const query = document.getElementById("searchTimesheet").value.trim().toLowerCase();
    if (query === "") {
        filteredTimesheets = allTimesheets;
    } else {
        filteredTimesheets = allTimesheets.filter(t =>
            (t.employee_name && t.employee_name.toLowerCase().includes(query)) ||
            (t.log_date && t.log_date.toLowerCase().includes(query)) ||
            (t.status && t.status.toLowerCase().includes(query)) ||
            (t.total_work_hours && t.total_work_hours.toString().includes(query)) ||
            (t.total_break_time && t.total_break_time.toString().includes(query)) ||
            (t.overtime && t.overtime.toString().includes(query))
        );
    }
    timesheetCurrentPage = 1;
    updateTimesheetTablePaginated();
    renderTimesheetPagination();
}

function updateTimesheetTablePaginated() {
    const table = document.querySelector("#timesheet-details");
    if (!table) {
        console.error("Timesheet table body not found.");
        return;
    }
    if (!filteredTimesheets.length) {
        table.innerHTML = `<tr><td colspan="8" class="text-center">No matching records found</td></tr>`;
        return;
    }
    table.innerHTML = "";

    const startIdx = (timesheetCurrentPage - 1) * TIMESHEET_PAGE_SIZE;
    const endIdx = startIdx + TIMESHEET_PAGE_SIZE;
    const pageTimesheets = filteredTimesheets.slice(startIdx, endIdx);

    pageTimesheets.forEach(t => {
        const workTime = t.total_work_hours ? t.total_work_hours : "0:0:0";
        const breakTime = t.total_break_time ? t.total_break_time : "0:0:0";
        const overtime = t.overtime ? t.overtime : "0:0:0";
        const statusBadge = `<span class="badge bg-${getStatusClass(t.status)} text-capitalize">${t.status}</span>`;
        const row = `
            <tr>
                <td>${t.timesheet_id}</td>
                <td>${t.employee_name}</td>
                <td>${t.log_date}</td>
                <td>${formatTimeHMSS(workTime)}</td>
                <td>${formatTimeHMSS(breakTime)}</td>
                <td>${formatTimeHMSS(overtime)}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-info" onclick="viewTimesheetDetails(${t.timesheet_id})">View</button>
                    <button class="btn btn-warning" onclick="openEditModal(${t.timesheet_id}, '${workTime}', '${breakTime}','${overtime}')">Edit</button>
                    <button class="btn btn-danger" onclick="openDeleteModal(${t.timesheet_id})">Delete</button>
                </td>
            </tr>`;
        table.innerHTML += row;
    });
}

function renderTimesheetPagination() {
    const container = document.getElementById("timesheet-pagination");
    if (!container) return;
    container.innerHTML = "";

    const totalPages = Math.ceil(filteredTimesheets.length / TIMESHEET_PAGE_SIZE) || 1;
    if (totalPages === 1) return; // No pagination needed

    // Helper to create page button
    function createPageBtn(pageNum, active) {
        const li = document.createElement('li');
        li.className = `page-item${active ? " active" : ""}`;
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "page-link";
        btn.textContent = pageNum;
        btn.onclick = () => {
            if (timesheetCurrentPage !== pageNum) {
                timesheetCurrentPage = pageNum;
                updateTimesheetTablePaginated();
                renderTimesheetPagination();
            }
        };
        li.appendChild(btn);
        return li;
    }

    function createEllipsis() {
        const li = document.createElement('li');
        li.className = "page-item disabled";
        li.innerHTML = '<span class="page-link">â€¦</span>';
        return li;
    }

    const ul = document.createElement('ul');
    ul.className = "pagination justify-content-center";

    // Prev button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item${timesheetCurrentPage === 1 ? " disabled" : ""}`;
    const prevBtn = document.createElement('button');
    prevBtn.type = "button";
    prevBtn.className = "page-link";
    prevBtn.textContent = "Previous";
    prevBtn.onclick = () => {
        if (timesheetCurrentPage > 1) {
            timesheetCurrentPage--;
            updateTimesheetTablePaginated();
            renderTimesheetPagination();
        }
    };
    prevLi.appendChild(prevBtn);
    ul.appendChild(prevLi);

    // Page numbers (smart display up to 5, ellipsis if needed)
    let startPage = Math.max(1, timesheetCurrentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
    }
    if (startPage > 1) {
        ul.appendChild(createPageBtn(1, timesheetCurrentPage === 1));
        if (startPage > 2) ul.appendChild(createEllipsis());
    }
    for (let i = startPage; i <= endPage; i++) {
        ul.appendChild(createPageBtn(i, timesheetCurrentPage === i));
    }
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) ul.appendChild(createEllipsis());
        ul.appendChild(createPageBtn(totalPages, timesheetCurrentPage === totalPages));
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item${timesheetCurrentPage === totalPages ? " disabled" : ""}`;
    const nextBtn = document.createElement('button');
    nextBtn.type = "button";
    nextBtn.className = "page-link";
    nextBtn.textContent = "Next";
    nextBtn.onclick = () => {
        if (timesheetCurrentPage < totalPages) {
            timesheetCurrentPage++;
            updateTimesheetTablePaginated();
            renderTimesheetPagination();
        }
    };
    nextLi.appendChild(nextBtn);
    ul.appendChild(nextLi);

    container.appendChild(ul);
}

function viewTimesheetDetails(timesheetId) {
    ModalUtils.showSpinner();
    fetch(`/get-timesheet-detail/${timesheetId}`, { headers: getAuthHeaders() })
        .then(res => res.json())
        .then(data => {
            ModalUtils.hideSpinner();
            console.log("API response:", data);
            if (!data.timesheet) {
                ModalUtils.showerror(data.message || "Timesheet not found.");
                return;
            }
            const t = data.timesheet;
            const safeSet = (id, val) => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn("Missing element:", id);
                    return;
                }
                el.innerText = val;
            };
            safeSet("viewTimesheetId", t.timesheet_id);
            safeSet("viewEmployeeName", t.employee_name || t.employee_id);
            safeSet("viewLogDate", t.log_date);
            safeSet("viewTotalWorkHours", formatTimeHMSS(t.total_work_hours));
            safeSet("viewTotalBreakTime", formatTimeHMSS(t.total_break_time));
            safeSet("viewOvertime", formatTimeHMSS(t.overtime));
            safeSet("viewStatus", t.status);
            safeSet("viewCreatedAt", t.submitted_at || "-");
            safeSet("viewUpdatedAt", t.updated_at || "-");
            const tbody = document.getElementById("viewBreaksTableBody");
            if (tbody) {
                const breaks = t.breaks || [];
                tbody.innerHTML = "";
                if (breaks.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No breaks recorded</td></tr>`;
                } else {
                    breaks.forEach((b, i) => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${b.break_type || "-"}</td>
                                <td>${b.break_start ? new Date(b.break_start).toLocaleTimeString() : "-"}</td>
                                <td>${b.break_end ? new Date(b.break_end).toLocaleTimeString() : "-"}</td>
                                <td>${formatTimeHMSS(b.break_duration)}</td>
                            </tr>
                        `;
                    });
                }
            }
            $("#viewTimesheetModal").modal("show");
        })
        .catch(err => {
            ModalUtils.hideSpinner();
            console.error("Error fetching timesheet details:", err);
            ModalUtils.showerror("Error fetching timesheet details.");
        });
}

function updateTimesheetTable(timesheets) {
    const table = document.querySelector("#timesheet-details");
    if (!table) {
        console.error("Timesheet table body not found.");
        return;
    }
    table.innerHTML = timesheets.length === 0 
        ? `<tr><td colspan="8" class="text-center">No matching records found</td></tr>` 
        : "";
    timesheets.forEach(t => {
        const workTime = t.total_work_hours ? t.total_work_hours : "0:0:0";
        const breakTime = t.total_break_time ? t.total_break_time : "0:0:0";
        const overtime = t.overtime ? t.overtime : "0:0:0";
        const statusBadge = `<span class="badge bg-${getStatusClass(t.status)} text-capitalize">${t.status}</span>`;
        const row = `
            <tr>
                <td>${t.timesheet_id}</td>
                <td>${t.employee_name}</td>
                <td>${t.log_date}</td>
                <td>${formatTimeHMSS(workTime)}</td>
                <td>${formatTimeHMSS(breakTime)}</td>
                <td>${formatTimeHMSS(overtime)}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-info" onclick="viewTimesheetDetails(${t.timesheet_id})">View</button>
                    <button class="btn btn-warning" onclick="openEditModal(${t.timesheet_id}, '${workTime}', '${breakTime}','${overtime}')">Edit</button>
                    <button class="btn btn-danger" onclick="openDeleteModal(${t.timesheet_id})">Delete</button>
                </td>
            </tr>`;
        table.innerHTML += row;
    });
}

function getStatusClass(status) {
    switch ((status || "").toLowerCase()) {
        case "approved": return "success";
        case "rejected": return "danger";
        case "pending": return "warning text-dark";
        default: return "secondary";
    }
}

function openEditModal(id, work, breakTime, overtime) {
    document.getElementById("editTimesheetId").value = id;
    function cleanTime(val) {
        return (!val || val === "undefined" || val === "'undefined'" || val === "null" || val === "'null'") ? "0:0:0" : val.replace(/^'+|'+$/g, "");
    }
    function pad(val) {
        val = (val || "0").toString();
        return val.padStart(2, "0");
    }
    let [wh, wm, ws] = cleanTime(work).split(":").map(pad);
    let [bh, bm, bs] = cleanTime(breakTime).split(":").map(pad);
    let [oh, om, os] = cleanTime(overtime).split(":").map(pad);
    document.getElementById("editWorkHours").value = wh;
    document.getElementById("editWorkMinutes").value = wm;
    document.getElementById("editWorkSeconds").value = ws;
    document.getElementById("editBreakHours").value = bh;
    document.getElementById("editBreakMinutes").value = bm;
    document.getElementById("editBreakSeconds").value = bs;
    document.getElementById("editOvertimeHours").value = oh;
    document.getElementById("editOvertimeMinutes").value = om;
    document.getElementById("editOvertimeSeconds").value = os;
    $("#editTimesheetModal").modal("show");
}

function submitEditTimesheet() {
    const id = document.getElementById("editTimesheetId").value;
    const wh = document.getElementById("editWorkHours").value || '0';
    const wm = document.getElementById("editWorkMinutes").value || '0';
    const ws = document.getElementById("editWorkSeconds").value || '0';
    const bh = document.getElementById("editBreakHours").value || '0';
    const bm = document.getElementById("editBreakMinutes").value || '0';
    const bs = document.getElementById("editBreakSeconds").value || '0';
    const oh = document.getElementById("editOvertimeHours").value || '0';
    const om = document.getElementById("editOvertimeMinutes").value || '0';
    const os = document.getElementById("editOvertimeSeconds").value || '0';

    let updateData = { timesheet_id: id };
    if (wh !== '0' || wm !== '0' || ws !== '0') updateData.total_work_hours = `${wh}:${wm}:${ws}`;
    if (bh !== '0' || bm !== '0' || bs !== '0') updateData.total_break_time = `${bh}:${bm}:${bs}`;
    if (oh !== '0' || om !== '0' || os !== '0') updateData.overtime = `${oh}:${om}:${os}`;

    if (!updateData.total_work_hours && !updateData.total_break_time && !updateData.overtime) {
        ModalUtils.showerror("No update provided. Please enter new work hours, break time, or overtime.");
        return;
    }

    ModalUtils.showSpinner();
    fetch("/edit-timesheet", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(updateData)
    })
    .then(async res => {
        ModalUtils.hideSpinner();
        let data;
        try { data = await res.json(); } catch (e) { data = {}; }
        if (res.ok) {
            ModalUtils.showSuccess(data.message || "Timesheet updated successfully!");
            fetchTimesheets();
            $('#editTimesheetModal').modal("hide");
        } else {
            ModalUtils.showerror(data.message || `Error ${res.status}: Unauthorized or failed to edit timesheet.`);
        }
    })
    .catch(err => {
        ModalUtils.hideSpinner();
        displayFetchError("editing timesheet", err);
    });
}

function openDeleteModal(id) {
    document.getElementById("deleteTimesheetId").value = id;
    $("#deleteTimesheetModal").modal("show");
}

function confirmDeleteTimesheet() {
    const id = document.getElementById("deleteTimesheetId").value;
    ModalUtils.showSpinner();
    fetch("/delete-timesheet", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({ timesheet_id: id })
    })
    .then(async res => {
        ModalUtils.hideSpinner();
        let data;
        try { data = await res.json(); } catch (e) { data = {}; }
        if (res.ok) {
            ModalUtils.showSuccess(data.message || "Timesheet deleted successfully!");
            fetchTimesheets();
            $("#deleteTimesheetModal").modal("hide");
        } else {
            ModalUtils.showerror(data.message || `Error ${res.status}: Unauthorized or failed to delete timesheet.`);
        }
    })
    .catch(err => {
        ModalUtils.hideSpinner();
        displayFetchError("deleting timesheet", err);
    });
}

let filteredEmployees = [];
let employeeCurrentPage = 1;
const EMPLOYEE_PAGE_SIZE = 10;

function fetchEmployees(query = "") {
    ModalUtils.showSpinner();
    fetch(`/get_employees_timesheet?query=${query}`, {
        headers: getAuthHeaders()
    })
    .then(res => res.json())
    .then(data => {
        ModalUtils.hideSpinner();
        allEmployees = data.employees || [];
        filteredEmployees = allEmployees;
        employeeCurrentPage = 1;
        updateEmployeeTablePaginated();
        renderEmployeePagination();
    })
    .catch(err => {
        ModalUtils.hideSpinner();
        displayFetchError("fetching employees", err);
    });
}

function searchEmployees() {
    const query = document.getElementById("search-bar").value.trim();
    if (query === "") {
        filteredEmployees = allEmployees;
    } else {
        filteredEmployees = allEmployees.filter(emp =>
            (emp.employee_name && emp.employee_name.toLowerCase().includes(query.toLowerCase())) ||
            (emp.email && emp.email.toLowerCase().includes(query.toLowerCase())) ||
            (emp.status && emp.status.toLowerCase().includes(query.toLowerCase())) ||
            (emp.first_name && emp.first_name.toLowerCase().includes(query.toLowerCase())) ||
            (emp.last_name && emp.last_name.toLowerCase().includes(query.toLowerCase()))
        );
    }
    employeeCurrentPage = 1;
    updateEmployeeTablePaginated();
    renderEmployeePagination();
}

function updateEmployeeTablePaginated() {
    const table = document.getElementById("employee-list");
    if (!table) return console.error("Employee table not found.");
    if (!filteredEmployees.length) {
        table.innerHTML = `<tr><td colspan="3" class="text-center">No matching employees found</td></tr>`;
        return;
    }
    table.innerHTML = "";

    const startIdx = (employeeCurrentPage - 1) * EMPLOYEE_PAGE_SIZE;
    const endIdx = startIdx + EMPLOYEE_PAGE_SIZE;
    const pageEmployees = filteredEmployees.slice(startIdx, endIdx);

    pageEmployees.forEach(emp => {
        const displayName = emp.employee_name || emp.first_name + ' ' + emp.last_name || emp.email;
        table.innerHTML += `
            <tr>
                <td>${emp.email || `Employee's ID: ` + emp.employee_id}</td>
                <td>
                    <span class="badge bg-${getEmployeeStatusClass(emp.status || 'No status')}">${emp.status || 'No status'}</span>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="openGenerateModal(${emp.employee_id})">Generate</button>
                    ${emp.timesheet_id ? `
                        <button class="btn btn-success btn-sm" onclick="updateTimesheet(${emp.timesheet_id}, 'approved')">Approve</button>
                        <button class="btn btn-warning btn-sm" onclick="updateTimesheet(${emp.timesheet_id}, 'rejected')">Reject</button>
                    ` : ''}
                </td>
            </tr>`;
    });
}

function renderEmployeePagination() {
    const container = document.getElementById("employee-pagination");
    if (!container) return;
    container.innerHTML = "";

    const totalPages = Math.ceil(filteredEmployees.length / EMPLOYEE_PAGE_SIZE) || 1;
    if (totalPages === 1) return;

    function createPageBtn(pageNum, active) {
        const li = document.createElement('li');
        li.className = `page-item${active ? " active" : ""}`;
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "page-link";
        btn.textContent = pageNum;
        btn.onclick = () => {
            if (employeeCurrentPage !== pageNum) {
                employeeCurrentPage = pageNum;
                updateEmployeeTablePaginated();
                renderEmployeePagination();
            }
        };
        li.appendChild(btn);
        return li;
    }

    function createEllipsis() {
        const li = document.createElement('li');
        li.className = "page-item disabled";
        li.innerHTML = '<span class="page-link">â€¦</span>';
        return li;
    }

    const ul = document.createElement('ul');
    ul.className = "pagination justify-content-center";

    // Prev button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item${employeeCurrentPage === 1 ? " disabled" : ""}`;
    const prevBtn = document.createElement('button');
    prevBtn.type = "button";
    prevBtn.className = "page-link";
    prevBtn.textContent = "Previous";
    prevBtn.onclick = () => {
        if (employeeCurrentPage > 1) {
            employeeCurrentPage--;
            updateEmployeeTablePaginated();
            renderEmployeePagination();
        }
    };
    prevLi.appendChild(prevBtn);
    ul.appendChild(prevLi);

    // Page numbers (smart display up to 5, ellipsis if needed)
    let startPage = Math.max(1, employeeCurrentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
    }
    if (startPage > 1) {
        ul.appendChild(createPageBtn(1, employeeCurrentPage === 1));
        if (startPage > 2) ul.appendChild(createEllipsis());
    }
    for (let i = startPage; i <= endPage; i++) {
        ul.appendChild(createPageBtn(i, employeeCurrentPage === i));
    }
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) ul.appendChild(createEllipsis());
        ul.appendChild(createPageBtn(totalPages, employeeCurrentPage === totalPages));
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item${employeeCurrentPage === totalPages ? " disabled" : ""}`;
    const nextBtn = document.createElement('button');
    nextBtn.type = "button";
    nextBtn.className = "page-link";
    nextBtn.textContent = "Next";
    nextBtn.onclick = () => {
        if (employeeCurrentPage < totalPages) {
            employeeCurrentPage++;
            updateEmployeeTablePaginated();
            renderEmployeePagination();
        }
    };
    nextLi.appendChild(nextBtn);
    ul.appendChild(nextLi);

    container.appendChild(ul);
}

function getEmployeeStatusClass(status) {
    switch ((status || "").toLowerCase()) {
        case "approved": return "success";
        case "rejected": return "danger";
        case "pending": return "warning text-dark";
        default: return "secondary";
    }
}

let selectedEmployeeId = null;

function openGenerateModal(empId) {
    selectedEmployeeId = empId;
    document.getElementById("timesheetDate").value = "";
    $('#generateTimesheetModal').modal("show");
}

function generateTimesheet() {
    const date = document.getElementById("timesheetDate").value;
    if (!date || !selectedEmployeeId) return ModalUtils.showerror("Please select an employee and date.");
    ModalUtils.showSpinner();
    fetch("/generate-timesheet", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({ employee_id: selectedEmployeeId, log_date: date })
    })
    .then(async res => {
        ModalUtils.hideSpinner();
        let data;
        try { data = await res.json(); } catch (e) { data = {}; }
        if (res.ok) {
            ModalUtils.showSuccess(data.message || "Timesheet generated successfully!");
            fetchTimesheets();
            fetchEmployees();
            $('#generateTimesheetModal').modal("hide");
        } else {
            ModalUtils.showerror(data.message || `Error ${res.status}: Unauthorized or failed to generate timesheet.`);
        }
    })
    .catch(err => {
        ModalUtils.hideSpinner();
        displayFetchError("generating timesheet", err);
    });
}

function updateTimesheet(id, status) {
    ModalUtils.showSpinner();
    fetch("/update-timesheet-status", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({ timesheet_id: id, status })
    })
    .then(async res => {
        ModalUtils.hideSpinner();
        let data;
        try { data = await res.json(); } catch (e) { data = {}; }
        if (res.ok) {
            ModalUtils.showSuccess(data.message || "Timesheet updated successfully!");
            fetchTimesheets();
            fetchEmployees("");
        } else {
            ModalUtils.showerror(data.message || `Error ${res.status}: Unauthorized or failed to update timesheet status.`);
        }
    })
    .catch(err => {
        ModalUtils.hideSpinner();
        displayFetchError("updating timesheet status", err);
    });
}

function displayFetchError(action, error) {
    console.error(`Error ${action}:`, error);
    ModalUtils.showerror(`An error occurred while ${action}. Please try again.`);
}
</script>
<!-- Script for displaying, editing, deleting, adding timesheet (End) -->

<!-- Script for logging out (Start) -->
<script>
  document.querySelector(".logout-btn").addEventListener("click", function () {
    $("#logoutModal").modal("show"); // Show modal using jQuery
  });

  document
    .getElementById("confirmLogout")
    .addEventListener("click", function () {
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    });

  document
    .getElementById("cancelLogout")
    .addEventListener("click", function () {
      $("#logoutModal").modal("hide"); // Hide modal using jQuery
    });

  document
    .getElementById("closeLogoutModal")
    .addEventListener("click", function () {
      $("#logoutModal").modal("hide"); // Also hide on "X"
    });
</script>
<!-- Script for logging out (End) -->

<!-- Script that redirects admin back to login page if the token doesn't exist (Start) -->
<script>
  const token = sessionStorage.getItem("adminToken")
  if (!token) {
    alert("Not authenticated. Redirecting to login.");
    window.location.href = "/admin_login";
  }
</script>
<!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

<!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start) -->
<script>
  function getToken() {
  return sessionStorage.getItem("adminToken");
}

function checkSessionConflict() {
  const token = getToken();
  if (!token) return;

  fetch("/check_jti", {
    method: "GET",
    headers: {
      Authorization: "Bearer " + token,
    },
  })
    .then((response) => {
      if (response.status === 403) {
        throw new Error("session_conflict");
      }
      return response.json();
    })
    .then((data) => {
      if (data.error === "session_conflict") {
        throw new Error("session_conflict");
      }
    })
    .catch((err) => {
      if (err.message === "session_conflict") {
        // Show session conflict modal using ModalUtils (Bootstrap 4)
        $('#sessionConflictModal').modal({
          backdrop: 'static',
          keyboard: false
        });

        // Attach event listener only once
        const logoutBtn = document.getElementById("confirmLogoutBetweenTabs");
        if (!logoutBtn.dataset.bound) {
          logoutBtn.addEventListener("click", () => {
            sessionStorage.removeItem("adminToken");
            window.location.href = "/admin_login";
          });
          logoutBtn.dataset.bound = "true";
        }
        // Show error modal for feedback (optional)
        ModalUtils.showerror("Session conflict detected. Please log in again.");
      }
    });
}

// Initial check + every 30 seconds
checkSessionConflict();
setInterval(checkSessionConflict, 30000);
</script>
<!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

<!-- Script for checking admin if they have access to this page (Start) -->
<script>
  // Only run this if the backend passed access_denied = True
const accessDenied = {{ 'true' if access_denied else 'false' }};
if (accessDenied) {
  // Show error modal using ModalUtils for Bootstrap 4
  ModalUtils.showerror("Access denied. You do not have permission to view this page.");

  // Show the access denied modal (Bootstrap 4)
  $('#accessDeniedModal').modal({
    backdrop: 'static',
    keyboard: false
  });

  document.getElementById("forceLogoutBtn").addEventListener("click", function () {
    sessionStorage.removeItem("adminToken");
    window.location.href = "/admin_login";
  });
}
</script>
<!-- Script for checking admin if they have access to this page (End) -->


  </body>
</html>
