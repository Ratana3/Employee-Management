<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2FA Verification</title>
    <!-- Bootstrap 4 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f4f4f4;
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 100%;
        max-width: 400px;
      }
      h2 {
        margin-bottom: 10px;
      }
      p {
        color: #666;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
      }
      button {
        width: 100%;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      .error-message {
        color: red;
        font-size: 14px;
        margin-top: 10px;
      }
      .resend-link {
        display: block;
        margin-top: 15px;
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
      }
      .resend-link:hover {
        color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Two-Factor Authentication</h2>
      <p>
        Enter the verification code sent to your email or generated by Google
        Authenticator.
      </p>
      {% if error %}
      <p class="error-message">{{ error }}</p>
      {% endif %}
      <form method="POST" id="twofaForm" autocomplete="off">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input
          type="text"
          name="code"
          placeholder="Enter 6-digit code"
          required
          maxlength="6"
          pattern="[0-9]{6}"
          inputmode="numeric"
          autocomplete="one-time-code"
        />
        <button type="submit">Verify</button>
      </form>
      <a class="resend-link" href="#" id="resend2fa">Resend Code</a>
      <button
        onclick="window.location.href='/admin_login'"
        type="button"
        style="margin-top: 1em; background: #6c757d"
      >
        Back to Login
      </button>
    </div>

    <!-- Spinner Modal -->
    <div
      class="modal fade"
      id="loadingSpinnerModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div
          class="modal-content d-flex justify-content-center align-items-center p-4"
          style="min-height: 150px"
        >
          <div class="text-center">
            <div
              class="spinner-border text-primary"
              role="status"
              style="width: 3rem; height: 3rem"
            ></div>
            <div class="mt-3">Please wait...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Closable Message Modal -->
    <div
      class="modal fade"
      id="messageModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="messageModalTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalTitle">Message</h5>
          </div>
          <div class="modal-body" id="messageModalBody">
            <!-- Message inserted by script -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" data-dismiss="modal">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Non‑Closable Redirect Modal -->
    <div
      class="modal fade"
      id="redirectModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center p-4">
          <div class="modal-body" id="redirectModalBody">Redirecting...</div>
        </div>
      </div>
    </div>

    <!-- 1. jQuery v3.x -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- 2. Popper.js (for Bootstrap 4) -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- 3. Bootstrap 4 JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- Script for displaying loading,success and error modals (Start) -->
    <script>
      // Show spinner
      function showSpinner() {
        $("#loadingSpinnerModal").appendTo("body").modal("show");
      }
      // Hide spinner
      function hideSpinner() {
        $("#loadingSpinnerModal").modal("hide");
      }

      // Regular message (closable) — OK, Warning, or Error
      function showMessage(type, message, onHide) {
        // type: 'Success' or 'Error'
        $("#messageModalTitle").text(type);
        $("#messageModalBody").text(message);
        $("#messageModal")
          .off("hidden.bs.modal")
          .on("hidden.bs.modal", function () {
            if (typeof onHide === "function") onHide();
          })
          .modal("show");
      }

      // Static success (non‑closable) + redirect
      function showRedirectMessage(message, redirectUrl) {
        $("#redirectModalBody").text(message);
        $("#redirectModal").appendTo("body").modal("show");

        // after a short pause (optional), navigate
        setTimeout(() => {
          window.location.replace(redirectUrl);
        }, 1000); // adjust delay as you like
      }
    </script>
    <!-- Script for displaying loading,success and error modals (End) -->

    <!-- Script for handling the 2FA verification and 2FA resend logic (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("twofaForm");
        const resendBtn = document.getElementById("resend2fa");

        // Handle form submission
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Inject token if missing
          if (!form.querySelector('input[name="token"]')) {
            const tokenInput = document.createElement("input");
            tokenInput.type = "hidden";
            tokenInput.name = "token";
            tokenInput.value = sessionStorage.getItem("adminToken");
            form.appendChild(tokenInput);
          }

          // Prepare body data
          const formData = new FormData(form);
          const body = new URLSearchParams();
          for (let [key, value] of formData.entries()) {
            body.append(key, value);
          }

          showSpinner();

          try {
            const response = await fetch(window.location.href, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: body.toString(),
            });

            hideSpinner();

            const result = await response.json().catch(() => ({}));

            if (
              response.ok &&
              (result.success || result.status === "success")
            ) {
              // Set token if returned
              const token =
                result.token || sessionStorage.getItem("adminToken");
              if (token) {
                sessionStorage.setItem("adminToken", token);
                document.cookie = `adminToken=${token}; path=/; secure; sameSite=Lax`;
              }

              // Show static success + redirect
              showRedirectMessage(
                result.message || "Verification successful! Redirecting...",
                result.redirect || "/dashboard"
              );
            } else {
              showMessage(
                "Error",
                result.error ||
                  result.message ||
                  "Invalid code. Please try again."
              );
            }
          } catch (err) {
            hideSpinner();
            showMessage(
              "Error",
              "Network error. Please check your connection."
            );
          }
        });

        // Handle "Resend Code" click
        resendBtn.addEventListener("click", async function (e) {
          e.preventDefault();
          const token = sessionStorage.getItem("adminToken");
          const csrf = document.querySelector(
            'input[name="csrf_token"]'
          )?.value;

          if (!token || !csrf) {
            showMessage("Error", "Missing authentication. Please login again.");
            return;
          }

          showSpinner();

          try {
            const res = await fetch("/resend-2fa-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({
                token,
                csrf_token: csrf,
              }),
            });

            hideSpinner();

            if (res.ok) {
              showMessage("Success", "Verification code resent successfully!");
            } else {
              showMessage("Error", "Failed to resend code. Please try again.");
            }
          } catch (err) {
            hideSpinner();
            showMessage(
              "Error",
              "Network error. Please check your connection."
            );
          }
        });
      });
    </script>
    <!-- Script for handling the 2FA verification and 2FA resend logic (End) -->
  </body>
</html>
