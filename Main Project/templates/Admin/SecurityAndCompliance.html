<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <style>
      /* Make .modal-body scrollable in Bootstrap 4.x */
      #editDocumentModal .modal-body {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
    </style>
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin stretch-card">
                <!-- ...existing card HTML... -->
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">- Compliance monitoring</h4>
                    <div class="card">
                      <div class="card-body">
                        <h4 class="card-title">Search compliance :</h4>
                        <div class="input-group mb-2">
                          <input
                            type="text"
                            class="form-control"
                            placeholder="Search Here..."
                            aria-label="search"
                            aria-describedby="search"
                            style="border: 1px solid black; color: black"
                            id="complianceSearchInput"
                          />
                          <div class="form-group">
                            <select
                              class="form-control"
                              id="complianceDateFilter"
                              style="max-width: 180px"
                            >
                              <option value="">All Dates</option>
                              <option value="today">Today</option>
                              <option value="yesterday">Yesterday</option>
                              <option value="last_week">Last Week</option>
                              <option value="last_month">Last Month</option>
                            </select>
                          </div>
                        </div>
                        <p class="card-description">
                          Search user by email, name, date, permission, etc..
                        </p>
                        <div
                          class="table-responsive"
                          style="max-height: 300px; overflow-y: auto"
                        >
                          <table class="table">
                            <thead>
                              <tr>
                                <th>Description</th>
                                <th>Compliance status</th>
                                <th>Date</th>
                                <th>Action</th>
                              </tr>
                            </thead>
                            <tbody id="compliancetable">
                              <!-- Table rows with <tr> will be rendered here -->
                            </tbody>
                          </table>
                        </div>
                        <div id="compliance-pagination-controls"></div>
                      </div>
                    </div>

                    <h4 class="card-title" style="margin-top: 10px">
                      - Incident logs
                    </h4>
                    <button class="btn btn-primary">Report new incident</button>
                    <h4 class="card-title" style="margin-top: 10px">
                      Search incident :
                    </h4>
                    <div class="input-group mb-2">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Search Here..."
                        aria-label="search"
                        aria-describedby="search"
                        style="border: 1px solid black; color: black"
                        id="incidentSearchInput"
                      />
                      <div class="form-group">
                        <select
                          class="form-control"
                          id="incidentDateFilter"
                          style="max-width: 180px"
                        >
                          <option value="">All Dates</option>
                          <option value="today">Today</option>
                          <option value="yesterday">Yesterday</option>
                          <option value="last_week">Last Week</option>
                          <option value="last_month">Last Month</option>
                        </select>
                      </div>
                    </div>
                    <p class="card-description">
                      Search user by email, name, date, permission, etc..
                    </p>
                    <div
                      class="table-responsive"
                      style="max-height: 300px; overflow-y: auto"
                    >
                      <table class="table">
                        <thead>
                          <tr>
                            <th>Incident Type</th>
                            <th>Description</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Reported At</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="incidentTableBody"></tbody>
                      </table>
                    </div>
                    <div id="incident-pagination-controls"></div>
                  </div>
                </div>
              </div>
              <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">ðŸ“„ Document Management</h4>
                    <button id="uploadDocumentBtn" class="btn btn-primary">
                      Upload Document
                    </button>
                    <button
                      class="btn btn-success"
                      data-toggle="modal"
                      data-target="#createCategoryModal"
                    >
                      Create New Document Category
                    </button>
                    <button
                      class="btn btn-danger"
                      onclick="openDeleteCategoryModal()"
                    >
                      Delete Document Category
                    </button>

                    <h4 class="card-title">Search Documents:</h4>
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Search Here..."
                        id="searchInput"
                        style="border: 1px solid black; color: black"
                      />
                    </div>
                    <p class="card-description">
                      Search by title, uploader, description, etc.
                    </p>

                    <div
                      class="table-responsive"
                      style="max-height: 300px; overflow-y: auto"
                    >
                      <table class="table">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Uploader</th>
                            <th>Upload Date</th>
                            <th>Version</th>
                            <th>Visibility</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="documentTableBody">
                          <!-- Document rows will be populated here -->
                        </tbody>
                      </table>
                    </div>
                    <div id="document-pagination-controls"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <footer class="footer">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                    >Copyright Â© bootstrapdash.com 2020</span
                  >
                  <span
                    class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                  >
                    Free
                    <a href="https://www.bootstrapdash.com/" target="_blank"
                      >Bootstrap dashboard templates</a
                    >
                    from Bootstrapdash.com</span
                  >
                </div>
              </div>
            </div>
          </footer>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteDocumentModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="deleteForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="modal-header">
              <h5 class="modal-title" id="deleteModalLabel">Delete Document</h5>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this document?</p>
              <input type="hidden" id="deleteDocumentId" />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-danger">Delete</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Create Category Modal (Bootstrap 4) -->
    <div
      class="modal fade"
      id="createCategoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="createCategoryLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="createCategoryForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="modal-header">
              <h5 class="modal-title" id="createCategoryLabel">
                Create New Category
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Category Name</label>
                <input type="text" class="form-control" name="name" required />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Create</button>
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Upload Document Modal -->
    <div
      class="modal fade"
      id="uploadModal"
      tabindex="-1"
      aria-labelledby="uploadModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <form
          class="modal-content"
          id="uploadForm"
          enctype="multipart/form-data"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="modal-header">
            <h5 class="modal-title" id="uploadModalLabel">Upload Document</h5>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Visibility</label>
              <select
                class="form-control"
                id="editVisibilityUpload"
                name="visibility_by_role_id"
                required
              >
                <option value="">-- Select an option --</option>
                <!-- Options will be populated via JS -->
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" name="title" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select
                name="category_id"
                id="categorySelect"
                class="form-control"
                required
              ></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Upload File</label>
              <input type="file" name="file" class="form-control" required />
            </div>
            <input type="hidden" name="uploaded_by" value="admin" />
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Upload</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Document Modal (Bootstrap 4) -->
    <div
      class="modal fade"
      id="editDocumentModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="editFormDocument">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit Document</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="editDocumentId" name="document_id" />
              <div class="mb-3">
                <label class="form-label">Visibility</label>
                <select
                  class="form-control"
                  id="editVisibility"
                  name="visibility_by_role_id"
                >
                  <!-- Options will be populated via JS -->
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="editTitle"
                  name="title"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="editDescription"
                  name="description"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Category</label>
                <select
                  class="form-control"
                  id="editCategory"
                  name="category_id"
                  required
                ></select>
              </div>
              <div class="mb-3">
                <label for="editNewFile">Replace Document File</label>
                <input
                  type="file"
                  class="form-control-file"
                  id="editNewFile"
                  name="editNewFile"
                />
                <small class="form-text text-muted"
                  >Leave empty to keep the current file.</small
                >
              </div>
              <div class="mb-3">
                <label class="form-label">Upload Date</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="editUploadDate"
                  name="upload_date"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Download Count</label>
                <input
                  type="number"
                  class="form-control"
                  id="editDownloadCount"
                  name="download_count"
                  min="0"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Version</label>
                <input
                  type="text"
                  class="form-control"
                  id="editVersion"
                  name="version"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Uploaded By Role</label>
                <input
                  type="text"
                  class="form-control"
                  id="editUploadedBy"
                  name="uploaded_by_role_id"
                  readonly
                />
                <!-- Options populated via JS -->
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Update</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Document History</h5>
            <button
              type="button"
              class="btn-close"
              data-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="historyError" class="text-danger mb-2"></div>
            <table class="table table-striped table-hover table-bordered">
              <thead>
                <tr>
                  <th>Version</th>
                  <th>Filename</th>
                  <th>Updated By</th>
                  <th>Updated At</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Incident Modal -->
    <div
      class="modal fade"
      id="editIncidentModal"
      tabindex="-1"
      aria-labelledby="editIncidentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editIncidentModalLabel">
              Edit Incident
            </h5>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-incident-id" />
            <div class="mb-3">
              <label for="edit-incident-type" class="form-label"
                >Incident Type</label
              >
              <select class="form-control" id="edit-incident-type">
                <option value="" disabled>-- Select Incident Type --</option>
                <option value="Security Breach">Security Breach</option>
                <option value="System Outage">System Outage</option>
                <option value="Data Leak">Data Leak</option>
                <option value="Unauthorized Access">Unauthorized Access</option>
                <option value="Policy Violation">Policy Violation</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-incident-description" class="form-label"
                >Description</label
              >
              <textarea
                class="form-control"
                id="edit-incident-description"
              ></textarea>
            </div>
            <div class="mb-3">
              <label for="edit-severity-level" class="form-label"
                >Severity Level</label
              >
              <select class="form-control" id="edit-severity-level">
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-incident-status" class="form-label"
                >Status</label
              >
              <select class="form-control" id="edit-incident-status">
                <option>Open</option>
                <option>In Progress</option>
                <option>Resolved</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-reported-at" class="form-label"
                >Reported At</label
              >
              <input type="date" class="form-control" id="edit-reported-at" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveEditedIncident()"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Incident Modal -->
    <div
      class="modal fade"
      id="deleteIncidentModal"
      tabindex="-1"
      aria-labelledby="deleteIncidentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteIncidentModalLabel">
              Delete Incident
            </h5>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this incident?</p>
            <input type="hidden" id="delete-incident-id" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDeleteIncident()"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Incident Modal -->
    <div
      class="modal fade"
      id="viewIncidentModal"
      tabindex="-1"
      aria-labelledby="viewIncidentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewIncidentModalLabel">
              Incident Details
            </h5>
          </div>
          <div class="modal-body">
            <p><strong>Type:</strong> <span id="view-incident-type"></span></p>
            <p>
              <strong>Description:</strong>
              <span id="view-incident-description"></span>
            </p>
            <p>
              <strong>Severity:</strong> <span id="view-severity-level"></span>
            </p>
            <p>
              <strong>Status:</strong> <span id="view-incident-status"></span>
            </p>
            <p>
              <strong>Reported At:</strong> <span id="view-reported-at"></span>
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for editing compliance -->
    <div
      class="modal fade"
      id="editComplianceModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Compliance</h5>
            <button
              type="button"
              class="close text-black"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <input type="hidden" id="edit-id" />
              <div class="mb-3">
                <label for="edit-status" class="form-label"
                  >Compliance Status</label
                >
                <select id="edit-status" class="form-control">
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="edit-last-reviewed" class="form-label"
                  >Last Reviewed</label
                >
                <input
                  type="date"
                  id="edit-last-reviewed"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-role" class="form-label">Role</label>
                <select id="edit-role" class="form-control" required>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
              <div class="mb-3">
                <label for="edit-details" class="form-label">Description</label>
                <textarea
                  id="edit-details"
                  class="form-control"
                  required
                ></textarea>
              </div>
              <button
                type="button"
                class="btn btn-primary"
                onclick="saveEdit()"
              >
                Save
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for deleting compliance -->
    <div
      class="modal fade"
      id="deleteComplianceModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button
              type="button"
              class="close text-black"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this record?</p>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDelete()"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View compliance details Modal -->
    <div
      class="modal fade"
      id="complianceModal"
      tabindex="-1"
      aria-labelledby="complianceModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="card border border-secondary p-3 rounded-3 bg-light">
            <div
              class="card-header text-center bg-warning text-white fw-bold fs-4 rounded-top"
            >
              Compliance Details
            </div>
            <div class="card-body">
              <div style="line-height: 1.6">
                <p><strong>Role:</strong> <span id="userRole"></span></p>
                <p><strong>Action:</strong> <span id="actionTaken"></span></p>
                <p><strong>Details:</strong> <span id="details"></span></p>
                <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
                <p><strong>Status:</strong> <span id="status"></span></p>
                <p
                  id="complianceMessage"
                  class="mt-2 text-muted fw-semibold"
                ></p>
              </div>
            </div>
            <div class="card-footer text-center">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Incident Report Modal -->
    <div
      class="modal fade"
      id="incident-modal"
      tabindex="-1"
      aria-labelledby="incidentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="incidentModalLabel">
              Report New Incident
            </h5>
          </div>
          <div class="modal-body">
            <form id="incident-form">
              <div class="mb-3">
                <label for="incident-type" class="form-label"
                  >Incident Type</label
                >
                <select class="form-control" id="incident-type" required>
                  <option value="">-- Select Incident Type --</option>
                  <option value="Security Breach">Security Breach</option>
                  <option value="System Outage">System Outage</option>
                  <option value="Data Leak">Data Leak</option>
                  <option value="Unauthorized Access">
                    Unauthorized Access
                  </option>
                  <option value="Policy Violation">Policy Violation</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="incident-description" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="incident-description"
                  rows="3"
                  required
                  placeholder="Describe the incident..."
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="severity-level" class="form-label"
                  >Severity Level</label
                >
                <select class="form-control" id="severity-level" required>
                  <option value="">-- Select Severity Level --</option>
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="incident-status" class="form-label">Status</label>
                <select class="form-control" id="incident-status" required>
                  <option value="Open">Open</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Resolved">Resolved</option>
                </select>
              </div>
              <button
                type="button"
                class="btn btn-primary"
                id="submit-incident"
              >
                Submit
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-success">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="successModalLabel">Success</h5>
          </div>
          <div class="modal-body" id="successModalMessage">
            <!-- Message will be injected here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              data-dismiss="modal"
              id="successModalOkBtn"
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div
      class="modal fade"
      id="errorModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="errorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-danger">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
          </div>
          <div class="modal-body" id="errorModalMessage">
            <!-- Message will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              Dismiss
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Category Modal -->
    <div
      class="modal fade"
      id="deleteCategoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteCategoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <form id="deleteCategoryForm">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="deleteCategoryModalLabel">
                Delete Category
              </h5>
              <button
                type="button"
                class="close text-white"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <label for="deleteCategorySelect"
                >Select Category to Delete:</label
              >
              <select
                class="form-control"
                id="deleteCategorySelect"
                name="category_id"
                required
              ></select>
              <small class="form-text text-muted mt-2"
                >Only unused categories can be deleted.</small
              >
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-danger">
                Delete Category
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteConfirmLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteConfirmLabel">
              Confirm Deletion
            </h5>
            <button
              type="button"
              class="close text-white"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="deleteConfirmText">
              Are you sure you want to delete this document?
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
              Delete
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Session Conflict Modal -->
    <div
      class="modal fade"
      id="sessionConflictModal"
      tabindex="-1"
      aria-labelledby="sessionConflictLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="sessionConflictLabel">
              Session Conflict
            </h5>
          </div>
          <div class="modal-body">
            <p>
              <strong
                >Someone has logged into your account from another tab or
                device.</strong
              >
            </p>
            <p>You will be logged out for security reasons.</p>
          </div>
          <div class="modal-footer justify-content-center">
            <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Logout</h5>
            <button type="button" class="close" id="closeLogoutModal">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to logout?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelLogout">
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmLogout">
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Access Denied Modal -->
    <div
      class="modal fade"
      id="accessDeniedModal"
      tabindex="-1"
      aria-labelledby="accessDeniedLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
          </div>
          <div class="modal-body">
            <p>Only Super Admins are allowed to access this page.</p>
          </div>
          <div class="modal-footer">
            <button id="redirectBtn" type="button" class="btn btn-danger">
              Go to Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Document History Modal -->
    <div
      class="modal fade"
      id="documentHistoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="documentHistoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="documentHistoryModalLabel">
              Document History
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <th>Version</th>
                  <th>Filename</th>
                  <th>Updated By</th>
                  <th>Updated At</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <!-- History rows go here -->
              </tbody>
            </table>
            <div id="historyError" class="text-danger"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner Modal -->
    <div
      class="modal fade"
      id="loadingSpinnerModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 bg-transparent shadow-none">
          <div class="modal-body text-center">
            <div
              class="spinner-border text-white"
              style="width: 4rem; height: 4rem"
              role="status"
            >
              <span class="sr-only"></span>
            </div>
            <div class="mt-3 text-white font-weight-bold">Please wait...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 (works with your current jQuery + modal HTML) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <!-- container-scroller -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- Custom js for this page-->
    <script src="../../static/Admin/js/file-upload.js"></script>
    <!-- End custom js for this page-->
    <!-- plugin js for this page -->
    <script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>
    <!-- End plugin js for this page -->

    <!-- Script for spinner logic and displaying success and error (Start) -->
    <script>
      window.ModalUtils = (function () {
        let spinnerVisible = false;

        function showSpinner() {
          if (spinnerVisible) return;
          spinnerVisible = true;
          $("#loadingSpinnerModal").modal({
            backdrop: "static",
            keyboard: false,
            show: true,
          });
        }

        function hideSpinner() {
          spinnerVisible = false;
          $("#loadingSpinnerModal").modal("hide");
        }

        function showSuccess(message, onClose) {
          $("#successModalMessage").html(message);
          $("#successModal").modal("show");
          $("#successModal").off("hidden.bs.modal");
          if (typeof onClose === "function") {
            const handler = function () {
              $("#successModal").off("hidden.bs.modal", handler);
              onClose();
            };
            $("#successModal").on("hidden.bs.modal", handler);
          }
        }

        function showerror(message, onClose) {
          $("#errorModalMessage").html(message);
          $("#errorModal").modal("show");
          $("#errorModal").off("hidden.bs.modal");
          if (typeof onClose === "function") {
            const handler = function () {
              $("#errorModal").off("hidden.bs.modal", handler);
              onClose();
            };
            $("#errorModal").on("hidden.bs.modal", handler);
          }
        }

        function hideSuccess() {
          $("#successModal").modal("hide");
        }
        function hideError() {
          $("#errorModal").modal("hide");
        }

        return {
          showSpinner,
          hideSpinner,
          showSuccess,
          showerror,
          hideSuccess,
          hideError,
        };
      })();
    </script>
    <!-- Script for spinner logic and displaying success and error (End) -->

    <!-- Script for handling documents table (Start) -->
    <script>
      // Disable all modal JavaScript temporarily to prevent conflicts
      let modalsDisabled = false;

      function loadVisibilityOptions() {
        const uploadSelect = document.getElementById("editVisibilityUpload");
        const editSelect = document.getElementById("editVisibility");

        function populateSelect(selectElement) {
          if (!selectElement) return;
          selectElement.innerHTML = "";

          // Add "All Roles" option first
          const allOption = document.createElement("option");
          allOption.value = "all";
          allOption.textContent = "All Roles";
          selectElement.appendChild(allOption);

          // Add placeholder option
          const placeholderOption = document.createElement("option");
          placeholderOption.value = "";
          placeholderOption.textContent = "-- Select an option --";
          placeholderOption.disabled = true;
          placeholderOption.selected = true;
          selectElement.appendChild(placeholderOption);
        }

        populateSelect(uploadSelect);
        populateSelect(editSelect);

        fetch("/get_roles", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            if (!res.ok) throw new Error(`Roles API returned ${res.status}`);
            return res.json();
          })
          .then((data) => {
            let roles = data;
            if (data.roles) roles = data.roles;
            else if (data.data) roles = data.data;

            if (!Array.isArray(roles)) throw new Error("Invalid roles format");

            roles.forEach((role) => {
              const option = document.createElement("option");
              option.value = `${role.role_id}`;
              option.textContent = role.role_name;

              if (uploadSelect)
                uploadSelect.appendChild(option.cloneNode(true));
              if (editSelect) editSelect.appendChild(option.cloneNode(true));
            });
          })
          .catch((err) => {
            console.warn("Failed to load roles:", err);
            // Improved error handling - show user-friendly message
            if (uploadSelect) {
              const errorOption = document.createElement("option");
              errorOption.value = "";
              errorOption.textContent = "Error loading roles";
              errorOption.disabled = true;
              uploadSelect.appendChild(errorOption);
            }
          });
      }

      const token = sessionStorage.getItem("adminToken");

      function downloadDocument(documentId) {
        ModalUtils.showSpinner();
        fetch(`/api/documents/${documentId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => {
            // Improved error handling
            if (!response.ok) {
              return response
                .json()
                .then((data) => {
                  throw new Error(
                    data.message ||
                      data.error ||
                      `Download failed (${response.status})`
                  );
                })
                .catch(() => {
                  throw new Error(`Download failed (${response.status})`);
                });
            }

            const contentDisposition = response.headers.get(
              "content-disposition"
            );
            let filename = "download";
            if (contentDisposition) {
              const match = contentDisposition.match(/filename="(.+)"/);
              if (match) filename = match[1];
            }
            return response.blob().then((blob) => ({ blob, filename }));
          })
          .then(({ blob, filename }) => {
            ModalUtils.hideSpinner();
            // Download the file
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Show a success modal after download triggers
            ModalUtils.showSuccess(
              "Document download started: " + filename,
              () => window.location.reload()
            );
          })
          .catch((error) => {
            ModalUtils.hideSpinner();
            console.error("Download error:", error);
            ModalUtils.showerror(
              "Failed to download document: " + error.message
            );
          });
      }

      let categoriesCache = [];

      function loadCategories() {
        if (categoriesCache.length > 0) {
          populateCategorySelect(categoriesCache);
          return;
        }

        fetch("/api/document_categories", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            if (!res.ok)
              throw new Error(`Categories API returned ${res.status}`);
            return res.json();
          })
          .then((categories) => {
            if (categories && categories.error) {
              ModalUtils.showerror(
                "Failed to load categories: " + categories.error
              );
              return;
            }
            categoriesCache = categories;
            populateCategorySelect(categories);
          })
          .catch((err) => {
            console.error("Failed to load categories:", err);
            ModalUtils.showerror("Failed to load categories: " + err.message);
          });
      }

      function populateCategorySelect(categories) {
        if (!Array.isArray(categories)) {
          console.error(
            "populateCategorySelect: categories is not an array",
            categories
          );
          ModalUtils.showerror(
            "Failed to load categories: invalid data format."
          );
          return;
        }

        const categorySelect = document.getElementById("categorySelect");
        const editCategorySelect = document.getElementById("editCategory");

        if (categorySelect) {
          categorySelect.innerHTML = "";
          // Add placeholder option for upload
          const placeholderOption = document.createElement("option");
          placeholderOption.value = "";
          placeholderOption.textContent = "-- Select a category --";
          placeholderOption.disabled = true;
          placeholderOption.selected = true;
          categorySelect.appendChild(placeholderOption);

          categories.forEach((cat) => {
            // CHANGED: Use 'id' and 'name' property as returned by /api/document_categories
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.name;
            categorySelect.appendChild(option);
          });
        }

        if (editCategorySelect) {
          editCategorySelect.innerHTML = "";
          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.name;
            editCategorySelect.appendChild(option);
          });
        }
      }

      function showDocumentHistory(documentId) {
        // Clear previous data and show loader
        document.getElementById("historyTableBody").innerHTML = "";
        document.getElementById("historyError").textContent = "";

        // Show spinner first and only open the modal after spinner is hidden
        ModalUtils.showSpinner();

        fetch(`/api/documents/${documentId}/history`, {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            // Improved error handling
            if (!res.ok) {
              return res
                .json()
                .then((data) => {
                  throw new Error(
                    data.message ||
                      data.error ||
                      `History API returned ${res.status}`
                  );
                })
                .catch(() => {
                  throw new Error(`History API returned ${res.status}`);
                });
            }
            return res.json();
          })
          .then((data) => {
            ModalUtils.hideSpinner();

            // Wait for the spinner modal to be fully hidden before opening history modal
            $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
              // Error in API or not an array
              if (!Array.isArray(data)) {
                const errorMsg = data.error || "No history found.";
                document.getElementById("historyError").textContent = errorMsg;
                ModalUtils.showerror(errorMsg);
                // Optionally open the modal to show the error
                $("#historyModal").modal("show");
                return;
              }

              // No history entries
              if (data.length === 0) {
                document.getElementById("historyTableBody").innerHTML =
                  "<tr><td colspan='5' class='text-center'>No history found.</td></tr>";
                $("#historyModal").modal("show");
                return;
              }

              // Populate the table with Bootstrap's text-break to prevent overflow
              const rows = data
                .map(
                  (h) =>
                    `<tr>
            <td class="text-break">${h.version || "N/A"}</td>
            <td class="text-break">${h.filename || "N/A"}</td>
            <td class="text-break">${h.updated_by || "N/A"}</td>
            <td class="text-break">${h.updated_at || "N/A"}</td>
            <td>
              ${
                h.file_path
                  ? `<a class="btn btn-sm btn-secondary" href="${h.file_path}" target="_blank" download>Download</a>`
                  : '<span class="text-muted">No file</span>'
              }
            </td>
          </tr>`
                )
                .join("");
              document.getElementById("historyTableBody").innerHTML = rows;
              $("#historyModal").modal("show");
            });
          })
          .catch((err) => {
            ModalUtils.hideSpinner();
            $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
              const errorMsg = "Error loading history: " + err.message;
              document.getElementById("historyError").textContent = errorMsg;
              ModalUtils.showerror(errorMsg);
              // Optionally open the modal to show the error
              $("#historyModal").modal("show");
            });
          });
      }

      // --- Pagination constants and state ---
      const DOCUMENT_PAGE_SIZE = 40;
      let documentCurrentPage = 1;
      let documentDataCache = [];

      // --- Smart pagination control renderer ---
      function renderDocumentPaginationControls(totalPages) {
        const container = document.getElementById(
          "document-pagination-controls"
        );
        if (!container) return;
        container.innerHTML = "";
        if (totalPages <= 1) {
          container.style.display = "none";
          return;
        }
        container.style.display = "flex";
        const windowSize = 2;

        function createBtn(label, page, disabled = false, active = false) {
          const btn = document.createElement("button");
          btn.className =
            "btn btn-sm mx-1 " +
            (active ? "btn-primary" : "btn-outline-primary");
          btn.textContent = label;
          btn.disabled = disabled;
          if (!disabled && !active) {
            btn.onclick = function () {
              documentCurrentPage = page;
              renderDocumentTable(documentDataCache);
            };
          }
          return btn;
        }

        // Prev
        container.appendChild(
          createBtn("Prev", documentCurrentPage - 1, documentCurrentPage === 1)
        );
        // Always show first page
        container.appendChild(
          createBtn("1", 1, false, documentCurrentPage === 1)
        );

        // Left ellipsis
        if (documentCurrentPage - windowSize > 2) {
          const span = document.createElement("span");
          span.className = "mx-1";
          span.textContent = "...";
          container.appendChild(span);
        }

        // Page window
        for (
          let i = Math.max(2, documentCurrentPage - windowSize);
          i <= Math.min(totalPages - 1, documentCurrentPage + windowSize);
          i++
        ) {
          container.appendChild(
            createBtn(i, i, false, documentCurrentPage === i)
          );
        }

        // Right ellipsis
        if (documentCurrentPage + windowSize < totalPages - 1) {
          const span = document.createElement("span");
          span.className = "mx-1";
          span.textContent = "...";
          container.appendChild(span);
        }

        // Always show last page (if not already in window)
        if (totalPages > 1)
          container.appendChild(
            createBtn(
              totalPages,
              totalPages,
              false,
              documentCurrentPage === totalPages
            )
          );

        // Next
        container.appendChild(
          createBtn(
            "Next",
            documentCurrentPage + 1,
            documentCurrentPage === totalPages
          )
        );
      }

      // --- Paginated table renderer ---
      function renderDocumentTable(data) {
        const tbody = document.getElementById("documentTableBody");
        if (!tbody) return;
        documentDataCache = data; // Always keep the latest source
        tbody.innerHTML = "";

        // Error or empty
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = "<tr><td colspan='7'>No documents found.</td></tr>";
          renderDocumentPaginationControls(0);
          return;
        }

        const totalPages = Math.ceil(data.length / DOCUMENT_PAGE_SIZE);
        if (documentCurrentPage > totalPages) documentCurrentPage = totalPages;
        if (documentCurrentPage < 1) documentCurrentPage = 1;
        const startIdx = (documentCurrentPage - 1) * DOCUMENT_PAGE_SIZE;
        const endIdx = startIdx + DOCUMENT_PAGE_SIZE;
        const pagedList = data.slice(startIdx, endIdx);

        pagedList.forEach((doc) => {
          // Improved string escaping
          const safeFilePath = (doc.file_path || "")
            .replace(/\\/g, "\\\\")
            .replace(/'/g, "\\'");
          const description = (doc.description || "")
            .replace(/'/g, "&apos;")
            .replace(/"/g, "&quot;");
          const title = (doc.title || "")
            .replace(/'/g, "&apos;")
            .replace(/"/g, "&quot;");

          const row = document.createElement("tr");
          row.innerHTML = `
<td>${doc.document_id}</td>
<td>${doc.title || "Untitled"}</td>
<td>${doc.uploaded_by || "Unknown"}</td>
<td>${doc.upload_date || "Unknown"}</td>
<td>${doc.version || "1"}</td>
<td>${doc.role_name || "Unknown"}</td>
<td>
  <button class="btn btn-sm btn-primary"
    onclick="openEditModalDocument(
      ${doc.document_id},
      '${title}',
      '${description}',
      ${doc.category_id || 0},
      ${doc.visibility_by_role_id || 0}, 
      '${(doc.filename || "").replace(/'/g, "\\'")}', 
      '${safeFilePath}', 
      '${doc.upload_date || ""}', 
      ${doc.download_count || 0}, 
      '${doc.version || "1"}', 
      ${doc.uploaded_by_role_id || 0},
      '${doc.role_name || "Unknown"}'
    )">
    Edit
  </button>
  <button class="btn btn-sm btn-danger" onclick="deleteDocument(${
    doc.document_id
  }, '${title}')">Delete</button>
  <button class="btn btn-sm btn-success" onclick="downloadDocument(${
    doc.document_id
  })">Download</button>
  <button class="btn btn-sm btn-info" onclick="showDocumentHistory(${
    doc.document_id
  })">History</button>
</td>
`;
          tbody.appendChild(row);
        });

        renderDocumentPaginationControls(totalPages);
      }

      // --- Updated fetchDocuments to use paginated rendering ---
      function fetchDocuments() {
        ModalUtils.showSpinner();
        fetch("/api/documents", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            if (!res.ok)
              throw new Error(`Documents API returned ${res.status}`);
            return res.json();
          })
          .then((data) => {
            ModalUtils.hideSpinner();
            // If your API returns { error: ... }
            if (data && data.error) {
              renderDocumentTable([]); // Will show error/empty row
              const tbody = document.getElementById("documentTableBody");
              if (tbody)
                tbody.innerHTML = `<tr><td colspan="7">Error: ${data.error}</td></tr>`;
              return;
            }
            // Defensive: Only process if data is an array
            if (!Array.isArray(data) || data.length === 0) {
              renderDocumentTable([]);
              return;
            }
            documentCurrentPage = 1; // reset to first page
            renderDocumentTable(data);
          })
          .catch((err) => {
            ModalUtils.hideSpinner();
            console.error("Failed to fetch documents:", err);
            ModalUtils.showerror("Failed to load documents: " + err.message);
            renderDocumentTable([]);
          });
      }

      function formatDateForInputDocument(dateString) {
        try {
          // Handle null, undefined, or empty strings
          if (!dateString) return "";

          console.log("Processing date string:", dateString);

          let date;

          // If it's already a Date object, use it directly
          if (dateString instanceof Date) {
            date = dateString;
          } else {
            // Handle PostgreSQL timestamp format: "2025-05-24 19:03:03.550326"
            let normalizedDateString = dateString.toString().trim();

            // If it contains microseconds, truncate them to milliseconds for JavaScript compatibility
            if (normalizedDateString.includes(".")) {
              const parts = normalizedDateString.split(".");
              if (parts[1] && parts[1].length > 3) {
                // Keep only first 3 digits (milliseconds) and remove microseconds
                normalizedDateString =
                  parts[0] + "." + parts[1].substring(0, 3);
              }
            }

            // Replace space with 'T' to make it ISO format compatible
            normalizedDateString = normalizedDateString.replace(" ", "T");

            console.log("Normalized date string:", normalizedDateString);

            date = new Date(normalizedDateString);
          }

          // Check if date is valid
          if (isNaN(date.getTime())) {
            console.warn("Invalid date created from:", dateString);
            return "";
          }

          console.log("Created date object:", date);

          // Helper function to pad numbers with leading zero
          const pad = (n) => n.toString().padStart(2, "0");

          // Extract date components in local timezone
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          const hours = pad(date.getHours());
          const minutes = pad(date.getMinutes());

          const result = `${year}-${month}-${day}T${hours}:${minutes}`;
          console.log("Final formatted result:", result);

          // Return in format required by datetime-local input: YYYY-MM-DDTHH:MM
          return result;
        } catch (error) {
          console.error("Error formatting date:", error, "Input:", dateString);
          return "";
        }
      }

      // Alternative function if you need to handle UTC dates specifically
      function formatUTCDateForInputDocument(dateString) {
        try {
          if (!dateString) return "";

          const date = new Date(dateString);
          if (isNaN(date.getTime())) return "";

          const pad = (n) => n.toString().padStart(2, "0");

          // Use UTC methods to avoid timezone conversion
          const year = date.getUTCFullYear();
          const month = pad(date.getUTCMonth() + 1);
          const day = pad(date.getUTCDate());
          const hours = pad(date.getUTCHours());
          const minutes = pad(date.getUTCMinutes());

          return `${year}-${month}-${day}T${hours}:${minutes}`;
        } catch (error) {
          console.error("Error formatting UTC date:", error);
          return "";
        }
      }

      let originalDocumentValues = {};

      function openEditModalDocument(
        id,
        title,
        desc,
        categoryId,
        visibilityRoleId,
        filename,
        filePath,
        upload_date,
        download_count,
        version,
        uploadedByRoleId,
        role_name
      ) {
        // Store original values for comparison
        originalDocumentValues = {
          id: id,
          title: title,
          description: desc,
          category_id: categoryId,
          visibility_by_role_id: visibilityRoleId,
          filename: filename,
          file_path: filePath,
          upload_date: upload_date,
          download_count: download_count,
          version: version,
          uploaded_by_role_id: uploadedByRoleId,
          role_name: role_name,
        };

        document.getElementById("editDocumentId").value = id;
        document.getElementById("editTitle").value = title;
        document.getElementById("editDescription").value = desc;
        document.getElementById("editVisibility").value =
          visibilityRoleId || "";
        document.getElementById("editDownloadCount").value = download_count;
        document.getElementById("editVersion").value = version;

        const formattedDate = formatDateForInputDocument(upload_date);
        document.getElementById("editUploadDate").value = formattedDate;

        // Role (read-only display) - improved formatting
        document.getElementById(
          "editUploadedBy"
        ).value = `${role_name} (ID: ${uploadedByRoleId})`;

        // Reset file input
        document.getElementById("editNewFile").value = "";

        // Load categories dynamically
        const categorySelect = document.getElementById("editCategory");
        categorySelect.innerHTML = "";
        ModalUtils.showSpinner();
        fetch("/api/document_categories", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            if (!res.ok)
              throw new Error(`Categories API returned ${res.status}`);
            return res.json();
          })
          .then((categories) => {
            ModalUtils.hideSpinner();
            if (!Array.isArray(categories)) {
              ModalUtils.showerror(
                "Failed to load categories: invalid data format."
              );
              return;
            }
            categories.forEach((cat) => {
              const option = document.createElement("option");
              // Use cat.category_id if present, otherwise fallback to cat.id for flexibility
              option.value =
                typeof cat.category_id !== "undefined"
                  ? cat.category_id
                  : cat.id;
              option.textContent = cat.name;
              if (
                (typeof cat.category_id !== "undefined"
                  ? cat.category_id
                  : cat.id) == categoryId
              )
                option.selected = true;
              categorySelect.appendChild(option);
            });

            $("#editDocumentModal").modal("show");
          })
          .catch((err) => {
            ModalUtils.hideSpinner();
            console.error("Failed to load categories:", err);
            ModalUtils.showerror("Failed to load categories: " + err.message);
          });
      }

      let pendingDeleteId = null;
      let pendingDeleteTitle = null;

      function deleteDocument(id, title) {
        pendingDeleteId = id;
        pendingDeleteTitle = title;

        document.getElementById(
          "deleteConfirmText"
        ).textContent = `Are you sure you want to delete the document: "${title}"?`;

        $("#deleteConfirmModal").modal("show");
      }

      document
        .getElementById("confirmDeleteBtn")
        .addEventListener("click", function () {
          if (!pendingDeleteId) return;
          ModalUtils.showSpinner();
          fetch(`/api/documents/${pendingDeleteId}/delete`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((res) => {
              if (!res.ok) {
                // parse error message and throw error
                return res.json().then((data) => {
                  throw new Error(data.error || "Failed to delete document.");
                });
              }
              return res.json();
            })
            .then((response) => {
              ModalUtils.hideSpinner();
              $("#deleteConfirmModal").modal("hide");
              ModalUtils.showSuccess(
                response.message || "Document deleted successfully.",
                fetchDocuments,
                () => window.location.reload()
              );
            })
            .catch((err) => {
              ModalUtils.hideSpinner();
              $("#deleteConfirmModal").modal("hide");
              ModalUtils.showerror("Failed to delete document: " + err.message);
            })
            .finally(() => {
              pendingDeleteId = null;
              pendingDeleteTitle = null;
            });
        });

      // Initialize form handlers with error protection
      // Initialize form handlers with error protection and modal debugging
      function initializeFormHandlers() {
        console.debug("[ModalFlow] Initializing form handlers...");

        const uploadBtn = document.getElementById("uploadDocumentBtn");
        if (uploadBtn) {
          uploadBtn.addEventListener("click", () => {
            console.debug(
              "[ModalFlow] uploadDocumentBtn clicked, showing #uploadModal"
            );
            $("#uploadModal").modal("show");
          });
        }
        try {
          const createCategoryForm =
            document.getElementById("createCategoryForm");
          if (createCategoryForm) {
            createCategoryForm.addEventListener("submit", function (e) {
              e.preventDefault();
              const name = this.name.value.trim();
              if (!name) {
                console.debug(
                  "[ModalFlow] createCategoryForm: empty name, showing error modal"
                );
                ModalUtils.showerror("Category name cannot be empty.");
                return;
              }

              console.debug("[ModalFlow] createCategoryForm: showing spinner");
              ModalUtils.showSpinner();

              fetch("/api/categories", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ name }),
              })
                .then((res) => {
                  if (!res.ok)
                    throw new Error(`Categories API returned ${res.status}`);
                  return res.json();
                })
                .then((response) => {
                  console.debug(
                    "[ModalFlow] createCategoryForm: fetch complete, hiding spinner"
                  );
                  ModalUtils.hideSpinner();
                  $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
                    console.debug(
                      "[ModalFlow] createCategoryForm: spinner hidden"
                    );
                    if (response.message) {
                      console.debug(
                        "[ModalFlow] createCategoryForm: success, hiding #createCategoryModal and showing success modal"
                      );
                      $("#createCategoryModal").modal("hide");
                      createCategoryForm.reset();
                      ModalUtils.showSuccess(response.message, () => {
                        refreshCategoriesAfterCreate();
                        window.location.reload();
                      });
                    } else if (response.error) {
                      console.debug(
                        "[ModalFlow] createCategoryForm: error, showing error modal"
                      );
                      ModalUtils.showerror("Error: " + response.error);
                    }
                  });
                })
                .catch((err) => {
                  console.debug(
                    "[ModalFlow] createCategoryForm: fetch error, hiding spinner"
                  );
                  ModalUtils.hideSpinner();
                  $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
                    console.debug(
                      "[ModalFlow] createCategoryForm: spinner hidden after error, showing error modal"
                    );
                    ModalUtils.showerror(
                      "Failed to create category: " + err.message
                    );
                  });
                });
            });
          }

          const uploadForm = document.getElementById("uploadForm");
          if (uploadForm) {
            uploadForm.addEventListener("submit", function (e) {
              e.preventDefault();
              const submitButton = this.querySelector('button[type="submit"]');
              const originalText = submitButton.textContent;
              submitButton.disabled = true;
              submitButton.textContent = "Uploading...";

              console.debug("[ModalFlow] uploadForm: showing spinner");
              ModalUtils.showSpinner();

              const formData = new FormData(this);

              fetch("/api/documents/upload", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              })
                .then((res) => {
                  if (!res.ok)
                    throw new Error(`Upload API returned ${res.status}`);
                  return res.json();
                })
                .then((response) => {
                  console.debug(
                    "[ModalFlow] uploadForm: fetch complete, hiding spinner"
                  );
                  ModalUtils.hideSpinner();
                  $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
                    console.debug("[ModalFlow] uploadForm: spinner hidden");
                    if (response.message || response.success) {
                      console.debug(
                        "[ModalFlow] uploadForm: success, hiding #uploadModal and showing success modal"
                      );
                      $("#uploadModal").modal("hide");
                      uploadForm.reset(); // Reset form
                      ModalUtils.showSuccess(
                        response.message || "Document uploaded successfully!",
                        fetchDocuments,
                        () => {
                          console.debug(
                            "[ModalFlow] uploadForm: page reload after success"
                          );
                          window.location.reload();
                        }
                      );
                    } else if (response.error) {
                      console.debug(
                        "[ModalFlow] uploadForm: error, showing error modal"
                      );
                      ModalUtils.showerror(response.error);
                    }
                  });
                })
                .catch((err) => {
                  console.debug(
                    "[ModalFlow] uploadForm: fetch error, hiding spinner"
                  );
                  ModalUtils.hideSpinner();
                  $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
                    console.debug(
                      "[ModalFlow] uploadForm: spinner hidden after error, showing error modal"
                    );
                    ModalUtils.showerror("Upload failed: " + err.message);
                  });
                })
                .finally(() => {
                  submitButton.disabled = false;
                  submitButton.textContent = originalText;
                });
            });
          }

          const editFormDocument = document.getElementById("editFormDocument");
          if (editFormDocument) {
            editFormDocument.addEventListener("submit", function (e) {
              e.preventDefault();
              const id = document.getElementById("editDocumentId").value;

              const formData = new FormData();

              // Get current form values
              const currentValues = {
                title: document.getElementById("editTitle").value.trim(),
                description: document
                  .getElementById("editDescription")
                  .value.trim(),
                category_id: document.getElementById("editCategory").value,
                visibility: document.getElementById("editVisibility").value,
                upload_date: document.getElementById("editUploadDate").value,
                download_count:
                  document.getElementById("editDownloadCount").value,
                version: document.getElementById("editVersion").value.trim(),
              };

              // Only append fields that have changed or are not empty
              if (currentValues.title !== originalDocumentValues.title) {
                formData.append("title", currentValues.title);
              }
              if (
                currentValues.description !== originalDocumentValues.description
              ) {
                formData.append("description", currentValues.description);
              }
              if (
                parseInt(currentValues.category_id) !==
                originalDocumentValues.category_id
              ) {
                formData.append("category_id", currentValues.category_id);
              }
              if (
                parseInt(currentValues.visibility) !==
                originalDocumentValues.visibility_by_role_id
              ) {
                formData.append("visibility", currentValues.visibility);
              }
              if (
                currentValues.upload_date &&
                currentValues.upload_date !==
                  formatDateForInputDocument(originalDocumentValues.upload_date)
              ) {
                formData.append("upload_date", currentValues.upload_date);
              }
              if (
                parseInt(currentValues.download_count) !==
                originalDocumentValues.download_count
              ) {
                formData.append("download_count", currentValues.download_count);
              }
              if (currentValues.version !== originalDocumentValues.version) {
                formData.append("version", currentValues.version);
              }

              // Always check for file replacement
              const newFile = document.getElementById("editNewFile").files[0];
              if (newFile) {
                formData.append("editNewFile", newFile);
              }

              console.debug("[ModalFlow] editFormDocument: showing spinner");
              ModalUtils.showSpinner();
              fetch(`/api/documents/${id}/edit`, {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              })
                .then((res) => {
                  if (!res.ok)
                    throw new Error(`Edit API returned ${res.status}`);
                  return res.json();
                })
                .then((response) => {
                  console.debug(
                    "[ModalFlow] editFormDocument: fetch complete, hiding spinner"
                  );
                  ModalUtils.hideSpinner();
                  $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
                    console.debug(
                      "[ModalFlow] editFormDocument: spinner hidden"
                    );
                    if (response.message || response.success) {
                      console.debug(
                        "[ModalFlow] editFormDocument: success, showing success modal"
                      );
                      ModalUtils.showSuccess(
                        response.message || "Document updated successfully!",
                        () => {
                          console.debug(
                            "[ModalFlow] editFormDocument: success modal closed, hiding #editDocumentModal and refreshing documents"
                          );
                          $("#editDocumentModal").modal("hide");
                          fetchDocuments();
                        },
                        () => {
                          console.debug(
                            "[ModalFlow] editFormDocument: page reload after success"
                          );
                          window.location.reload();
                        }
                      );
                    } else if (response.error) {
                      console.debug(
                        "[ModalFlow] editFormDocument: error, showing error modal"
                      );
                      ModalUtils.showerror(
                        "Failed to update document: " + response.error
                      );
                    }
                  });
                })
                .catch((err) => {
                  console.debug(
                    "[ModalFlow] editFormDocument: fetch error, hiding spinner"
                  );
                  ModalUtils.hideSpinner();
                  $("#loadingSpinnerModal").one("hidden.bs.modal", function () {
                    console.error("Update error:", err);
                    ModalUtils.showerror(
                      "Failed to update document: " + err.message
                    );
                  });
                });
            });
          }

          const searchInput = document.getElementById("searchInput");
          if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener("input", function () {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(() => {
                const filter = this.value.toLowerCase().trim();

                if (!filter) {
                  // Show all documents if search is empty
                  renderDocumentTable(documentDataCache);
                  return;
                }

                // Filter cached data
                const filteredData = documentDataCache.filter(
                  (doc) =>
                    (doc.title || "").toLowerCase().includes(filter) ||
                    (doc.description || "").toLowerCase().includes(filter) ||
                    (doc.filename || "").toLowerCase().includes(filter) ||
                    (doc.role_name || "").toLowerCase().includes(filter) ||
                    (doc.uploaded_by || "").toLowerCase().includes(filter)
                );

                documentCurrentPage = 1; // Reset to first page
                renderDocumentTable(filteredData);
              }, 300); // Debounce search
            });
          }
        } catch (error) {
          console.error("[ModalFlow] Error initializing form handlers:", error);
        }
      }

      function openDeleteCategoryModal() {
        const select = document.getElementById("deleteCategorySelect");
        select.innerHTML = "";
        ModalUtils.showSpinner();

        // CHANGED: Use /api/document_categories for fetching categories
        fetch("/api/document_categories", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            if (!res.ok)
              throw new Error(`Categories API returned ${res.status}`);
            return res.json();
          })
          .then((categories) => {
            ModalUtils.hideSpinner();
            if (!Array.isArray(categories)) {
              ModalUtils.showerror(
                "Failed to load categories: invalid data format."
              );
              return;
            }
            categories.forEach((cat) => {
              const option = document.createElement("option");
              option.value = cat.id;
              option.textContent = cat.name;
              select.appendChild(option);
            });
            $("#deleteCategoryModal").modal("show");
          })
          .catch((err) => {
            ModalUtils.hideSpinner();
            ModalUtils.showerror("Failed to load categories: " + err.message);
          });
      }

      // When you create a category, also refresh categories using the new endpoint:
      function refreshCategoriesAfterCreate() {
        ModalUtils.showSpinner();
        fetch("/api/document_categories", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            if (!res.ok)
              throw new Error(`Categories API returned ${res.status}`);
            return res.json();
          })
          .then((categories) => {
            ModalUtils.hideSpinner();
            if (!Array.isArray(categories)) {
              ModalUtils.showerror(
                "Failed to reload categories after adding new: invalid data format."
              );
              return;
            }
            categoriesCache = categories;
            populateCategorySelect(categories);
          })
          .catch((err) => {
            ModalUtils.hideSpinner();
            console.error("Failed to reload categories:", err);
            ModalUtils.showerror(
              "Failed to reload categories after adding new: " + err.message
            );
          });
      }

      // Delete handler
      document
        .getElementById("deleteCategoryForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const categoryId = this.category_id.value;
          ModalUtils.showSpinner();

          fetch(`/api/categories/${categoryId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((res) => {
              if (!res.ok) throw new Error(`Delete API returned ${res.status}`);
              return res.json();
            })
            .then((response) => {
              ModalUtils.hideSpinner();
              if (response.message || response.success) {
                $("#deleteCategoryModal").modal("hide");
                ModalUtils.showSuccess(
                  response.message || "Category deleted successfully!",
                  () => {
                    refreshCategoriesAfterCreate();
                    window.location.reload();
                  }
                );
              } else if (response.error) {
                ModalUtils.showerror("Error: " + response.error);
              }
            })
            .catch((err) => {
              ModalUtils.hideSpinner();
              ModalUtils.showerror("Failed to delete category: " + err.message);
            });
        });

      // Initialize everything when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        // Add a small delay to let all libraries load
        setTimeout(() => {
          initializeFormHandlers();
          fetchDocuments();
          loadCategories();
          loadVisibilityOptions();
        }, 100);
      });
    </script>
    <!-- Script for handling documents table (End) -->

    <!-- Script for displaying compliance details,incident logs, search bar function to be able to search for specific compliance and for reporting new incident (Start) -->
    <script>
      let complianceDataCache = [];

      document.addEventListener("DOMContentLoaded", function () {
        // Compliance
        fetchComplianceData();
        const complianceSearchInput = document.getElementById(
          "complianceSearchInput"
        );
        const complianceDateFilter = document.getElementById(
          "complianceDateFilter"
        );
        complianceSearchInput.addEventListener(
          "input",
          clientSideComplianceSearch
        );
        if (complianceDateFilter) {
          complianceDateFilter.addEventListener(
            "change",
            clientSideComplianceSearch
          );
        }

        // Incidents
        fetchIncidentData();
        const incidentSearchInput = document.getElementById(
          "incidentSearchInput"
        );
        const incidentDateFilter =
          document.getElementById("incidentDateFilter");
        if (incidentSearchInput) {
          incidentSearchInput.addEventListener(
            "input",
            clientSideIncidentSearch
          );
        }
        if (incidentDateFilter) {
          incidentDateFilter.addEventListener(
            "change",
            clientSideIncidentSearch
          );
        }

        // Modal
        const primaryBtn = document.querySelector(".btn-primary");
        if (primaryBtn) {
          primaryBtn.addEventListener("click", function () {
            $("#incident-modal").modal("show");
          });
        }

        const submitIncident = document.getElementById("submit-incident");
        if (submitIncident) {
          submitIncident.addEventListener("click", function () {
            const incidentType = document.getElementById("incident-type").value;
            const description = document.getElementById(
              "incident-description"
            ).value;
            const severityLevel =
              document.getElementById("severity-level").value;
            const status = document.getElementById("incident-status").value;

            if (!incidentType || !description || !severityLevel || !status) {
              alert("Please fill in all fields before submitting.");
              return;
            }

            const token = sessionStorage.getItem("adminToken");
            const incidentData = {
              incident_type: incidentType,
              description: description,
              severity_level: severityLevel,
              status: status,
            };
            ModalUtils.showSpinner();
            fetch("/report-incident", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(incidentData),
            })
              .then((response) => response.json())
              .then((data) => {
                ModalUtils.hideSpinner();
                if (data.error) {
                  alert("Error: " + data.error);
                } else {
                  $("#incident-modal").modal("hide");
                  ModalUtils.showSuccess(
                    "Incident reported successfully!",
                    () => window.location.reload()
                  );
                  document.getElementById("incident-form").reset();
                  fetchIncidentData();
                  ModalUtils.hideSpinner();
                }
              })
              .catch((error) => {
                ModalUtils.hideSpinner();
                console.error("Error:", error);
              });
          });
        }
      });

      // Compliance
      function fetchComplianceData() {
        const token = sessionStorage.getItem("adminToken");
        fetch("/compliance", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((response) => response.json())
          .then((data) => {
            complianceDataCache = Array.isArray(data) ? data : [];
            clientSideComplianceSearch();
          })
          .catch((error) => {
            const tableBody = document.getElementById("compliancetable");
            tableBody.innerHTML = `<tr><td colspan="4">Error loading compliance data.</td></tr>`;
            console.error("Error fetching compliance data:", error);
          });
      }

      // --- Pagination constants and state ---
      const COMPLIANCE_PAGE_SIZE = 40;
      let complianceCurrentPage = 1;

      // --- Pagination control renderer ---
      function renderCompliancePaginationControls(totalPages) {
        const container = document.getElementById(
          "compliance-pagination-controls"
        );
        if (!container) return;
        container.innerHTML = "";
        if (totalPages <= 1) {
          container.style.display = "none";
          return;
        }
        container.style.display = "flex";
        const windowSize = 2; // how many pages left/right of current to show
        const createBtn = (label, page, disabled = false, active = false) => {
          const btn = document.createElement("button");
          btn.className =
            "btn btn-sm mx-1 " +
            (active ? "btn-primary" : "btn-outline-primary");
          btn.textContent = label;
          btn.disabled = disabled;
          if (!disabled && !active) {
            btn.onclick = function () {
              complianceCurrentPage = page;
              renderComplianceTable(complianceDataCache);
            };
          }
          return btn;
        };
        // Prev
        container.appendChild(
          createBtn(
            "Prev",
            complianceCurrentPage - 1,
            complianceCurrentPage === 1
          )
        );
        // Always show first page
        container.appendChild(
          createBtn("1", 1, false, complianceCurrentPage === 1)
        );
        // Left ellipsis
        if (complianceCurrentPage - windowSize > 2) {
          const span = document.createElement("span");
          span.className = "mx-1";
          span.textContent = "...";
          container.appendChild(span);
        }
        // Page window
        for (
          let i = Math.max(2, complianceCurrentPage - windowSize);
          i <= Math.min(totalPages - 1, complianceCurrentPage + windowSize);
          i++
        ) {
          container.appendChild(
            createBtn(i, i, false, complianceCurrentPage === i)
          );
        }
        // Right ellipsis
        if (complianceCurrentPage + windowSize < totalPages - 1) {
          const span = document.createElement("span");
          span.className = "mx-1";
          span.textContent = "...";
          container.appendChild(span);
        }
        // Always show last page (if not already in window)
        if (totalPages > 1)
          container.appendChild(
            createBtn(
              totalPages,
              totalPages,
              false,
              complianceCurrentPage === totalPages
            )
          );
        // Next
        container.appendChild(
          createBtn(
            "Next",
            complianceCurrentPage + 1,
            complianceCurrentPage === totalPages
          )
        );
      }
      // --- Paginated table renderer ---
      function renderComplianceTable(data) {
        const tableBody = document.getElementById("compliancetable");
        if (!tableBody) return;
        tableBody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="4">No compliance records found.</td></tr>`;
          renderCompliancePaginationControls(0);
          return;
        }

        const totalPages = Math.ceil(data.length / COMPLIANCE_PAGE_SIZE);
        if (complianceCurrentPage > totalPages)
          complianceCurrentPage = totalPages;
        if (complianceCurrentPage < 1) complianceCurrentPage = 1;
        const startIdx = (complianceCurrentPage - 1) * COMPLIANCE_PAGE_SIZE;
        const endIdx = startIdx + COMPLIANCE_PAGE_SIZE;
        const pagedList = data.slice(startIdx, endIdx);

        pagedList.forEach((row) => {
          tableBody.innerHTML += `
      <tr>
        <td>${row.details || ""}</td>
        <td>${row.status || ""}</td>
        <td>${formatComplianceDate(row.timestamp)}</td>
        <td>
          <button class="btn btn-info btn-sm" onclick="openViewComplianceModal(${
            row.id
          })">View</button>
          <button class="btn btn-success btn-sm" onclick="openEditComplianceModal(${
            row.id
          })">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="openDeleteComplianceModal(${
            row.id
          })">Delete</button>
        </td>
      </tr>
    `;
        });

        renderCompliancePaginationControls(totalPages);
      }

      // Robust formatting for compliance date (handles formats like "Mon, 21 Jul 2025 02:32:50 GM")
      function formatComplianceDate(dateStr) {
        if (!dateStr) return "";
        const d = parseAnyDate(dateStr);
        if (d && !isNaN(d.getTime())) {
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          return `${yyyy}-${mm}-${dd}`;
        }
        // fallback: try to extract YYYY-MM-DD from string
        const match = dateStr.match(/(\d{4}-\d{2}-\d{2})/);
        return match ? match[1] : dateStr;
      }

      function clientSideComplianceSearch() {
        const input = document
          .getElementById("complianceSearchInput")
          .value.trim()
          .toLowerCase();
        const dateFilterElem = document.getElementById("complianceDateFilter");
        const dateFilter = dateFilterElem ? dateFilterElem.value : "";

        let filtered = complianceDataCache.filter((row) => {
          let showRow = true;
          if (input) {
            const rowText = [
              row.details || "",
              row.status || "",
              formatComplianceDate(row.timestamp),
            ]
              .join(" ")
              .toLowerCase();
            if (!rowText.includes(input)) showRow = false;
          }

          if (showRow && dateFilter) {
            const dateObj = row.timestamp ? parseAnyDate(row.timestamp) : null;
            if (!checkDateMatchObj(dateObj, dateFilter)) showRow = false;
          }
          return showRow;
        });

        renderComplianceTable(filtered);
      }

      // Incidents
      function fetchIncidentData() {
        const token = sessionStorage.getItem("adminToken");
        fetch("/incidents", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((response) => response.json())
          .then((data) => {
            incidentDataCache = Array.isArray(data) ? data : [];
            clientSideIncidentSearch();
          })
          .catch((error) => {
            const tableBody = document.getElementById("incidentTableBody");
            tableBody.innerHTML = `<tr><td colspan="6">Error loading incidents.</td></tr>`;
            console.error("Error fetching incidents:", error);
          });
      }

      // --- Pagination constants and state ---
      const INCIDENT_PAGE_SIZE = 40;
      let incidentCurrentPage = 1;
      let incidentDataCache = [];

      // --- Smart pagination control renderer ---
      function renderIncidentPaginationControls(totalPages) {
        const container = document.getElementById(
          "incident-pagination-controls"
        );
        if (!container) return;
        container.innerHTML = "";
        if (totalPages <= 1) {
          container.style.display = "none";
          return;
        }
        container.style.display = "flex";
        const windowSize = 2; // Number of pages left/right of current to show

        function createBtn(label, page, disabled = false, active = false) {
          const btn = document.createElement("button");
          btn.className =
            "btn btn-sm mx-1 " +
            (active ? "btn-primary" : "btn-outline-primary");
          btn.textContent = label;
          btn.disabled = disabled;
          if (!disabled && !active) {
            btn.onclick = function () {
              incidentCurrentPage = page;
              renderIncidentTable(incidentDataCache);
            };
          }
          return btn;
        }

        // Prev
        container.appendChild(
          createBtn("Prev", incidentCurrentPage - 1, incidentCurrentPage === 1)
        );

        // Always show first page
        container.appendChild(
          createBtn("1", 1, false, incidentCurrentPage === 1)
        );

        // Left ellipsis
        if (incidentCurrentPage - windowSize > 2) {
          const span = document.createElement("span");
          span.className = "mx-1";
          span.textContent = "...";
          container.appendChild(span);
        }

        // Page window
        for (
          let i = Math.max(2, incidentCurrentPage - windowSize);
          i <= Math.min(totalPages - 1, incidentCurrentPage + windowSize);
          i++
        ) {
          container.appendChild(
            createBtn(i, i, false, incidentCurrentPage === i)
          );
        }

        // Right ellipsis
        if (incidentCurrentPage + windowSize < totalPages - 1) {
          const span = document.createElement("span");
          span.className = "mx-1";
          span.textContent = "...";
          container.appendChild(span);
        }

        // Always show last page (if not already in window)
        if (totalPages > 1)
          container.appendChild(
            createBtn(
              totalPages,
              totalPages,
              false,
              incidentCurrentPage === totalPages
            )
          );

        // Next
        container.appendChild(
          createBtn(
            "Next",
            incidentCurrentPage + 1,
            incidentCurrentPage === totalPages
          )
        );
      }

      // --- Updated renderIncidentTable with smart pagination ---
      function renderIncidentTable(data) {
        const tableBody = document.getElementById("incidentTableBody");
        if (!tableBody) return;
        incidentDataCache = data; // Always keep the latest source for pagination
        tableBody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML =
            "<tr><td colspan='6'>No matching incidents found</td></tr>";
          renderIncidentPaginationControls(0);
          return;
        }

        const totalPages = Math.ceil(data.length / INCIDENT_PAGE_SIZE);
        if (incidentCurrentPage > totalPages) incidentCurrentPage = totalPages;
        if (incidentCurrentPage < 1) incidentCurrentPage = 1;
        const startIdx = (incidentCurrentPage - 1) * INCIDENT_PAGE_SIZE;
        const endIdx = startIdx + INCIDENT_PAGE_SIZE;
        const pagedList = data.slice(startIdx, endIdx);

        pagedList.forEach((log) => {
          tableBody.innerHTML += `
      <tr>
        <td>${log.type || ""}</td>
        <td>${log.description || ""}</td>
        <td>${log.severity || ""}</td>
        <td>${log.status || ""}</td>
        <td>${formatIncidentDate(log.reported_at)}</td>
        <td>
          <button class="btn btn-success" onclick="openEditIncidentModal(${
            log.id
          })">Edit</button>
          <button class="btn btn-danger" onclick="openDeleteIncidentModal(${
            log.id
          })">Delete</button>
          <button class="btn btn-info" onclick="openViewIncidentModal(${
            log.id
          })">View</button>
        </td>
      </tr>`;
        });

        renderIncidentPaginationControls(totalPages);
      }

      function formatIncidentDate(dateStr) {
        if (!dateStr) return "";
        const d = parseAnyDate(dateStr);
        if (d && !isNaN(d.getTime())) {
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          return `${yyyy}-${mm}-${dd}`;
        }
        const match = dateStr.match(/(\d{4}-\d{2}-\d{2})/);
        return match ? match[1] : dateStr;
      }

      function clientSideIncidentSearch() {
        const input = document.getElementById("incidentSearchInput")
          ? document
              .getElementById("incidentSearchInput")
              .value.trim()
              .toLowerCase()
          : "";
        const dateFilterElem = document.getElementById("incidentDateFilter");
        const dateFilter = dateFilterElem ? dateFilterElem.value : "";

        let filtered = incidentDataCache.filter((log) => {
          let showRow = true;
          const rowText = [
            log.type || "",
            log.description || "",
            log.severity || "",
            log.status || "",
            formatIncidentDate(log.reported_at),
          ]
            .join(" ")
            .toLowerCase();

          if (input && !rowText.includes(input)) showRow = false;

          if (showRow && dateFilter) {
            let dateObj = log.reported_at
              ? parseAnyDate(log.reported_at)
              : null;
            if (!checkDateMatchObj(dateObj, dateFilter)) showRow = false;
          }
          return showRow;
        });

        renderIncidentTable(filtered);
      }

      // Robust Date parser for all formats, including "Mon, 21 Jul 2025 02:32:50 GM"
      function parseAnyDate(dateStr) {
        if (!dateStr) return null;
        let d = new Date(dateStr);
        if (!isNaN(d.getTime())) return d;
        const match = dateStr.match(/(\d{1,2}\s\w{3}\s\d{4})/);
        if (match) {
          d = new Date(match[1]);
          if (!isNaN(d.getTime())) return d;
        }
        const isomatch = dateStr.match(/(\d{4}-\d{2}-\d{2})/);
        if (isomatch) {
          d = new Date(isomatch[1]);
          if (!isNaN(d.getTime())) return d;
        }
        return null;
      }

      // Date filter helper for all date objects
      function checkDateMatchObj(date, filter) {
        if (!(date instanceof Date) || isNaN(date.getTime())) return false;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const target = new Date(date);
        target.setHours(0, 0, 0, 0);

        if (filter === "today") {
          return today.getTime() === target.getTime();
        }
        if (filter === "yesterday") {
          const yesterday = new Date(today);
          yesterday.setDate(today.getDate() - 1);
          return yesterday.getTime() === target.getTime();
        }
        if (filter === "last_week") {
          const start = new Date(today);
          start.setDate(today.getDate() - 7);
          return target >= start && target < today;
        }
        if (filter === "last_month") {
          const start = new Date(today);
          start.setDate(today.getDate() - 30);
          return target >= start && target < today;
        }
        return true;
      }
    </script>
    <!-- Script for displaying compliance details,incident logs, search bar function to be able to search for specific compliance and for reporting new incident (End) -->

    <!-- Script for handling edit, delete and viewing details of compliance table (Start) -->
    <script>
      function formatDateForInput(dateString) {
        if (!dateString) return "";
        let date = new Date(dateString);
        if (isNaN(date.getTime())) return "";
        return date.toISOString().split("T")[0];
      }

      function openEditComplianceModal(id) {
        ModalUtils.showSpinner();
        const token = sessionStorage.getItem("adminToken");
        Promise.all([
          fetch(`/view_compliance/${id}`, {
            headers: { Authorization: `Bearer ${token}` },
          }).then((res) => res.json()),
          fetch("/roles", {
            headers: { Authorization: `Bearer ${token}` },
          }).then((res) => res.json()),
        ])
          .then(([compliance, roles]) => {
            ModalUtils.hideSpinner();
            if (!compliance.audit_id) {
              ModalUtils.showError("Compliance record not found.");
              return;
            }
            document.getElementById("edit-id").value =
              compliance.audit_id || "";
            document.getElementById("edit-status").value =
              compliance.compliance_status || "Active";
            document.getElementById("edit-details").value =
              compliance.details || "";
            document.getElementById("edit-last-reviewed").value =
              formatDateForInput(compliance.timestamp);

            const roleSelect = document.getElementById("edit-role");
            roleSelect.innerHTML = "";
            roles.forEach((role) => {
              const option = document.createElement("option");
              option.value = role.role_id;
              option.textContent = role.role_name;
              if (role.role_name === compliance.role) option.selected = true;
              roleSelect.appendChild(option);
            });

            // Show the edit compliance modal after everything is loaded and populated
            $("#editComplianceModal").modal("show");
          })
          .catch(() => {
            ModalUtils.hideSpinner();
            ModalUtils.showError("Failed to load compliance or roles.");
          });
      }

      function openDeleteComplianceModal(id) {
        window.deleteId = id;
        // Show the delete compliance confirmation modal
        $("#deleteComplianceModal").modal("show");
      }

      function loadRoles(selectedRoleId = null) {
        ModalUtils.showSpinner();
        fetch("/roles", {
          headers: {
            Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
          },
        })
          .then((response) => response.json())
          .then((roles) => {
            ModalUtils.hideSpinner();
            const roleSelect = document.getElementById("edit-role");
            roleSelect.innerHTML = "";
            roles.forEach((role) => {
              const option = document.createElement("option");
              option.value = role.role_id;
              option.textContent = role.role_name;
              if (selectedRoleId && selectedRoleId == role.role_id)
                option.selected = true;
              roleSelect.appendChild(option);
            });
          })
          .catch(() => {
            ModalUtils.showerror("Error loading roles.");
          });
      }

      function openViewComplianceModal(id) {
        ModalUtils.showSpinner();
        fetch(`/view_compliance/${id}`, {
          headers: {
            Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            ModalUtils.hideSpinner();
            if (data.error) {
              ModalUtils.showError(data.error);
            } else {
              document.getElementById("userRole").textContent =
                data.role_name || "N/A";
              document.getElementById("actionTaken").textContent =
                data.action || "N/A";
              document.getElementById("details").textContent =
                data.details || "N/A";
              document.getElementById("timestamp").textContent =
                formatDateForInput(data.timestamp);
              document.getElementById("status").textContent =
                data.compliance_status || "N/A";

              const messageEl = document.getElementById("complianceMessage");
              if (data.compliance_status === "Active") {
                messageEl.textContent =
                  "This user has demonstrated full compliance with organizational policies.";
                messageEl.classList.remove("text-danger");
                messageEl.classList.add("text-success");
              } else if (data.compliance_status === "Inactive") {
                messageEl.textContent =
                  "This user has not adhered to the required compliance standards.";
                messageEl.classList.remove("text-success");
                messageEl.classList.add("text-danger");
              } else {
                messageEl.textContent = "";
                messageEl.classList.remove("text-danger", "text-success");
              }

              // Show the compliance modal after populating its contents
              $("#complianceModal").modal("show");
            }
          })
          .catch(() => {
            ModalUtils.hideSpinner();
            ModalUtils.showError("Failed to fetch compliance record.");
          });
      }

      function saveEdit() {
        const data = {
          id: document.getElementById("edit-id").value,
          status: document.getElementById("edit-status").value,
          timestamp: document.getElementById("edit-last-reviewed").value,
          role_id: document.getElementById("edit-role").value,
          details: document.getElementById("edit-details").value,
        };

        ModalUtils.showSpinner();
        fetch("/edit_compliance", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((responseData) => {
            if (responseData.error) {
              ModalUtils.showerror(
                responseData.error || "Failed to save changes."
              );
            } else {
              $("#editComplianceModal").modal("hide");
              ModalUtils.showSuccess(
                "Compliance record updated successfully!",
                () => window.location.reload()
              );
              ModalUtils.hideSpinner();
            }
          })
          .catch((error) => {
            ModalUtils.hideSpinner();
            ModalUtils.showerror("An unexpected error occurred while saving.");
          });
      }

      function confirmDelete() {
        $("#deleteComplianceModal").modal("hide");
        ModalUtils.showSpinner();
        fetch(`/delete_compliance/${window.deleteId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionStorage.getItem("adminToken")}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(
                  data.error || "Failed to delete compliance record."
                );
              });
            }
            ModalUtils.showSuccess(
              "Compliance record deleted successfully!",
              () => window.location.reload()
            );
            ModalUtils.hideSpinner();
          })
          .catch((error) => {
            ModalUtils.hideSpinner();
            ModalUtils.showerror(
              error.message || "An unexpected error occurred while deleting."
            );
          });
      }
    </script>
    <!-- Script for handling edit, delete and viewing details of compliance table (End) -->

    <!-- Script for handling edit, delete and viewing details of incident logs table (Start, spinner integrated) -->
    <script>
      function getAuthHeaders() {
        const token = sessionStorage.getItem("adminToken");
        return {
          "Content-Type": "application/json",
          Authorization: token ? `Bearer ${token}` : "",
        };
      }

      function openEditIncidentModal(id) {
        ModalUtils.showSpinner();
        fetch(`/view_incident/${id}`, {
          method: "GET",
          headers: getAuthHeaders(),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Failed to fetch incident data.");
            return response.json();
          })
          .then((data) => {
            document.getElementById("edit-incident-id").value =
              data.incident_id;
            document.getElementById("edit-incident-type").value =
              data.incident_type;
            document.getElementById("edit-incident-description").value =
              data.description;
            document.getElementById("edit-severity-level").value =
              data.severity_level;
            document.getElementById("edit-incident-status").value = data.status;
            document.getElementById("edit-reported-at").value =
              formatDateForInput(data.reported_at);

            ModalUtils.hideSpinner();
            // Show the edit modal after fields are populated
            $("#editIncidentModal").modal("show");
          })
          .catch((error) => {
            ModalUtils.hideSpinner();
            ModalUtils.showError(
              "Error fetching incident record: " + error.message
            );
          });
      }

      function saveEditedIncident() {
        const incidentData = {
          id: document.getElementById("edit-incident-id").value,
          type: document.getElementById("edit-incident-type").value,
          description: document.getElementById("edit-incident-description")
            .value,
          severity: document.getElementById("edit-severity-level").value,
          status: document.getElementById("edit-incident-status").value,
          reported_at: document.getElementById("edit-reported-at").value,
        };

        ModalUtils.showSpinner();
        fetch("/edit_incident", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(incidentData),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Failed to update incident.");
            return response.json();
          })
          .then((data) => {
            $("#editIncidentModal").modal("hide");
            ModalUtils.showSuccess(data.message, () =>
              window.location.reload()
            );
            ModalUtils.hideSpinner();
          })
          .catch((error) => {
            ModalUtils.showSpinner();
            ModalUtils.showerror("Error updating incident: " + error.message);
          });
      }

      function openDeleteIncidentModal(id) {
        // Set the incident ID in the hidden input field
        document.getElementById("delete-incident-id").value = id;
        // Show the delete confirmation modal
        $("#deleteIncidentModal").modal("show");
      }

      function confirmDeleteIncident() {
        const id = document.getElementById("delete-incident-id").value;
        ModalUtils.showSpinner();
        fetch(`/delete_incident/${id}`, {
          method: "DELETE",
          headers: getAuthHeaders(),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Failed to delete incident.");
            return response.json();
          })
          .then((data) => {
            $("#deleteIncidentModal").modal("hide");
            ModalUtils.showSuccess(data.message, () =>
              window.location.reload()
            );
            ModalUtils.hideSpinner();
          })
          .catch((error) => {
            ModalUtils.hideSpinner();
            ModalUtils.showerror("Error deleting incident: " + error.message);
          });
      }

      function openViewIncidentModal(id) {
        ModalUtils.showSpinner();
        fetch(`/view_incident/${id}`, {
          method: "GET",
          headers: getAuthHeaders(),
        })
          .then((response) => {
            if (!response.ok)
              throw new Error("Failed to fetch incident details.");
            return response.json();
          })
          .then((data) => {
            document.getElementById("view-incident-type").textContent =
              data.incident_type;
            document.getElementById("view-incident-description").textContent =
              data.description;
            document.getElementById("view-severity-level").textContent =
              data.severity_level;
            document.getElementById("view-incident-status").textContent =
              data.status;
            document.getElementById("view-reported-at").textContent =
              formatDateForInput(data.reported_at);

            ModalUtils.hideSpinner();
            // Show the modal after it has been populated
            $("#viewIncidentModal").modal("show");
          })
          .catch((error) => {
            ModalUtils.hideSpinner();
            ModalUtils.showError(
              "Error fetching incident details: " + error.message
            );
          });
      }

      function formatDateForInput(dateString) {
        return dateString
          ? new Date(dateString).toISOString().split("T")[0]
          : "";
      }
    </script>
    <!-- Script for handling edit, delete and viewing details of incident logs table (End) -->

    <!-- Script for logging out (Start) -->
    <script>
      document
        .querySelector(".logout-btn")
        .addEventListener("click", function () {
          $("#logoutModal").modal("show"); // Show modal using jQuery
        });

      document
        .getElementById("confirmLogout")
        .addEventListener("click", function () {
          sessionStorage.removeItem("adminToken");
          window.location.href = "/admin_login";
        });

      document
        .getElementById("cancelLogout")
        .addEventListener("click", function () {
          $("#logoutModal").modal("hide"); // Hide modal using jQuery
        });

      document
        .getElementById("closeLogoutModal")
        .addEventListener("click", function () {
          $("#logoutModal").modal("hide"); // Also hide on "X"
        });
    </script>
    <!-- Script for logging out (End) -->

    <!-- Script that redirects admin back to login page if the token doesn't exist (Start, spinner integrated) -->
    <script>
      if (!token) {
        ModalUtils.showSpinner();
        setTimeout(function () {
          alert("Not authenticated. Redirecting to login.");
          window.location.href = "/admin_login";
        }, 600);
      }
    </script>
    <!-- Script that redirects admin back to login page if the token doesn't exist (End) -->

    <!-- Script for redirect admin back to the login page when someone else logged in from another tab (Start, spinner integrated) -->
    <script>
      function getToken() {
        return sessionStorage.getItem("adminToken");
      }

      function checkSessionConflict() {
        const token = getToken();
        if (!token) return;

        fetch("/check_jti", {
          method: "GET",
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then((response) => {
            if (response.status === 403) {
              throw new Error("session_conflict");
            }
            return response.json();
          })
          .then((data) => {
            if (data.error === "session_conflict") {
              throw new Error("session_conflict");
            }
          })
          .catch((err) => {
            if (err.message === "session_conflict") {
              // Show modal
              const modal = new bootstrap.Modal(
                document.getElementById("sessionConflictModal"),
                {
                  backdrop: "static",
                  keyboard: false,
                }
              );
              modal.show();

              // Attach event listener only once
              const logoutBtn = document.getElementById(
                "confirmLogoutBetweenTabs"
              );
              if (!logoutBtn.dataset.bound) {
                logoutBtn.addEventListener("click", () => {
                  setTimeout(function () {
                    sessionStorage.removeItem("adminToken");
                    window.location.href = "/admin_login";
                  }, 600);
                });
                logoutBtn.dataset.bound = "true";
              }
            }
          });
      }

      // Initial check + every 30 seconds
      checkSessionConflict();
      setInterval(checkSessionConflict, 30000);
    </script>
    <!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

    <!-- Script for checking admin if they have access to this page (Start, spinner integrated) -->
    <script>
      // Only run this if the backend passed access_denied = True
      const accessDenied = {{ 'true' if access_denied else 'false' }};
      if (accessDenied) {
        const accessModal = new bootstrap.Modal(document.getElementById("accessDeniedModal"));
        accessModal.show();

        document.getElementById("forceLogoutBtn").addEventListener("click", function () {
          ModalUtils.showSpinner();
          setTimeout(function() {
            sessionStorage.removeItem("adminToken");
            window.location.href = "/admin_login";
          }, 600);
        });
      }
    </script>
    <!-- Script for checking admin if they have access to this page (End) -->
  </body>
</html>
