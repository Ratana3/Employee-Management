<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />

      <meta name="csrf-token" content="{{ csrf_token() }}">
      <style>
        .highlight-blink {
          animation: blink-animation 1s infinite;
        }
      
        @keyframes blink-animation {
          0% { color: red; }
          50% { color: white; }
          100% { color: red; }
        }
      </style>
  </head>

  <body>
    <div class="container-scroller d-flex">
      <!-- partial:../../partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item sidebar-category">
            <p>Admin dashboard</p>
            <span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="mdi mdi-view-quilt menu-icon"></i>
              <span class="menu-title">Dashboard</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/employeemanagement">
              <i class="mdi mdi-account-box-outline menu-icon"></i>
              <span class="menu-title">Employee <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attendanceandtimetracking">
              <i class="mdi mdi-clipboard-text menu-icon"></i>
              <span class="menu-title">Attendance and <br />Time tracking</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/perfomancemanagement">
              <i class="mdi mdi-settings menu-icon"></i>
              <span class="menu-title">Performance <br />management</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/reportingandanalytics">
              <i class="mdi mdi-chart-pie menu-icon"></i>
              <span class="menu-title">Reporting <br />and Analytics </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/notificationsandcommunication">
              <i class="mdi mdi-bell-ring menu-icon"></i>
              <span class="menu-title"
                >Notifications <br />and Communication
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/payrollandfinancialmanagement">
              <i class="mdi mdi-currency-usd menu-icon"></i>
              <span class="menu-title"
                >Payroll and <br />Financial Management
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/securityandcompliance">
              <i class="mdi mdi-security menu-icon"></i>
              <span class="menu-title"
                >Security and<br />
                Compliance
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/systemadministration">
              <i class="mdi mdi-monitor menu-icon"></i>
              <span class="menu-title">System <br />Administration </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/traininganddevelopment">
              <i class="mdi mdi-grease-pencil menu-icon"></i>
              <span class="menu-title"
                >Training and<br />
                Development
              </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/workflowmanagement">
              <i class="mdi mdi-lan-connect menu-icon"></i>
              <span class="menu-title">Workflow <br />Management </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/employeeEngagement">
              <i class="mdi mdi-human-male menu-icon"></i>
              <span class="menu-title">Employee <br />Engagement </span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dataimportandexport">
              <i class="mdi mdi-file-document menu-icon"></i>
              <span class="menu-title">Data Import </span>
            </a>
          </li>
                    <li class="nav-item">
            <a class="nav-link" href="/verification">
              <i class="mdi mdi-clipboard-check menu-icon"></i>
              <span class="menu-title">Access control</span>
              <div class="badge badge-info badge-pill"></div>
            </a>
          </li>
          <li class="nav-item">
            <button class="btn btn-danger logout-btn" style="margin-left: 80px">
              <i class="la la-power-off"></i>
              <p>Logout</p>
            </button>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:../../partials/_navbar.html -->

        <nav class="navbar col-lg-12 col-12 px-0 py-0 py-lg-4 d-flex flex-row">
          <div
            class="navbar-menu-wrapper d-flex align-items-center justify-content-end"
          >
            <button
              class="navbar-toggler navbar-toggler align-self-center"
              type="button"
              data-toggle="minimize"
            >
              <span class="mdi mdi-menu"></span>
            </button>
            <div class="navbar-brand-wrapper">
              <a class="navbar-brand brand-logo" href="/profile_details">
                <img
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                            class="img-lg rounded-circle mb-3"
                            id="profileImg"
                            alt="Profile Image"
                          />
              </a>
            </div>
            <h4 id="nameDisplay" class="font-weight-bold mb-0 d-none d-md-block mt-1">Lastname, Firstname (email)</h4>
            <ul class="navbar-nav navbar-nav-right">
              <li class="nav-item">
                <h4 class="mb-0 font-weight-bold d-none d-xl-block" id="date-range">
                  Today's date: 
                </h4>
              </li>
              <li class="nav-item dropdown mr-1">
                <a
                  class="nav-link count-indicator dropdown-toggle d-flex justify-content-center align-items-center"
                  id="messageDropdown"
                  href="#"
                  data-toggle="dropdown"
                >
                  <i class="mdi mdi-email mx-0"></i>
                </a>
                <div
                  class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                  aria-labelledby="messageDropdown"
                >
                  <p class="mb-0 font-weight-normal float-left dropdown-header">
                    Messages
                  </p>
              
                  <!-- Action 1: View Inbox -->
                  <a
                    class="dropdown-item preview-item"
                    href="#"
                    onclick="openMessageInboxModal()"
                  >
                    <div class="preview-thumbnail">
                      <div class="preview-icon bg-primary">
                        <i class="mdi mdi-inbox mx-0 text-white"></i>
                      </div>
                    </div>
                    <div class="preview-item-content">
                      <h6 class="preview-subject font-weight-normal">Inbox</h6>
                      <p class="font-weight-light small-text text-muted mb-0">
                        View messages sent to you
                      </p>
                    </div>
                  </a>
              
                  <!-- Action 2: Compose Message -->
                  <a
                    class="dropdown-item preview-item"
                    href="#"
                    onclick="openComposeMessageModal()"
                  >
                    <div class="preview-thumbnail">
                      <div class="preview-icon bg-success">
                        <i class="mdi mdi-pencil mx-0 text-white"></i>
                      </div>
                    </div>
                    <div class="preview-item-content">
                      <h6 class="preview-subject font-weight-normal">Compose Message</h6>
                      <p class="font-weight-light small-text text-muted mb-0">
                        Send a new message
                      </p>
                    </div>
                  </a>

                  <!-- Action: Reply to User Request -->
<a
  class="dropdown-item preview-item"
  href="#"
  onclick="openReplyMessageModal()"
>
  <div class="preview-thumbnail">
    <div class="preview-icon bg-info">
      <i class="mdi mdi-reply mx-0 text-white"></i>
    </div>
  </div>
  <div class="preview-item-content">
    <h6 class="preview-subject font-weight-normal">Reply to Request</h6>
    <p class="font-weight-light small-text text-muted mb-0">
      Respond to user's password reset request
    </p>
  </div>
</a>
                </div>
              </li>              
              <li class="nav-item dropdown mr-2">
                <a
                  class="nav-link count-indicator dropdown-toggle d-flex align-items-center justify-content-center"
                  id="notificationDropdown"
                  href="#"
                  data-toggle="dropdown"
                >
                <i class="mdi mdi-bell-ring-outline" id="messageIcon"></i>
                <span class="count bg-danger" id="unreadCountBadge">0</span>
                </a>
                <div
                  class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                  aria-labelledby="notificationDropdown"
                  id="notificationList"
                >
                  <p class="mb-0 font-weight-normal float-left dropdown-header">
                    Notifications
                  </p>
                </div>
              </li>
            </ul>
            <button
              class="navbar-toggler navbar-toggler-right d-lg-none align-self-center"
              type="button"
              data-toggle="offcanvas"
            >
              <span class="mdi mdi-menu"></span>
            </button>
          </div>
        </nav>

        <div class="col-md-4 grid-margin stretch-card mt-4">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Total Employees :</h4>
              <div class="media">
                <i class="mdi mdi-earth icon-md text-info d-flex align-self-start mr-3"></i>
                <div class="media-body">
                  <p id="totalEmployees" class="display-6">Loading...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="card ml-2">
            <div class="card-body">
              <h4 class="card-title">Employee that clock in :</h4>
              <div class="media">
                <i class="mdi mdi-earth icon-md text-info d-flex align-self-start mr-3"></i>
                <div class="media-body">
                  <p id="clockedInUsers" class="display-6">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="errorAlert" class="alert alert-danger d-none" role="alert">
          Session expired. Please log in again.
        </div>
        

        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-lg-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Employees in each department</h4>
                    <canvas id="pieChart" height="100"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Attendance</h4>
                    <canvas id="barChart" height="100"></canvas>
                  </div>
                </div>
              </div>
            </div>
          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <footer class="footer">
            <div class="card">
              <div class="card-body">
                <div
                  class="d-sm-flex justify-content-center justify-content-sm-between"
                >
                  <span
                    class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                    >Copyright © bootstrapdash.com 2020</span
                  >
                  <span
                    class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                  >
                    Free
                    <a href="https://www.bootstrapdash.com/" target="_blank"
                      >Bootstrap dashboard templates</a
                    >
                    from Bootstrapdash.com</span
                  >
                </div>
              </div>
            </div>
          </footer>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

<!-- Success Modal -->
<div class="modal fade" id="messageSentSuccessModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow border-0 rounded-3">
      <div class="modal-header bg-success text-white border-0 rounded-top">
        <div class="d-flex align-items-center">
          <span class="mr-2">
            <i class="bi bi-check-circle-fill" style="font-size:2rem;"></i>
          </span>
          <h5 class="modal-title mb-0" id="successModalLabel">Success</h5>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center py-4" id="successModalBody">
        Message sent successfully!
      </div>
      <div class="modal-footer border-0 justify-content-center p-2">
        <button type="button" class="btn btn-outline-success px-4" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="messageSentErrorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow border-0 rounded-3">
      <div class="modal-header bg-danger text-white border-0 rounded-top">
        <div class="d-flex align-items-center">
          <span class="mr-2">
            <i class="bi bi-x-circle-fill" style="font-size:2rem;"></i>
          </span>
          <h5 class="modal-title mb-0" id="errorModalLabel">Error</h5>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center py-4" id="errorModalBody">
        Something went wrong.
      </div>
      <div class="modal-footer border-0 justify-content-center p-2">
        <button type="button" class="btn btn-outline-danger px-4" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Session Conflict Modal -->
<div
  class="modal fade"
  id="sessionConflictModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="sessionConflictLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="sessionConflictLabel">Session Conflict</h5>
      </div>
      <div class="modal-body">
        <p>
          <strong>Someone has logged into your account from another tab or device.</strong>
        </p>
        <p>You will be logged out for security reasons.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger" id="confirmLogoutBetweenTabs">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Logout</h5>
        <button type="button" class="close" id="closeLogoutModal" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelLogout" data-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmLogout">
          Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Access Denied Modal -->
<div
  class="modal fade"
  id="accessDeniedModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="accessDeniedLabel"
  aria-hidden="true"
  data-backdrop="static"
  data-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="accessDeniedLabel">Access Denied</h5>
      </div>
      <div class="modal-body">
        <p>Only Super Admins are allowed to access this page.</p>
      </div>
      <div class="modal-footer">
        <button id="redirectBtn" type="button" class="btn btn-danger">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner Modal -->
<div class="modal fade" id="loadingSpinnerModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-0 bg-transparent shadow-none">
      <div class="modal-body text-center">
        <div class="spinner-border text-white" style="width: 4rem; height: 4rem;" role="status">
          <span class="sr-only"></span>
        </div>
        <div class="mt-3 text-white font-weight-bold">Please wait...</div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this message? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Yes, delete</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Compose Message Modal  -->
<div class="modal fade" id="composeMessageModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Compose Message</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="roleSelect" class="form-label">Select Role</label>
          <select class="form-control" id="roleSelect"></select>
        </div>
        <div class="mb-3">
          <label for="receiverSelect" class="form-label">Select Receiver</label>
          <select class="form-control" id="receiverSelect"></select>
        </div>
        <div class="mb-3">
          <label for="messageText" class="form-label">Message</label>
          <textarea class="form-control" id="messageText" rows="4"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="sendButton">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Inbox Modal -->
<div class="modal fade" id="inboxModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Inbox</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="inboxMessages">
        <!-- Messages loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- Modal for Replying to User Request -->
<div class="modal fade" id="replyMessageModal" tabindex="-1" role="dialog" aria-labelledby="replyMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="replyMessageModalLabel">Reply to User Request</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Search bar -->
        <div class="mb-3">
          <input type="text" id="searchRequestInput" class="form-control" placeholder="Search requests by name, email, or status...">
        </div>
        <!-- Requests List -->
        <div id="requestList" class="mb-3" style="max-height: 200px; overflow-y:auto;"></div>
        <!-- Reply Form -->
        <form id="replyForm" style="display: none;">
          <div class="mb-3">
            <label for="replyToEmail" class="form-label">To:</label>
            <input type="email" class="form-control" id="replyToEmail" readonly>
          </div>
          <div class="mb-3">
            <label for="replyMessage" class="form-label">Message:</label>
            <textarea class="form-control" id="replyMessage" rows="4" required placeholder="Your reply message..."></textarea>
          </div>
          <button type="submit" class="btn btn-info w-100">Send Reply</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Contact Request Delete Confirmation Modal -->
<div class="modal fade" id="deleteContactRequestModal" tabindex="-1" role="dialog" aria-labelledby="deleteContactRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteContactRequestModalLabel">Delete Contact Request</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this contact request? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteContactRequestBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap 4 JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <script src="../../static/Admin/vendors/chart.js/Chart.min.js"></script>
    <!-- End plugin js for this page -->

<!-- Script for handling contact request reply and delete (Bootstrap 4 version) (Start) -->
<script>
  // --- Script for handling contact request reply and delete (Bootstrap 4 version) (With Spinner) ---
let allContactRequests = [];
let selectedRequestId = null;
let shouldReopenReplyModal = false;
let deleteModalWasOpenedFromReplyModal = false;


function makeAuthHeaders() {
  const token = sessionStorage.getItem('adminToken');
  return token ? { Authorization: "Bearer " + token } : {};
}

// Render the contact request list
function renderRequestList(filter) {
  const listDiv = document.getElementById('requestList');
  let filtered = allContactRequests;
  if (filter) {
    const term = filter.toLowerCase();
    filtered = allContactRequests.filter(req =>
      (req.first_name && req.first_name.toLowerCase().includes(term)) ||
      (req.last_name && req.last_name.toLowerCase().includes(term)) ||
      (req.email && req.email.toLowerCase().includes(term)) ||
      (req.status && req.status.toLowerCase().includes(term))
    );
  }
  if (!filtered.length) {
    listDiv.innerHTML = '<div class="text-center text-muted">No requests found.</div>';
    return;
  }
  listDiv.innerHTML = filtered.map(req => `
    <div class="card mb-2" style="cursor:pointer;">
      <div class="card-body p-2" onclick="selectContactRequest(${req.id})">
        <strong>${req.first_name} ${req.last_name}</strong> &mdash; <span class="text-muted small">${req.email}</span>
        <div class="small text-muted">${req.message}</div>
        <div>
          <span class="badge badge-${req.status === 'pending' ? 'warning' : 'success'}">${req.status}</span>
          <span class="float-right small">${new Date(req.created_at).toLocaleString()}</span>
        </div>
      </div>
      <div class="card-footer py-1 text-right" style="background:transparent; border:none;">
        <button class="btn btn-sm btn-danger" type="button" onclick="event.stopPropagation(); showDeleteContactRequestModal(${req.id});">
          <i class="fa fa-trash"></i> Delete
        </button>
      </div>
    </div>
  `).join('');
}

// Show the delete confirmation modal for contact requests (hides reply modal if open)
function showDeleteContactRequestModal(requestId) {
  selectedRequestId = requestId;
  if ($('#replyMessageModal').hasClass('show')) {
    deleteModalWasOpenedFromReplyModal = true;
    $('#replyMessageModal').modal('hide');
    $('#replyMessageModal').one('hidden.bs.modal', function() {
      $('#deleteContactRequestModal').modal('show');
    });
  } else {
    deleteModalWasOpenedFromReplyModal = false;
    $('#deleteContactRequestModal').modal('show');
  }
}

// When delete modal is closed (cancel or after delete), if it was opened from reply modal, reopen reply modal (unless success modal is about to show)
$('#deleteContactRequestModal').on('hidden.bs.modal', function() {
  if (deleteModalWasOpenedFromReplyModal && !shouldReopenReplyModal) {
    $('#replyMessageModal').modal('show');
    deleteModalWasOpenedFromReplyModal = false;
  }
});

// Confirm delete handler
document.getElementById('confirmDeleteContactRequestBtn').addEventListener('click', function() {
  $('#deleteContactRequestModal').modal('hide');
  showSpinner();
  fetch(`/api/admin/contact_requests/${selectedRequestId}`, {
    method: 'DELETE',
    headers: makeAuthHeaders()
  })
  .then(res => res.json().then(data => ({ status: res.status, body: data })))
  .then(result => {
    hideSpinner();
    if (result.status === 200) {
      shouldReopenReplyModal = true;
      $('#replyMessageModal').modal('hide'); // Always hide reply modal
      document.getElementById('successModalBody').textContent =
        result.body.message || 'Contact request deleted successfully!';
      $('#messageSentSuccessModal').modal('show');
    } else {
      document.getElementById('errorModalBody').textContent =
        result.body.error || 'Failed to delete contact request.';
      $('#messageSentErrorModal').modal('show');
    }
  })
  .catch(err => {
    hideSpinner();
    document.getElementById('errorModalBody').textContent =
      err.message || 'Network error.';
    $('#messageSentErrorModal').modal('show');
  });
});

// For filtering the contact request list
document.getElementById('searchRequestInput').addEventListener('input', function() {
  renderRequestList(this.value);
});

// Select a contact request for reply
window.selectContactRequest = function(id) {
  const req = allContactRequests.find(r => r.id === id);
  if (!req) return;
  selectedRequestId = id;
  document.getElementById('replyForm').style.display = 'block';
  document.getElementById('replyToEmail').value = req.email;
};

// Open contact request reply modal (opens and loads requests)
function openReplyMessageModal() {
  $('#replyMessageModal').modal('show');
  fetchContactRequestsAndRender();
  document.getElementById('searchRequestInput').value = '';
  document.getElementById('replyForm').style.display = 'none';
  document.getElementById('replyToEmail').value = '';
  document.getElementById('replyMessage').value = '';
  selectedRequestId = null;
}

// After deletion success, reopen reply modal and refresh list
$('#messageSentSuccessModal').off('hidden.bs.modal').on('hidden.bs.modal', function() {
  if (shouldReopenReplyModal) {
    shouldReopenReplyModal = false;
    fetchContactRequestsAndRender(openReplyMessageModal);
  }
});

// Submit handler for reply form
document.getElementById('replyForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!selectedRequestId) {
    document.getElementById('errorModalBody').textContent = 'No request selected.';
    $('#messageSentErrorModal').modal('show');
    return;
  }
  
  const message = document.getElementById('replyMessage').value.trim();
  
  if (!message) {
    document.getElementById('errorModalBody').textContent = 'Please enter a reply message.';
    $('#messageSentErrorModal').modal('show');
    return;
  }
  
  // Send the reply
  showSpinner();
  $('#replyMessageModal').modal('hide');
  
  fetch('/api/admin/reply_to_contact_request', {
    method: 'POST',
    headers: {
      ...makeAuthHeaders(),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      request_id: selectedRequestId,
      message: message
      // No subject field - will use the default from the backend
    })
  })
  .then(res => res.json().then(data => ({ status: res.status, body: data })))
  .then(result => {
    hideSpinner();
    if (result.status === 200 || result.body.success) {
      document.getElementById('successModalBody').textContent = 'Reply sent successfully!';
      $('#messageSentSuccessModal').modal('show');
      // After success, refresh the list
      shouldReopenReplyModal = true;
    } else {
      document.getElementById('errorModalBody').textContent = result.body.error || 'Failed to send reply.';
      $('#messageSentErrorModal').modal('show');
      // Reopen the reply modal
      $('#replyMessageModal').modal('show');
    }
  })
  .catch(err => {
    hideSpinner();
    document.getElementById('errorModalBody').textContent = err.message || 'Network error.';
    $('#messageSentErrorModal').modal('show');
    // Reopen the reply modal
    $('#replyMessageModal').modal('show');
  });
});

// Fetch contact requests and render
function fetchContactRequestsAndRender(callbackAfterRender) {
  showSpinner();
  fetch('/api/admin/contact_requests', { headers: makeAuthHeaders() })
    .then(res => res.json())
    .then(data => {
      allContactRequests = data.requests || [];
      renderRequestList('');
      hideSpinner();
      if (typeof callbackAfterRender === 'function') callbackAfterRender();
    })
    .catch(() => {
      hideSpinner();
      document.getElementById('requestList').innerHTML = '<div class="text-danger text-center">Failed to load requests.</div>';
      if (typeof callbackAfterRender === 'function') callbackAfterRender();
    });
}

// Make the modal opener globally accessible
window.openContactRequestModal = openReplyMessageModal;
window.showDeleteContactRequestModal = showDeleteContactRequestModal;
</script>
<!-- Script for handling contact request reply and delete (Bootstrap 4 version) (End) -->

<!-- Script for message and notification system (Bootstrap 4 compatible) (Start) -->
<script>
  // --- Script for message and notification system (Bootstrap 4 compatible) (With Spinner) ---
let messageDeleteModal = null;
let composeMessageModal = null;
let inboxModal = null;
let replyMessageModal = null;
let messageSentSuccessModal = null;
let messageSentErrorModal = null;
let bsSpinnerModal = null;

// Spinner functions are assumed globally available

let CURRENT_USER_ID = null;
let CURRENT_USER_ROLE = null;
let previousUnreadCount = 0;

document.addEventListener("DOMContentLoaded", () => {
  const token = getToken();
  if (!token) return;
  initMessagingSystem();
});

function getToken() {
  const token = sessionStorage.getItem("adminToken");
  if (!token) return null;
  try {
    const decoded = JSON.parse(atob(token.split('.')[1]));
    console.log("Decoded JWT payload:", decoded);

    if (decoded.exp < Date.now() / 1000) throw new Error("Token expired");

    let uid = decoded.admin_id || decoded.user_id || decoded.id;
    let urole = decoded.role || decoded.user_role || decoded.type;

    sessionStorage.setItem("CURRENT_USER_ID", uid ?? "");
    sessionStorage.setItem("CURRENT_USER_ROLE", urole ?? "");

    return token;
  } catch {
    sessionStorage.removeItem("adminToken");
    alert("Session expired. Please log in again.");
    window.location.href = "/admin_login";
    return null;
  }
}
function secureFetch(url, options = {}) {
  const token = getToken();
  if (!token) return Promise.reject("No valid token");
  return fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  }).then(async res => {
    if (res.status === 401) {
      sessionStorage.removeItem("adminToken");
      alert("Session expired. Please log in again.");
      window.location.href = "/admin_login";
      return null;
    } else if (res.status === 403) {
      return { error: "forbidden", message: "You do not have access to this feature." };
    }
    return res.json();
  });
}

function initMessagingSystem() {
  loadMessageNotifications();
  setInterval(loadMessageNotifications, 30000);
  loadRoles();
  requestNotificationPermission();
  document.getElementById("roleSelect")?.addEventListener("change", handleRoleChange);
  document.getElementById("sendButton")?.addEventListener("click", sendMessage);
}

function loadMessageNotifications() {
  showSpinner();
  secureFetch(`/messages/unread-count`)
    .then(data => {
      if (!data || data.error === "forbidden") {
        updateUnreadCountBadge(0);
        updateNotificationList(0, [], [], true);
        hideSpinner();
        return;
      }
      const messageCount = data.messages ? data.messages.length : 0;
      const requestCount = data.requests ? data.requests.length : 0;
      const totalCount = (messageCount + requestCount);

      updateUnreadCountBadge(totalCount);
      updateNotificationList(totalCount, data.messages || [], data.requests || [], false);

      if (totalCount > previousUnreadCount) {
        showNewMessageNotification(totalCount - previousUnreadCount);
        playNotificationSound();
      }
      previousUnreadCount = totalCount;
      hideSpinner();
    })
    .catch(() => {
      hideSpinner();
    });
}

function updateUnreadCountBadge(count) {
  const badge = document.getElementById("unreadCountBadge");
  badge.textContent = count;
  badge.style.display = count === 0 ? 'none' : 'inline-block';
}

function updateNotificationList(count, messages = [], requests = [], forbidden = false) {
  const list = document.getElementById("notificationList");
  if (forbidden) {
    list.innerHTML =
      `<p class="mb-0 font-weight-normal float-left dropdown-header">Notifications</p>
       <p class="px-3 text-danger">You do not have access to notifications.</p>`;
    return;
  }
  let html = `<p class="mb-0 font-weight-normal float-left dropdown-header">Notifications</p>`;
  if (count === 0) {
    html += `<p class="px-3 text-muted">Empty</p>`;
  } else {
    if (messages.length) {
      html += `<a class="dropdown-item preview-item" href="#" onclick="openMessageInboxModal()">
        <div class="preview-thumbnail">
          <div class="preview-icon bg-warning">
            <i class="mdi mdi-email-alert text-white"></i>
          </div>
        </div>
        <div class="preview-item-content">
          <h6 class="preview-subject font-weight-normal">You have ${messages.length} unread message(s)</h6>
          <p class="font-weight-light small text-muted mb-0">Check your inbox</p>
        </div>
      </a>`;
    }
    if (requests.length) {
      html += `<a class="dropdown-item preview-item" href="#" onclick="openContactRequestModal()">
        <div class="preview-thumbnail">
          <div class="preview-icon bg-info">
            <i class="mdi mdi-account-question text-white"></i>
          </div>
        </div>
        <div class="preview-item-content">
          <h6 class="preview-subject font-weight-normal">You have ${requests.length} new password/help request(s)</h6>
          <p class="font-weight-light small text-muted mb-0">Review user requests</p>
        </div>
      </a>`;
    }
  }
  list.innerHTML = html;
}

function openComposeMessageModal() {
  $('#composeMessageModal').modal('show');
}

function openContactRequestModal() {
  $('#replyMessageModal').modal('show');
  showSpinner();
  secureFetch('/api/admin/contact_requests')
    .then(data => {
      allContactRequests = data.requests || [];
      renderRequestList('');
      hideSpinner();
    })
    .catch(() => {
      hideSpinner();
      document.getElementById('requestList').innerHTML = '<div class="text-danger text-center">Failed to load requests.</div>';
    });
  document.getElementById('searchRequestInput').value = '';
  document.getElementById('replyForm').style.display = 'none';
  document.getElementById('replyToEmail').value = '';
  document.getElementById('replyMessage').value = '';
  selectedRequestId = null;
}

function openMessageInboxModal() {
  showSpinner();
  secureFetch('/messages/inbox').then(messages => {
    const container = document.getElementById('inboxMessages');
    container.innerHTML = '';
    if (!messages || messages.error === "forbidden") {
      container.innerHTML = '<p class="text-danger">You do not have access to view your inbox.</p>';
      $('#inboxModal').modal('show');
      hideSpinner();
      return;
    }
    if (!messages.length) {
      container.innerHTML = '<p class="text-muted">No messages found.</p>';
    } else {
      messages.forEach(msg => container.appendChild(createMessageCard(msg)));
    }
    $('#inboxModal').modal('show');
    hideSpinner();
  }).catch(() => {
    hideSpinner();
  });
}

function createMessageCard(msg) {
  const card = document.createElement('div');
  card.className = 'card mb-2';
  card.innerHTML = `<div class="card-body">
    <h6 class="card-subtitle mb-1 text-muted">From ${msg.sender_role.toUpperCase()} (User ID: ${msg.sender_id})</h6>
    <p class="card-text">${msg.content}</p>
    <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
    ${!msg.is_read ? `<button class="btn btn-sm btn-outline-primary float-right ml-2" onclick="markAsRead(${msg.message_id})">Mark as Read</button>` : ''}
    <button class="btn btn-sm btn-outline-danger float-right" onclick="showDeleteConfirmationModal(${msg.message_id})">Delete</button>
  </div>`;
  return card;
}

let messageIdToDelete = null;

function showDeleteConfirmationModal(messageId) {
  messageIdToDelete = messageId;
  $('#inboxModal').modal('hide');
  $('#deleteConfirmationModal').modal('show');
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('confirmDeleteButton').addEventListener('click', function() {
    if (messageIdToDelete) {
      showSpinner();
      secureFetch(`/messages/delete/${messageIdToDelete}`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content }
      })
      .then(res => {
        $('#deleteConfirmationModal').modal('hide');
        hideSpinner();
        if (typeof loadMessageNotifications === 'function') {
          loadMessageNotifications();
        }
        if (res && res.message) {
          showSuccessModal(res.message);
        } else if (res && res.error) {
          showErrorModal(res.error || "Failed to delete message.");
        } else {
          showErrorModal("Unknown error occurred.");
        }
      })
      .catch(err => {
        $('#deleteConfirmationModal').modal('hide');
        hideSpinner();
        showErrorModal("Failed to delete message. Please try again.");
        console.error(err);
      });
    }
  });
});

function showSuccessModal(message) {
  document.getElementById("successModalBody").textContent = message;
  $('#inboxModal').modal('hide');
  $('#messageSentSuccessModal').modal('show');
}

function showErrorModal(message) {
  document.getElementById("errorModalBody").textContent = message;
  $('#inboxModal').modal('hide');
  $('#messageSentErrorModal').modal('show');
}

function markAsRead(messageId) {
  showSpinner();
  secureFetch(`/messages/read/${messageId}`, {
    method: 'POST',
    headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
    body: JSON.stringify({})
  }).then(() => {
    openMessageInboxModal();
    loadMessageNotifications();
    hideSpinner();
  }).catch(() => {
    hideSpinner();
  });
}

function sendMessage() {
  getToken();
  const receiverSelect = document.getElementById("receiverSelect");
  const selected = receiverSelect.options[receiverSelect.selectedIndex];
  if (!selected || selected.disabled) {
    showErrorModal("Please select a valid receiver.");
    return;
  }
  const message = document.getElementById("messageText").value.trim();
  if (!message) {
    showErrorModal("Please enter a message.");
    return;
  }
  const sender_id = sessionStorage.getItem("CURRENT_USER_ID");
  const sender_role = sessionStorage.getItem("CURRENT_USER_ROLE");
  if (!sender_id || !sender_role) {
    showErrorModal("Sender information is missing. Please re-login.");
    return;
  }
  const payload = {
    sender_id: parseInt(sender_id),
    sender_role,
    receiver_id: parseInt(selected.value),
    receiver_email: selected.getAttribute("data-email"),
    receiver_role: document.getElementById("roleSelect").selectedOptions[0].text,
    subject: "No Subject",
    body: message
  };
  showSpinner();
  secureFetch('/messages/send', {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify(payload)
  }).then((res) => {
    hideSpinner();
    if (res && !res.error && res.message) {
      $('#composeMessageModal').modal('hide');
      showSuccessModal(res.message || "Message sent!");
    } else if (
      res && (
        res.error === "forbidden" ||
        res.error === "Forbidden: Not authorized" ||
        (typeof res.error === "string" && res.error.toLowerCase().includes("forbidden"))
      )
    ) {
      showErrorModal("You do not have permission to send messages.");
    } else if (res && res.error) {
      showErrorModal(res.message || res.error);
    } else {
      showErrorModal("Unknown error occurred.");
    }
  }).catch(err => {
    hideSpinner();
    console.error('Send error:', err);
    showErrorModal("Failed to send message. Please try again.");
  });
}
function loadRoles() {
  showSpinner();
  secureFetch("/roles")
    .then(data => {
      const roleSelect = document.getElementById("roleSelect");
      roleSelect.innerHTML = '<option disabled selected>Select a role</option>';
      data.forEach(role => {
        const opt = document.createElement("option");
        opt.value = role.role_id;
        opt.textContent = role.role_name;
        roleSelect.appendChild(opt);
      });
      hideSpinner();
    })
    .catch(err => {
      hideSpinner();
      console.error("Error loading roles:", err);
    });
}

function handleRoleChange() {
  const roleId = document.getElementById("roleSelect").value;
  showSpinner();
  secureFetch(`/users/by_role/${roleId}`)
    .then(users => {
      const receiverSelect = document.getElementById("receiverSelect");
      receiverSelect.innerHTML = '';
      if (!users || users.error === "forbidden" || !users.length) {
        const opt = document.createElement("option");
        opt.disabled = true;
        opt.selected = true;
        opt.textContent = "No users available";
        receiverSelect.appendChild(opt);
        hideSpinner();
        return;
      }
      const defaultOpt = document.createElement("option");
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      defaultOpt.textContent = "Select a receiver";
      receiverSelect.appendChild(defaultOpt);
      users.forEach(user => {
        const opt = document.createElement("option");
        opt.value = user.user_id;
        opt.setAttribute("data-email", user.email);
        opt.textContent = user.email;
        receiverSelect.appendChild(opt);
      });
      hideSpinner();
    })
    .catch(err => {
      hideSpinner();
      console.error("Error fetching users by role:", err);
      alert("Failed to load users for the selected role.");
    });
}

function requestNotificationPermission() {
  if (Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

function showNewMessageNotification(count) {
  if (Notification.permission === 'granted') {
    new Notification(`New Message${count > 1 ? 's' : ''}`, {
      body: `You have ${count} new unread message${count > 1 ? 's' : ''}.`,
      icon: '/path/to/your/message-icon.png'
    });
  }
}

function playNotificationSound() {
  const audio = document.getElementById("messageSound");
  if (audio) audio.play().catch(console.error);
}
</script>
<!-- Script for message and notification system (End) -->

    <!-- Script for displaying dashboard data and charts (Start) -->
<script>
  // --- Script for displaying dashboard data and charts (with Spinner and friendly 403 handling) ---
document.addEventListener("DOMContentLoaded", () => {
  const token = sessionStorage.getItem("adminToken");
  if (!token) {
    showErrorAndRedirect("No token found. Please log in.");
    return;
  }

  // Initial dashboard load
  loadDashboardData();

  // Periodic access check every 10 seconds (optional, can remove if not needed)
  setInterval(checkAccessDenied, 10000);

  function loadDashboardData() {
    const token = sessionStorage.getItem("adminToken");
    if (!token) {
      showErrorAndRedirect("No token found. Please log in.");
      return;
    }

    showSpinner();
    fetch("/dashboard_data", {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => {
      if (res.status === 401) {
        hideSpinner();
        showErrorAndRedirect("Session expired or unauthorized. Redirecting to login...");
        return;
      } else if (res.status === 403) {
        hideSpinner();
        document.getElementById("totalEmployees").textContent = "No access";
        document.getElementById("clockedInUsers").textContent = "No access";
        clearDashboardCharts();
        return;
      } else if (!res.ok) {
        hideSpinner();
        throw new Error("Unexpected error");
      }

      // ---- 2FA detection logic ----
      const contentType = res.headers.get("content-type");
      if (contentType && contentType.includes("text/html")) {
        hideSpinner();
        // Manually redirect to the 2FA page!
        window.location.href = "/verify-2fa";
        return;
      }
      // ---- End 2FA detection ----

      return res.json();
    })
    .then(data => {
      hideSpinner();
      if (!data) return;
      document.getElementById("totalEmployees").textContent = data.total_employees;
      const clockedInUsers = document.getElementById("clockedInUsers");
      if (clockedInUsers) clockedInUsers.textContent = data.clockin_users;
      renderChart("attendanceChart", "line", data.attendance_data);
      renderChart("barChart", "bar", data.attendance_data);
      renderPieChart("pieChart", data.department_data);
      renderPieChart("departmentChart", data.department_data);
      if (data.admin_profile && data.admin_id && data.admin_role) {
        const { first_name, last_name, email } = data.admin_profile;
        const profileUrl = `/profile-picture/${data.admin_role}/${data.admin_id}`;
        setProfileImageWithToken(profileUrl, token);
        document.getElementById("nameDisplay").textContent = `${last_name}, ${first_name} (${email})`;
      }
    })
    .catch(err => {
      hideSpinner();
      console.error("Dashboard loading error:", err);
      showErrorAndRedirect("An unexpected error occurred. Redirecting to login...");
    });
  }

  // Helper to clear/hide charts when no dashboard data permission
  function clearDashboardCharts() {
    ["attendanceChart", "barChart", "pieChart", "departmentChart"].forEach(id => {
      const canvas = document.getElementById(id);
      if (canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "16px Arial";
        ctx.fillStyle = "#c00";
        ctx.fillText("No access", 20, 40);
      }
    });
  }

  function setProfileImageWithToken(url, token) {
    // Add a cache-buster to always fetch the latest image
    const cacheBustedUrl = url + "?t=" + Date.now();
    showSpinner();
    fetch(cacheBustedUrl, {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => {
      if (!res.ok) {
        hideSpinner();
        throw new Error("Failed to load profile image");
      }
      return res.blob();
    })
    .then(blob => {
      hideSpinner();
      const img = document.getElementById("profileImg");
      if (img) {
        img.src = URL.createObjectURL(blob);
      }
    })
    .catch(err => {
      hideSpinner();
      console.error("Profile image load error:", err);
      // fallback to default image
      const img = document.getElementById("profileImg");
      if (img) img.src = "/static/default_resource.png";
    });
  }

  function checkAccessDenied() {
    fetch("/dashboard_data", {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => {
      if (res.status === 403) {
        // Do nothing - handled in UI by friendly message
        // Optionally, display a toast or notification if you want
      } else if (res.status === 401) {
        showErrorAndRedirect("Session expired or unauthorized. Redirecting to login...");
      }
    })
    .catch(err => {
      console.error("Access check error:", err);
      showErrorAndRedirect("An unexpected error occurred. Redirecting to login...");
    });
  }

  function showErrorAndRedirect(message) {
    const alert = document.getElementById("errorAlert");
    if (alert) {
      alert.classList.remove("d-none");
      alert.textContent = message;
    }
    setTimeout(() => {
      sessionStorage.removeItem("adminToken");
      window.location.href = "/admin_login";
    }, 4000);
  }

  function renderChart(id, type, chartData) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    new Chart(ctx, {
      type,
      data: {
        labels: chartData.dates,
        datasets: [{
          label: "Employees Clocked In",
          data: chartData.counts,
          backgroundColor: type === "bar" ? 'rgba(54, 162, 235, 0.7)' : undefined,
          borderColor: 'rgba(54, 162, 235, 1)',
          fill: type !== "bar",
          tension: type === "line" ? 0.3 : 0
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
      }
    });
  }

  function renderPieChart(id, departmentData) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: departmentData.labels,
        datasets: [{
          data: departmentData.counts,
          backgroundColor: [
            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
            '#20c997', '#6610f2', '#fd7e14', '#17a2b8'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: 'Department Distribution' } }
      }
    });
  }
});

</script>
<!-- Script for displaying dashboard data and charts (End) -->

<!-- Script that redirects admin back to login page if the token doesn't exist (Start) -->
<script>
  // --- Script that redirects admin back to login page if the token doesn't exist (With Spinner) ---
const token = sessionStorage.getItem("adminToken");
if (!token) {
  showSpinner && showSpinner();
  setTimeout(() => {
    alert("Not authenticated. Redirecting to login.");
    window.location.href = "/admin_login";
  }, 800); // Short delay so spinner can be seen
}

</script>
<!-- Script that redirects admin back to login page if the token doesn't exist (End) -->


    <!-- Script for formatiing the date (Start) -->
     <script>
  document.addEventListener("DOMContentLoaded", () => {
    const dateElement = document.getElementById("date-range");
    const today = new Date();

    const options = { year: "numeric", month: "short", day: "2-digit" };
    const formattedDate = today.toLocaleDateString("en-US", options);

    // Display the same date as both start and end
    dateElement.textContent = `Today's date : ${formattedDate}`;
  });
</script>
<!-- Script for formatiing the date (End) -->

<!-- Script for checking admin if they have access to this page (Bootstrap 4 version, With Spinner) (Start) -->
<script>
(function(){
  // Only run this if the backend passed access_denied = True
  const accessDenied = {{ 'true' if access_denied else 'false' }};
  if (accessDenied) {
    // Show the modal using jQuery in Bootstrap 4
    $('#accessDeniedModal').modal({
      backdrop: 'static',
      keyboard: false
    });

    // Make sure the button exists and add click handler
    document.getElementById("forceLogoutBtn").addEventListener("click", function () {
      if (typeof showSpinner === "function") showSpinner();
      setTimeout(function(){
        sessionStorage.removeItem("adminToken");
        window.location.href = "/admin_login";
      }, 600); // Show spinner briefly before redirect
    });
  }
})();
</script>
<!-- Script for checking admin if they have access to this page (End) -->

<!-- Script for logging out (With Spinner) (Start) -->
<script>
(function(){
  document.querySelector(".logout-btn").addEventListener("click", function () {
    $("#logoutModal").modal("show"); // Show modal using jQuery
  });

  document
    .getElementById("confirmLogout")
    .addEventListener("click", function () {
      if (typeof showSpinner === "function") showSpinner();
      setTimeout(function(){
        sessionStorage.removeItem("adminToken");
        window.location.href = "/admin_login";
      }, 600); // Show spinner briefly before redirect
    });

  document
    .getElementById("cancelLogout")
    .addEventListener("click", function () {
      $("#logoutModal").modal("hide"); // Hide modal using jQuery
    });

  document
    .getElementById("closeLogoutModal")
    .addEventListener("click", function () {
      $("#logoutModal").modal("hide"); // Also hide on "X"
    });
})();
</script>
<!-- Script for logging out (End) -->

<!-- Script for redirect admin back to the login page when someone else logged in from another tab (With Spinner) (Start) -->
<script>
(function(){
  function getToken() {
    const token = sessionStorage.getItem("adminToken");
    return token;
  }

  function checkSessionConflict() {
    const token = getToken();
    if (!token) return;

    fetch("/check_jti", {
      method: "GET",
      headers: {
        Authorization: "Bearer " + token,
      },
    })
      .then((response) => {
        if (response.status === 403) {
          throw new Error("session_conflict");
        }
        return response.json();
      })
      .then((data) => {
        if (data.error === "session_conflict") {
          throw new Error("session_conflict");
        }
      })
      .catch((err) => {
        if (err.message === "session_conflict") {
          // Show modal (Bootstrap 5 version fallback for Bootstrap 4)
          if (window.bootstrap && window.bootstrap.Modal) {
            const modal = new bootstrap.Modal(
              document.getElementById("sessionConflictModal"),
              {
                backdrop: "static",
                keyboard: false,
              }
            );
            modal.show();
          } else {
            $('#sessionConflictModal').modal({
              backdrop: 'static',
              keyboard: false
            });
          }

          // Attach event listener only once
          const logoutBtn = document.getElementById("confirmLogoutBetweenTabs");
          if (!logoutBtn.dataset.bound) {
            logoutBtn.addEventListener("click", () => {
              if (typeof showSpinner === "function") showSpinner();
              setTimeout(function(){
                sessionStorage.removeItem("adminToken");
                window.location.href = "/admin_login";
              }, 600);
            });
            logoutBtn.dataset.bound = "true";
          }
        }
      });
  }

  // Initial check + every 30 seconds
  checkSessionConflict();
  setInterval(checkSessionConflict, 30000);
})();
</script>
<!-- Script for redirect admin back to the login page when someone else logged in from another tab (End) -->

<!-- Spinner functions (if not already globally defined) (Start) -->
<script>
function showSpinner() {
  $('#loadingSpinnerModal').modal({
    backdrop: 'static',
    keyboard: false
  });
}
function hideSpinner() {
  $('#loadingSpinnerModal').modal('hide');
}
</script>
<!-- Spinner functions (End) -->

  </body>
</html>
