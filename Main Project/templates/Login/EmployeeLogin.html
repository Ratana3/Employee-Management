<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
  </head>

  <body>
    <div class="container-scroller d-flex">
      <div class="container-fluid page-body-wrapper full-page-wrapper d-flex">
        <div class="content-wrapper d-flex align-items-center auth px-0">
          <div class="row w-100 mx-0">
            <div class="col-lg-4 mx-auto">
              <div class="auth-form-light text-left py-5 px-4 px-sm-5">
                <div class="brand-logo">
                  <img src="../../static/Admin/images/logo.svg" alt="logo" />
                </div>
                <h4>Hello! let's get started</h4>
                <h6 class="font-weight-light">Sign in to continue.</h6>
                <form class="pt-3" id="login-form">
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <div class="form-group">
                    <input
                      type="email"
                      class="form-control form-control-lg"
                      id="email"
                      placeholder="Email"
                      name="email"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <input
                      type="password"
                      class="form-control form-control-lg"
                      id="password"
                      placeholder="Password"
                      name="password"
                      required
                    />
                  </div>
                  <div class="mt-3">
                    <button
                      type="submit"
                      class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn"
                    >
                      SIGN IN
                    </button>
                  </div>
                  <div
                    class="my-2 d-flex justify-content-between align-items-center"
                  >
                    <div class="form-check">
                      <a href="/admin_login" class="auth-link text-black"
                        >Login as Admin</a
                      >
                    </div>
                    <a href="/forgot_password" class="auth-link text-black"
                      >Forgot password?</a
                    >
                  </div>
                  <div class="text-center mt-4 font-weight-light">
                    Don't have an account?
                    <a href="/register" class="text-primary">Create</a>
                  </div>
                </form>
                <div id="error-message" class="error-message"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

    <!-- Success Modal -->
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div
            class="modal-header text-white"
            style="
              background: linear-gradient(145deg, #3a8dff, #7ab8ff);
              box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            "
          >
            <h5 class="modal-title" id="successModalLabel">Login Successful</h5>
          </div>
          <div
            class="modal-body text-center"
            style="font-size: 1.2rem; padding: 30px; position: relative"
          >
            <div class="checkmark-animation">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-check-circle"
                style="animation: bounce 1s infinite"
              >
                <path d="M20 6L9 17l-5-5"></path>
              </svg>
            </div>
            <p class="mt-4 fw-semibold text-success">
              Redirecting to your dashboard...
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div
      class="modal fade"
      id="errorModal"
      tabindex="-1"
      aria-labelledby="errorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger border-2 shadow">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel">Login Failed</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <div class="error-animation">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-x-circle"
              >
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
              </svg>
            </div>
            <p id="errorMessage" class="fw-semibold text-danger mt-3">
              Error message will appear here
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Session Expired Modal -->
    <div
      class="modal fade"
      id="sessionExpiredModal"
      tabindex="-1"
      aria-labelledby="sessionExpiredModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning border-2">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="sessionExpiredModalLabel">
              Session Expired
            </h5>
          </div>
          <div class="modal-body">
            Your session has expired or was logged out from another tab. Please
            log in again.
          </div>
          <div class="modal-footer">
            <a href="/" class="btn btn-primary">OK</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Deactivated Modal -->
    <div
      class="modal fade"
      id="accountDeactivatedModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger border-3 shadow">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Account Deactivated</h5>
          </div>
          <div class="modal-body fw-semibold text-danger text-center">
            Your account has been <strong>deactivated</strong> by the
            administrator. Please contact support for assistance.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-danger"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Terminated Modal -->
    <div
      class="modal fade"
      id="accountTerminatedModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div
          class="modal-content bg-dark text-white border-light border-2 shadow"
        >
          <div class="modal-header border-0">
            <h5 class="modal-title">Account Terminated</h5>
          </div>
          <div class="modal-body text-center fw-semibold">
            Your account has been <strong>terminated</strong>. Access is no
            longer available.
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-outline-light"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- container-scroller -->
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->

    <!-- Script for displaying the modal after logging out from a page when the token is expired or blacklisted (Start) -->
    {% if reason == 'session_expired' %}
    <script>
      window.addEventListener("DOMContentLoaded", function () {
        var modal = new bootstrap.Modal(
          document.getElementById("sessionExpiredModal")
        );
        modal.show();
      });
    </script>
    {% endif %}
    <!-- Script for displaying the modal after logging out from a page when the token is expired or blacklisted (End) -->

    <!-- Script for employee login (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("login-form");
        if (!loginForm) return;

        loginForm.addEventListener("submit", async function (event) {
          event.preventDefault();

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const loginButton = loginForm.querySelector("button[type='submit']");
          loginButton.disabled = true;

          try {
            const response = await fetch("/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email, password }),
            });

            const result = await response.json();

            if (response.ok && result.token) {
              // Store token in sessionStorage for JS use
              sessionStorage.setItem("employeeToken", result.token);

              // ALSO set the token as a cookie for backend authentication
              document.cookie = `employeeToken=${result.token}; path=/; secure; sameSite=Lax`;

              const successModal = new bootstrap.Modal(
                document.getElementById("successModal")
              );
              successModal.show();

              setTimeout(() => {
                window.location.href = "/user";
              }, 3000);
            } else if (response.status === 403) {
              if (result.status === "Deactivated") {
                const deactivatedModal = new bootstrap.Modal(
                  document.getElementById("accountDeactivatedModal")
                );
                deactivatedModal.show();
              } else if (result.status === "Terminated") {
                const terminatedModal = new bootstrap.Modal(
                  document.getElementById("accountTerminatedModal")
                );
                terminatedModal.show();
              } else {
                const errorModal = new bootstrap.Modal(
                  document.getElementById("errorModal")
                );
                document.getElementById("errorMessage").textContent =
                  result.message || "Your account is not permitted to login.";
                errorModal.show();
              }
            } else {
              const errorModal = new bootstrap.Modal(
                document.getElementById("errorModal")
              );
              document.getElementById("errorMessage").textContent =
                result.error || "Login failed. Please try again.";
              errorModal.show();
            }
          } catch (error) {
            const errorModal = new bootstrap.Modal(
              document.getElementById("errorModal")
            );
            document.getElementById("errorMessage").textContent =
              "An error occurred: " + error.message;
            errorModal.show();
          } finally {
            loginButton.disabled = false;
          }
        });
      });
    </script>
    <!-- Script for employee login (End) -->
  </body>
</html>
