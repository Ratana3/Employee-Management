<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Spica Admin</title>
    <!-- base:css -->
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../static/Admin/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../static/Admin/css/style.css" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../../static/Admin/images/favicon.png" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
  </head>

  <body>
    <div class="container-scroller d-flex">
      <div class="container-fluid page-body-wrapper full-page-wrapper d-flex">
        <div
          class="content-wrapper d-flex align-items-stretch auth auth-img-bg"
        >
          <div class="row flex-grow">
            <div
              class="col-lg-6 d-flex align-items-center justify-content-center"
            >
              <div class="auth-form-transparent text-left p-3">
                <div class="brand-logo">
                  <img src="../../static/Admin/images/logo.svg" alt="logo" />
                </div>
                <h4>Sign In</h4>
                <h6 class="font-weight-light">
                  Login to access admin's features!
                </h6>
                <form class="pt-3" id="adminLoginForm">
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />

                  {% with messages = get_flashed_messages(with_categories=true)
                  %} {% if messages %}
                  <div class="alert alert-danger">
                    {% for category, message in messages %}
                    <p>{{ message }}</p>
                    {% endfor %}
                  </div>
                  {% endif %} {% endwith %}

                  <div class="form-group">
                    <label>Email</label>
                    <div class="input-group">
                      <div class="input-group-prepend bg-transparent">
                        <span
                          class="input-group-text bg-transparent border-right-0"
                        >
                          <i class="mdi mdi-email-outline text-primary"></i>
                        </span>
                      </div>
                      <input
                        type="text"
                        id="email"
                        name="email"
                        class="form-control form-control-lg border-left-0"
                        placeholder="Email"
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Role</label>
                    <div class="input-group">
                      <div class="input-group-prepend bg-transparent">
                        <span
                          class="input-group-text bg-transparent border-right-0"
                        >
                          <i class="mdi mdi-account-key text-primary"></i>
                        </span>
                      </div>
                      <select
                        id="role"
                        name="role"
                        class="form-control form-control-lg border-left-0"
                        required
                      >
                        <option value="" disabled>-- Select Role --</option>
                        {% for role in roles %}
                        <option value="{{ role }}">{{ role }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Password</label>
                    <div class="input-group">
                      <div class="input-group-prepend bg-transparent">
                        <span
                          class="input-group-text bg-transparent border-right-0"
                        >
                          <i class="mdi mdi-lock-outline text-primary"></i>
                        </span>
                      </div>
                      <input
                        type="password"
                        id="password"
                        name="password"
                        class="form-control form-control-lg border-left-0"
                        placeholder="Password"
                      />
                    </div>
                  </div>
                  <div
                    id="loginError"
                    class="alert alert-danger"
                    style="display: none"
                  ></div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Login</button>
                  </div>
                  <div class="text-center mt-4 font-weight-light">
                    Back to employee login page.
                    <a href="/" class="text-primary">Click here</a>
                  </div>
                </form>
              </div>
            </div>
            <div class="col-lg-6 register-half-bg d-none d-lg-flex flex-row">
              <p
                class="text-white font-weight-medium text-center flex-grow align-self-end"
              >
                Copyright &copy; 2018 All rights reserved.
              </p>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

    <!-- Script for logging in verification (Start) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("adminLoginForm");
        const loginError = document.getElementById("loginError");
        const submitBtn = document.querySelector(
          "#adminLoginForm button[type='submit']"
        );

        if (loginForm) {
          loginForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;
            const role = document.getElementById("role").value;

            if (!email || !password || !role) {
              showError("Email, password, and role are required");
              return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<span class="spinner-border spinner-border-sm"></span> Logging in...';

            try {
              const response = await fetch("/admin_login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password, role }),
              });

              const result = await response.json();

              if (!response.ok) {
                throw new Error(result.error || "Login failed");
              }

              // âœ… Redirect after successful login
              sessionStorage.setItem("adminToken", result.token);
              window.location.href = "/dashboard";
            } catch (error) {
              showError(error.message);
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = "Login";
            }
          });
        }

        function showError(message) {
          if (loginError) {
            loginError.textContent = message;
            loginError.style.display = "block";
          } else {
            alert(message);
          }
        }
      });
    </script>
    <!-- Script for logging in verification (End) -->

    <!-- container-scroller -->
    <!-- base:js -->
    <script src="../../static/Admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- inject:js -->
    <script src="../../static/Admin/js/off-canvas.js"></script>
    <script src="../../static/Admin/js/hoverable-collapse.js"></script>
    <script src="../../static/Admin/js/template.js"></script>
    <!-- endinject -->
  </body>
</html>
