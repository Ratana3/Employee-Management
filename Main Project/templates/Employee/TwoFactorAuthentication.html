<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2FA Verification</title>
    <!-- Bootstrap 4 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <style>
      .success-message {
        color: #12b76a;
        font-size: 0.96rem;
        margin-top: 0.7rem;
        margin-bottom: 0.2rem;
        min-height: 1.2em;
      }
      #send2faBtn:disabled {
        background: #e3e7ee;
        color: #a0a4aa;
        cursor: not-allowed;
        border: 1px solid #e3e7ee;
      }
      body {
        font-family: "Inter", Arial, sans-serif;
        background: #f7f9fa;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
      }
      .container {
        background: #fff;
        padding: 2.2rem 2rem 2rem 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 16px rgba(24, 32, 56, 0.11);
        text-align: center;
        width: 100%;
        max-width: 350px;
        border: 1px solid #ececec;
      }
      h2 {
        font-size: 1.45rem;
        font-weight: 600;
        color: #222;
        margin-bottom: 0.5rem;
        letter-spacing: 0.01em;
      }
      p {
        font-size: 1rem;
        color: #5a6270;
        margin-bottom: 1.2rem;
      }
      input[type="text"] {
        width: 100%;
        padding: 0.7rem 0.9rem;
        margin: 0.45rem 0 1rem 0;
        border: 1px solid #e3e7ee;
        border-radius: 6px;
        font-size: 1.08rem;
        letter-spacing: 0.12em;
        background: #f9fbfc;
        transition: border 0.2s;
      }
      input[type="text"]:focus {
        border: 1.5px solid #007bff;
        outline: none;
        background: #fff;
      }
      button {
        width: 100%;
        padding: 0.7rem 0;
        background: #1769aa;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.08rem;
        font-weight: 500;
        margin-top: 0.4rem;
        margin-bottom: 0.4rem;
        transition: background 0.18s;
        box-shadow: 0 1px 3px rgba(24, 32, 56, 0.04);
      }
      button:hover,
      button:focus {
        background: #125182;
      }
      #error-message,
      .error-message {
        color: #d92d20;
        font-size: 0.96rem;
        margin-top: 0.7rem;
        margin-bottom: 0.2rem;
        min-height: 1.2em;
      }
      #timer {
        color: #1769aa;
        font-size: 0.98rem;
        margin-top: 0.3rem;
        margin-bottom: 0.3rem;
        display: block;
        min-height: 1.2em;
      }
      button[style*="background: #6c757d"] {
        background: #f4f6fa !important;
        color: #5a6270 !important;
        border: 1px solid #e3e7ee !important;
        margin-top: 0.8em !important;
      }
      button[style*="background: #6c757d"]:hover {
        background: #e3e7ee !important;
      }

      @media (max-width: 450px) {
        .container {
          max-width: 96vw;
          padding: 1.1rem 0.5rem 1rem 0.5rem;
        }
        h2 {
          font-size: 1.12rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Two-Factor Authentication</h2>
      <p>
        Enter the verification code sent to your email or generated by Google
        Authenticator.
      </p>
      {% if error %}
      <p class="error-message">{{ error }}</p>
      {% endif %}
      <form method="POST" id="twofaForm" autocomplete="off">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input
          type="text"
          name="code"
          placeholder="Enter 6-digit code"
          required
          maxlength="6"
          pattern="[0-9]{6}"
          inputmode="numeric"
          autocomplete="one-time-code"
        />
        <button type="submit" id="verifyBtn">Verify</button>
      </form>
      <button id="send2faBtn">Send code</button>
      <span id="timer" style="display: inline-block; margin-top: 10px"></span>
      <div id="twofa-message"></div>
      <button
        onclick="window.location.href='/'"
        type="button"
        style="margin-top: 1em; background: #6c757d"
      >
        Back to Login
      </button>
    </div>

    <!-- Spinner Modal -->
    <div
      class="modal fade"
      id="loadingSpinnerModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div
          class="modal-content d-flex justify-content-center align-items-center p-4"
          style="min-height: 150px"
        >
          <div class="text-center">
            <div
              class="spinner-border text-primary"
              role="status"
              style="width: 3rem; height: 3rem"
            ></div>
            <div class="mt-3">Please wait...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Closable Message Modal -->
    <div
      class="modal fade"
      id="messageModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="messageModalTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalTitle">Message</h5>
          </div>
          <div class="modal-body" id="messageModalBody">
            <!-- Message inserted by script -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" data-dismiss="modal">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Non‑Closable Redirect Modal -->
    <div
      class="modal fade"
      id="redirectModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center p-4">
          <div class="modal-body" id="redirectModalBody">Redirecting...</div>
        </div>
      </div>
    </div>

    <!-- 1. jQuery v3.x -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- 2. Popper.js (for Bootstrap 4) -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- 3. Bootstrap 4 JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- Script for displaying loading,success and error modals (Start) -->
    <script>
      // Show spinner
      function showSpinner() {
        $("#loadingSpinnerModal").appendTo("body").modal("show");
      }
      // Hide spinner
      function hideSpinner() {
        $("#loadingSpinnerModal").modal("hide");
      }

      // Regular message (closable) — OK, Warning, or Error
      function showMessage(type, message, onHide) {
        // type: 'Success' or 'Error'
        $("#messageModalTitle").text(type);
        $("#messageModalBody").text(message);
        $("#messageModal")
          .off("hidden.bs.modal")
          .on("hidden.bs.modal", function () {
            if (typeof onHide === "function") onHide();
          })
          .modal("show");
      }

      // Static success (non‑closable) + redirect
      function showRedirectMessage(message, redirectUrl) {
        $("#redirectModalBody").text(message);
        $("#redirectModal").appendTo("body").modal("show");

        // after a short pause (optional), navigate
        setTimeout(() => {
          window.location.replace(redirectUrl);
        }, 1000); // adjust delay as you like
      }
    </script>
    <!-- Script for displaying loading,success and error modals (End) -->

    <!-- Script for handling the 2FA verification and 2FA resend logic (Start) -->
    <script>
      let sendBtn = null,
        timerSpan = null,
        seconds = 60,
        timerId = null;

      function start2FATimer() {
        sendBtn.disabled = true;
        timerSpan.textContent = `You can resend the code in ${seconds}s`;
        timerId = setInterval(() => {
          seconds--;
          timerSpan.textContent = `You can resend the code in ${seconds}s`;
          if (seconds <= 0) {
            clearInterval(timerId);
            sendBtn.disabled = false;
            sendBtn.textContent = "Resend code";
            timerSpan.textContent = "";
            seconds = 60;
          }
        }, 1000);
      }

      function send2FACode() {
        const token = sessionStorage.getItem("employeeToken");
        showSpinner();
        fetch("/employee/resend-2fa-code", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            token: token,
            csrf_token: document.querySelector('input[name="csrf_token"]')
              .value,
          }).toString(),
        })
          .then((res) => res.json())
          .then((data) => {
            hideSpinner();
            const msgDiv = document.getElementById("twofa-message");
            if (data.success) {
              msgDiv.textContent = "Verification code sent! Check your email.";
              msgDiv.classList.remove("error-message");
              msgDiv.classList.add("success-message");
              start2FATimer();
            } else {
              msgDiv.textContent =
                data.message || "Failed to send code. Please try again.";
              msgDiv.classList.remove("success-message");
              msgDiv.classList.add("error-message");
            }
          })
          .catch((err) => {
            hideSpinner();
            const msgDiv = document.getElementById("twofa-message");
            msgDiv.textContent = "Network error. Please try again.";
            msgDiv.classList.remove("success-message");
            msgDiv.classList.add("error-message");
          });
      }

      $(function () {
        sendBtn = document.getElementById("send2faBtn");
        timerSpan = document.getElementById("timer");

        // On first click, send code and start timer
        sendBtn.onclick = function (e) {
          e.preventDefault();
          sendBtn.disabled = true;
          send2FACode();
        };

        // 2FA form submit
        $("#twofaForm").on("submit", async function (e) {
          e.preventDefault();
          // inject token if missing
          if (!this.querySelector('input[name="token"]')) {
            $("<input>", {
              type: "hidden",
              name: "token",
              value: sessionStorage.getItem("employeeToken"),
            }).appendTo(this);
          }

          const body = new URLSearchParams(new FormData(this)).toString();
          showSpinner();

          try {
            const res = await fetch(window.location.href, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: body,
            });
            const result = await res.json().catch(() => ({}));
            hideSpinner();

            if (res.ok && (result.success || result.status === "success")) {
              const t = result.token || sessionStorage.getItem("employeeToken");
              if (t) {
                document.cookie = `employeeToken=${t}; path=/; secure; sameSite=Lax`;
                sessionStorage.setItem("employeeToken", t);
              }
              showRedirectMessage(
                result.message || "Verification successful! Redirecting…",
                result.redirect || "/user"
              );
            } else {
              showMessage(
                "Error",
                result.error ||
                  result.message ||
                  "Invalid code. Please try again."
              );
            }
          } catch (err) {
            hideSpinner();
            showMessage(
              "Error",
              "Network error. Please check your connection."
            );
          }
        });
      });
    </script>
    <!-- Script for handling the 2FA verification and 2FA resend logic (End) -->
  </body>
</html>
