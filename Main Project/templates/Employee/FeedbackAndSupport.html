<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>Ready Bootstrap Dashboard</title>
	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
	<link rel="stylesheet" href="../../static/Employee/assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
	<link rel="stylesheet" href="../../static/Employee/assets/css/ready.css">
	<link rel="stylesheet" href="../../static/Employee/assets/css/demo.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
	<meta name="csrf-token" content="{{ csrf_token() }}">
		<!-- Styling the logging you out spinner -->	
		<style>
          /* Make modal-body scrollable in Bootstrap 4 */
.inbox-scrollable {
  max-height: 60vh;   /* Adjust height as needed */
  overflow-y: auto;
}
			/* Basic styling for spinner container */
		.spinner-container {
			display: flex;
			justify-content: center;
			align-items: center;
		}
	
		/* Spinner Animation (Circular Progress) */
		.spinner {
			border: 4px solid transparent;
			border-top: 4px solid #007bff; /* Blue color for the spinner */
			border-radius: 50%;
			width: 3rem;
			height: 3rem;
			animation: spin 1.5s linear infinite;
		}
			/* CSS for spinner animation */
			@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
	
		.spinner-border {
			animation: spin 2s linear infinite;
		}
		</style>
		<!-- Styling the logging you out spinner -->	
	<!-- CSS style for survey options (Start) -->
	<style>
		.active-option {
    background-color: #e7f1ff;
    color: #0d6efd;
    font-weight: 500;
}

.active-option::before {
    content: "‚úì ";
}
		/* Makes entire option clickable */
		.form-check-label {
			cursor: pointer;
			width: 100%;
			padding: 8px;
			border-radius: 4px;
		}
	
		.form-check-label:hover {
			background-color: #f8f9fa;
		}
	
		/* Better spacing for options */
		.form-check {
			margin-bottom: 8px;
		}
	
		/* Style for selected option */
		.form-check-input:checked + .form-check-label {
			background-color: #e7f1ff;
			color: #0d6efd;
			font-weight: 500;
		}
	
		/* For radio buttons specifically */
		.form-check-input[type="radio"]:checked + .form-check-label::before {
			content: "‚úì ";
		}
	</style>
	<!-- CSS style for survey options (End) -->
</head>
<body>
	<div class="wrapper">
		<div class="main-header">
			<div class="logo-header">
				<a href="#" class="logo" data-toggle="modal" data-target="#modalUpdate">
					Contact Details
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<button class="topbar-toggler more"><i class="la la-ellipsis-v"></i></button>
			</div>
			<nav class="navbar navbar-header navbar-expand-lg">
				<div class="container-fluid">
					<ul class="navbar-nav topbar-nav ml-md-auto align-items-center">
																								<!-- Message Dropdown -->
<li class="nav-item dropdown hidden-caret">
	<a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	  <i class="la la-envelope"></i>
	</a>
	<ul class="dropdown-menu notif-box msg-box" aria-labelledby="messageDropdown">
	  <li>
		<div class="dropdown-title d-flex justify-content-between align-items-center">
		  Messages
		  <a href="javascript:void(0);" onclick="openComposeMessageModal()">Compose</a>
		</div>
	  </li>
	  <li>
		<div class="message-notif-scroll" style="max-height: 250px; overflow-y: auto;">
		  <div id="messagePreviewContainer" class="notif-center">
			<!-- JS will insert message previews here -->
		  </div>
		</div>
	  </li>
	  <li>
		<a class="see-all" href="javascript:void(0);" onclick="openMessageInboxModal()"> <strong>View Inbox</strong> <i class="la la-angle-right"></i> </a>
	  </li>
	</ul>
  </li>
  
  <!-- Notification Dropdown -->
  <li class="nav-item dropdown hidden-caret">
	<a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	  <i class="la la-bell"></i>
	  <span class="notification" id="unreadCountBadge" style="display:none;"></span>
	</a>
	<ul class="dropdown-menu notif-box" aria-labelledby="notificationDropdown">
	  <li>
		<div class="dropdown-title">You have <span id="notificationTitleCount">0</span> new notification(s)</div>
	  </li>
	  <li>
		<div class="notif-center" id="notificationList">
		  <!-- JS will insert notifications here -->
		</div>
	  </li>
	</ul>
  </li>  
  <li class="nav-item dropdown">
	<a class="dropdown-toggle profile-pic" data-toggle="dropdown" href="#" aria-expanded="false"> <img alt="user-img" width="36" class="img-circle" id="profile-picture-dropdown"><span id="user-name"></span></span> </a>
	<ul class="dropdown-menu dropdown-user">
		<li>
			<div class="user-box">
				<div class="u-img"><img alt="user" id="profile-picture-box"></div>
				<div class="u-text">
					<h4 id="user-name"></h4>
					<p class="text-muted" id="user-email-dropdown"></p>
					<a href="/profile" class="btn btn-rounded btn-danger btn-sm">View Profile</a>
				</div>
				</div>
			</li>
		</ul>
		<!-- /.dropdown-user -->
	</li>
						</ul>
					</div>
				</nav>
			</div>
			<div class="sidebar">
				<div class="scrollbar-inner sidebar-wrapper">
					<div class="user">
						<div class="photo">
							<img id="profile-picture-sidebar">
						</div>
						<div class="info">
							<a class="" data-toggle="collapse" href="#collapseExample" aria-expanded="true">
								<span>
									<span id="user-name"></span> (Your ID: <span id="user-id"></span>)
									<span class="user-level" id="user-position"></span>
									<span class="caret"></span>
								</span>
							</a>
							<div class="clearfix"></div>
			
							<div class="collapse in" id="collapseExample" aria-expanded="true" >
								<ul class="nav">
									<li>
										
											<span class="link-collapse" style="color: black;">Department : <span id="user-department"></span></span>
										
									</li>
									<li>
										
										<span class="link-collapse" style="color: black;">Hired since : <span id="user-date-hired"></span></span>
									
								</li>
								<li>
										
									<span class="link-collapse" style="color: black;">Team : <span id="user-team_name"></span></span>
								
							</li>
							
									
								</ul>
							</div>
						</div>
					</div>
          					<ul class="nav">
						<li class="nav-item ">
							<a href="/user">
								<i class="la la-dashboard"></i>
								<p>Dashboard</p>
							</a>
						</li>
						<li class="nav-item ">
							<a href="/payroll">
								<i class="la la-cc-mastercard"></i>
								<p>Payroll information</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/goals">
								<i class="
								la la-crosshairs"></i>
								<p>Your goals</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/workandproductivity">
								<i class="
								la la-file-text-o"></i>
								<p>Your tasks</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/notifications">
								<i class="la la-bell"></i>
								<p>Notifications</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/trainings">
								<i class="la la-mortar-board"></i>
								<p>Training and Development</p>
							</a>
						</li>
						<li class="nav-item active">
							<a href="/feedbackandsupport">
								<i class="la la-weixin"></i>
								<p>Feedback and support</p>
							</a>
						</li>
						<li class="nav-item ">
							<a href="/financialmanagement">
								<i class="la la-usd"></i>
								<p>Financial management</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/AdministrativeTools">
								<i class="la la-gear"></i>
								<p>Administrative Tools</p>
							</a>
						</li>
						
						<li class="nav-item update-pro">
							<button class="btn btn-danger" data-toggle="modal" data-target="#logoutModal">
								<i class="la la-power-off"></i>
								<p>Logout</p>
							</button>
						</li>

						<li class="nav-item update-pro">
						<button id="viewDevicesBtn" class="btn btn-warning">
							üñ•Ô∏è View Recent Devices
						</button>
					</li>
					</ul>
				</div>
			</div>
			<div class="main-panel">
				<div class="content">
					<div class="row">
						<div class="col-md-12">
							<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <h4 class="card-title mb-0">Feedback Requests</h4>
      <p class="card-category mb-0">Respond to requests from your manager or team</p>
    </div>
    <div class="form-inline">
      <input id="searchInput" type="text" class="form-control mr-2" placeholder="Search...">
      <select id="deadlineFilter" class="form-control mr-2">
        <option value="">All Deadlines</option>
        <option value="upcoming">Upcoming</option>
        <option value="past">Past</option>
      </select>
      <select id="sortBy" class="form-control">
        <option value="desc">Newest</option>
        <option value="asc">Oldest</option>
      </select>
    </div>
  </div>
  <div class="card-body" id="feedbackContainer">
    <div class="text-center" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  </div>
</div>
						  </div>
						  <div class="col-md-12">
							<div class="card">
								<div class="card-header d-flex justify-content-between align-items-center">
									<div>
										<h4 class="card-title">Surveys & Polls</h4>
										<p class="card-category mb-0">Participate in active surveys</p>
									</div>
								</div>
								<div class="card-body">
									<div id="alertContainer"></div>
									<div id="surveyContainer">
										<div class="text-center" id="surveyLoadingSpinner">
											<div class="spinner-border text-primary" role="status">
												<span class="sr-only">Loading...</span>
											</div>
										</div>
									</div>
								</div>
							</div>
						  </div>
						  <div class="col-md-12">
							<div class="card">
							  <div class="card-header d-flex justify-content-between align-items-center">
								<div>
								  <h4 class="card-title">Ticket Requests</h4>
								  <p class="card-category mb-0">Respond to assigned support or HR tickets</p>
								</div>
								<div class="form-inline">
									
									<input id="searchInputTicket" type="text" class="form-control mr-2" placeholder="Search...">
									<select id="deadlineFilterTicket" class="form-control mr-2">
										<option value="">All Deadlines</option>
										<option value="upcoming">Upcoming</option>
										<option value="past">Past</option>
									</select>
									<select id="sortByTicket" class="form-control mr-2">
										<option value="desc">Newest</option>
										<option value="asc">Oldest</option>
									</select>
									
								  <button class="btn btn-primary" data-toggle="modal" data-target="#ticketRequestModal">Request Ticket</button>
								</div>
							  </div>
						  
							  <div class="card-body" id="ticketContainer">
								<!-- Tickets will be rendered here dynamically via JS -->
							  </div>
							</div>
						  </div>
						  <div class="col-md-12">
							<div class="card">
							  <div class="card-header d-flex justify-content-between align-items-center">
								<div>
								  <h4 class="card-title">Your Badges</h4>
								  <p class="card-category mb-0">Recognition you‚Äôve earned through your contributions</p>
								</div>
								<div class="form-inline">
								  <input id="searchInputBadge" type="text" class="form-control mr-2" placeholder="Search badges...">
								  <select id="sortBadge" class="form-control mr-2">
									<option value="desc">Newest</option>
									<option value="asc">Oldest</option>
								  </select>
								</div>
							  </div>
						  
							  <div class="card-body">
								<div class="card-body row" id="employeeBadgesContainer">
								  <!-- Badges will be rendered here via JavaScript -->
								</div>
							  </div>
							</div>
						  </div>
						  
					</div>
				</div>
				<footer class="footer">
					<div class="container-fluid">
						<nav class="pull-left">
							<ul class="nav">
								<li class="nav-item">
									<a class="nav-link" href="http://www.themekita.com">
										ThemeKita
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="#">
										Help
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="https://themewagon.com/license/#free-item">
										Licenses
									</a>
								</li>
							</ul>
						</nav>
						<div class="copyright ml-auto">
							2018, made with <i class="la la-heart heart text-danger"></i> by <a href="http://www.themekita.com">ThemeKita</a>
						</div>				
					</div>
				</footer>
			</div>
		</div>
	</div>


<!-- Edit Response Modal (Ticket table)-->
<div class="modal fade" id="editResponseModal" tabindex="-1" role="dialog" aria-labelledby="editResponseModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="editResponseForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editResponseModalLabel">Edit Response</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <textarea id="editResponseText" class="form-control" rows="4" required></textarea>
          <input type="hidden" id="editResponseId">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

  
  <!-- Delete Confirmation Modal (Ticket table) -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this response?
        <input type="hidden" id="deleteResponseId">
      </div>
      <div class="modal-footer">
        <button id="confirmDeleteBtn" class="btn btn-danger">Yes, Delete</button>
        <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

  

	<!-- Modal for requesting ticket -->
<div class="modal fade" id="ticketRequestModal" tabindex="-1" role="dialog" aria-labelledby="ticketRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="ticketRequestForm" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ticketRequestModalLabel">Request a New Ticket</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Category</label>
            <select name="category" class="form-control" required>
              <option value="">Select Category</option>
              <option value="Support">Support</option>
              <option value="HR">HR</option>
              <option value="IT">IT</option>
              <option value="General">General</option>
            </select>
          </div>
          <div class="form-group">
            <label>Subject</label>
            <input type="text" name="subject" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea name="description" class="form-control" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select name="priority" class="form-control" required>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="form-group">
            <label>Attach File (optional)</label>
            <input type="file" name="attachment" class="form-control-file">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit Ticket</button>
        </div>
      </div>
    </form>
  </div>
</div>


	  <!-- Modal for viewing attachments -->
<div class="modal fade" id="attachmentModal" tabindex="-1" role="dialog" aria-labelledby="attachmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content bg-dark">
      <div class="modal-body text-center">
        <img id="attachmentModalImage" src="" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>

  
	  <!-- Survey Modal -->
<div class="modal fade" id="surveyModal" tabindex="-1" role="dialog" aria-labelledby="surveyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="surveyModalLabel">Survey</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="surveyForm">
        <div class="modal-body">
          <div id="surveyQuestionsContainer"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="surveySubmitBtn">Submit Survey</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Alert Survey Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertModalTitle">Alert</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="alertModalBody">
        <!-- Message will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>


	  <!-- Modal for contact details -->
<div class="modal fade" id="modalUpdate" tabindex="-1" role="dialog" aria-labelledby="modalUpdatePro" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h6 class="modal-title"><i class="la la-phone-square"></i> Contact <span id="user-name"></span></h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <p>Phone number : <b><span id="user-phone"></span></b></p>
        <p>Email : <b><span id="user-email-contact"></span></b></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


	<!-- Compose Message Modal -->
<div class="modal fade" id="composeMessageModal" tabindex="-1" role="dialog" aria-labelledby="composeMessageLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="composeMessageLabel">Compose Message</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="composeForm">
          <div class="form-group">
            <label for="roleSelect">Select Role</label>
            <select id="roleSelect" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="receiverSelect">Select Receiver</label>
            <select id="receiverSelect" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="messageText">Message</label>
            <textarea class="form-control" id="messageText" rows="4" placeholder="Write your message..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" id="sendButton" class="btn btn-primary">Send Message</button>
      </div>
    </div>
  </div>
</div>

  <!-- Inbox Modal -->
<div class="modal fade" id="inboxModal" tabindex="-1" role="dialog" aria-labelledby="inboxLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="inboxLabel">Inbox</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body inbox-scrollable" id="inboxMessages">
        <!-- Messages are dynamically inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


	 <!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to logout?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmLogoutBtnCurrentUser">Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for displaying the recent devices -->
<div class="modal fade" id="recentDevicesModal" tabindex="-1" aria-labelledby="recentDevicesLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="recentDevicesLabel">Recent Devices</h5>
		  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		  </button>
		</div>
		<div class="modal-body">
		  <table class="table table-striped" id="devicesTable">
			<thead>
			  <tr>
				<th>Device</th>
				<th>OS</th>
				<th>Browser</th>
				<th>IP Address</th>
				<th>Last Seen</th>
			  </tr>
			</thead>
			<tbody>
			  <!-- Devices will be injected here -->
			</tbody>
		  </table>
		</div>
	  </div>
	</div>
  </div>

<!-- Logging you out modal -->
<div class="modal fade" id="loadingModalCurrentUser" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="max-width: 600px;">
    <div class="modal-content">
      <div class="modal-body text-center" style="padding: 30px;">
        <h4 style="font-size: 2rem; font-weight: 600; color: #007bff;">Logging you out... üîÑ</h4>
        <p style="font-size: 1.2rem; color: #6c757d; margin-top: 10px;">Please wait while we log you out from your account.</p>
        <div class="spinner-container" style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Logout Notification Modal -->
<div class="modal fade" id="multiTabLogoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title w-100" id="logoutModalLabel">Session Ended</h5>
      </div>
      <div class="modal-body">
        You have been logged out from another tab.
      </div>
      <div class="modal-footer justify-content-center">
        <div class="spinner-container" style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Token Invalid Modal -->
<div class="modal fade" id="sessionExpiredModal" tabindex="-1" role="dialog" aria-labelledby="sessionExpiredLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title w-100" id="sessionExpiredLabel">Session Expired</h5>
      </div>
      <div class="modal-body">
        Your session has ended due to another login or token expiration.
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-danger" id="redirectToLogin">Go to Login</button>
      </div>
    </div>
  </div>
</div>


    <!-- Account Deactivated Modal -->
	<div class="modal fade" id="accountDeactivatedModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger border-3 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Account Deactivated</h5>
      </div>
      <div class="modal-body fw-semibold text-danger text-center">
        Your account has been <strong>deactivated</strong> by the administrator. Please contact support for assistance.
      </div>
      <div class="modal-footer"></div>
    </div>
  </div>
</div>

    <!-- Account Terminated Modal -->
	<div class="modal fade" id="accountTerminatedModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content bg-dark text-white border-light border-2 shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title">Account Terminated</h5>
      </div>
      <div class="modal-body text-center fw-semibold">
        Your account has been <strong>terminated</strong>. Access is no longer available.
      </div>
      <div class="modal-footer border-0"></div>
    </div>
  </div>
</div>


<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white justify-content-center">
        <div class="d-flex align-items-center mx-auto">
          <h5 class="modal-title mb-0" id="successModalLabel">Success</h5>
        </div>
      </div>
      <div class="modal-body text-center" id="successModalBody"></div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white justify-content-center">
        <div class="d-flex align-items-center mx-auto">
          <h5 class="modal-title mb-0" id="errorModalLabel">Error</h5>
        </div>
      </div>
      <div class="modal-body text-center" id="errorModalBody"></div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger" id="confirmDeleteModalHeader">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this message?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtnMessage">Delete</button>
      </div>
    </div>
  </div>
</div>

	
<!-- Employee Spinner Modal (Bootstrap 4) -->
<div class="modal fade" id="employeeSpinnerModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content" style="background: rgba(255,255,255,0.90); border: none; box-shadow: none;">
      <div class="modal-body d-flex flex-column justify-content-center align-items-center" style="min-height: 170px;">
        <!-- Spinner -->
        <div style="
          width: 3.5rem;
          height: 3.5rem;
          border: 0.5rem solid #e3e6ef;
          border-top: 0.5rem solid #007bff;
          border-radius: 50%;
          animation: employee-spin 0.8s linear infinite;
          margin-bottom: 16px;">
        </div>
        <!-- Message Area -->
        <div id="employeeSpinnerMessage" style="color: #007bff; font-weight: 600; font-size: 1.15rem; letter-spacing: 0.02em;">
          Loading...
        </div>
        <style>
          @keyframes employee-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </div>
    </div>
  </div>
</div>


</body>

<!-- Use full version of jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Include jsPDF from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Other necessary custom JS -->
<script src="../../static/Employee/assets/js/core/popper.min.js"></script>
<script src="../../static/Employee/assets/js/core/bootstrap.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/chartist/chartist.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/chartist/plugin/chartist-plugin-tooltip.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/bootstrap-toggle/bootstrap-toggle.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/jquery-mapael/jquery.mapael.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/jquery-mapael/maps/world_countries.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/chart-circle/circles.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<script src="../../static/Employee/assets/js/ready.min.js"></script>
<script src="../../static/Employee/assets/js/demo.js"></script>

<!-- Script for making the spinner modal to disappear first before displaying the follow up modals (Start) -->
<script>
function showModalAfterSpinnerHide(modalSelector) {
  return new Promise((resolve) => {
    const spinner = $('#employeeSpinnerModal');

    // Helper function to ensure modal backdrop exists
    const ensureModalBackdrop = () => {
      // Check if there's already a backdrop
      const existingBackdrop = document.querySelector('.modal-backdrop');
      
      if (!existingBackdrop) {
        // Create backdrop if it doesn't exist
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.style.zIndex = '1040'; // Bootstrap's default backdrop z-index
        document.body.appendChild(backdrop);
      }
    };

    // Function to show the target modal after hiding spinner
    const showTargetModal = () => {
      // Ensure backdrop exists before showing modal
      ensureModalBackdrop();
      
      $(modalSelector).modal('show');
      setTimeout(() => {
        document.body.classList.add('modal-open');
        resolve();
      }, 150); // Slightly increased delay for better backdrop handling
    };

    // If spinner is already hidden
    if (!spinner.hasClass('show')) {
      showTargetModal();
    } else {
      // Wait until spinner finishes hiding
      spinner.one('hidden.bs.modal', () => {
        // Small delay to ensure spinner is fully hidden and backdrop is ready
        setTimeout(showTargetModal, 100);
      });
      spinner.modal('hide');
    }
  });
}
</script>
<!-- Script for making the spinner modal to disappear first before displaying the follow up modals (End) -->

<!-- Script for displaying spinner (Start) -->
<script>
(function () {
  const modalId = 'employeeSpinnerModal';
  let _spinnerOpen = false;
  let _eventAttached = false;
  let _forceHideTimeoutId = null;
  let _pendingModals = []; // Track modals that need to be shown after spinner

  function getModalElement() {
    return document.getElementById(modalId);
  }

  function showEmployeeSpinner() {
    console.log('[Spinner] showEmployeeSpinner called');
    const modalElement = getModalElement();
    if (!modalElement || typeof jQuery === "undefined") return;

    if (!_eventAttached) {
      jQuery(modalElement).off('hidden.bs.modal', spinnerHiddenHandler);
      jQuery(modalElement).on('hidden.bs.modal', spinnerHiddenHandler);
      _eventAttached = true;
    }

    if (!_spinnerOpen) {
      jQuery(modalElement).modal({
        backdrop: 'static',
        keyboard: false,
        show: true
      });
      _spinnerOpen = true;
      _forceHideTimeoutId = setTimeout(forceHideSpinner, 30000); // fallback
    }
  }

  function hideEmployeeSpinner() {
    console.log('[Spinner] hideEmployeeSpinner called');
    const modalElement = getModalElement();
    if (!modalElement || typeof jQuery === "undefined") return;

    if (_spinnerOpen) {
      jQuery(modalElement).modal('hide');
      _spinnerOpen = false;
      setTimeout(forceHideSpinner, 2000);
    }
  }

  function spinnerHiddenHandler() {
    console.log('[Spinner] spinnerHiddenHandler (hidden.bs.modal) fired');
    _spinnerOpen = false;
    if (_forceHideTimeoutId) clearTimeout(_forceHideTimeoutId);
    
    // Check if there are other modals that need backdrop
    const hasOtherModals = checkForOtherActiveModals();
    
    if (!hasOtherModals) {
      removeAllBackdrops();
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    } else {
      // Keep modal-open class and padding for other modals
      console.log('[Spinner] Preserving modal state for other active modals');
    }
  }

  function forceHideSpinner() {
    const modalElement = getModalElement();
    if (!modalElement) return;

    jQuery(modalElement).modal('hide');
    jQuery(modalElement).hide();
    _spinnerOpen = false;
    if (_forceHideTimeoutId) clearTimeout(_forceHideTimeoutId);
    
    // Check if there are other modals that need backdrop
    const hasOtherModals = checkForOtherActiveModals();
    
    if (!hasOtherModals) {
      removeAllBackdrops();
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    }
    
    console.log('[Spinner] forceHideSpinner called (emergency fallback)');
  }

  function checkForOtherActiveModals() {
    // Check for any other visible modals
    const allModals = document.querySelectorAll('.modal');
    for (let modal of allModals) {
      if (modal.id !== modalId && (modal.classList.contains('show') || jQuery(modal).hasClass('show'))) {
        return true;
      }
    }
    return false;
  }

  function removeAllBackdrops() {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(el => el.parentNode && el.parentNode.removeChild(el));
  }

  // Enhanced function to check if spinner is currently visible
  function isSpinnerVisible() {
    const modalElement = getModalElement();
    if (!modalElement) return false;
    
    return _spinnerOpen || 
           modalElement.classList.contains('show') || 
           jQuery(modalElement).hasClass('show') ||
           jQuery(modalElement).is(':visible');
  }

  // Function to wait for spinner to hide before executing callback
  function waitForSpinnerHide(callback) {
    if (!isSpinnerVisible()) {
      // Spinner is already hidden, execute callback with small delay
      setTimeout(callback, 100);
      return;
    }

    // Listen for spinner hidden event
    const modalElement = getModalElement();
    if (modalElement) {
      jQuery(modalElement).one('hidden.bs.modal', function() {
        setTimeout(callback, 150);
      });
    }

    // Fallback polling
    let attempts = 0;
    const maxAttempts = 50;
    
    const checkHidden = () => {
      attempts++;
      if (!isSpinnerVisible() || attempts >= maxAttempts) {
        setTimeout(callback, 150);
      } else {
        setTimeout(checkHidden, 100);
      }
    };

    setTimeout(checkHidden, 100);
  }

  // Export functions globally
  window.showEmployeeSpinner = showEmployeeSpinner;
  window.hideEmployeeSpinner = hideEmployeeSpinner;
  window.waitForSpinnerHide = waitForSpinnerHide;
  window.isSpinnerVisible = isSpinnerVisible;

  document.addEventListener('keydown', function (e) {
    if (e.altKey && e.key.toLowerCase() === 's') {
      console.log('[Spinner] Alt+S pressed, force hiding spinner');
      forceHideSpinner();
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    // Only clean up if no modals are active
    if (!checkForOtherActiveModals()) {
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
      removeAllBackdrops();
    }
  });
})();
</script>
 <!-- Script for displaying spinner (End) -->

<!-- Script for displaying success and error modal (Start) -->
 <script>
function showSuccessModal(message) {
  document.getElementById('successModalBody').textContent = message;
  $('#successModal').modal('show');
}

function showErrorModal(message) {
  document.getElementById('errorModalBody').textContent = message;
  $('#errorModal').modal('show');
}
 </script>
 <!-- Script for displaying success and error modal (End) -->

<!-- Script for checking 2FA (Start) -->
<script>
(function () {
  const modalId = 'employeeSpinnerModal';
  let _spinnerOpen = false;
  let _eventAttached = false;
  let _forceHideTimeoutId = null;

  function getModalElement() {
    return document.getElementById(modalId);
  }

  function showEmployeeSpinner() {
    const modalElement = getModalElement();
    if (!modalElement || typeof jQuery === "undefined") return;

    if (!_eventAttached) {
      jQuery(modalElement).off('hidden.bs.modal', spinnerHiddenHandler);
      jQuery(modalElement).on('hidden.bs.modal', spinnerHiddenHandler);
      _eventAttached = true;
    }

    if (!_spinnerOpen) {
      jQuery(modalElement).modal({
        backdrop: 'static',
        keyboard: false,
        show: true
      });
      _spinnerOpen = true;
      _forceHideTimeoutId = setTimeout(forceHideSpinner, 30000); // fallback
    }
  }

  function hideEmployeeSpinner() {
    const modalElement = getModalElement();
    if (!modalElement || typeof jQuery === "undefined") return;

    if (_spinnerOpen) {
      jQuery(modalElement).modal('hide');
      _spinnerOpen = false;
      setTimeout(forceHideSpinner, 2000);
    }
  }

  function spinnerHiddenHandler() {
    _spinnerOpen = false;
    if (_forceHideTimeoutId) clearTimeout(_forceHideTimeoutId);

    // Check for other active modals
    const hasOtherModals = checkForOtherActiveModals();

    if (!hasOtherModals) {
      removeAllBackdrops();
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    }
  }

  function forceHideSpinner() {
    const modalElement = getModalElement();
    if (!modalElement) return;

    jQuery(modalElement).modal('hide');
    jQuery(modalElement).hide();
    _spinnerOpen = false;
    if (_forceHideTimeoutId) clearTimeout(_forceHideTimeoutId);

    const hasOtherModals = checkForOtherActiveModals();
    if (!hasOtherModals) {
      removeAllBackdrops();
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    }
  }

  function checkForOtherActiveModals() {
    const allModals = document.querySelectorAll('.modal');
    for (let modal of allModals) {
      if (modal.id !== modalId && (modal.classList.contains('show') || jQuery(modal).hasClass('show'))) {
        return true;
      }
    }
    return false;
  }

  function removeAllBackdrops() {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(el => el.parentNode && el.parentNode.removeChild(el));
  }

  function isSpinnerVisible() {
    const modalElement = getModalElement();
    if (!modalElement) return false;
    return _spinnerOpen || 
           modalElement.classList.contains('show') ||
           jQuery(modalElement).hasClass('show') ||
           jQuery(modalElement).is(':visible');
  }

  function waitForSpinnerHide(callback) {
    if (!isSpinnerVisible()) {
      setTimeout(callback, 100);
      return;
    }

    const modalElement = getModalElement();
    if (modalElement) {
      jQuery(modalElement).one('hidden.bs.modal', function() {
        setTimeout(callback, 150);
      });
    }

    let attempts = 0;
    const maxAttempts = 50;
    const checkHidden = () => {
      attempts++;
      if (!isSpinnerVisible() || attempts >= maxAttempts) {
        setTimeout(callback, 150);
      } else {
        setTimeout(checkHidden, 100);
      }
    };
    setTimeout(checkHidden, 100);
  }

  window.showEmployeeSpinner = showEmployeeSpinner;
  window.hideEmployeeSpinner = hideEmployeeSpinner;
  window.waitForSpinnerHide = waitForSpinnerHide;
  window.isSpinnerVisible = isSpinnerVisible;
})();

function employeeSecureFetch(url, options = {}) {
  options.headers = options.headers || {};
  const token = sessionStorage.getItem('employeeToken');
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  options.headers['X-Requested-With'] = 'XMLHttpRequest';

  const showSpinner = options.showSpinner !== false;
  let didRedirect = false;

  if (showSpinner) {
    showEmployeeSpinner();
  }

  const finalize = async () => {
    if (!didRedirect && showSpinner) {
      hideEmployeeSpinner();
      await new Promise(resolve => waitForSpinnerHide(resolve));
    }
  };

  return fetch(url, options)
    .then(async res => {
      let data;
      try { data = await res.clone().json(); } catch { data = {}; }
      if (res.status === 403 && data?.error === "2FA_REQUIRED" && data.redirect) {
        didRedirect = true;
        window.location.href = data.redirect;
        return Promise.reject("2FA required, redirecting");
      }
      if ((res.status === 401 || res.status === 403) && data.redirect) {
        didRedirect = true;
        window.location.href = data.redirect;
        return Promise.reject(data.error || "Unauthorized, redirecting");
      }
      if (!res.ok) {
        throw new Error(data.message || "An error occurred");
      }
      if (options.showSuccessMessage) {
        // Use your preferred success modal logic here
      }
      return data;
    })
    .catch(err => {
      if (!didRedirect && !options.suppressErrorModal) {
        // Use your preferred error modal logic here
      }
      throw err;
    })
    .finally(finalize);
}

</script>
<!-- Script for checking 2FA (End) -->

<!-- Script for checking if the account is terminated or deactivated (Start) -->
<script>
  // Robust periodic account status checker (relies on employeeSecureFetch for spinner and error modal logic)

/**
 * Periodically checks the user's employee account status.
 * If the account is deactivated or terminated, shows the appropriate modal and cleans up all backdrops.
 */
function checkAccountStatusPeriodically() {
  async function checkStatus() {
    try {
      // Use the secure fetch (no spinner; error modal shown automatically)
      await employeeSecureFetch('/api/employee_status', { showSpinner: false });
      // If fetch succeeds, account is active: do nothing
    } catch (err) {
      // If error is a string from employeeSecureFetch (e.g., redirect message), ignore (handled already)
      if (typeof err === 'string') return;

      try {
        // Fallback: direct fetch in case of edge errors
        const res = await fetch('/api/employee_status', {
          headers: {
            'Authorization': `Bearer ${sessionStorage.getItem('employeeToken') || ''}`,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (res.status === 401 || res.status === 403) {
          let data;
          try {
            data = await res.json();
          } catch {
            data = {};
          }
          const status = data.status?.toLowerCase();

          let modalId = '';
          if (status === 'deactivated') {
            modalId = '#accountDeactivatedModal';
          } else if (status === 'terminated') {
            modalId = '#accountTerminatedModal';
          }
          if (modalId) {
            // Show modal with static backdrop, no keyboard dismissal
            $(modalId).modal({ backdrop: 'static', keyboard: false, show: true });
          }

          setTimeout(function () {
            sessionStorage.clear();
            sessionStorage.clear();
            // Clean up stray backdrops just in case
            if (window.EmployeeModals && typeof window.EmployeeModals._removeStrayBackdrops === 'function') {
              window.EmployeeModals._removeStrayBackdrops();
            }
            window.location.href = '/';
          }, 5000);
        }
      } catch (modalErr) {
        console.error('Modal error:', modalErr);
        if (window.EmployeeModals && typeof window.EmployeeModals._removeStrayBackdrops === 'function') {
          window.EmployeeModals._removeStrayBackdrops();
        }
      }
    }
  }

  checkStatus();
  setInterval(checkStatus, 10000);
}

document.addEventListener('DOMContentLoaded', checkAccountStatusPeriodically);
</script>
<!-- Script for checking if the account is terminated or deactivated (End) -->

<!-- Script for redirecting the employee back to login page when the token is blacklisted or overwritten (Start) -->
<script>
  // Seamless session expiry checker (spinner and error modal logic handled by employeeSecureFetch)

/**
 * Checks token validity using employeeSecureFetch.
 * If invalid, triggers the session expired modal.
 */
function checkTokenValidity() {
  employeeSecureFetch('/validate_token', { method: 'GET', showSpinner: false })
    .catch(() => {
      showExpiredModal();
    });
}

/**
 * Shows the session expired modal,
 * ensuring backdrops are cleared and input is blocked outside the modal.
 */
function showExpiredModal() {
  // Robustly remove any stray backdrops or spinner artifacts
  if (window.EmployeeModals && typeof window.EmployeeModals._removeStrayBackdrops === 'function') {
    window.EmployeeModals._removeStrayBackdrops();
  }

  // Show modal with static backdrop
  $('#sessionExpiredModal').modal({
    backdrop: 'static',
    keyboard: false,
    show: true
  });

  // Ensure modal-open class for scrolling lock
  document.body.classList.add("modal-open");

  // Disable all interactive elements outside the modal
  document.querySelectorAll('button, a, input, select, textarea').forEach(el => {
    if (!el.closest('#sessionExpiredModal')) {
      el.setAttribute('disabled', 'disabled');
    }
  });

  // Attach click handler for login redirect
  const loginBtn = document.getElementById('redirectToLogin');
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      sessionStorage.removeItem('employeeToken');
      window.location.href = '/';
    });
  }
}

// Periodically check token validity
setInterval(checkTokenValidity, 10000);
</script>
<!-- Script for redirecting the employee back to login page when the token is blacklisted or overwritten (End) -->

<!-- Script for loading user data from API routes (Start) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    showEmployeeSpinner();
    const spinnerShownAt = Date.now(); // For minimum display duration

    console.log("üì¶ DOM fully loaded and parsed.");

    employeeSecureFetch("/api/profile-info", { method: "GET" })
        .then(data => {
            console.log("üìÑ Parsed response data:", data);

            const user = data.user;
            const userRole = data.employee_role;

            if (!user) {
                throw new Error("User data not found in response");
            }

            console.log("üë§ Populating UI with user data:", user);

            const displayValue = val =>
                val === null || val === undefined || val === "" ? "N/A" : val;

            const safeSet = (id, value, prop = "textContent") => {
                const el = document.getElementById(id);
                if (el) {
                    if (prop === "src") el.src = value;
                    else el.textContent = displayValue(value);
                    console.log(`‚úÖ Set #${id} ‚Üí`, value);
                } else {
                    console.warn(`‚ö†Ô∏è Element with id "${id}" not found.`);
                }
            };

            let cacheBustedUrl = "";
            if (user.profile_picture_url) {
                cacheBustedUrl =
                    user.profile_picture_url +
                    (user.profile_picture_url.includes("?") ? "&" : "?") +
                    "v=" +
                    Date.now();
            }

            safeSet("profile-picture", cacheBustedUrl || "N/A", "src");
            safeSet("profile-picture-dropdown", cacheBustedUrl || "N/A", "src");
            safeSet("profile-picture-box", cacheBustedUrl || "N/A", "src");
            safeSet("profile-picture-sidebar", cacheBustedUrl || "N/A", "src");

            safeSet("user-email-dropdown", user.email);
            safeSet("user-id", user.employee_id);
            safeSet("user-position", user.role_name);
            safeSet("user-name", user.first_name + " " + user.last_name);
            safeSet("user-department", user.department);
            safeSet("user-date-hired", user.date_hired);
            safeSet("user-team_name", user.team_name);
            safeSet("user-email-contact", user.email);
            safeSet("user-phone", user.phone_number);

            safeSet("position-modal-detail", user.role_name);
            safeSet("first-name-modal", user.first_name);
            safeSet("last-name-modal", user.last_name);
            safeSet("email", user.email);
            safeSet("phone-number-modal", user.phone_number);
            safeSet("phone-number-modal-emergency", user.phone_number);
            safeSet("department-modal", user.department);
            safeSet("department-modal-detail", user.department);
            safeSet("address1-modal", user.address1);
            safeSet("address2-modal", user.address2);
            safeSet("certification", user.certification);
            safeSet("skills", user.skills);
            safeSet("education", user.education);
            safeSet("language", user.language);
            safeSet("hobbies", user.hobbies);
            safeSet("city-modal", user.city);

            if (typeof initMessagingFeatures === "function") {
                console.log("üì¨ Initializing messaging features...");
                initMessagingFeatures({
                    user: user,
                    employee_role: userRole
                });
            } else {
                console.log("‚ÑπÔ∏è initMessagingFeatures() not found, skipping messaging setup.");
            }
        })
        .catch(error => {
            console.error("‚ùå Error loading profile info:", error);
            alert("Error loading profile info. Please try again later or contact support.");
        })
        .finally(() => {
            const elapsed = Date.now() - spinnerShownAt;
            const minDelay = 800; // ms minimum display time
            if (elapsed < minDelay) {
                setTimeout(hideEmployeeSpinner, minDelay - elapsed);
            } else {
                hideEmployeeSpinner();
            }
        });
});
</script>
<!-- Script for loading user data from API routes (End) -->

<!-- Script for messages and notifications (Start) -->
<script>
  // Employee Messaging Module - Seamless spinner, success, and error handling using employeeSecureFetch

// Globals
let previousUnreadCount = 0;
let messageIdToDelete = null;
let userData = null;

/**
 * Fetches messages from inbox.
 * @returns {Promise<Array>}
 */
function fetchMessages(url = '/employee/messages/inbox') {
  return employeeSecureFetch(url, { method: 'GET' })
    .then(messages => {
      if (Array.isArray(messages)) return messages;
      if (Array.isArray(messages.messages)) return messages.messages;
      return [];
    });
}

/**
 * Opens the compose message modal, fetching roles.
 */
function openComposeMessageModal() {
  employeeSecureFetch("/employee/roles", { method: 'GET' })
    .then(roleData => {
      $('#composeMessageModal').modal('show');
      const roleSelect = document.getElementById("roleSelect");
      roleSelect.innerHTML = '<option disabled selected>Select a role</option>';
      roleData.forEach(role => {
        const option = document.createElement("option");
        option.value = role.role_id;
        option.textContent = role.role_name;
        roleSelect.appendChild(option);
      });
      if (roleData.length > 0) {
        roleSelect.selectedIndex = 1;
        roleSelect.dispatchEvent(new Event("change"));
        handleRoleChange();
      }
    })
    .catch(err => {
      console.error("[openComposeMessageModal] Error:", err);
      showMessageModal("Failed to load compose modal.", false);
    });
}

/**
 * Opens the message inbox modal and populates messages.
 */
function openMessageInboxModal() {
  fetchMessages()
    .then(messages => {
      const container = document.getElementById('inboxMessages');
      container.innerHTML = '';
      if (!messages || messages.length === 0) {
        container.innerHTML = '<p class="text-muted">No messages found.</p>';
      } else {
        messages.forEach(msg => {
          const card = createMessageCard(msg);
          container.appendChild(card);
        });
      }
      $('#inboxModal').modal('show');
    })
    .catch(err => {
      console.error("[openMessageInboxModal] Error:", err);
      showMessageModal("Failed to load inbox messages.", false);
    });
}

/**
 * Creates a DOM card for a message.
 * @param {Object} msg
 * @returns {HTMLElement}
 */
function createMessageCard(msg) {
  const card = document.createElement('div');
  card.className = 'card mb-2';
  card.innerHTML = `
    <div class="card-body">
      <h6 class="card-subtitle mb-1 text-muted">
        From ${msg.sender_role?.toUpperCase() || ''} (User ID: ${msg.sender_id})
      </h6>
      <p class="card-text">${msg.content}</p>
      <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
      ${!msg.is_read ? `<button class="btn btn-sm btn-outline-primary float-right ml-2" onclick="markAsRead(${msg.message_id})">Mark as Read</button>` : ''}
      <button class="btn btn-sm btn-outline-danger float-right" onclick="showDeleteConfirmModal(${msg.message_id})">Delete</button>
    </div>`;
  return card;
}

/**
 * Shows the delete confirm modal for a message.
 * @param {number} messageId
 */
function showDeleteConfirmModal(messageId) {
  messageIdToDelete = messageId;
  $('#confirmDeleteModal').modal('show');
}

// Confirm delete handler
document.addEventListener('DOMContentLoaded', function() {
  const deleteBtn = document.getElementById('confirmDeleteBtnMessage');
  if (deleteBtn) {
    deleteBtn.onclick = function() {
      if (messageIdToDelete !== null) {
        actuallyDeleteMessage(messageIdToDelete);
        messageIdToDelete = null;
        $('#confirmDeleteModal').modal('hide');
      }
    };
  }
});

/**
 * Deletes a message.
 * @param {number} messageId
 */
function actuallyDeleteMessage(messageId) {
  employeeSecureFetch(`/employee/messages/delete/${messageId}`, { method: 'DELETE' })
    .then(response => {
      showMessageModal("Message deleted successfully.", true);
      openMessageInboxModal();
      loadMessageNotifications(userData.user.employee_id, userData.employee_role);
    })
    .catch(err => {
      console.error("[deleteMessage] Error:", err);
      showMessageModal("Failed to delete message.", false);
    });
}

/**
 * Marks a message as read.
 * @param {number} messageId
 */
function markAsRead(messageId) {
  employeeSecureFetch(`/employee/messages/read/${messageId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({})
  })
    .then(() => {
      openMessageInboxModal();
      loadMessageNotifications(userData.user.employee_id, userData.employee_role);
    })
    .catch(err => {
      console.error("[markAsRead] Error:", err);
      showMessageModal("Failed to mark message as read.", false);
    });
}

/**
 * Loads unread message count and updates UI.
 * @param {string} userId
 * @param {string} role
 */
function loadMessageNotifications(userId, role) {
  const url = `/employee/messages/unread-count?user_id=${userId}&role=${role}`;
  employeeSecureFetch(url, { method: 'GET', showSpinner: false })
    .then(data => {
      updateUnreadCountBadge(data.unread_count);
      updateNotificationList(data.unread_count);
      if (data.unread_count > previousUnreadCount) {
        playNotificationSound();
        showNewMessageNotification(data.unread_count - previousUnreadCount);
      }
      previousUnreadCount = data.unread_count;
    })
    .catch(error => {
      console.error("[loadMessageNotifications] Error:", error);
      showMessageModal("Failed to load unread messages count.", false);
    });
}

/**
 * Updates the unread badge in the UI.
 * @param {number} count
 */
function updateUnreadCountBadge(count) {
  const badge = document.getElementById('unreadCountBadge');
  if (!badge) return;
  badge.innerText = count;
  badge.style.display = count === 0 ? 'none' : 'inline-block';
}

/**
 * Updates the notification dropdown.
 * @param {number} count
 */
function updateNotificationList(count) {
  const list = document.getElementById('notificationList');
  if (!list) return;
  list.innerHTML = count > 0
    ? `<a class="dropdown-item preview-item" href="#" onclick="openMessageInboxModal()">
        <div class="preview-thumbnail">
          <div class="preview-icon bg-warning">
            <i class="mdi mdi-email-alert text-white"></i>
          </div>
        </div>
        <div class="preview-item-content">
          <h6 class="preview-subject font-weight-normal">You have ${count} unread message${count > 1 ? 's' : ''}</h6>
          <p class="font-weight-light small-text text-muted mb-0">Check your inbox</p>
        </div>
      </a>`
    : '<p class="px-3 text-muted">Empty</p>';
}

/**
 * Shows a notification for new messages.
 * @param {number} newCount
 */
function showNewMessageNotification(newCount) {
  if (Notification.permission === 'granted') {
    new Notification(`New Message${newCount > 1 ? 's' : ''}`, {
      body: `You have ${newCount} new unread message${newCount > 1 ? 's' : ''}.`,
      icon: '/path/to/your/message-icon.png'
    });
  }
}

/**
 * Plays a notification sound.
 */
function playNotificationSound() {
  const audio = document.getElementById('messageSound');
  if (audio) {
    audio.play().catch(err => console.error("[playNotificationSound] Play error:", err));
  }
}

/**
 * Handles a role change in the compose message modal.
 */
function handleRoleChange() {
  const roleSelect = document.getElementById("roleSelect");
  const roleId = roleSelect.value;
  if (!roleId) return;
  const url = `/employee/users/by_role/${roleId}`;
  employeeSecureFetch(url, { method: 'GET' })
    .then(users => {
      const receiverSelect = document.getElementById("receiverSelect");
      receiverSelect.innerHTML = '';
      if (!users || users.length === 0) {
        receiverSelect.innerHTML = '<option disabled selected>No users available</option>';
      } else {
        const defaultOption = document.createElement("option");
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.value = "";
        defaultOption.textContent = "Select a receiver";
        receiverSelect.appendChild(defaultOption);
        users.forEach(user => {
          const option = document.createElement("option");
          option.value = user.user_id;
          option.setAttribute("data-email", user.email);
          option.textContent = user.email;
          receiverSelect.appendChild(option);
        });
      }
    })
    .catch(err => {
      console.error("[handleRoleChange] Error:", err);
      showMessageModal("Failed to load users for the selected role.", false);
    });
}

/**
 * Sends a message from the compose modal.
 */
function sendMessage() {
  const receiverSelect = document.getElementById("receiverSelect");
  const selectedOption = receiverSelect.options[receiverSelect.selectedIndex];
  if (!selectedOption || selectedOption.disabled) {
    showMessageModal("Please select a valid receiver.", false);
    return;
  }
  const receiverId = parseInt(selectedOption.value);
  const receiverEmail = selectedOption.getAttribute("data-email");
  const receiverRoleText = document.getElementById("roleSelect").selectedOptions[0]?.text || "Unknown";
  const message = document.getElementById("messageText").value;
  if (!message.trim()) {
    showMessageModal("Please enter a message.", false);
    return;
  }
  const payload = {
    sender_id: userData.user.employee_id,
    sender_role: userData.employee_role,
    receiver_id: receiverId,
    receiver_email: receiverEmail,
    receiver_role: receiverRoleText,
    subject: "No Subject",
    body: message
  };
  employeeSecureFetch('/employee/messages/send', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify(payload)
  })
    .then(response => {
      showMessageModal("Message sent!", true);
      $('#composeMessageModal').modal('hide');
    })
    .catch(err => {
      console.error("[sendMessage] Error:", err);
      showMessageModal('Failed to send message.', false);
    });
}

/**
 * Shows a message modal (success or error) using the correct modal IDs.
 * @param {string} message
 * @param {boolean} isSuccess
 */
function showMessageModal(message, isSuccess = true) {
  if (isSuccess) {
    const body = document.getElementById("successModalBody");
    if (body) body.textContent = message || "Success!";
    $('#successModal').modal('show');
  } else {
    const body = document.getElementById("errorModalBody");
    if (body) body.textContent = message || "An error occurred!";
    $('#errorModal').modal('show');
  }
}

/**
 * Initializes messaging features.
 * @param {Object} data
 */
function initMessagingFeatures(data) {
  userData = data;
  const roleSelect = document.getElementById("roleSelect");
  const sendButton = document.getElementById("sendButton");
  if (roleSelect) roleSelect.addEventListener("change", handleRoleChange);
  if (sendButton) sendButton.addEventListener("click", sendMessage);
  fetchMessages();
  loadMessageNotifications(userData.user.employee_id, userData.employee_role);
  setInterval(() => loadMessageNotifications(userData.user.employee_id, userData.employee_role), 30000);

  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      console.log("[initMessagingFeatures] Notification permission:", permission);
    });
  }
}
</script>
<!-- Script for messages and notifications (End) -->

<!-- Script for displaying the recent devices that is logged in (Start) -->
<script>
  $('#viewDevicesBtn').on('click', function () {
    employeeSecureFetch('/recent-devices', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(data => {
      // Wait for spinner to hide before showing modal and updating DOM
      $('#employeeSpinnerModal').one('hidden.bs.modal', () => {
        const tableBody = $('#devicesTable tbody');
        tableBody.empty();

        if (data.success) {
          if (data.devices.length === 0) {
            tableBody.html('<tr><td colspan="5" class="text-center">No devices found.</td></tr>');
          } else {
            data.devices.forEach(device => {
              const row = `
                <tr>
                  <td>${device.device_name}</td>
                  <td>${device.device_os}</td>
                  <td>${device.browser_name}</td>
                  <td>${device.ip_address}</td>
                  <td>${device.issued_at}</td>
                </tr>`;
              tableBody.append(row);
            });
          }
        } else {
          tableBody.html('<tr><td colspan="5" class="text-center text-danger">Failed to load recent devices.</td></tr>');
        }

        // Now show the recent devices modal after spinner hidden and table updated
        $('#recentDevicesModal').modal('show');

        // Fix Bootstrap removing modal-open class for multiple modals
        setTimeout(() => {
          if ($('#recentDevicesModal').hasClass('show')) {
            document.body.classList.add('modal-open');
          }
        }, 100);
      });

      // Hide spinner modal (will trigger the one('hidden.bs.modal') handler above)
      $('#employeeSpinnerModal').modal('hide');
    })
    .catch(error => {
      console.error('Error fetching recent devices:', error);
      const tableBody = $('#devicesTable tbody');
      tableBody.empty();
      tableBody.html('<tr><td colspan="5" class="text-center text-danger">Failed to load recent devices.</td></tr>');

      // Also hide spinner if visible
      $('#employeeSpinnerModal').modal('hide');

      // Show recent devices modal anyway (or show an error modal if you prefer)
      $('#recentDevicesModal').modal('show');

      setTimeout(() => {
        if ($('#recentDevicesModal').hasClass('show')) {
          document.body.classList.add('modal-open');
        }
      }, 100);
    });
  });
</script>
<!-- Script for displaying the recent devices that is logged in (End) -->

<!-- Script for handling logout confirmation (Current User) (Start) -->
<script>
  let tokenCheckIntervalId = null;

  function checkTokenValidity() {
    employeeSecureFetch('/validate_token', { method: 'GET', showSpinner: false })
      .catch(err => {
        showExpiredModal();
      });
  }

  function showExpiredModal() {
    $('#sessionExpiredModal').modal({
      backdrop: 'static',
      keyboard: false
    });

    $('#sessionExpiredModal').modal('show');

    document.body.classList.add("modal-open");
    document.querySelectorAll('button, a, input, select, textarea').forEach(el => {
      if (!el.closest('#sessionExpiredModal')) {
        el.setAttribute('disabled', 'disabled');
      }
    });

    document.getElementById('redirectToLogin').addEventListener('click', () => {
      sessionStorage.removeItem('employeeToken');
      window.location.href = '/';
    });
  }

  tokenCheckIntervalId = setInterval(checkTokenValidity, 10000);

  document.addEventListener('DOMContentLoaded', function () {
    const logoutBtn = document.getElementById('confirmLogoutBtnCurrentUser');
    if (!logoutBtn) return;

    logoutBtn.addEventListener('click', function () {
      clearInterval(tokenCheckIntervalId);

      const token = sessionStorage.getItem("employeeToken"); // üëà Read BEFORE removing

      $('#loadingModalCurrentUser').modal('show');
      $('#logoutModal').modal('hide');

      fetch("{{ url_for('login_bp.logout') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`  // üëà Add token to header
        }
      })
      .then(res => {
        sessionStorage.removeItem("employeeToken"); // üëà Now safe to remove
        setTimeout(() => {
          window.location.href = "/";
        }, 3000);
      })
      .catch(err => {
        sessionStorage.removeItem("employeeToken");
        setTimeout(() => {
          window.location.href = "/";
        }, 3000);
      });
    });
  });
</script>
<!-- Script for handling logout confirmation (Current User (End) -->


<!-- Script for displaying health and wellness resource (Start) -->
<script>
	// Assumes employeeSecureFetch is globally defined

	$(document).ready(function () {
	  const descriptions = {
		'Safety Training': 'Access resources about safety protocols and emergency procedures.',
		'Mental Health': 'Find resources that support your emotional and psychological well-being.',
		'Skill Development': 'Explore content to grow your professional and personal skills.',
		'all': 'Browse all learning resources available to support your development.'
	  };

	  function updateDescription(category) {
		const desc = descriptions[category] || '';
		$('#resourceCategoryDescription').text(desc);
	  }

	  function fetchAndDisplayResources() {
  showEmployeeSpinner();
  const spinnerShownAt = Date.now();
  const search = $('#searchInputResource').val().toLowerCase();
  const sort = $('#sortResource').val();
  const category = $('#filterResourceCategory').val();

  employeeSecureFetch('/employee/health_resources', { method: 'GET' })
    .then(resources => {
      let filtered = resources;

      if (category !== 'all') {
        filtered = filtered.filter(r => r.category === category);
      }

      if (search) {
        filtered = filtered.filter(r =>
          r.title.toLowerCase().includes(search) ||
          r.description.toLowerCase().includes(search)
        );
      }

      if (sort === 'asc') {
        filtered.sort((a, b) => a.resource_id - b.resource_id);
      } else {
        filtered.sort((a, b) => b.resource_id - a.resource_id);
      }

      renderResources(filtered);
    })
    .catch(() => {
      $('#employeeResourcesContainer').html('<div class="col-12 text-center text-danger">Failed to load resources.</div>');
    })
    .finally(() => {
      const elapsed = Date.now() - spinnerShownAt;
      const minDelay = 800;
      if (elapsed < minDelay) {
        setTimeout(hideEmployeeSpinner, minDelay - elapsed);
      } else {
        hideEmployeeSpinner();
      }
    });
}

	  function renderResources(resources) {
		const container = $('#employeeResourcesContainer');
		container.empty();

		if (resources.length === 0) {
		  container.append('<div class="col-12 text-center text-muted">No resources found.</div>');
		  return;
		}

		resources.forEach(resource => {
		  const imageUrl = resource.file_path && resource.file_path.startsWith('/static')
			? resource.file_path
			: '/static/default_resource.png';

		  const card = `
			<div class="col-md-4 mb-3">
			  <div class="card h-100 shadow-sm">
				<div class="card-body text-center">
				  <img src="${imageUrl}" alt="${resource.title}" class="mb-3" style="width: 60px; height: 60px;">
				  <h5 class="card-title">${resource.title}</h5>
				  <p class="card-text small">${resource.description}</p>
				  ${resource.url ? `<a href="${resource.url}" target="_blank" class="btn btn-sm btn-outline-primary">View Resource</a>` : ''}
				</div>
			  </div>
			</div>`;
		  container.append(card);
		});
	  }

	  $('#searchInputResource, #sortResource').on('input change', fetchAndDisplayResources);
	  $('#filterResourceCategory').on('change', function () {
		const selectedCategory = $(this).val();
		updateDescription(selectedCategory);
		fetchAndDisplayResources();
	  });

	  // Initial setup
	  updateDescription('Safety Training');
	  fetchAndDisplayResources();
	});
</script>
<!-- Script for displaying health and wellness resource (End) -->

<!-- Script for displaying badge (Start) -->
<script>
	let allBadges = [];

	document.addEventListener('DOMContentLoaded', function () {
		showEmployeeSpinner();
const spinnerShownAt = Date.now();
	  // Use employeeSecureFetch instead of fetch
	   employeeSecureFetch('/employee/badges', { method: 'GET' })
    .then(data => {
      allBadges = data;
      filterAndRenderBadges();
      const elapsed = Date.now() - spinnerShownAt;
      setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
    })
    .catch(error => {
      console.error('Error fetching badges:', error);
      const elapsed = Date.now() - spinnerShownAt;
      setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
    });

  document.getElementById('searchInputBadge').addEventListener('input', filterAndRenderBadges);
  document.getElementById('sortBadge').addEventListener('change', filterAndRenderBadges);
});

	function filterAndRenderBadges() {
	  const searchQuery = document.getElementById('searchInputBadge').value.toLowerCase();
	  const sortOrder = document.getElementById('sortBadge').value;

	  let filtered = allBadges.filter(b => 
		b.title.toLowerCase().includes(searchQuery) || 
		b.description.toLowerCase().includes(searchQuery)
	  );

	  filtered.sort((a, b) => {
		const dateA = new Date(a.assigned_at);
		const dateB = new Date(b.assigned_at);
		return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
	  });

	  renderBadges(filtered);
	}

	function renderBadges(badges) {
	  const container = document.getElementById('employeeBadgesContainer');
	  container.innerHTML = '';

	  if (badges.length === 0) {
		container.innerHTML = '<p class="text-center text-muted">No badges found.</p>';
		return;
	  }

	  badges.forEach(badge => {
		const card = document.createElement('div');
		card.className = 'col-md-4 mb-3';

		card.innerHTML = `
		  <div class="card h-100 shadow-sm">
			<div class="card-body text-center">
			  <img src="${badge.icon_url}" alt="${badge.title}" class="mb-3" style="width: 60px; height: 60px;">
			  <h5 class="card-title">${badge.title}</h5>
			  <p class="card-text small">${badge.description}</p>
			  <p class="text-muted small">Awarded on: ${new Date(badge.assigned_at).toLocaleDateString()}</p>
			</div>
		  </div>
		`;

		container.appendChild(card);
	  });
	}
</script>
<!-- Script for displaying badge (End) -->

<!-- Script for displaying surveys and submitting the answers for the survey (Start) -->
<script>
	// Assumes employeeSecureFetch is globally defined

	document.addEventListener("DOMContentLoaded", function() {
		console.log("DOM fully loaded and parsed");
		fetchAssignedSurveys();
		let selectedSurveyId = null;

		function fetchAssignedSurveys() {
			const container = document.getElementById("surveyContainer");
			const spinner = document.getElementById("surveyLoadingSpinner");
			if (spinner) spinner.style.display = "block";
			showEmployeeSpinner();
const spinnerShownAt = Date.now();
			console.log("Fetching assigned surveys...");
			employeeSecureFetch('/assigned_surveys', { method: 'GET' })
			.then(data => {
				if (spinner) spinner.style.display = "none";
				if (data.error) {
					container.innerHTML = `<p class="text-danger text-center">${data.error}</p>`;
					return;
				}
				if (data.length === 0) {
					container.innerHTML = "<p class='text-center'>No active surveys assigned.</p>";
					return;
				}

				container.innerHTML = "";
				data.forEach(survey => {
					console.log("Rendering survey:", survey);
					const card = document.createElement("div");
					card.className = "card mb-3";
					card.innerHTML = `
						<div class="card-body">
              ${survey.is_active ? `<span class="badge bg-success">Active</span>` : `<span class="badge bg-secondary">Inactive</span>`}
							<h5 class="card-title">${survey.title}</h5>
							<p class="card-text">${survey.description}</p>
							<p class="text-muted small">Created: ${new Date(survey.created_at).toLocaleDateString()}</p>
							<button class="btn btn-outline-primary btn-sm mt-2" 
									onclick="openSurveyModal(${survey.survey_id}, '${survey.title.replace(/'/g, "\\'")}')">
								Take Survey
							</button>
						</div>
					`;
					container.appendChild(card);
				});
			})
			.catch(err => {
				if (spinner) spinner.style.display = "none";
				container.innerHTML = `<p class="text-danger text-center">Failed to load surveys: ${err.message}</p>`;
				console.error("Survey loading error:", err);
			}).finally(() => {
  const elapsed = Date.now() - spinnerShownAt;
  setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
});
		}

		window.openSurveyModal = function(surveyId, title) {
			showEmployeeSpinner();
const spinnerShownAt = Date.now();
			console.log("Opening survey modal for ID:", surveyId);
			selectedSurveyId = surveyId;
			document.getElementById("surveyModalLabel").innerText = title;
			const container = document.getElementById("surveyQuestionsContainer");
			container.innerHTML = `<div class="text-center py-4"><div class="spinner-border"></div></div>`;

			employeeSecureFetch(`/survey/${surveyId}/questions`, { method: 'GET' })
			.then(questions => {
				console.log("Questions fetched:", questions);
				container.innerHTML = "";

				questions.forEach((q, index) => {
					const qDiv = document.createElement("div");
					qDiv.className = "mb-4 p-3 border rounded";
					qDiv.innerHTML = `
						<h6 class="mb-2">Q${index + 1}: ${q.question_text}</h6>
						<small class="text-muted">${q.question_type}</small>
					`;

					if (q.question_type === 'text') {
						qDiv.innerHTML += `
							<textarea class="form-control mt-2" rows="2" name="question_${q.question_id}" required></textarea>
						`;
						container.appendChild(qDiv);
					}
					else if (q.question_type === 'rating') {
						const ratingScale = q.rating_scale || 5;
						qDiv.innerHTML += `<div class="d-flex mt-2">` +
							[...Array(ratingScale)].map((_, r) => `
								<div class="form-check">
									<input class="form-check-input" type="radio"
										name="question_${q.question_id}"
										id="q${q.question_id}_r${r + 1}"
										value="${r + 1}" required>
									<label class="form-check-label" for="q${q.question_id}_r${r + 1}">
										${r + 1}
									</label>
								</div>
							`).join('') +
							`</div>`;
						container.appendChild(qDiv);
					}
					else if (q.question_type === 'multiple_choice') {
						qDiv.innerHTML += `<div class="mt-2" id="options-${q.question_id}">
							<div class="spinner-border spinner-border-sm"></div> Loading options...
						</div>`;
						container.appendChild(qDiv);

						// Fetch and render options for multiple choice
						employeeSecureFetch(`/survey_question_options/${q.question_id}`, { method: 'GET' })
							.then(options => {
								const optionsContainer = document.getElementById(`options-${q.question_id}`);
								optionsContainer.innerHTML = options.map(opt => `
									<div class="form-check">
										<input class="form-check-input" type="radio"
											name="question_${q.question_id}"
											id="q${q.question_id}_o${opt.option_id}"
											value="${opt.option_id}" required>
										<label class="form-check-label" for="q${q.question_id}_o${opt.option_id}">
											${opt.option_text}
										</label>
									</div>
								`).join('');
								optionsContainer.querySelectorAll('.form-check-input').forEach(input => {
									input.addEventListener('change', function() {
										optionsContainer.querySelectorAll('.form-check-label').forEach(label => {
											label.classList.remove('active-option');
										});
										if (this.checked) {
											this.nextElementSibling.classList.add('active-option');
										}
									});
								});
							})
							.catch(err => console.error(`Error fetching options for question ${q.question_id}:`, err));
					}
				});
			})
			.catch(err => {
				console.error("Failed to load questions for survey:", err);
			})
			.finally(() => {
  const elapsed = Date.now() - spinnerShownAt;
  setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
});
    showModalAfterSpinnerHide('#surveyModal');
		};

		document.getElementById("surveyForm").addEventListener("submit", function(e) {
			e.preventDefault();
			const submitBtn = document.getElementById("surveySubmitBtn");
			submitBtn.disabled = true;
			submitBtn.innerHTML = `
				<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
				Submitting...
			`;

			const formData = new FormData(e.target);
			const responses = [];

			document.querySelectorAll('#surveyQuestionsContainer > .mb-4').forEach(qDiv => {
				const qHeader = qDiv.querySelector('h6');
				if (!qHeader) return;
				const anyInput = qDiv.querySelector('[name^="question_"]');
				if (!anyInput) return;
				const questionId = parseInt(anyInput.name.split("_")[1]);
				const questionType = qDiv.querySelector('small.text-muted')?.textContent;

				if (questionType === 'multiple_choice') {
					const checkedRadio = qDiv.querySelector('input[type="radio"]:checked');
					if (checkedRadio) {
						const label = qDiv.querySelector(`label[for="${checkedRadio.id}"]`);
						responses.push({
							question_id: questionId,
							response_text: label ? label.textContent.trim() : checkedRadio.value
						});
					}
				} else if (questionType === 'rating') {
					const checkedRadio = qDiv.querySelector('input[type="radio"]:checked');
					if (checkedRadio) {
						responses.push({
							question_id: questionId,
							response_text: checkedRadio.value
						});
					}
				} else if (questionType === 'text') {
					const textarea = qDiv.querySelector('textarea');
					if (textarea && textarea.value.trim().length > 0) {
						responses.push({
							question_id: questionId,
							response_text: textarea.value.trim()
						});
					}
				}
			});

			if (responses.length === 0) {
				showErrorModal("Please answer at least one question.");
				submitBtn.disabled = false;
				submitBtn.textContent = "Submit Survey";
				return;
			}

			console.log("Submitting responses:", responses);
			 showEmployeeSpinner();
const spinnerShownAt = Date.now();

			employeeSecureFetch(`/survey/${selectedSurveyId}/submit`, {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({ responses })
			})
			.then(data => {
				if (data.error) throw new Error(data.error);
				$('#surveyModal').modal('hide');
				showSuccessModal('Survey submitted successfully!');
				fetchAssignedSurveys();
			})
			.catch(err => {
				showErrorModal(`Failed to submit survey: ${err.message}`);
				console.error("Submission error:", err);
			})
			.finally(() => {
  const elapsed = Date.now() - spinnerShownAt;
  setTimeout(() => {
    hideEmployeeSpinner();
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Survey";
  }, Math.max(0, 800 - elapsed));
});
		});

function showAlert(type, message) {
  const modalTitle = document.getElementById('alertModalTitle');
  const modalBody = document.getElementById('alertModalBody');

  switch(type) {
    case 'success':
      modalTitle.textContent = 'Success';
      modalBody.innerHTML = `<div class="alert alert-success d-flex align-items-center">
        <i class="bi bi-check-circle-fill mr-2" style="font-size: 1.5rem;"></i>
        <div>${message}</div>
      </div>`;
      break;
    case 'error':
      modalTitle.textContent = 'Error';
      modalBody.innerHTML = `<div class="alert alert-danger d-flex align-items-center">
        <i class="bi bi-exclamation-triangle-fill mr-2" style="font-size: 1.5rem;"></i>
        <div>${message}</div>
      </div>`;
      break;
    default:
      modalTitle.textContent = 'Notice';
      modalBody.innerHTML = `<div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-info-circle-fill mr-2" style="font-size: 1.5rem;"></i>
        <div>${message}</div>
      </div>`;
  }

  $('#alertModal').modal('show');
}
	});
</script>	
<!-- Script for displaying surveys and submitting the answers for the survey (End) -->

<!-- Script for displaying feedback requests and submitting responses (Start) -->
<script>
	// Assumes employeeSecureFetch is globally defined

	document.addEventListener("DOMContentLoaded", function () {
		fetchFeedbackRequests();

		document.getElementById("searchInput").addEventListener("input", fetchFeedbackRequests);
		document.getElementById("deadlineFilter").addEventListener("change", fetchFeedbackRequests);
		document.getElementById("sortBy").addEventListener("change", fetchFeedbackRequests);
	});

	async function fetchFeedbackRequests() {
		const container = document.getElementById("feedbackContainer");
		container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
		showEmployeeSpinner();
		const spinnerShownAt = Date.now();
		try {
			// Authenticated fetch for feedback requests and responses
			const feedbacks = await employeeSecureFetch('/feedback_requests', { method: 'GET' });
			const responses = await employeeSecureFetch('/feedback_responses', { method: 'GET' });

			const myEmail = sessionStorage.getItem('employeeEmail');
			const myId = parseInt(sessionStorage.getItem('employeeId'));

			const search = document.getElementById("searchInput").value.toLowerCase();
			const deadlineFilter = document.getElementById("deadlineFilter").value;
			const sortBy = document.getElementById("sortBy").value;
			let filtered = feedbacks;

			if (search) {
				filtered = filtered.filter(f => {
					const theseResponses = responses.filter(r => r.request_id === f.request_id);
					const responsesText = theseResponses.map(r =>
						(r.response || '') + ' ' + (r.employee_email || '')
					).join(' ').toLowerCase();

					return (
						f.title.toLowerCase().includes(search) ||
						f.message.toLowerCase().includes(search) ||
						(f.deadline && new Date(f.deadline).toLocaleDateString().toLowerCase().includes(search)) ||
						(f.created_at && new Date(f.created_at).toLocaleDateString().toLowerCase().includes(search)) ||
						responsesText.includes(search)
					);
				});
			}
			const today = new Date();
			if (deadlineFilter === 'upcoming') filtered = filtered.filter(f => new Date(f.deadline) >= today);
			if (deadlineFilter === 'past') filtered = filtered.filter(f => new Date(f.deadline) < today);
			filtered.sort((a, b) => sortBy === 'asc'
				? new Date(a.created_at) - new Date(b.created_at)
				: new Date(b.created_at) - new Date(a.created_at)
			);

			container.innerHTML = filtered.length === 0
				? '<p class="text-center">No feedback requests found.</p>'
				: filtered.map(f => renderFeedbackCard(f, responses, myId, myEmail)).join('');
		} catch (err) {
			console.error("Fetch error:", err);
			container.innerHTML = '<p class="text-danger text-center">Failed to load feedback requests.</p>';
		}
		finally {
			hideEmployeeSpinner();
		}
	}

	function renderFeedbackCard(f, responses, myId, myEmail) {
		const theseResponses = responses.filter(r => r.request_id === f.request_id);
		const hasMyResponse = theseResponses.some(r => parseInt(r.employee_id) === myId);

		let responseBlock = '';
		if (theseResponses.length) {
			responseBlock = `
				<div class="mt-3">
					<strong>Responses:</strong>
					<ul class="list-group mt-1 mb-2">
						${theseResponses.map(r => `
							<li class="list-group-item">
								<div>
									<span class="font-weight-bold">${r.employee_email || 'User ' + r.employee_id}</span>
									<span class="text-muted small ml-2">${new Date(r.submitted_at).toLocaleString()}</span>
								</div>
								<div>${r.response}</div>
							</li>
						`).join('')}
					</ul>
				</div>
			`;
		}

		const responseForm = hasMyResponse
			? '<div class="alert alert-success">You have already responded to this request.</div>'
			: `
			<div class="feedback-response-form">
				<textarea class="form-control mb-2" placeholder="Write your response..." id="responseInput-${f.request_id}"></textarea>
				<button class="btn btn-sm btn-success" onclick="submitFeedbackResponse(${f.request_id})">Submit Response</button>
			</div>`;

		return `
			<div class="card mb-3">
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center mb-2">
						<h5 class="card-title mb-0">${f.title}</h5>
					</div>
					<p class="card-text">${f.message}</p>
					<p class="card-text text-muted mb-2">
						<small>Deadline: ${new Date(f.deadline).toLocaleDateString()}</small>
						<small class="ml-2">Created: ${new Date(f.created_at).toLocaleDateString()}</small>
					</p>
					${responseBlock}
					${responseForm}
				</div>
			</div>
		`;
	}

	function submitFeedbackResponse(requestId) {
		const textarea = document.getElementById(`responseInput-${requestId}`);

		if (!textarea) {
			alert("Could not find the input field. Please try again.");
			return;
		}

		const responseText = textarea.value.trim();

		if (!responseText) {
			alert("Response cannot be empty.");
			return;
		}
		showEmployeeSpinner();
		employeeSecureFetch('/submit_feedback_response', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				"X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.content || ''
			},
			body: JSON.stringify({ request_id: requestId, response: responseText })
		})
		.then(data => {
			if (data.message) {
				showSuccessModal(data.message || "Response submitted successfully!");
				fetchFeedbackRequests();
			} else {
				showErrorModal(data.error || "Failed to submit response.");
			}
		})
		.catch(err => {
			console.error("[submitFeedbackResponse] Submission error:", err);
			showErrorModal("Something went wrong.");
		})
		.finally(() => {
  const elapsed = Date.now() - spinnerShownAt;
  setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
});

	}
</script>
<!-- Script for displaying feedback requests and submitting responses (End) -->

<!-- Script for submitting ticket requests (Start) -->
<script>
// Assumes employeeSecureFetch is globally defined

document.addEventListener('DOMContentLoaded', function () {
  console.log('DOM fully loaded and parsed');
  fetchTickets();

  document.getElementById('searchInputTicket').addEventListener('input', function () {
    console.log('Search input changed');
    fetchTickets();
  });

  document.getElementById('deadlineFilterTicket').addEventListener('change', function () {
    console.log('Deadline filter changed');
    fetchTickets();
  });

  document.getElementById('sortByTicket').addEventListener('change', function () {
    console.log('Sort by changed');
    fetchTickets();
  });

  const ticketForm = document.getElementById('ticketRequestForm');
  if (ticketForm) {
    ticketForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(ticketForm);
	  showEmployeeSpinner();
const spinnerShownAt = Date.now();
      console.log('Submitting ticket request', Object.fromEntries(formData.entries()));

      // Use employeeSecureFetch for multipart/form-data
      employeeSecureFetch('/submit_ticket_request', {
        method: 'POST',
        headers: {
          "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
          // Do NOT set Content-Type for FormData!
        },
        body: formData
      })
      .then(result => {
        console.log('Ticket submitted successfully', result);
        showSuccessModal(result.message || 'Ticket submitted!');
        $('#ticketRequestModal').modal('hide');
        ticketForm.reset();
        fetchTickets();
      })
      .catch(err => {
        console.error('Ticket request failed:', err);
        showErrorModal('Could not submit ticket.');
      })
	  .finally(() => {
  const elapsed = Date.now() - spinnerShownAt;
  setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
});
    });
  }
});

function fetchTickets() {
  const search = document.getElementById('searchInputTicket').value.trim();
  const deadline = document.getElementById('deadlineFilterTicket').value;
  const sort = document.getElementById('sortByTicket').value;

  const queryParams = new URLSearchParams({ search, deadline, sort });
  const url = `/get_my_tickets?${queryParams.toString()}`;
  showEmployeeSpinner();
  const spinnerShownAt = Date.now();
  console.log('Fetching tickets with:', { search, deadline, sort });

  employeeSecureFetch(url, { method: 'GET' })
    .then(data => {
      console.log('Tickets fetched:', data);
      renderTickets(data);
    })
    .catch(err => console.error('Error fetching tickets:', err))
	.finally(() => {
  const elapsed = Date.now() - spinnerShownAt;
  setTimeout(hideEmployeeSpinner, Math.max(0, 800 - elapsed));
});
}

function renderTickets(tickets) {
  const container = document.getElementById('ticketContainer');
  container.innerHTML = '';
  if (!Array.isArray(tickets)) {
    container.innerHTML = '<p class="text-danger text-center">Error loading tickets.</p>';
    return;
  }
  if (tickets.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">No tickets found.</p>';
    return;
  }
  tickets.forEach((ticket, idx) => {
    try {
      const card = document.createElement('div');
      card.className = 'card mb-3 shadow-sm';

      const responseHtml = (ticket.responses || []).map((resp, rIdx) => {
        if (!resp) return '';
        return `
          <div class="border p-2 mb-2 rounded bg-light">
            <p class="mb-1">
              <strong>Employee Response:</strong> ${resp.response || '-'}<br>
              <strong>Responded By:</strong> ${resp.responded_by || '-'}<br>
              <strong>Admin Response:</strong> ${resp.admin_response || '-'}<br>
              <strong>Responded By Admin:</strong> ${resp.responded_by_admin || '-'}<br>
              <strong>Responded At:</strong> ${resp.responded_at ? formatDate(resp.responded_at) : '-'}
            </p>
            <div class="d-flex justify-content-end">
              <button class="btn btn-sm btn-outline-secondary mr-1" onclick="editResponse(${resp.response_id}, ${ticket.ticket_id})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteResponse(${resp.response_id}, ${ticket.ticket_id})">Delete</button>
            </div>
          </div>
        `;
      }).join('');
      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">
            ${ticket.subject}
            <span class="badge badge-${getPriorityClass(ticket.priority)} ml-2">${ticket.priority}</span>
          </h5>
          <p class="card-text"><strong>Ticket ID:</strong> ${ticket.ticket_id}</p>
          <p class="card-text"><strong>Employee ID:</strong> ${ticket.employee_id}</p>
          <p class="card-text"><strong>Category:</strong> ${ticket.category}</p>
          <p class="card-text"><strong>Description:</strong> ${ticket.description}</p>
          <p class="card-text"><strong>Status:</strong>
            <span class="badge badge-${getStatusClass(ticket.status)}">${ticket.status}</span>
          </p>
          <p class="card-text"><strong>File Path:</strong> <code>${ticket.file_path || '-'}</code></p>
          <p class="card-text text-muted">
            <small><strong>Created At:</strong> ${ticket.created_at ? formatDate(ticket.created_at) : '-'}</small><br>
            <small><strong>Updated At:</strong> ${ticket.updated_at ? formatDate(ticket.updated_at) : '-'}</small>
          </p>
          <p class="card-text"><strong>Attachment:</strong><br>${getAttachmentPreview(ticket.file_path)}</p>
          <div class="ticket-responses mt-3">
            <h6>Responses:</h6>
            ${responseHtml || '<p class="text-muted">No responses yet.</p>'}
          </div>
          <div class="feedback-response-form mt-3">
            <textarea class="form-control mb-2" placeholder="Write your response..." id="responseTicketInput-${ticket.ticket_id}"></textarea>
            <button class="btn btn-sm btn-success" onclick="submitResponse(this)">Submit Response</button>
          </div>
        </div>
      `;
      container.appendChild(card);
    } catch (err) {
      console.error(`[renderTickets] Error rendering ticket #${idx}:`, err);
    }
  });
}

function submitResponse(button) {
  try {
    if (!(button instanceof HTMLElement)) {
      console.error("[submitResponse] Invalid element passed:", button);
      alert("Unexpected error occurred.");
      return;
    }

    const cardBody = button.closest('.card-body');
    console.log("[submitResponse] Found card body:", cardBody);

    const textarea = cardBody.querySelector('textarea');
    console.log("[submitResponse] Found textarea:", textarea);

    if (!textarea) {
      alert("Could not find the response input.");
      return;
    }

    const responseText = textarea.value.trim();
    if (!responseText) {
      alert('Please write a response before submitting.');
      return;
    }

    const idParts = textarea.id.split('-');
    console.log("[submitResponse] Parsed ID parts:", idParts);

    const ticketId = parseInt(idParts[1]);
    if (isNaN(ticketId)) {
      console.error("[submitResponse] Invalid ticket ID parsed from:", textarea.id);
      alert("Invalid ticket ID.");
      return;
    }

    console.log('[submitResponse] Submitting response:', { ticket_id: ticketId, response: responseText });

    employeeSecureFetch('/submit_ticket_response', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ ticket_id: ticketId, response: responseText })
    })
    .then(data => {
      showSuccessModal(data.message || 'Response submitted!');
      textarea.value = '';
      fetchTickets();
    })
    .catch(err => {
      console.error('[submitResponse] Fetch error:', err);
      showErrorModal('Something went wrong submitting your response.');
    });

  } catch (err) {
    console.error("[submitResponse] Unexpected error:", err);
    alert('An unexpected error occurred.');
  }
}

function getPriorityClass(priority) {
  return { high: 'danger', medium: 'warning', low: 'success' }[priority?.toLowerCase()] || 'secondary';
}

function getStatusClass(status) {
  return {
    'open': 'primary',
    'in progress': 'info',
    'resolved': 'success',
    'closed': 'dark'
  }[status?.toLowerCase()] || 'secondary';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
}

function getAttachmentPreview(filePath) {
  if (!filePath) return '<span class="text-muted">None</span>';
  const fileUrl = filePath.replace(/\\/g, '/');
  const fullUrl = fileUrl.startsWith('/static') ? fileUrl : `/${fileUrl}`;
  const ext = fileUrl.split('.').pop().toLowerCase();
  console.log('Generating attachment preview for:', fullUrl);

  if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
    return `<img src="${fullUrl}" class="img-thumbnail attachment-preview" style="max-width: 200px;" data-toggle="modal" data-target="#attachmentModal" data-src="${fullUrl}">`;
  } else if (ext === 'pdf') {
    return `<iframe src="${fullUrl}" width="100%" height="300px"></iframe>`;
  } else {
    return `<a href="${fullUrl}" target="_blank" class="btn btn-sm btn-outline-info">Download</a>`;
  }
}
document.addEventListener('click', function (e) {
  if (e.target.classList.contains('attachment-preview')) {
    const src = e.target.getAttribute('data-src');
    console.log('Opening attachment modal with src:', src);
    document.getElementById('attachmentModalImage').src = src;
  }
});

let currentEditTicketId = null;

function editResponse(responseId, ticketId) {
  console.log('Editing response:', { responseId, ticketId });
  currentEditTicketId = ticketId;
  const card = document.querySelector(`#responseTicketInput-${ticketId}`).closest('.card');
  const responseBox = [...card.querySelectorAll('.ticket-responses .border')].find(box =>
    box.innerHTML.includes(`editResponse(${responseId}`)
  );
  const existingText = responseBox?.querySelector('span strong')?.nextSibling?.textContent?.trim().replace(/^:\s*/, '') || '';
  document.getElementById('editResponseText').value = existingText;
  document.getElementById('editResponseId').value = responseId;
  $('#editResponseModal').modal('show');
}

document.getElementById('editResponseForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const responseId = document.getElementById('editResponseId').value;
  const updatedText = document.getElementById('editResponseText').value.trim();

  if (!updatedText) {
    alert('Response cannot be empty.');
    return;
  }

  console.log('Submitting edited response:', { responseId, updatedText });

  employeeSecureFetch(`/edit-response/${responseId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({ response_id: responseId, response: updatedText })
  })
  .then(data => {
    $('#editResponseModal').modal('hide');
    showSuccessModal(data.message || 'Response updated!');
    fetchTickets();
  })
  .catch(err => {
    console.error('Update failed:', err);
    showErrorModal('Failed to update response.');
  });
});

function deleteResponse(responseId, ticketId) {
  console.log('Preparing to delete response:', { responseId, ticketId });
  document.getElementById('deleteResponseId').value = responseId;
  $('#deleteConfirmModal').modal('show');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
  const responseId = document.getElementById('deleteResponseId').value;
  console.log('Confirming deletion of response:', responseId);

  employeeSecureFetch(`/delete-response/${responseId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({ response_id: responseId })
  })
  .then(data => {
    $('#deleteConfirmModal').modal('hide');
    showSuccessModal(data.message || 'Response deleted!');
    fetchTickets();
  })
  .catch(err => {
    console.error('Delete failed:', err);
    showErrorModal('Failed to delete response.');
  });
});
</script>  
<!-- Script for submitting ticket requests (End) -->	

<!-- Script for forcing logout when the logout all devices triggered from other tabs (Start) -->
<script>
window.addEventListener('storage', function (event) {
  if (event.key === 'employeeToken' && event.newValue === null) {
    const modal = new bootstrap.Modal(document.getElementById('multiTabLogoutModal'));
    modal.show();
    showEmployeeSpinner();
    setTimeout(() => {
      hideEmployeeSpinner();
      window.location.href = '/';
    }, 3000);
  }
});
</script>
<!-- Script for forcing logout when the logout all devices triggered from other tabs (End) -->

</html>