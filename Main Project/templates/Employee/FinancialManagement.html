<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>Ready Bootstrap Dashboard</title>
	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
	<link rel="stylesheet" href="../../static/Employee/assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
	<link rel="stylesheet" href="../../static/Employee/assets/css/ready.css">
	<link rel="stylesheet" href="../../static/Employee/assets/css/demo.css">
	<meta name="csrf-token" content="{{ csrf_token() }}">
	<!-- Styling the logging you out spinner -->	
	<style>
        /* Make modal-body scrollable in Bootstrap 4 */
.inbox-scrollable {
  max-height: 60vh;   /* Adjust height as needed */
  overflow-y: auto;
}
    /* Make modal-body scrollable in Bootstrap 4 */
.inbox-scrollable {
  max-height: 60vh;   /* Adjust height as needed */
  overflow-y: auto;
}
		/* Basic styling for spinner container */
    .spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Spinner Animation (Circular Progress) */
    .spinner {
        border: 4px solid transparent;
        border-top: 4px solid #007bff; /* Blue color for the spinner */
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        animation: spin 1.5s linear infinite;
    }
		/* CSS for spinner animation */
		@keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .spinner-border {
        animation: spin 2s linear infinite;
    }
	</style>
	<!-- Styling the logging you out spinner -->	
	 
</head>
<body>
	<div class="wrapper">
		<div class="main-header">
			<div class="logo-header">
				<a href="#" class="logo" data-toggle="modal" data-target="#modalUpdate">
					Contact Details
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<button class="topbar-toggler more"><i class="la la-ellipsis-v"></i></button>
			</div>
			<nav class="navbar navbar-header navbar-expand-lg">
				<div class="container-fluid">
					<ul class="navbar-nav topbar-nav ml-md-auto align-items-center">
																														<!-- Message Dropdown -->
<li class="nav-item dropdown hidden-caret">
	<a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	  <i class="la la-envelope"></i>
	</a>
	<ul class="dropdown-menu notif-box msg-box" aria-labelledby="messageDropdown">
	  <li>
		<div class="dropdown-title d-flex justify-content-between align-items-center">
		  Messages
		  <a href="javascript:void(0);" onclick="openComposeMessageModal()">Compose</a>
		</div>
	  </li>
	  <li>
		<div class="message-notif-scroll" style="max-height: 250px; overflow-y: auto;">
		  <div id="messagePreviewContainer" class="notif-center">
			<!-- JS will insert message previews here -->
		  </div>
		</div>
	  </li>
	  <li>
		<a class="see-all" href="javascript:void(0);" onclick="openMessageInboxModal()"> <strong>View Inbox</strong> <i class="la la-angle-right"></i> </a>
	  </li>
	</ul>
  </li>
  
  <!-- Notification Dropdown -->
  <li class="nav-item dropdown hidden-caret">
	<a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	  <i class="la la-bell"></i>
	  <span class="notification" id="unreadCountBadge" style="display:none;"></span>
	</a>
	<ul class="dropdown-menu notif-box" aria-labelledby="notificationDropdown">
	  <li>
		<div class="dropdown-title">You have <span id="notificationTitleCount">0</span> new notification(s)</div>
	  </li>
	  <li>
		<div class="notif-center" id="notificationList">
		  <!-- JS will insert notifications here -->
		</div>
	  </li>
	</ul>
  </li>  
  <li class="nav-item dropdown">
	<a class="dropdown-toggle profile-pic" data-toggle="dropdown" href="#" aria-expanded="false"> <img alt="user-img" width="36" class="img-circle" id="profile-picture-dropdown"><span id="user-name"></span></span> </a>
	<ul class="dropdown-menu dropdown-user">
		<li>
			<div class="user-box">
				<div class="u-img"><img alt="user" id="profile-picture-box"></div>
				<div class="u-text">
					<h4 id="user-name"></h4>
					<p class="text-muted" id="user-email-dropdown"></p>
					<a href="/profile" class="btn btn-rounded btn-danger btn-sm">View Profile</a>
				</div>
				</div>
			</li>

		</ul>
		<!-- /.dropdown-user -->
	</li>
						</ul>
					</div>
				</nav>
			</div>
						<div class="sidebar">
				<div class="scrollbar-inner sidebar-wrapper">
					<div class="user">
						<div class="photo">
							<img id="profile-picture-sidebar">
						</div>
						<div class="info">
							<a class="" data-toggle="collapse" href="#collapseExample" aria-expanded="true">
								<span>
									<span id="user-name"></span> (Your ID: <span id="user-id"></span>)
									<span class="user-level" id="user-position"></span>
									<span class="caret"></span>
								</span>
							</a>
							<div class="clearfix"></div>
			
							<div class="collapse in" id="collapseExample" aria-expanded="true" >
								<ul class="nav">
									<li>
										
											<span class="link-collapse" style="color: black;">Department : <span id="user-department"></span></span>
										
									</li>
									<li>
										
										<span class="link-collapse" style="color: black;">Hired since : <span id="user-date-hired"></span></span>
									
								</li>
								<li>
										
									<span class="link-collapse" style="color: black;">Team : <span id="user-team_name"></span></span>
								
							</li>
							
									
								</ul>
							</div>
						</div>
					</div>
          					<ul class="nav">
						<li class="nav-item ">
							<a href="/user">
								<i class="la la-dashboard"></i>
								<p>Dashboard</p>
							</a>
						</li>
						<li class="nav-item ">
							<a href="/payroll">
								<i class="la la-cc-mastercard"></i>
								<p>Payroll information</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/goals">
								<i class="
								la la-crosshairs"></i>
								<p>Your goals</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/workandproductivity">
								<i class="
								la la-file-text-o"></i>
								<p>Your tasks</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/notifications">
								<i class="la la-bell"></i>
								<p>Notifications</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/trainings">
								<i class="la la-mortar-board"></i>
								<p>Training and Development</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/feedbackandsupport">
								<i class="la la-weixin"></i>
								<p>Feedback and support</p>
							</a>
						</li>
						<li class="nav-item active">
							<a href="/financialmanagement">
								<i class="la la-usd"></i>
								<p>Financial management</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/AdministrativeTools">
								<i class="la la-gear"></i>
								<p>Administrative Tools</p>
							</a>
						</li>
						
						<li class="nav-item update-pro">
							<button class="btn btn-danger" data-toggle="modal" data-target="#logoutModal">
								<i class="la la-power-off"></i>
								<p>Logout</p>
							</button>
						</li>

						<li class="nav-item update-pro">
						<button id="viewDevicesBtn" class="btn btn-warning">
							üñ•Ô∏è View Recent Devices
						</button>
					</li>
					</ul>
				</div>
			</div>
			<div class="main-panel">
				<div class="content">
					<div class="row">
						<div class="col-md-12">
							<div class="card">
							  <div class="card-header d-flex justify-content-between align-items-center">
								<div>
									<!-- View History Button -->
									<button class="btn btn-warning mb-3" onclick="openExpenseHistoryModal()">View Expense Claims History</button>
								  <h4 class="card-title">Submit Expense Claim</h4>
								  <p class="card-category mb-0">Fill in details and attach your receipt</p>
								</div>
							  </div>
						  
							  <div class="card-body">
								<form id="expenseForm" enctype="multipart/form-data">
									<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
								  <div class="form-group">
									<label for="title">Expense Title</label>
									<input type="text" class="form-control" id="title" name="title" placeholder="e.g., Hotel Stay in NYC" required>
								  </div>
						  
								  <div class="form-group">
									<label for="amount">Amount ($)</label>
									<input type="number" class="form-control" id="amount" name="amount" step="0.01" required>
								  </div>
						  
								  <div class="form-group">
									<label for="date">Expense Date</label>
									<input type="date" class="form-control" id="date" name="date" required>
								  </div>
						  
								  <div class="form-group">
									<label for="category">Category</label>
									<select class="form-control" id="category" name="category" required>
									  <option value="">Select Category</option>
									  <option value="Travel">Travel</option>
									  <option value="Meals">Meals</option>
									  <option value="Accommodation">Accommodation</option>
									  <option value="Other">Other</option>
									</select>
								  </div>
						  
								  <div class="form-group">
									<label for="description">Description (Optional)</label>
									<textarea class="form-control" id="description" name="description" rows="3" placeholder="Add any notes about the expense..."></textarea>
								  </div>
						  
								  <div class="form-group">
									<label for="receipt">Upload Receipt</label>
									<input type="file" class="form-control-file" id="receipt" name="receipt" accept="image/*,application/pdf" required>
								  </div>
						  
								  <button type="submit" class="btn btn-primary">Submit Claim</button>
								</form>
						  
								<div id="expenseStatus" class="mt-3"></div>
							  </div>
							</div>
						  </div>		
						  <div class="col-md-12">
							<div class="card">
							  <div class="card-header d-flex justify-content-between align-items-center">
								<div>
								  <h4 class="card-title">My Bonuses & Incentives</h4>
								  <p class="card-category mb-0">All rewards awarded to you by the organization</p>
								</div>
							  </div>
						  
							  <div class="card-body">
								<div class="table-responsive">
								  <table class="table table-bordered">
									<thead class="text-primary">
									  <tr>
										<th>Amount</th>
										<th>Type</th>
										<th>Description</th>
										<th>Awarded Date</th>
										<th>Actions</th>
									  </tr>
									</thead>
									<tbody id="myBonusTableBody">
									  <!-- Bonus rows will be injected here -->
									</tbody>
								  </table>
								</div>
							  </div>
							</div>
						  </div>
						  <div class="col-md-12">
							<div class="card">
							  <div class="card-header d-flex justify-content-between align-items-center">
								<div>
								  <h4 class="card-title">My Savings Plans</h4>
								  <p class="card-category mb-0">Retirement plans and employee savings options assigned to you</p>
								</div>
							  </div>
						  
							  <div class="card-body">
								<div class="table-responsive">
								  <table class="table table-bordered">
									<thead class="text-primary">
									  <tr>
										<th>Plan Type</th>
										<th>Provider</th>
										<th>Contribution %</th>
										<th>Start Date</th>
										<th>Status</th>
										<th>Actions</th>
									  </tr>
									</thead>
									<tbody id="savingsPlansTableBody">
									  <!-- Injected rows -->
									</tbody>
								  </table>
								</div>
							  </div>
							</div>
						  </div>
					</div>
				</div>
				<footer class="footer">
					<div class="container-fluid">
						<nav class="pull-left">
							<ul class="nav">
								<li class="nav-item">
									<a class="nav-link" href="http://www.themekita.com">
										ThemeKita
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="#">
										Help
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="https://themewagon.com/license/#free-item">
										Licenses
									</a>
								</li>
							</ul>
						</nav>
						<div class="copyright ml-auto">
							2018, made with <i class="la la-heart heart text-danger"></i> by <a href="http://www.themekita.com">ThemeKita</a>
						</div>				
					</div>
				</footer>
			</div>
		</div>
	</div>

<!-- Response View Modal -->
<div class="modal fade" id="responseViewModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">All Plan Responses</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body inbox-scrollable" id="responseViewModalBody">
        <!-- Responses will be dynamically inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Request Change Modal -->
<div class="modal fade" id="requestChangeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Request Savings Plan Change</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="requestPlanId">
        <div class="form-group">
          <label for="changeRequestText">Your Request</label>
          <textarea class="form-control" id="changeRequestText" rows="4" placeholder="E.g., I would like to increase my contribution to 7%..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="submitChangeRequest()">Submit</button>
        <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Savings Plan Detail Modal -->
<div class="modal fade" id="savingsPlanDetailModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Savings Plan Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Type:</strong> <span id="planDetailType"></span></p>
        <p><strong>Provider:</strong> <span id="planDetailProvider"></span></p>
        <p><strong>Contribution:</strong> <span id="planDetailContribution"></span></p>
        <p><strong>Employer Match:</strong> <span id="planDetailEmployerMatch"></span></p>
        <p><strong>Start Date:</strong> <span id="planDetailStartDate"></span></p>
        <p><strong>Status:</strong> <span id="planDetailStatus"></span></p>
        <p><strong>Notes:</strong> <span id="planDetailNotes"></span></p>
        <div id="planDetailDoc" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bonus Detail Modal -->
<div class="modal fade" id="bonusDetailModal" tabindex="-1" role="dialog" aria-labelledby="bonusDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="bonusDetailModalLabel">Bonus Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Type:</strong> <span id="bonusDetailType"></span></p>
        <p><strong>Amount:</strong> <span id="bonusDetailAmount"></span></p>
        <p><strong>Description:</strong> <span id="bonusDetailDesc"></span></p>
        <p><strong>Awarded Date:</strong> <span id="bonusDetailDate"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Savings Plan Detail Modal (Alt Layout) -->
<div class="modal fade" id="savingsPlanDetailModalAlt" tabindex="-1" role="dialog" aria-labelledby="savingsPlanDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="savingsPlanDetailModalLabel">Savings Plan Details</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body px-4 py-3">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Plan Type:</strong>
            <p id="planDetailTypeAlt" class="mb-2"></p>
          </div>
          <div class="col-md-6">
            <strong>Provider:</strong>
            <p id="planDetailProviderAlt" class="mb-2"></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Contribution:</strong>
            <p id="planDetailContributionAlt" class="mb-2"></p>
          </div>
          <div class="col-md-6">
            <strong>Employer Match:</strong>
            <p id="planDetailEmployerMatchAlt" class="mb-2"></p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Start Date:</strong>
            <p id="planDetailStartDateAlt" class="mb-2"></p>
          </div>
          <div class="col-md-6">
            <strong>Status:</strong>
            <p id="planDetailStatusAlt" class="mb-2"></p>
          </div>
        </div>
        <div class="mb-3">
          <strong>Additional Notes:</strong>
          <p id="planDetailNotesAlt" class="mb-0"></p>
        </div>
        <div class="mb-3">
          <strong>Document:</strong>
          <div id="planDetailDocAlt"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Expense Claims History Modal -->
<div class="modal fade" id="expenseHistoryModal" tabindex="-1" role="dialog" aria-labelledby="expenseHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Your Expense Claims History</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 row">
          <div class="col-md-3">
            <select id="categoryFilter" class="form-control">
              <option value="">All Categories</option>
              <option value="Travel">Travel</option>
              <option value="Meals">Meals</option>
              <option value="Accommodation">Accommodation</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="statusFilter" class="form-control">
              <option value="">All Statuses</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div class="mb-3 row">
          <div class="col-md-3">
            <input type="date" id="startDateFilter" class="form-control" placeholder="From date">
          </div>
          <div class="col-md-3">
            <input type="date" id="endDateFilter" class="form-control" placeholder="To date">
          </div>
        </div>
        <div class="table-responsive">
          <input type="text" id="generalSearch" class="form-control mb-2" placeholder="Search anything...">
          <table class="table table-bordered table-hover mb-0" id="expenseHistoryTable">
            <thead class="thead-light">
              <tr>
                <th>Title</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Status</th>
                <th>Receipt</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Compose Message Modal -->
<div class="modal fade" id="composeMessageModal" tabindex="-1" role="dialog" aria-labelledby="composeMessageLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="composeMessageLabel">Compose Message</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="composeForm">
          <div class="form-group">
            <label for="roleSelect">Select Role</label>
            <select id="roleSelect" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="receiverSelect">Select Receiver</label>
            <select id="receiverSelect" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="messageText">Message</label>
            <textarea class="form-control" id="messageText" rows="4" placeholder="Write your message..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" id="sendButton" class="btn btn-primary">Send Message</button>
      </div>
    </div>
  </div>
</div>

<!-- Inbox Modal -->
<div class="modal fade" id="inboxModal" tabindex="-1" role="dialog" aria-labelledby="inboxLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="inboxLabel">Inbox</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body inbox-scrollable" id="inboxMessages">
        <!-- Messages are dynamically inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to logout?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmLogoutBtnCurrentUser">Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for displaying the recent devices -->
<div class="modal fade" id="recentDevicesModal" tabindex="-1" role="dialog" aria-labelledby="recentDevicesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recentDevicesLabel">Recent Devices</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-striped" id="devicesTable">
          <thead>
            <tr>
              <th>Device</th>
              <th>OS</th>
              <th>Browser</th>
              <th>IP Address</th>
              <th>Last Seen</th>
            </tr>
          </thead>
          <tbody>
            <!-- Devices will be injected here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- Logging you out modal -->
<div id="loadingModalCurrentUser" class="modal" style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;">
    <div class="modal-dialog modal-lg" style="max-width: 600px;">
        <div class="modal-content">
            <div class="modal-body text-center" style="padding: 30px;">
                <h4 style="font-size: 2rem; font-weight: 600; color: #007bff;">Logging you out... üîÑ</h4>
                <p style="font-size: 1.2rem; color: #6c757d; margin-top: 10px;">Please wait while we log you out from your account.</p>
                <div class="spinner-container" style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logout Notification Modal -->
<div class="modal fade" id="multiTabLogoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title w-100" id="logoutModalLabel">Session Ended</h5>
      </div>
      <div class="modal-body">
        You have been logged out from another tab.
      </div>
      <div class="modal-footer justify-content-center">
        <div class="d-flex justify-content-center">
          <div class="spinner-border text-secondary" role="status" aria-hidden="true" style="width: 2.5rem; height: 2.5rem;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Token Invalid Modal -->
<div class="modal fade" id="sessionExpiredModal" tabindex="-1" role="dialog" aria-labelledby="sessionExpiredLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title w-100" id="sessionExpiredLabel">Session Expired</h5>
      </div>
      <div class="modal-body">
        Your session has ended due to another login or token expiration.
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-danger" id="redirectToLogin">Go to Login</button>
      </div>
    </div>
  </div>
</div>

<!-- Account Deactivated Modal -->
<div class="modal fade" id="accountDeactivatedModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger border-3 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Account Deactivated</h5>
      </div>
      <div class="modal-body fw-semibold text-danger text-center">
        Your account has been <strong>deactivated</strong> by the administrator. Please contact support for assistance.
      </div>
      <div class="modal-footer"></div>
    </div>
  </div>
</div>

<!-- Account Terminated Modal -->
<div class="modal fade" id="accountTerminatedModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content bg-dark text-white border-light border-2 shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title">Account Terminated</h5>
      </div>
      <div class="modal-body text-center fw-semibold">
        Your account has been <strong>terminated</strong>. Access is no longer available.
      </div>
      <div class="modal-footer border-0"></div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white justify-content-center">
        <div class="d-flex align-items-center mx-auto">
          <h5 class="modal-title mb-0" id="successModalLabel">Success</h5>
        </div>
      </div>
      <div class="modal-body text-center" id="successModalBody"></div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal (Bootstrap 4) -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white justify-content-center">
        <div class="d-flex align-items-center mx-auto">
          <h5 class="modal-title mb-0" id="errorModalLabel">Error</h5>
        </div>
      </div>
      <div class="modal-body text-center" id="errorModalBody"></div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for contact details (Bootstrap 4) -->
<div class="modal fade" id="modalUpdate" tabindex="-1" role="dialog" aria-labelledby="modalUpdatePro" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h6 class="modal-title"><i class="la la-phone-square"></i> Contact <span id="user-name"></span> </h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <p>Phone number : <b><span id="user-phone"></span></b></p>
        <p>Email : <b><span id="user-email-contact"></span></b></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal (Bootstrap 4) -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger" id="confirmDeleteModalHeader">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this message?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

	<!-- Spinner Modal (Bootstrap 4) -->
<div class="modal fade" id="employeeSpinnerModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content" style="background: rgba(255,255,255,0.90); border: none; box-shadow: none;">
      <div class="modal-body d-flex flex-column justify-content-center align-items-center" style="min-height: 170px;">
        <div style="
          width: 3.5rem;
          height: 3.5rem;
          border: 0.5rem solid #e3e6ef;
          border-top: 0.5rem solid #007bff;
          border-radius: 50%;
          animation: employee-spin 0.8s linear infinite;
          margin-bottom: 16px;
          ">
        </div>
        <div class="spinner-message" style="color: #007bff; font-weight: 600; font-size: 1.15rem; letter-spacing: 0.02em;">
          Loading...
        </div>
        <style>
          @keyframes employee-spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
          }
        </style>
      </div>
    </div>
  </div>
</div>

	
</body>

<!-- Use full version of jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> <!-- Full jQuery version -->
<!-- Include jsPDF from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Bootstrap 4 JS (use your local or CDN, but only one) -->
<script src="../../static/Employee/assets/js/core/bootstrap.min.js"></script>
<!-- Other plugins and your custom scripts -->
<script src="../../static/Employee/assets/js/core/popper.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/chartist/chartist.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/chartist/plugin/chartist-plugin-tooltip.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/bootstrap-toggle/bootstrap-toggle.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/jquery-mapael/jquery.mapael.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/jquery-mapael/maps/world_countries.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/chart-circle/circles.min.js"></script>
<script src="../../static/Employee/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<script src="../../static/Employee/assets/js/ready.min.js"></script>
<script src="../../static/Employee/assets/js/demo.js"></script>
<!-- jsPDF and any other libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<!-- Script for checking 2FA (Start) -->
<script>
(function () {
  const modalId = 'employeeSpinnerModal';
  let _spinnerOpen = false;
  let _eventAttached = false;
  let _forceHideTimeoutId = null;

  function getModalElement() {
    return document.getElementById(modalId);
  }

  function showEmployeeSpinner() {
    const modalElement = getModalElement();
    if (!modalElement || typeof jQuery === "undefined") return;

    if (!_eventAttached) {
      jQuery(modalElement).off('hidden.bs.modal', spinnerHiddenHandler);
      jQuery(modalElement).on('hidden.bs.modal', spinnerHiddenHandler);
      _eventAttached = true;
    }

    if (!_spinnerOpen) {
      jQuery(modalElement).modal({
        backdrop: 'static',
        keyboard: false,
        show: true
      });
      _spinnerOpen = true;
      _forceHideTimeoutId = setTimeout(forceHideSpinner, 30000); // fallback
    }
  }

  function hideEmployeeSpinner() {
    const modalElement = getModalElement();
    if (!modalElement || typeof jQuery === "undefined") return;

    if (_spinnerOpen) {
      jQuery(modalElement).modal('hide');
      _spinnerOpen = false;
      setTimeout(forceHideSpinner, 2000);
    }
  }

  function spinnerHiddenHandler() {
    _spinnerOpen = false;
    if (_forceHideTimeoutId) clearTimeout(_forceHideTimeoutId);

    // Check for other active modals
    const hasOtherModals = checkForOtherActiveModals();

    if (!hasOtherModals) {
      removeAllBackdrops();
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    }
  }

  function forceHideSpinner() {
    const modalElement = getModalElement();
    if (!modalElement) return;

    jQuery(modalElement).modal('hide');
    jQuery(modalElement).hide();
    _spinnerOpen = false;
    if (_forceHideTimeoutId) clearTimeout(_forceHideTimeoutId);

    const hasOtherModals = checkForOtherActiveModals();
    if (!hasOtherModals) {
      removeAllBackdrops();
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    }
  }

  function checkForOtherActiveModals() {
    const allModals = document.querySelectorAll('.modal');
    for (let modal of allModals) {
      if (modal.id !== modalId && (modal.classList.contains('show') || jQuery(modal).hasClass('show'))) {
        return true;
      }
    }
    return false;
  }

  function removeAllBackdrops() {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(el => el.parentNode && el.parentNode.removeChild(el));
  }

  function isSpinnerVisible() {
    const modalElement = getModalElement();
    if (!modalElement) return false;
    return _spinnerOpen || 
           modalElement.classList.contains('show') ||
           jQuery(modalElement).hasClass('show') ||
           jQuery(modalElement).is(':visible');
  }

  function waitForSpinnerHide(callback) {
    if (!isSpinnerVisible()) {
      setTimeout(callback, 100);
      return;
    }

    const modalElement = getModalElement();
    if (modalElement) {
      jQuery(modalElement).one('hidden.bs.modal', function() {
        setTimeout(callback, 150);
      });
    }

    let attempts = 0;
    const maxAttempts = 50;
    const checkHidden = () => {
      attempts++;
      if (!isSpinnerVisible() || attempts >= maxAttempts) {
        setTimeout(callback, 150);
      } else {
        setTimeout(checkHidden, 100);
      }
    };
    setTimeout(checkHidden, 100);
  }

  window.showEmployeeSpinner = showEmployeeSpinner;
  window.hideEmployeeSpinner = hideEmployeeSpinner;
  window.waitForSpinnerHide = waitForSpinnerHide;
  window.isSpinnerVisible = isSpinnerVisible;
})();

function employeeSecureFetch(url, options = {}) {
  options.headers = options.headers || {};
  const token = sessionStorage.getItem('employeeToken');
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  options.headers['X-Requested-With'] = 'XMLHttpRequest';

  const showSpinner = options.showSpinner !== false;
  let didRedirect = false;

  if (showSpinner) {
    showEmployeeSpinner();
  }

  const finalize = async () => {
    if (!didRedirect && showSpinner) {
      hideEmployeeSpinner();
      await new Promise(resolve => waitForSpinnerHide(resolve));
    }
  };

  return fetch(url, options)
    .then(async res => {
      let data;
      try { data = await res.clone().json(); } catch { data = {}; }
      if (res.status === 403 && data?.error === "2FA_REQUIRED" && data.redirect) {
        didRedirect = true;
        window.location.href = data.redirect;
        return Promise.reject("2FA required, redirecting");
      }
      if ((res.status === 401 || res.status === 403) && data.redirect) {
        didRedirect = true;
        window.location.href = data.redirect;
        return Promise.reject(data.error || "Unauthorized, redirecting");
      }
      if (!res.ok) {
        throw new Error(data.message || "An error occurred");
      }
      if (options.showSuccessMessage) {
        // Use your preferred success modal logic here
      }
      return data;
    })
    .catch(err => {
      if (!didRedirect && !options.suppressErrorModal) {
        // Use your preferred error modal logic here
      }
      throw err;
    })
    .finally(finalize);
}

</script>
<!-- Script for checking 2FA  (End) -->

<!-- Script for checking if the account is terminated or deactivated (Start) -->
<script>
  // Assumes employeeSecureFetch is loaded globally

  function checkAccountStatusPeriodically() {
    async function checkStatus() {
      try {
        await employeeSecureFetch('/api/employee_status', { method: 'GET', showSpinner: false });
        // Employee is active, do nothing
      } catch (err) {
        try {
          const res = await fetch('/api/employee_status', {
            headers: {
              'Authorization': `Bearer ${sessionStorage.getItem('employeeToken') || ''}`,
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          if (res.status === 401 || res.status === 403) {
            const data = await res.json();
            const status = data.status?.toLowerCase();

            if (status === 'deactivated') {
              $('#accountDeactivatedModal').modal({
                backdrop: 'static',
                keyboard: false,
                focus: true
              });
              $('#accountDeactivatedModal').modal('show');
            } else if (status === 'terminated') {
              $('#accountTerminatedModal').modal({
                backdrop: 'static',
                keyboard: false,
                focus: true
              });
              $('#accountTerminatedModal').modal('show');
            }

            setTimeout(() => {
              sessionStorage.clear();
              sessionStorage.clear();
              window.location.href = '/';
            }, 5000);
          }
        } catch (modalErr) {
          console.error('Modal error:', modalErr);
        }
      }
    }

    checkStatus(); // Initial check
    setInterval(checkStatus, 10000); // Repeat every 10s
  }

  document.addEventListener('DOMContentLoaded', checkAccountStatusPeriodically);
</script>
<!-- Script for checking if the account is terminated or deactivated (End) -->

<!-- Script for forcing logout when the logout all devices triggered from other tabs (Start) -->
<script>
  window.addEventListener('storage', function (event) {
    if (event.key === 'employeeToken' && event.newValue === null) {
      // Show the logout modal using jQuery for Bootstrap 4
      $('#multiTabLogoutModal').modal({
        backdrop: 'static',
        keyboard: false
      });
      $('#multiTabLogoutModal').modal('show');

      // Redirect after 3 seconds
      setTimeout(() => {
        window.location.href = '/';
      }, 3000);
    }
  });
</script>
<!-- Script for forcing logout when the logout all devices triggered from other tabs (End) -->

<!-- Script for handling logout confirmation (Current User) (Start) -->
<script>
  // Token validity polling: no spinner, no success, no error modals for /validate_token

let tokenCheckIntervalId = null;

function checkTokenValidity() {
  // Do NOT show spinner, success, or error modal for this route
  employeeSecureFetch('/validate_token', { method: 'GET', showSpinner: false })
    .catch(err => {
      showExpiredModal();
    });
}

function showExpiredModal() {
  $('#sessionExpiredModal').modal({
    backdrop: 'static',
    keyboard: false
  });

  $('#sessionExpiredModal').modal('show');

  document.body.classList.add("modal-open");
  document.querySelectorAll('button, a, input, select, textarea').forEach(el => {
    if (!el.closest('#sessionExpiredModal')) {
      el.setAttribute('disabled', 'disabled');
    }
  });

  document.getElementById('redirectToLogin').addEventListener('click', () => {
    sessionStorage.removeItem('employeeToken');
    window.location.href = '/';
  });
}

tokenCheckIntervalId = setInterval(checkTokenValidity, 10000);

document.addEventListener('DOMContentLoaded', function () {
  const logoutBtn = document.getElementById('confirmLogoutBtnCurrentUser');
  if (!logoutBtn) return;

  logoutBtn.addEventListener('click', function () {
    clearInterval(tokenCheckIntervalId);

    const token = sessionStorage.getItem("employeeToken"); // üëà Read BEFORE removing

    $('#loadingModalCurrentUser').modal('show');
    $('#logoutModal').modal('hide');

    fetch("{{ url_for('login_bp.logout') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`  // üëà Add token to header
      }
    })
    .then(res => {
      sessionStorage.removeItem("employeeToken"); // üëà Now safe to remove
      setTimeout(() => {
        window.location.href = "/";
      }, 3000);
    })
    .catch(err => {
      sessionStorage.removeItem("employeeToken");
      setTimeout(() => {
        window.location.href = "/";
      }, 3000);
    });
  });
});
</script>
<!-- Script for handling logout confirmation (Current User (End) -->

<!-- Script for redirecting when token is blacklisted or overwritten (Start) -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const redirectBtn = document.getElementById('redirectToLogin');
    if (redirectBtn) {
      redirectBtn.addEventListener('click', () => {
        sessionStorage.removeItem('employeeToken');
        window.location.href = '/';
      });
    }
  });
</script>
<!-- Script for redirecting when token is blacklisted or overwritten (End) -->

<!-- Script for displaying the recent devices that is logged in (Start) -->
<script>
  $('#viewDevicesBtn').on('click', function () {
    employeeSecureFetch('/recent-devices', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(data => {
      // Wait for spinner to hide before showing modal and updating DOM
      $('#employeeSpinnerModal').one('hidden.bs.modal', () => {
        const tableBody = $('#devicesTable tbody');
        tableBody.empty();

        if (data.success) {
          if (data.devices.length === 0) {
            tableBody.html('<tr><td colspan="5" class="text-center">No devices found.</td></tr>');
          } else {
            data.devices.forEach(device => {
              const row = `
                <tr>
                  <td>${device.device_name}</td>
                  <td>${device.device_os}</td>
                  <td>${device.browser_name}</td>
                  <td>${device.ip_address}</td>
                  <td>${device.issued_at}</td>
                </tr>`;
              tableBody.append(row);
            });
          }
        } else {
          tableBody.html('<tr><td colspan="5" class="text-center text-danger">Failed to load recent devices.</td></tr>');
        }

        // Now show the recent devices modal after spinner hidden and table updated
        $('#recentDevicesModal').modal('show');

        // Fix Bootstrap removing modal-open class for multiple modals
        setTimeout(() => {
          if ($('#recentDevicesModal').hasClass('show')) {
            document.body.classList.add('modal-open');
          }
        }, 100);
      });

      // Hide spinner modal (will trigger the one('hidden.bs.modal') handler above)
      $('#employeeSpinnerModal').modal('hide');
    })
    .catch(error => {
      console.error('Error fetching recent devices:', error);
      const tableBody = $('#devicesTable tbody');
      tableBody.empty();
      tableBody.html('<tr><td colspan="5" class="text-center text-danger">Failed to load recent devices.</td></tr>');

      // Also hide spinner if visible
      $('#employeeSpinnerModal').modal('hide');

      // Show recent devices modal anyway (or show an error modal if you prefer)
      $('#recentDevicesModal').modal('show');

      setTimeout(() => {
        if ($('#recentDevicesModal').hasClass('show')) {
          document.body.classList.add('modal-open');
        }
      }, 100);
    });
  });
</script>
<!-- Script for displaying the recent devices that is logged in (End) -->

<!-- Script for loading user data from API routes (Start) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("üì¶ DOM fully loaded and parsed.");

    showEmployeeSpinner();

    // Use employeeSecureFetch instead of manual fetch/token
    employeeSecureFetch("/api/profile-info", { method: "GET" })
    .then(data => {
        console.log("üìÑ Parsed response data:", data);

        const user = data.user;
        const userRole = data.employee_role;

        if (!user) {
            throw new Error("User data not found in response");
        }

        console.log("üë§ Populating UI with user data:", user);

        const displayValue = (val) => (val === null || val === undefined || val === "") ? "N/A" : val;

        const safeSet = (id, value, prop = "textContent") => {
            const el = document.getElementById(id);
            if (el) {
                if (prop === "src") el.src = value;
                else el.textContent = displayValue(value);
                console.log(`‚úÖ Set #${id} ‚Üí`, value);
            } else {
                console.warn(`‚ö†Ô∏è Element with id "${id}" not found.`);
            }
        };

        // Add cache-buster to profile images to always get the latest image
        let cacheBustedUrl = "";
        if (user.profile_picture_url) {
            cacheBustedUrl = user.profile_picture_url + (user.profile_picture_url.includes('?') ? '&' : '?') + 'v=' + Date.now();
        }

        // For images, set N/A as a fallback alt text if no image
        safeSet("profile-picture", cacheBustedUrl || "N/A", "src");
        safeSet("profile-picture-dropdown", cacheBustedUrl || "N/A", "src");
        safeSet("profile-picture-box", cacheBustedUrl || "N/A", "src");
        safeSet("profile-picture-sidebar", cacheBustedUrl || "N/A", "src");

        // The new IDs you requested
        safeSet("user-email-dropdown", user.email);
        safeSet("user-id", user.employee_id);
        safeSet("user-position", user.role_name);
        safeSet("user-name", user.first_name + " " + user.last_name);
        safeSet("user-department", user.department);
        safeSet("user-date-hired", user.date_hired);
        safeSet("user-team_name", user.team_name);
        safeSet("user-email-contact", user.email);
        safeSet("user-phone", user.phone_number);

        // Existing fields
        safeSet("position-modal-detail", user.role_name);
        safeSet("first-name-modal", user.first_name);
        safeSet("last-name-modal", user.last_name);
        safeSet("email", user.email);
        safeSet("phone-number-modal", user.phone_number);
        safeSet("phone-number-modal-emergency", user.phone_number);
        safeSet("department-modal", user.department);
        safeSet("department-modal-detail", user.department);
        safeSet("address1-modal", user.address1);
        safeSet("address2-modal", user.address2);
        safeSet("certification", user.certification);
        safeSet("skills", user.skills);
        safeSet("education", user.education);
        safeSet("language", user.language);
        safeSet("hobbies", user.hobbies);
        safeSet("city-modal", user.city);

        // Messaging features
        if (typeof initMessagingFeatures === "function") {
            console.log("üì¨ Initializing messaging features...");
            initMessagingFeatures({
                user: user,
                employee_role: userRole
            });
        } else {
            console.log("‚ÑπÔ∏è initMessagingFeatures() not found, skipping messaging setup.");
        }
    })
    .catch(error => {
        console.error("‚ùå Error loading profile info:", error);
        alert("Error loading profile info. Please try again later or contact support.");
    })
    .finally(() => {
        hideEmployeeSpinner();
    });
});
</script>
<!-- Script for loading user data from API routes (End) -->

<!-- Script for messages and notifications (Start) -->
<script>
  // Employee Messaging Module - Seamless spinner, success, and error handling using employeeSecureFetch

// Globals
let previousUnreadCount = 0;
let messageIdToDelete = null;
let userData = null;

/**
 * Fetches messages from inbox.
 * @returns {Promise<Array>}
 */
function fetchMessages(url = '/employee/messages/inbox') {
  return employeeSecureFetch(url, { method: 'GET' })
    .then(messages => {
      if (Array.isArray(messages)) return messages;
      if (Array.isArray(messages.messages)) return messages.messages;
      return [];
    });
}

/**
 * Opens the compose message modal, fetching roles.
 */
function openComposeMessageModal() {
  employeeSecureFetch("/employee/roles", { method: 'GET' })
    .then(roleData => {
      $('#composeMessageModal').modal('show');
      const roleSelect = document.getElementById("roleSelect");
      roleSelect.innerHTML = '<option disabled selected>Select a role</option>';
      roleData.forEach(role => {
        const option = document.createElement("option");
        option.value = role.role_id;
        option.textContent = role.role_name;
        roleSelect.appendChild(option);
      });
      if (roleData.length > 0) {
        roleSelect.selectedIndex = 1;
        roleSelect.dispatchEvent(new Event("change"));
        handleRoleChange();
      }
    })
    .catch(err => {
      console.error("[openComposeMessageModal] Error:", err);
      showMessageModal("Failed to load compose modal.", false);
    });
}

/**
 * Opens the message inbox modal and populates messages.
 */
function openMessageInboxModal() {
  fetchMessages()
    .then(messages => {
      const container = document.getElementById('inboxMessages');
      container.innerHTML = '';
      if (!messages || messages.length === 0) {
        container.innerHTML = '<p class="text-muted">No messages found.</p>';
      } else {
        messages.forEach(msg => {
          const card = createMessageCard(msg);
          container.appendChild(card);
        });
      }
      $('#inboxModal').modal('show');
    })
    .catch(err => {
      console.error("[openMessageInboxModal] Error:", err);
      showMessageModal("Failed to load inbox messages.", false);
    });
}

/**
 * Creates a DOM card for a message.
 * @param {Object} msg
 * @returns {HTMLElement}
 */
function createMessageCard(msg) {
  const card = document.createElement('div');
  card.className = 'card mb-2';
  card.innerHTML = `
    <div class="card-body">
      <h6 class="card-subtitle mb-1 text-muted">
        From ${msg.sender_role?.toUpperCase() || ''} (User ID: ${msg.sender_id})
      </h6>
      <p class="card-text">${msg.content}</p>
      <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
      ${!msg.is_read ? `<button class="btn btn-sm btn-outline-primary float-right ml-2" onclick="markAsRead(${msg.message_id})">Mark as Read</button>` : ''}
      <button class="btn btn-sm btn-outline-danger float-right" onclick="showDeleteConfirmModal(${msg.message_id})">Delete</button>
    </div>`;
  return card;
}

/**
 * Shows the delete confirm modal for a message.
 * @param {number} messageId
 */
function showDeleteConfirmModal(messageId) {
  messageIdToDelete = messageId;
  $('#confirmDeleteModal').modal('show');
}

// Confirm delete handler
document.addEventListener('DOMContentLoaded', function() {
  const deleteBtn = document.getElementById('confirmDeleteBtn');
  if (deleteBtn) {
    deleteBtn.onclick = function() {
      if (messageIdToDelete !== null) {
        actuallyDeleteMessage(messageIdToDelete);
        messageIdToDelete = null;
        $('#confirmDeleteModal').modal('hide');
      }
    };
  }
});

/**
 * Deletes a message.
 * @param {number} messageId
 */
function actuallyDeleteMessage(messageId) {
  employeeSecureFetch(`/employee/messages/delete/${messageId}`, { method: 'DELETE' })
    .then(response => {
      showMessageModal("Message deleted successfully.", true);
      openMessageInboxModal();
      loadMessageNotifications(userData.user.employee_id, userData.employee_role);
    })
    .catch(err => {
      console.error("[deleteMessage] Error:", err);
      showMessageModal("Failed to delete message.", false);
    });
}

/**
 * Marks a message as read.
 * @param {number} messageId
 */
function markAsRead(messageId) {
  employeeSecureFetch(`/employee/messages/read/${messageId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({})
  })
    .then(() => {
      openMessageInboxModal();
      loadMessageNotifications(userData.user.employee_id, userData.employee_role);
    })
    .catch(err => {
      console.error("[markAsRead] Error:", err);
      showMessageModal("Failed to mark message as read.", false);
    });
}

/**
 * Loads unread message count and updates UI.
 * @param {string} userId
 * @param {string} role
 */
function loadMessageNotifications(userId, role) {
  const url = `/employee/messages/unread-count?user_id=${userId}&role=${role}`;
  employeeSecureFetch(url, { method: 'GET', showSpinner: false })
    .then(data => {
      updateUnreadCountBadge(data.unread_count);
      updateNotificationList(data.unread_count);
      if (data.unread_count > previousUnreadCount) {
        playNotificationSound();
        showNewMessageNotification(data.unread_count - previousUnreadCount);
      }
      previousUnreadCount = data.unread_count;
    })
    .catch(error => {
      console.error("[loadMessageNotifications] Error:", error);
      showMessageModal("Failed to load unread messages count.", false);
    });
}

/**
 * Updates the unread badge in the UI.
 * @param {number} count
 */
function updateUnreadCountBadge(count) {
  const badge = document.getElementById('unreadCountBadge');
  if (!badge) return;
  badge.innerText = count;
  badge.style.display = count === 0 ? 'none' : 'inline-block';
}

/**
 * Updates the notification dropdown.
 * @param {number} count
 */
function updateNotificationList(count) {
  const list = document.getElementById('notificationList');
  if (!list) return;
  list.innerHTML = count > 0
    ? `<a class="dropdown-item preview-item" href="#" onclick="openMessageInboxModal()">
        <div class="preview-thumbnail">
          <div class="preview-icon bg-warning">
            <i class="mdi mdi-email-alert text-white"></i>
          </div>
        </div>
        <div class="preview-item-content">
          <h6 class="preview-subject font-weight-normal">You have ${count} unread message${count > 1 ? 's' : ''}</h6>
          <p class="font-weight-light small-text text-muted mb-0">Check your inbox</p>
        </div>
      </a>`
    : '<p class="px-3 text-muted">Empty</p>';
}

/**
 * Shows a notification for new messages.
 * @param {number} newCount
 */
function showNewMessageNotification(newCount) {
  if (Notification.permission === 'granted') {
    new Notification(`New Message${newCount > 1 ? 's' : ''}`, {
      body: `You have ${newCount} new unread message${newCount > 1 ? 's' : ''}.`,
      icon: '/path/to/your/message-icon.png'
    });
  }
}

/**
 * Plays a notification sound.
 */
function playNotificationSound() {
  const audio = document.getElementById('messageSound');
  if (audio) {
    audio.play().catch(err => console.error("[playNotificationSound] Play error:", err));
  }
}

/**
 * Handles a role change in the compose message modal.
 */
function handleRoleChange() {
  const roleSelect = document.getElementById("roleSelect");
  const roleId = roleSelect.value;
  if (!roleId) return;
  const url = `/employee/users/by_role/${roleId}`;
  employeeSecureFetch(url, { method: 'GET' })
    .then(users => {
      const receiverSelect = document.getElementById("receiverSelect");
      receiverSelect.innerHTML = '';
      if (!users || users.length === 0) {
        receiverSelect.innerHTML = '<option disabled selected>No users available</option>';
      } else {
        const defaultOption = document.createElement("option");
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.value = "";
        defaultOption.textContent = "Select a receiver";
        receiverSelect.appendChild(defaultOption);
        users.forEach(user => {
          const option = document.createElement("option");
          option.value = user.user_id;
          option.setAttribute("data-email", user.email);
          option.textContent = user.email;
          receiverSelect.appendChild(option);
        });
      }
    })
    .catch(err => {
      console.error("[handleRoleChange] Error:", err);
      showMessageModal("Failed to load users for the selected role.", false);
    });
}

/**
 * Sends a message from the compose modal.
 */
function sendMessage() {
  const receiverSelect = document.getElementById("receiverSelect");
  const selectedOption = receiverSelect.options[receiverSelect.selectedIndex];
  if (!selectedOption || selectedOption.disabled) {
    showMessageModal("Please select a valid receiver.", false);
    return;
  }
  const receiverId = parseInt(selectedOption.value);
  const receiverEmail = selectedOption.getAttribute("data-email");
  const receiverRoleText = document.getElementById("roleSelect").selectedOptions[0]?.text || "Unknown";
  const message = document.getElementById("messageText").value;
  if (!message.trim()) {
    showMessageModal("Please enter a message.", false);
    return;
  }
  const payload = {
    sender_id: userData.user.employee_id,
    sender_role: userData.employee_role,
    receiver_id: receiverId,
    receiver_email: receiverEmail,
    receiver_role: receiverRoleText,
    subject: "No Subject",
    body: message
  };
  employeeSecureFetch('/employee/messages/send', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify(payload)
  })
    .then(response => {
      showMessageModal("Message sent!", true);
      $('#composeMessageModal').modal('hide');
    })
    .catch(err => {
      console.error("[sendMessage] Error:", err);
      showMessageModal('Failed to send message.', false);
    });
}

/**
 * Shows a message modal (success or error) using the correct modal IDs.
 * @param {string} message
 * @param {boolean} isSuccess
 */
function showMessageModal(message, isSuccess = true) {
  if (isSuccess) {
    const body = document.getElementById("successModalBody");
    if (body) body.textContent = message || "Success!";
    $('#successModal').modal('show');
  } else {
    const body = document.getElementById("errorModalBody");
    if (body) body.textContent = message || "An error occurred!";
    $('#errorModal').modal('show');
  }
}

/**
 * Initializes messaging features.
 * @param {Object} data
 */
function initMessagingFeatures(data) {
  userData = data;
  const roleSelect = document.getElementById("roleSelect");
  const sendButton = document.getElementById("sendButton");
  if (roleSelect) roleSelect.addEventListener("change", handleRoleChange);
  if (sendButton) sendButton.addEventListener("click", sendMessage);
  fetchMessages();
  loadMessageNotifications(userData.user.employee_id, userData.employee_role);
  setInterval(() => loadMessageNotifications(userData.user.employee_id, userData.employee_role), 30000);

  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      console.log("[initMessagingFeatures] Notification permission:", permission);
    });
  }
}
</script>
<!-- Script for messages and notifications (End) -->

<!-- Script for displaying saving plans (Start) -->
<script>
  function showSuccessModal(message) {
  document.getElementById('successModalBody').textContent = message;
  $('#successModal').modal('show');  // Bootstrap 4 jQuery modal
}

function showErrorModal(message) {
  document.getElementById('errorModalBody').textContent = message;
  $('#errorModal').modal('show');  // Bootstrap 4 jQuery modal
}

function formatContributionForTable(plan) {
  if (plan.contribution_unit === '% of salary') {
    return (plan.contribution_percent != null) ? `${plan.contribution_percent}% of salary` : 'N/A';
  }
  if (plan.contribution_amount != null && plan.contribution_unit) {
    return `${plan.contribution_amount} ${plan.contribution_unit}`;
  }
  if (plan.contribution_percent != null) {
    return `${plan.contribution_percent}%`;
  }
  return 'N/A';
}

function formatEmployerMatch(plan) {
  if (plan.employer_match_unit === '% of salary') {
    return (plan.employer_match_percent != null) ? `${plan.employer_match_percent}% of salary` : 'N/A';
  }
  if (plan.employer_match_amount != null && plan.employer_match_unit) {
    return `${plan.employer_match_amount} ${plan.employer_match_unit}`;
  }
  if (plan.employer_match_percent != null) {
    return `${plan.employer_match_percent}%`;
  }
  return 'N/A';
}

function safeSetText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function fetchSavingsPlans() {
  // Spinner is handled by employeeSecureFetch internally
  employeeSecureFetch('/my_savings_plans', { method: 'GET' })
    .then(data => {
      const tbody = document.getElementById('savingsPlansTableBody');
      tbody.innerHTML = '';

      const plans = data.plans || [];

      if (plans.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No savings plans found.</td></tr>';
        return;
      }

      plans.forEach(plan => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${plan.plan_type}</td>
          <td>${plan.provider}</td>
          <td>${formatContributionForTable(plan)}</td>
          <td>${plan.start_date}</td>
          <td>
            <span class="badge badge-${plan.status === 'Active' ? 'success' : 'secondary'}">${plan.status}</span>
          </td>
          <td>
            <button class="btn btn-sm btn-info mb-1" onclick="viewSavingsPlanDetails(${plan.plan_id})">View</button>
            <button class="btn btn-sm btn-warning mb-1" onclick="openRequestModal(${plan.plan_id})">Request Change</button>
            ${plan.request_count > 0 ? `
              <button class="btn btn-sm btn-primary mb-1" onclick="viewPlanResponses(${plan.plan_id})">
                View Responses (${plan.request_count})
              </button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(row);
      });
    })
    .catch(err => {
      console.error('Error fetching savings plans:', err);
      showErrorModal('Failed to fetch savings plans.');
    });
}

function viewPlanResponses(planId) {
  // Spinner is handled by employeeSecureFetch internally
  employeeSecureFetch(`/employee/plan_responses/${planId}`, { method: 'GET' })
    .then(data => {
      const modalBody = document.getElementById('responseViewModalBody');
      modalBody.innerHTML = '';

      if (data.error) {
        modalBody.innerHTML = `<div class="alert alert-info">${data.error}</div>`;
        waitForSpinnerHide(function() {
          $('#responseViewModal').modal('show');
        });
        return;
      }

      modalBody.innerHTML = `<div class="mb-3"><h5>All Responses (${data.response_count})</h5></div>`;

      data.responses.forEach(response => {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Request #${response.request_id}</span>
            <span class="badge badge-${getStatusColorSavingsPlan(response.status)}">${response.status}</span>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <h6>Your Request:</h6>
              <div class="p-2 bg-light rounded">${response.message || 'No message'}</div>
              <small class="text-muted">Submitted: ${new Date(response.submitted_at).toLocaleString()}</small>
            </div>
            <div class="mb-3">
              <h6>Admin Response:</h6>
              <div class="p-2 bg-light rounded">${response.response || 'No response yet'}</div>
              ${response.reviewed_at ? `
                <small class="text-muted">
                  Reviewed by ${response.reviewed_by} on ${new Date(response.reviewed_at).toLocaleString()}
                </small>` : ''}
            </div>
          </div>
        `;
        modalBody.appendChild(card);
      });

      // Show modal after spinner is gone
      waitForSpinnerHide(function() {
        $('#responseViewModal').modal('show');
      });
    })
    .catch(err => {
      console.error('Error:', err);
      showErrorModal('Failed to load responses.');
    });
}

function viewSavingsPlanDetails(planId) {
  // Spinner is handled by employeeSecureFetch internally
  employeeSecureFetch(`/savings_plan_details/${planId}`, { method: 'GET' })
    .then(plan => {
      if (plan.error) {
        showErrorModal(plan.error);
        return;
      }

      safeSetText('planDetailType', plan.plan_type);
      safeSetText('planDetailProvider', plan.provider);
      safeSetText('planDetailContribution', formatContributionForTable(plan));
      safeSetText('planDetailEmployerMatch', formatEmployerMatch(plan));
      safeSetText('planDetailStartDate', plan.start_date);
      safeSetText('planDetailStatus', plan.status);
      safeSetText('planDetailNotes', plan.notes || '-');

      const docDiv = document.getElementById('planDetailDoc');
      docDiv.innerHTML = plan.document_url
        ? `<a href="${plan.document_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2" download>Download PDF</a>`
        : '<span class="text-muted">No document available</span>';

      // Show modal after spinner is gone
      waitForSpinnerHide(function() {
        $('#savingsPlanDetailModal').modal('show');
      });
    })
    .catch(err => {
      console.error('Error fetching plan details:', err);
      showErrorModal('Failed to fetch plan details.');
    });
}

function openRequestModal(planId) {
  document.getElementById('requestPlanId').value = planId;
  document.getElementById('changeRequestText').value = '';
  $('#requestChangeModal').modal('show');
}

function submitChangeRequest() {
  const planId = document.getElementById('requestPlanId').value;
  const message = document.getElementById('changeRequestText').value;

  if (!message.trim()) {
    showErrorModal("Please enter your request.");
    return;
  }

  const payload = {
    plan_id: planId,
    request_type: 'Change Request',
    message: message
  };

  // Spinner is handled by employeeSecureFetch internally
  employeeSecureFetch('/submit_savings_change_request', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
    .then(response => {
      if (response.success) {
        showSuccessModal("Request submitted successfully.");
        $('#requestChangeModal').modal('hide');
        fetchSavingsPlans(); // Refresh plans list
      } else {
        showErrorModal("Failed to submit request. Message: " + (response.message || "Unknown error"));
      }
    })
    .catch(err => {
      console.error('Error submitting request:', err);
      showErrorModal("An error occurred. Check console for details.");
    });
}

function getStatusColorSavingsPlan(status) {
  return status === 'Approved' ? 'success' :
         status === 'Rejected' ? 'danger' : 'warning';
}

document.addEventListener('DOMContentLoaded', fetchSavingsPlans);
</script>
<!-- Script for displaying saving plans (End) -->

<!-- Script for displaying bonus and its details (Start) -->
<script>
  function fetchBonuses() {
  // Spinner is handled by employeeSecureFetch internally
  employeeSecureFetch('/my_bonuses', { method: 'GET' })
    .then(data => {
      const tbody = document.getElementById('myBonusTableBody');
      tbody.innerHTML = '';

      const bonuses = data.bonuses || [];
      if (bonuses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No bonuses found.</td></tr>';
        return;
      }

      bonuses.forEach(bonus => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>$${parseFloat(bonus.amount).toFixed(2)}</td>
          <td>${bonus.type}</td>
          <td>${bonus.description || '-'}</td>
          <td>${bonus.awarded_date}</td>
          <td><button class="btn btn-sm btn-info" onclick="viewBonusDetails(${bonus.id})">View</button></td>
        `;
        tbody.appendChild(row);
      });
    })
    .catch(err => {
      console.error('Error fetching bonuses:', err);
      showErrorModal('Failed to fetch bonuses.');
    });
}

function viewBonusDetails(bonusId) {
  // Spinner is handled by employeeSecureFetch internally
  employeeSecureFetch(`/bonus_details/${bonusId}`, { method: 'GET' })
    .then(data => {
      if (data.error) {
        showErrorModal(data.error);
        return;
      }

      const bonus = data.bonus;
      document.getElementById('bonusDetailType').textContent = bonus.type;
      document.getElementById('bonusDetailAmount').textContent = `$${parseFloat(bonus.amount).toFixed(2)}`;
      document.getElementById('bonusDetailDesc').textContent = bonus.description || '-';
      document.getElementById('bonusDetailDate').textContent = bonus.awarded_date;

      // Show modal after spinner is gone
      waitForSpinnerHide(function() {
        $('#bonusDetailModal').modal('show');
      });
    })
    .catch(err => {
      console.error('Error fetching bonus details:', err);
      showErrorModal('Failed to load bonus details.');
    });
}

// Automatically fetch bonuses on page load
document.addEventListener('DOMContentLoaded', fetchBonuses);
</script>
<!-- Script for displaying bonus and its details (End) -->

<!-- Script for displaying expense claims history (Start) -->
<script>
  function filterExpenseTable() {
  const search = (document.getElementById('generalSearch')?.value || '').toLowerCase();
  const category = (document.getElementById('categoryFilter')?.value || '').toLowerCase();
  const status = (document.getElementById('statusFilter')?.value || '').toLowerCase();
  const startDate = document.getElementById('startDateFilter')?.value || '';
  const endDate = document.getElementById('endDateFilter')?.value || '';

  const rows = document.querySelectorAll('#expenseHistoryTable tbody tr');

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const rowText = row.textContent.toLowerCase();
    const rowCategory = cells[3]?.textContent.toLowerCase() || '';
    const rowStatus = cells[5]?.textContent.toLowerCase() || '';
    const rowDate = cells[2]?.textContent || '';

    let visible = true;
    if (search && !rowText.includes(search)) visible = false;
    if (category && rowCategory !== category) visible = false;
    if (status && rowStatus !== status) visible = false;
    if (startDate && rowDate < startDate) visible = false;
    if (endDate && rowDate > endDate) visible = false;

    row.style.display = visible ? '' : 'none';
  });
}

function getStatusColor(status) {
  switch ((status || '').toLowerCase()) {
    case 'approved': return 'success';
    case 'rejected': return 'danger';
    default: return 'secondary';
  }
}

function openExpenseHistoryModal() {
  // Spinner is handled by employeeSecureFetch internally

  employeeSecureFetch('/my-expense-claims', { method: 'GET' })
    .then(data => {
      const tbody = document.querySelector('#expenseHistoryTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No claims found.</td></tr>';
        // Show modal even if no data
        waitForSpinnerHide(function() {
          $('#expenseHistoryModal').modal('show');
        });
        return;
      }

      data.forEach(claim => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${claim.title}</td>
          <td>$${parseFloat(claim.amount).toFixed(2)}</td>
          <td>${claim.date}</td>
          <td>${claim.category}</td>
          <td>${claim.description || '-'}</td>
          <td><span class="badge badge-${getStatusColor(claim.status)}">${claim.status}</span></td>
          <td>${claim.receipt_url ? `<a href="${claim.receipt_url}" target="_blank">View</a>` : '-'}</td>
        `;
        tbody.appendChild(row);
      });

      // Show expense modal after spinner disappears
      waitForSpinnerHide(function() {
        $('#expenseHistoryModal').modal('show');
      });
    })
    .catch(err => {
      console.error('Error fetching expense history:', err);
      showErrorModal('Failed to load expense history.');
    });
}

document.addEventListener('DOMContentLoaded', function () {
  const attach = (id, evt, fn) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener(evt, fn);
  };

  attach('generalSearch', 'input', filterExpenseTable);
  attach('categoryFilter', 'change', filterExpenseTable);
  attach('statusFilter', 'change', filterExpenseTable);
  attach('startDateFilter', 'change', filterExpenseTable);
  attach('endDateFilter', 'change', filterExpenseTable);

  // Fallback legacy search (optional use)
  const expenseSearchEl = document.getElementById('expenseSearch');
  if (expenseSearchEl) {
    expenseSearchEl.addEventListener('keyup', function () {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#expenseHistoryTable tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }
});
</script>
<!-- Script for displaying expense claims history (End) -->

<!-- Script for submitting expense claims (Start) -->
<script>
  document.getElementById('expenseForm')?.addEventListener('submit', function (e) {
    e.preventDefault();

    const fileInput = document.getElementById('receipt');
    const file = fileInput?.files?.[0];

    function showSuccessModal(message) {
      document.getElementById('successModalBody').textContent = message;
      $('#successModal').modal('show'); // Bootstrap 4
    }

    function showErrorModal(message) {
      document.getElementById('errorModalBody').textContent = message;
      $('#errorModal').modal('show'); // Bootstrap 4
    }

    if (file) {
      const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      if (!allowedTypes.includes(file.type)) {
        showErrorModal('Only JPG, PNG, or PDF files are allowed.');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        showErrorModal('File size must be less than 5MB.');
        return;
      }
    }

    const formData = new FormData(this);
    showEmployeeSpinner();

    employeeSecureFetch('/submit-expense', {
      method: 'POST',
      body: formData
    })
      .then(data => {
        if (data.status === 'success') {
          showSuccessModal(data.message || 'Expense submitted successfully!');
          this.reset();
        } else {
          showErrorModal(data.message || data.error || 'Error submitting expense.');
        }
      })
      .catch(err => {
        console.error('Submission error:', err);
        showErrorModal('Something went wrong while submitting the expense.');
      })
      .finally(hideEmployeeSpinner);
  });
</script>
<!-- Script for submitting expense claims (End) -->

</html>